

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>45. Fiscal Risk and Government Debt &#8212; Advanced Quantitative Economics with Python</title>
    <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
        <script>
            MathJax = {
            loader: {load: ['[tex]/boldsymbol', '[tex]/textmacros']},
            tex: {
                packages: {'[+]': ['boldsymbol', 'textmacros']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    "argmax" : "arg\\,max",
                    "argmin" : "arg\\,min",
                    "col"    : "col",
                    "Span"   :  "span",
                    "epsilon": "\\varepsilon",
                    "EE": "\\mathbb{E}",
                    "PP": "\\mathbb{P}",
                    "RR": "\\mathbb{R}",
                    "NN": "\\mathbb{N}",
                    "ZZ": "\\mathbb{Z}",
                    "aA": "\\mathcal{A}",
                    "bB": "\\mathcal{B}",
                    "cC": "\\mathcal{C}",
                    "dD": "\\mathcal{D}",
                    "eE": "\\mathcal{E}",
                    "fF": "\\mathcal{F}",
                    "gG": "\\mathcal{G}",
                    "hH": "\\mathcal{H}",
                }
            },
            svg: {
                fontCache: 'global',
                scale: 0.92,
                displayAlign: "center",
            },
            };
        </script>
    
    
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/quantecon-book-theme.css?digest=b09b2da44b9015b4fa76ea072fa2d8f7faee5492" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>


    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/scripts/quantecon-book-theme.js?digest=eed9c059a3ee152aae2353ec732f0a6d12e6aa07"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KZLV7PM9LL"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KZLV7PM9LL');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"tex": {"macros": {"argmax": "arg\\,max", "argmin": "arg\\,min", "col": "col", "Span": "span", "epsilon": "\\varepsilon", "EE": "\\mathbb{E}", "PP": "\\mathbb{P}", "RR": "\\mathbb{R}", "NN": "\\mathbb{N}", "ZZ": "\\mathbb{Z}", "aA": "\\mathcal{A}", "bB": "\\mathcal{B}", "cC": "\\mathcal{C}", "dD": "\\mathcal{D}", "eE": "\\mathcal{E}", "fF": "\\mathcal{F}", "gG": "\\mathcal{G}", "hH": "\\mathcal{H}"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'amss3';</script>
    <link rel="canonical" href="https://python-advanced.quantecon.org/amss3.html" />
    <link rel="shortcut icon" href="_static/lectures-favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="46. Competitive Equilibria of a Model of Chang" href="chang_ramsey.html" />
    <link rel="prev" title="44. Fluctuating Interest Rates Deliver Fiscal Insurance" href="amss2.html" />

<!-- Normal Meta Tags -->
<meta name="author" context="Thomas J. Sargent &amp; John Stachurski" />
<meta name="keywords" content="Python, QuantEcon, Quantitative Economics, Economics, Sloan, Alfred P. Sloan Foundation, Tom J. Sargent, John Stachurski" />
<meta name="description" content=This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski. />

<!-- Twitter tags -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@quantecon" />
<meta name="twitter:title" content="Fiscal Risk and Government Debt"/>
<meta name="twitter:description" content="This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski.">
<meta name="twitter:creator" content="@quantecon">
<meta name="twitter:image" content="https://assets.quantecon.org/img/qe-twitter-logo.png">

<!-- Opengraph tags -->
<meta property="og:title" content="Fiscal Risk and Government Debt" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://python-advanced.quantecon.org/amss3.html" />
<meta property="og:image" content="https://assets.quantecon.org/img/qe-og-logo.png" />
<meta property="og:description" content="This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski." />
<meta property="og:site_name" content="Advanced Quantitative Economics with Python" />
<meta name="theme-color" content="#ffffff" />

  </head>
<body>


    <span id="top"></span>

    <div class="qe-wrapper">

        <div class="qe-main">

            <div class="qe-page" id=amss3>

                <div class="qe-page__toc">

                    <div class="inner">

                        
                        <div class="qe-page__toc-header">
                            On this page
                        </div>


                        <nav id="bd-toc-nav" class="qe-page__toc-nav">
                            <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">45.1. Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-economy">45.2. The Economy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#first-and-second-moments">45.2.1. First and Second Moments</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#long-simulation">45.3. Long Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#asymptotic-mean-and-rate-of-convergence">45.4. Asymptotic Mean and Rate of Convergence</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#asymptotic-mean">45.4.1. Asymptotic Mean</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rate-of-convergence">45.4.2. Rate of Convergence</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#more-advanced-topic">45.4.3. More Advanced Topic</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chicken-and-egg">45.4.4. Chicken and Egg</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approximating-the-ergodic-mean">45.4.5. Approximating the Ergodic Mean</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-by-step">45.4.6. Step by Step</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#execution">45.4.7. Execution</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1">45.4.7.1. Step 1</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2">45.4.7.2. Step 2</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-about-code">45.4.8. Note about Code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-code">45.4.9. Running the code</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3">45.4.9.1. Step 3</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4">45.4.9.2. Step 4</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-6">45.4.9.3. Step 6</a></li>
</ul>
</li>
</ul>
</li>
</ul>
                            <p class="logo">
                                
                                    
                                    <a href=https://quantecon.org><img src="_static/qe-logo-large.png" class="logo logo-img" alt="logo"></a>
                                    
                                    
                                
                            </p>

                            <p class="powered">Powered by <a href="https://jupyterbook.org/">Jupyter Book</a></p>

                        </nav>

                        <div class="qe-page__toc-footer">
                            
                            
                            <p><a href="#top"><strong>Back to top</strong></a></p>
                        </div>

                    </div>

                </div>

                <div class="qe-page__header">

                    <div class="qe-page__header-copy">

                        <p class="qe-page__header-heading"><a href="intro.html">Advanced Quantitative Economics with Python</a></p>

                        <p class="qe-page__header-subheading">Fiscal Risk and Government Debt</p>

                    </div>
                    <!-- length 2, since its a string and empty dict has length 2 - {} -->
                        <p class="qe-page__header-authors" font-size="18">
                            
                                
                                    <a href="http://www.tomsargent.com/" target="_blank"><span>Thomas J. Sargent</span></a>
                                
                            
                                
                                    and <a href="https://johnstachurski.net/" target="_blank"><span>John Stachurski</span></a>
                                
                            
                        </p>


                </div> <!-- .page__header -->



                
                <main class="qe-page__content" role="main">
                    
                    <div>
                        
  <div id="qe-notebook-header" align="right" style="text-align:right;">
        <a href="https://quantecon.org/" title="quantecon.org">
                <img style="width:250px;display:inline;" width="250px" src="https://assets.quantecon.org/img/qe-menubar-logo.svg" alt="QuantEcon">
        </a>
</div><section class="tex2jax_ignore mathjax_ignore" id="fiscal-risk-and-government-debt">
<h1><span class="section-number">45. </span>Fiscal Risk and Government Debt<a class="headerlink" href="#fiscal-risk-and-government-debt" title="Permalink to this heading">#</a></h1>
<p>In addition to what’s in Anaconda, this lecture will need the following libraries:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>quantecon
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: quantecon in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (0.7.2)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: numba&gt;=0.49.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from quantecon) (0.59.1)
Requirement already satisfied: numpy&gt;=1.17.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from quantecon) (1.26.4)
Requirement already satisfied: requests in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from quantecon) (2.31.0)
Requirement already satisfied: scipy&gt;=1.5.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from quantecon) (1.11.4)
Requirement already satisfied: sympy in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from quantecon) (1.12)
Requirement already satisfied: llvmlite&lt;0.43,&gt;=0.42.0dev0 in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from numba&gt;=0.49.0-&gt;quantecon) (0.42.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from requests-&gt;quantecon) (2.0.4)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from requests-&gt;quantecon) (3.4)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from requests-&gt;quantecon) (2.0.7)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from requests-&gt;quantecon) (2024.2.2)
Requirement already satisfied: mpmath&gt;=0.19 in /home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages (from sympy-&gt;quantecon) (1.3.0)
</pre></div>
</div>
</div>
</details>
</div>
<section id="overview">
<h2><span class="section-number">45.1. </span>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h2>
<p>This lecture studies government debt in an AMSS
economy <span id="id1">[<a class="reference internal" href="zreferences.html#id130" title="S Rao Aiyagari, Albert Marcet, Thomas J Sargent, and Juha Seppälä. Optimal taxation without state-contingent debt. Journal of Political Economy, 110(6):1220–1254, 2002.">Aiyagari <em>et al.</em>, 2002</a>]</span> of the type described in <a class="reference internal" href="amss.html"><span class="doc">Optimal Taxation without State-Contingent Debt</span></a>.</p>
<p>We study the behavior of government debt  as time <span class="math notranslate nohighlight">\(t \rightarrow + \infty\)</span>.</p>
<p>We use these techniques</p>
<ul class="simple">
<li><p>simulations</p></li>
<li><p>a regression coefficient from the tail of a long simulation that allows us to verify that  the asymptotic mean of government debt solves
a fiscal-risk minimization  problem</p></li>
<li><p>an approximation to the <strong>mean</strong> of an ergodic distribution of government debt</p></li>
<li><p>an approximation  to the <strong>rate of convergence</strong> to an ergodic distribution of government debt</p></li>
</ul>
<p>We apply tools that are applicable to  more general incomplete markets economies that are presented on pages 648 - 650 in section III.D
of <span id="id2">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> (BEGS).</p>
<p>We study an AMSS economy <span id="id3">[<a class="reference internal" href="zreferences.html#id130" title="S Rao Aiyagari, Albert Marcet, Thomas J Sargent, and Juha Seppälä. Optimal taxation without state-contingent debt. Journal of Political Economy, 110(6):1220–1254, 2002.">Aiyagari <em>et al.</em>, 2002</a>]</span>  with  three Markov states driving government expenditures.</p>
<ul class="simple">
<li><p>In a <a class="reference internal" href="amss2.html"><span class="doc">previous lecture</span></a>, we showed that with only two Markov states, it is possible that  endogenous
interest rate fluctuations eventually can support complete markets allocations and Ramsey outcomes.</p></li>
<li><p>The presence of three states  prevents the full spanning that eventually prevails in the two-state example featured in
<a class="reference internal" href="amss2.html"><span class="doc">Fiscal Insurance via Fluctuating Interest Rates</span></a>.</p></li>
</ul>
<p>The lack of full spanning means that the ergodic distribution of the par value of government debt is nontrivial, in contrast to the situation
in <a class="reference internal" href="amss2.html"><span class="doc">Fiscal Insurance via Fluctuating Interest Rates</span></a>  in which the ergodic distribution of the par value of government debt is concentrated on one point.</p>
<p>Nevertheless,   <span id="id4">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> (BEGS) establish that, for general settings that include ours, the Ramsey
planner steers government assets to a level that comes
<strong>as close as possible</strong> to providing full spanning in a precise a sense defined by
BEGS that we describe below.</p>
<p>We use code constructed in <a class="reference internal" href="amss2.html"><span class="doc">Fluctuating Interest Rates Deliver Fiscal Insurance</span></a>.</p>
<p><strong>Warning:</strong> Key equations in  <span id="id5">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> section III.D carry  typos  that we correct below.</p>
<p>Let’s start with some imports:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-economy">
<h2><span class="section-number">45.2. </span>The Economy<a class="headerlink" href="#the-economy" title="Permalink to this heading">#</a></h2>
<p>As in <a class="reference internal" href="amss.html"><span class="doc">Optimal Taxation without State-Contingent Debt</span></a> and <a class="reference internal" href="opt_tax_recur.html"><span class="doc">Optimal Taxation with State-Contingent Debt</span></a>,
we assume that the  representative agent has  utility function</p>
<div class="math notranslate nohighlight">
\[
u(c,n) = {\frac{c^{1-\sigma}}{1-\sigma}} - {\frac{n^{1+\gamma}}{1+\gamma}}
\]</div>
<p>We work directly with labor supply instead of leisure.</p>
<p>We assume that</p>
<div class="math notranslate nohighlight">
\[
c_t + g_t = n_t
\]</div>
<p>The Markov state <span class="math notranslate nohighlight">\(s_t\)</span> takes <strong>three</strong> values, namely,  <span class="math notranslate nohighlight">\(0,1,2\)</span>.</p>
<p>The initial Markov state is <span class="math notranslate nohighlight">\(0\)</span>.</p>
<p>The Markov transition matrix is <span class="math notranslate nohighlight">\((1/3) I\)</span> where <span class="math notranslate nohighlight">\(I\)</span> is a <span class="math notranslate nohighlight">\(3 \times 3\)</span> identity matrix, so the <span class="math notranslate nohighlight">\(s_t\)</span> process is IID.</p>
<p>Government expenditures <span class="math notranslate nohighlight">\(g(s)\)</span> equal <span class="math notranslate nohighlight">\(.1\)</span> in Markov state <span class="math notranslate nohighlight">\(0\)</span>, <span class="math notranslate nohighlight">\(.2\)</span> in Markov state <span class="math notranslate nohighlight">\(1\)</span>, and <span class="math notranslate nohighlight">\(.3\)</span>
in Markov state <span class="math notranslate nohighlight">\(2\)</span>.</p>
<p>We set preference parameters</p>
<div class="math notranslate nohighlight">
\[
\begin{aligned}
\beta &amp; = .9 \cr
\sigma &amp; = 2  \cr
\gamma &amp; = 2
\end{aligned}
\]</div>
<p>The following Python code sets up the economy</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">class</span> <span class="nc">CRRAutility</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">β</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                 <span class="n">σ</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">γ</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">π</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">),</span>
                 <span class="n">G</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]),</span>
                 <span class="n">Θ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                 <span class="n">transfers</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">σ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span> <span class="o">=</span> <span class="n">β</span><span class="p">,</span> <span class="n">σ</span><span class="p">,</span> <span class="n">γ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfers</span> <span class="o">=</span> <span class="n">π</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">transfers</span>

    <span class="c1"># Utility function</span>
    <span class="k">def</span> <span class="nf">U</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">σ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">σ</span>
        <span class="k">if</span> <span class="n">σ</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">U</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">σ</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">σ</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">U</span> <span class="o">-</span> <span class="n">n</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="p">)</span>

    <span class="c1"># Derivatives of utility function</span>
    <span class="k">def</span> <span class="nf">Uc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">σ</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Ucc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">σ</span> <span class="o">*</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">σ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Un</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">n</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span>

    <span class="k">def</span> <span class="nf">Unn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span> <span class="o">*</span> <span class="n">n</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="first-and-second-moments">
<h3><span class="section-number">45.2.1. </span>First and Second Moments<a class="headerlink" href="#first-and-second-moments" title="Permalink to this heading">#</a></h3>
<p>We’ll want  first and second moments of some key random variables below.</p>
<p>The following code computes these moments; the code is recycled from <a class="reference internal" href="amss2.html"><span class="doc">Fluctuating Interest Rates Deliver Fiscal Insurance</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns mean for x given initial state&#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">@</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">variance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">@</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">covariance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">@</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="long-simulation">
<h2><span class="section-number">45.3. </span>Long Simulation<a class="headerlink" href="#long-simulation" title="Permalink to this heading">#</a></h2>
<p>To generate a long simulation we use the following code.</p>
<p>We begin by showing the code that we used in earlier lectures on the AMSS model.</p>
<p>Here it is</p>
<div class="cell tag_collapse-20 docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">root</span>
<span class="kn">from</span> <span class="nn">quantecon</span> <span class="kn">import</span> <span class="n">MarkovChain</span>


<span class="k">class</span> <span class="nc">SequentialAllocation</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class that takes CESutility or BGPutility object as input returns</span>
<span class="sd">    planner&#39;s allocation as a function of the multiplier on the</span>
<span class="sd">    implementability constraint μ.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>

        <span class="c1"># Initialize from model object attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">G</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">Θ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">)</span>  <span class="c1"># Number of states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="c1"># Find the first best allocation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_first_best</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">find_first_best</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the first best allocation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span>

        <span class="k">def</span> <span class="nf">res</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find first best&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">S</span><span class="p">:]</span>

        <span class="c1"># Multiplier on the resource constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ΞFB</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zFB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ΞFB</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">time1_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">μ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes optimal allocation for time t &gt;= 1 for a given μ</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Ucc</span><span class="p">,</span> <span class="n">Un</span><span class="p">,</span> <span class="n">Unn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Ucc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Unn</span>

        <span class="k">def</span> <span class="nf">FOC</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">]</span>
            <span class="n">Ξ</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">:]</span>
            <span class="c1"># FOC of c</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">μ</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ucc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">-</span> <span class="n">Ξ</span><span class="p">,</span>
                              <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">μ</span> <span class="o">*</span> <span class="p">(</span><span class="n">Unn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> \
                              <span class="o">+</span> <span class="n">Θ</span> <span class="o">*</span> <span class="n">Ξ</span><span class="p">,</span>  <span class="c1"># FOC of n</span>
                              <span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">])</span>

        <span class="c1"># Find the root of the first-order condition</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">FOC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zFB</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find LS allocation.&#39;</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">Ξ</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">:]</span>

        <span class="c1"># Compute x</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Ξ</span>

    <span class="k">def</span> <span class="nf">time0_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">s_0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the optimal allocation given initial government debt B_ and</span>
<span class="sd">        state s_0</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">π</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">β</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Ucc</span><span class="p">,</span> <span class="n">Un</span><span class="p">,</span> <span class="n">Unn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Ucc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Unn</span>

        <span class="c1"># First order conditions of planner&#39;s problem</span>
        <span class="k">def</span> <span class="nf">FOC</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">μ</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">Ξ</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">xprime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">μ</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">B_</span><span class="p">)</span> <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">β</span> <span class="o">*</span> <span class="n">π</span><span class="p">[</span><span class="n">s_0</span><span class="p">]</span>
                                            <span class="o">@</span> <span class="n">xprime</span><span class="p">,</span>
                              <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">μ</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ucc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                                            <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">B_</span><span class="p">)</span> <span class="o">+</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">-</span> <span class="n">Ξ</span><span class="p">,</span>
                              <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">μ</span> <span class="o">*</span> <span class="p">(</span><span class="n">Unn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span>
                                            <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="n">Θ</span><span class="p">[</span><span class="n">s_0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ξ</span><span class="p">,</span>
                              <span class="p">(</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">)[</span><span class="n">s_0</span><span class="p">]])</span>

        <span class="c1"># Find root</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">FOC</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">[</span><span class="n">s_0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">[</span><span class="n">s_0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ΞFB</span><span class="p">[</span><span class="n">s_0</span><span class="p">]]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find time 0 LS allocation.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

    <span class="k">def</span> <span class="nf">time1_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">μ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the value associated with multiplier μ</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Ξ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">μ</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">V</span>

    <span class="k">def</span> <span class="nf">Τ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes Τ given c, n</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>  <span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">Un</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">Uc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">s_0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sHist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Simulates planners policies for T periods</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">π</span><span class="p">,</span> <span class="n">β</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span>
        <span class="n">Uc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span>

        <span class="k">if</span> <span class="n">sHist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sHist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">s_0</span><span class="p">)</span>

        <span class="n">cHist</span><span class="p">,</span> <span class="n">nHist</span><span class="p">,</span> <span class="n">Bhist</span><span class="p">,</span> <span class="n">ΤHist</span><span class="p">,</span> <span class="n">μHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
        <span class="n">RHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Time 0</span>
        <span class="n">μ</span><span class="p">,</span> <span class="n">cHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time0_allocation</span><span class="p">(</span><span class="n">B_</span><span class="p">,</span> <span class="n">s_0</span><span class="p">)</span>
        <span class="n">ΤHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Τ</span><span class="p">(</span><span class="n">cHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">s_0</span><span class="p">]</span>
        <span class="n">Bhist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B_</span>
        <span class="n">μHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">μ</span>

        <span class="c1"># Time 1 onward</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Ξ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">μ</span><span class="p">)</span>
            <span class="n">Τ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Τ</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">u_c</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">Eu_c</span> <span class="o">=</span> <span class="n">π</span><span class="p">[</span><span class="n">sHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">@</span> <span class="n">u_c</span>
            <span class="n">cHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">Bhist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">ΤHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/</span> <span class="n">u_c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> \
                                                     <span class="n">Τ</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">RHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">cHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">Eu_c</span><span class="p">)</span>
            <span class="n">μHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">μ</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">cHist</span><span class="p">,</span> <span class="n">nHist</span><span class="p">,</span> <span class="n">Bhist</span><span class="p">,</span> <span class="n">ΤHist</span><span class="p">,</span> <span class="n">sHist</span><span class="p">,</span> <span class="n">μHist</span><span class="p">,</span> <span class="n">RHist</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_collapse-20 docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">fmin_slsqp</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">root</span>
<span class="kn">from</span> <span class="nn">quantecon</span> <span class="kn">import</span> <span class="n">MarkovChain</span>


<span class="k">class</span> <span class="nc">RecursiveAllocationAMSS</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">μgrid</span><span class="p">,</span> <span class="n">tol_diff</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">G</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">)</span>  <span class="c1"># Number of states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">μgrid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">μgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol_diff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol_diff</span><span class="p">,</span> <span class="n">tol</span>

        <span class="c1"># Find the first best allocation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_time1_bellman</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">time_0</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Bellman equation now solves time 0 problem</span>

    <span class="k">def</span> <span class="nf">solve_time1_bellman</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Solve the time  1 Bellman equation for calibration model and</span>
<span class="sd">        initial grid μgrid0</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">μgrid0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">μgrid</span>
        <span class="n">π</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">π</span>
        <span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">)</span>

        <span class="c1"># First get initial fit from Lucas Stokey solution.</span>
        <span class="c1"># Need to change things to be ex ante</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">SequentialAllocation</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolator_factory</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">incomplete_allocation</span><span class="p">(</span><span class="n">μ_</span><span class="p">,</span> <span class="n">s_</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">time1_value</span><span class="p">(</span><span class="n">μ_</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="n">x</span><span class="p">,</span> <span class="n">π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="n">V</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">Vf</span><span class="p">,</span> <span class="n">xprimef</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">μ</span><span class="p">:</span> <span class="n">incomplete_allocation</span><span class="p">(</span><span class="n">μ</span><span class="p">,</span> <span class="n">s_</span><span class="p">),</span> <span class="n">μgrid0</span><span class="p">))</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
            <span class="n">xprimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span>
            <span class="n">cf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
            <span class="n">Vf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">V</span><span class="p">))</span>
            <span class="n">xgrid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">xprimef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xprimes</span><span class="p">))</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xprimef</span> <span class="o">=</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">cf</span><span class="p">),</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">nf</span><span class="p">),</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">xprimef</span><span class="p">)</span>
        <span class="n">Vf</span> <span class="o">=</span> <span class="n">fun_hstack</span><span class="p">(</span><span class="n">Vf</span><span class="p">)</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="p">[</span><span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xprimef</span><span class="p">]</span>

        <span class="c1"># Create xgrid</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">xbar</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xbar</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xbar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">μgrid0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xgrid</span> <span class="o">=</span> <span class="n">xgrid</span>

        <span class="c1"># Now iterate on Bellman equation</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">BellmanEquation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">policies</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol_diff</span><span class="p">:</span>
            <span class="n">PF</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">Vf</span><span class="p">)</span>

            <span class="n">Vfnew</span><span class="p">,</span> <span class="n">policies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_policy_function</span><span class="p">(</span><span class="n">PF</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">Vf</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span> <span class="o">-</span> <span class="n">Vfnew</span><span class="p">(</span><span class="n">xgrid</span><span class="p">))</span> <span class="o">/</span> <span class="n">Vf</span><span class="p">(</span><span class="n">xgrid</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="n">Vf</span> <span class="o">=</span> <span class="n">Vfnew</span>

        <span class="c1"># Store value function policies and Bellman Equations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vf</span> <span class="o">=</span> <span class="n">Vf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="o">=</span> <span class="n">policies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>

    <span class="k">def</span> <span class="nf">fit_policy_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PF</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fits the policy functions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">xgrid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xgrid</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolator_factory</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xprimef</span><span class="p">,</span> <span class="n">Tf</span><span class="p">,</span> <span class="n">Vf</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="n">PFvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">PF</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xgrid</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Vf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">PFvec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="n">cf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span> <span class="o">+</span> <span class="n">S</span><span class="p">]))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">S</span><span class="p">:</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">]))</span>
            <span class="n">xprimef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">:</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">S</span><span class="p">]))</span>
            <span class="n">Tf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">S</span><span class="p">:]))</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">cf</span><span class="p">),</span> <span class="n">fun_vstack</span><span class="p">(</span>
            <span class="n">nf</span><span class="p">),</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">xprimef</span><span class="p">),</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">Tf</span><span class="p">)</span>
        <span class="n">Vf</span> <span class="o">=</span> <span class="n">fun_hstack</span><span class="p">(</span><span class="n">Vf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Vf</span><span class="p">,</span> <span class="n">policies</span>

    <span class="k">def</span> <span class="nf">Τ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes Τ given c and n</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">Un</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">Uc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">time0_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">s0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the optimal allocation given initial government debt B_ and</span>
<span class="sd">        state s_0</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">PF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vf</span><span class="p">)</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">PF</span><span class="p">(</span><span class="n">B_</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span>
        <span class="n">c0</span><span class="p">,</span> <span class="n">n0</span><span class="p">,</span> <span class="n">xprime0</span><span class="p">,</span> <span class="n">T0</span> <span class="o">=</span> <span class="n">z0</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">c0</span><span class="p">,</span> <span class="n">n0</span><span class="p">,</span> <span class="n">xprime0</span><span class="p">,</span> <span class="n">T0</span>

    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">s_0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sHist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Simulates planners policies for T periods</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">π</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span>
        <span class="n">Uc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xprimef</span><span class="p">,</span> <span class="n">Tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span>

        <span class="k">if</span> <span class="n">sHist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sHist</span> <span class="o">=</span> <span class="n">simulate_markov</span><span class="p">(</span><span class="n">π</span><span class="p">,</span> <span class="n">s_0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="n">cHist</span><span class="p">,</span> <span class="n">nHist</span><span class="p">,</span> <span class="n">Bhist</span><span class="p">,</span> <span class="n">xHist</span><span class="p">,</span> <span class="n">ΤHist</span><span class="p">,</span> <span class="n">THist</span><span class="p">,</span> <span class="n">μHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
        <span class="c1"># Time 0</span>
        <span class="n">cHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">THist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time0_allocation</span><span class="p">(</span><span class="n">B_</span><span class="p">,</span> <span class="n">s_0</span><span class="p">)</span>
        <span class="n">ΤHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Τ</span><span class="p">(</span><span class="n">cHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">s_0</span><span class="p">]</span>
        <span class="n">Bhist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B_</span>
        <span class="n">μHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vf</span><span class="p">[</span><span class="n">s_0</span><span class="p">](</span><span class="n">xHist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Time 1 onward</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
            <span class="n">s_</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xprime</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">),</span> <span class="n">nf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span>
                <span class="n">x</span><span class="p">),</span> <span class="n">xprimef</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">),</span> <span class="n">Tf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">)</span>

            <span class="n">Τ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Τ</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">u_c</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">Eu_c</span> <span class="o">=</span> <span class="n">π</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:]</span> <span class="o">@</span> <span class="n">u_c</span>

            <span class="n">μHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vf</span><span class="p">[</span><span class="n">s</span><span class="p">](</span><span class="n">xprime</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

            <span class="n">cHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">Bhist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">ΤHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">x</span> <span class="o">/</span> <span class="n">Eu_c</span><span class="p">,</span> <span class="n">Τ</span>
            <span class="n">xHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">THist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">xprime</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cHist</span><span class="p">,</span> <span class="n">nHist</span><span class="p">,</span> <span class="n">Bhist</span><span class="p">,</span> <span class="n">ΤHist</span><span class="p">,</span> <span class="n">THist</span><span class="p">,</span> <span class="n">μHist</span><span class="p">,</span> <span class="n">sHist</span><span class="p">,</span> <span class="n">xHist</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">BellmanEquation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Bellman equation for the continuation of the Lucas-Stokey Problem</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">policies0</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">G</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">)</span>  <span class="c1"># Number of states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxiter</span> <span class="o">=</span> <span class="n">maxiter</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xbar</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">xgrid</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_0</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z0</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xprimef</span> <span class="o">=</span> <span class="n">policies0</span>

        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xgrid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">cf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">),</span>
                                            <span class="n">nf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">),</span>
                                            <span class="n">xprimef</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">find_first_best</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">find_first_best</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the first best allocation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>

        <span class="k">def</span> <span class="nf">res</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find first best&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">S</span><span class="p">:]</span>
        <span class="n">IFB</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span> <span class="o">+</span> \
            <span class="n">Un</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xFB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">IFB</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zFB</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">xFB</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Vf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given continuation value function next period return value function this</span>
<span class="sd">        period return T(V) and optimal policies</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_0</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">PF</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_policies_time1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">PF</span><span class="p">(</span><span class="n">B_</span><span class="p">,</span> <span class="n">s0</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_policies_time0</span><span class="p">(</span><span class="n">B_</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">Vf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PF</span>

    <span class="k">def</span> <span class="nf">get_policies_time1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">,</span> <span class="n">Vf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the optimal policies </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">π</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span>

        <span class="k">def</span> <span class="nf">objf</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xprime</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">:</span><span class="mi">3</span> <span class="o">*</span> <span class="n">S</span><span class="p">]</span>

            <span class="n">Vprime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
                <span class="n">Vprime</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vf</span><span class="p">[</span><span class="n">s</span><span class="p">](</span><span class="n">xprime</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

            <span class="k">return</span> <span class="o">-</span><span class="n">π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">β</span> <span class="o">*</span> <span class="n">Vprime</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">objf_prime</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>

            <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-7</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">objf</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">f0</span><span class="p">)])</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)):</span>
                <span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon</span>
                <span class="n">jac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">objf</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">dx</span><span class="p">)</span> <span class="o">-</span> <span class="n">f0</span><span class="p">)</span><span class="o">/</span><span class="n">epsilon</span>
                <span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">return</span> <span class="n">jac</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">cons</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xprime</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">:</span><span class="mi">3</span> <span class="o">*</span> <span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">S</span><span class="p">:]</span>
            <span class="n">u_c</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">Eu_c</span> <span class="o">=</span> <span class="n">π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="n">u_c</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span>
                <span class="n">x</span> <span class="o">*</span> <span class="n">u_c</span> <span class="o">/</span> <span class="n">Eu_c</span> <span class="o">-</span> <span class="n">u_c</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">β</span> <span class="o">*</span> <span class="n">xprime</span><span class="p">,</span>
                <span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">transfers</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> \
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xbar</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> \
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xbar</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">imode</span><span class="p">,</span> <span class="n">smode</span> <span class="o">=</span> <span class="n">fmin_slsqp</span><span class="p">(</span><span class="n">objf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">],</span>
                                              <span class="n">f_eqcons</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                                              <span class="n">fprime</span><span class="o">=</span><span class="n">objf_prime</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">iprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxiter</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">smode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="o">-</span><span class="n">fx</span><span class="p">,</span> <span class="n">out</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_policies_time0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">Vf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the optimal policies </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span>

        <span class="k">def</span> <span class="nf">objf</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xprime</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">β</span> <span class="o">*</span> <span class="n">Vf</span><span class="p">[</span><span class="n">s0</span><span class="p">](</span><span class="n">xprime</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">cons</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xprime</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">z</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span>
                <span class="o">-</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">B_</span> <span class="o">-</span> <span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">β</span> <span class="o">*</span> <span class="n">xprime</span><span class="p">,</span>
                <span class="p">(</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">)[</span><span class="n">s0</span><span class="p">]])</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">transfers</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbar</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbar</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)]</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">imode</span><span class="p">,</span> <span class="n">smode</span> <span class="o">=</span> <span class="n">fmin_slsqp</span><span class="p">(</span><span class="n">objf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s0</span><span class="p">],</span> <span class="n">f_eqcons</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span>
                                              <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">iprint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">smode</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="o">-</span><span class="n">fx</span><span class="p">,</span> <span class="n">out</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_collapse-20 docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">UnivariateSpline</span>


<span class="k">class</span> <span class="nc">interpolate_wrapper</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">F</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">interpolate_wrapper</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">reshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xvec</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">xvec</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
            <span class="k">return</span> <span class="n">fhat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
            <span class="k">return</span> <span class="n">fhat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">shape</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>


<span class="k">class</span> <span class="nc">interpolator_factory</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">Fs</span><span class="p">):</span>
        <span class="n">shape</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Fs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Fs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Fs</span> <span class="o">=</span> <span class="n">Fs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span>  <span class="c1"># Sort xgrid</span>
        <span class="k">for</span> <span class="n">Fhat</span> <span class="ow">in</span> <span class="n">Fs</span><span class="p">:</span>
            <span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">Fhat</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">interpolate_wrapper</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">F</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">fun_vstack</span><span class="p">(</span><span class="n">fun_list</span><span class="p">):</span>

    <span class="n">Fs</span> <span class="o">=</span> <span class="p">[</span><span class="n">IW</span><span class="o">.</span><span class="n">F</span> <span class="k">for</span> <span class="n">IW</span> <span class="ow">in</span> <span class="n">fun_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">interpolate_wrapper</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Fs</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">fun_hstack</span><span class="p">(</span><span class="n">fun_list</span><span class="p">):</span>

    <span class="n">Fs</span> <span class="o">=</span> <span class="p">[</span><span class="n">IW</span><span class="o">.</span><span class="n">F</span> <span class="k">for</span> <span class="n">IW</span> <span class="ow">in</span> <span class="n">fun_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">interpolate_wrapper</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">Fs</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">simulate_markov</span><span class="p">(</span><span class="n">π</span><span class="p">,</span> <span class="n">s_0</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>

    <span class="n">sHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">sHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_0</span>
    <span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">π</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
        <span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">π</span><span class="p">[</span><span class="n">sHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">sHist</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we show the code that we use to generate a very long simulation starting from initial
government debt equal to <span class="math notranslate nohighlight">\(-.5\)</span>.</p>
<p>Here is a graph of a long simulation of 102000 periods.</p>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μ_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">log_example</span> <span class="o">=</span> <span class="n">CRRAutility</span><span class="p">(</span><span class="n">π</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span>
                          <span class="n">G</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">.3</span><span class="p">]),</span>
                          <span class="n">Θ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="n">log_example</span><span class="o">.</span><span class="n">transfers</span> <span class="o">=</span> <span class="kc">True</span>        <span class="c1"># Government can use transfers</span>
<span class="n">log_sequential</span> <span class="o">=</span> <span class="n">SequentialAllocation</span><span class="p">(</span><span class="n">log_example</span><span class="p">)</span>  <span class="c1"># Solve sequential problem</span>
<span class="n">log_bellman</span> <span class="o">=</span> <span class="n">RecursiveAllocationAMSS</span><span class="p">(</span><span class="n">log_example</span><span class="p">,</span> <span class="n">μ_grid</span><span class="p">,</span>
                                       <span class="n">tol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">tol_diff</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>



<span class="n">T</span> <span class="o">=</span> <span class="mi">102000</span>  <span class="c1"># Set T to 102000 periods</span>

<span class="n">sim_seq_long</span> <span class="o">=</span> <span class="n">log_sequential</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="n">sHist_long</span> <span class="o">=</span> <span class="n">sim_seq_long</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
<span class="n">sim_bel_long</span> <span class="o">=</span> <span class="n">log_bellman</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sHist_long</span><span class="p">)</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Government Debt&#39;</span><span class="p">,</span> <span class="s1">&#39;Tax Rate&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">titles</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sim_seq_long</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">sim_bel_long</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="s1">&#39;-.b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;Complete Markets&#39;</span><span class="p">,</span> <span class="s1">&#39;Incomplete Markets&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/miniconda3/envs/quantecon/lib/python3.11/site-packages/scipy/optimize/_optimize.py:404: RuntimeWarning: Values in x were outside bounds during a minimize step, clipping to bounds
  warnings.warn(&quot;Values in x were outside bounds during a &quot;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_5582/108196118.py:24: RuntimeWarning: divide by zero encountered in reciprocal
  U = (c**(1 - σ) - 1) / (1 - σ)
/tmp/ipykernel_5582/108196118.py:29: RuntimeWarning: divide by zero encountered in power
  return c**(-self.σ)
/tmp/ipykernel_5582/1277371586.py:249: RuntimeWarning: invalid value encountered in divide
  x * u_c / Eu_c - u_c * (c - T) - Un(c, n) * n - β * xprime,
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_5582/1277371586.py:249: RuntimeWarning: invalid value encountered in multiply
  x * u_c / Eu_c - u_c * (c - T) - Un(c, n) * n - β * xprime,
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.038266353387659546
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0015144378246632448
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0013387575049931865
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0011833202400662248
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0010600307116134505
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0009506620324908642
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0008518776517238551
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0007625857031042564
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0006819563061669217
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0006094002927240671
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0005443007356805235
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00048599500343956094
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0004338395935928358
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00038722730865154364
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00034559541217657187
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00030842870645340995
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00027525901875688697
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0002456631291987257
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00021925988533911457
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0001957069581927878
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00017469751641633328
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00015595697131045533
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00013923987965580473
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0001243270476244632
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00011102285954170156
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.915283206080047e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.856139177373994e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.910986485356134e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.067466534026614e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.314566737649043e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.6424746008715835e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.04244714230645e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.5066942129829506e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.028274354582181e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.601001917066026e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.219364287744318e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.878448158073308e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.5738738366349524e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.3017369974638877e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0585562530972924e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.8412273759209572e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.6470096733078585e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4734148603737835e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.3182214255360329e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1794654716176686e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0553942898779478e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.444436197515114e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.452171093491432e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.564681603048501e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.770836606096674e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.060699172057158e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.4253876343226e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.856977544060761e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.348382732427091e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.893276456302588e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.4860028420224977e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.1215110784890745e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.7952840260155024e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.503284254157189e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.241904747465382e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0079209145832687e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.7984472260187192e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.610904141295967e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4429883256895489e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2926354365994746e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1580011940576491e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0374362190402233e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.294651286343194e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.327660623755013e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.461585686381671e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.68586648784756e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.991017296865946e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.368606502407216e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.811037017633464e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.3115434615062044e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.8640500348483447e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.4631274740294855e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.1039146715661056e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.782060642970499e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.493665449692665e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.235241683944158e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0036660045892633e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.796140357496926e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.610161234596195e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4434845857135709e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.29410194199688e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1602140686642469e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.04020962175412e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.326451087350253e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.362279520562034e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.49799979528415e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.723237810210067e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.028699653820159e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.4060588066801066e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.847855517381241e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.347405660607874e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.898720608840536e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.496434157686767e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.135737680533792e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.8123222131646282e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.5223262308472423e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.2622892571432625e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0291098813063476e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.820008555543109e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.6324938418135388e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4643330672610771e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.3135245110419445e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.178274355586975e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0569743803546048e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.48183058751907e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.506079544395937e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.630907318911004e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.845926774203295e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.141826797773109e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.510259068441386e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.943738281315066e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.435554859709816e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.979736766026741e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.5708317622814044e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.2040044801866767e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.874916539533131e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.579680212253616e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.3148068175021918e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.077170148801081e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.8639635474165993e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.6726726276855955e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.5010414936033808e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.3470449992327086e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2088698423920761e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0848882197883804e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.736395405805598e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.738135346705384e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.842367703299733e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.03855297579472e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.317225605423774e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.669925787732949e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.089032105148693e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.5677367318159076e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.0999013116379334e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.680044560697966e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.3032415368561477e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.96506010211222e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.6615516244191936e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.389139399385772e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.144649644252697e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.9252092177853976e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.7282471699749249e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.551454449875162e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.3927730577138407e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2503449048385917e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1224916676355658e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0077318342152794e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.047094182757221e-11
</pre></div>
</div>
<img alt="_images/b23d19a1cc5568359441b01b5d0a0227f0108ceaf4487395ca72fc9fc2cbc8bf.png" src="_images/b23d19a1cc5568359441b01b5d0a0227f0108ceaf4487395ca72fc9fc2cbc8bf.png" />
</div>
</div>
<figure class="align-default">
<img alt="_images/amss3_g1.png" src="_images/amss3_g1.png" />
</figure>
<p>The long simulation apparently  indicates eventual convergence to an ergodic distribution.</p>
<p>It takes about 1000 periods to reach the ergodic distribution – an outcome that is forecast by
approximations to rates of convergence that appear in BEGS <span id="id6">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> and that we discuss in <a class="reference internal" href="amss2.html"><span class="doc">Fluctuating Interest Rates Deliver Fiscal Insurance</span></a>.</p>
<p>Let’s discard the first 2000 observations of the simulation and construct the histogram of
the par value of government debt.</p>
<p>We obtain the following graph for the histogram of the last 100,000 observations on the par value of government debt.</p>
<figure class="align-default">
<img alt="_images/amss3_g3.png" src="_images/amss3_g3.png" />
</figure>
<p>The  black vertical line denotes the sample mean for the last 100,000 observations included in the histogram; the  green vertical line denotes the
value of <span class="math notranslate nohighlight">\(\frac{ {\mathcal B}^*}{E u_c}\)</span>, associated with a sample from our approximation to
the ergodic distribution where <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span> is a regression coefficient to be described below;  the red vertical line denotes an approximation by <span id="id7">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> to the mean of the ergodic
distribution that can be computed <strong>before</strong>  the ergodic distribution has been approximated, as described below.</p>
<p>Before moving on to discuss the histogram and the vertical lines approximating the ergodic  mean of government debt in more detail, the following graphs show
government debt and taxes early in the simulation, for periods 1-100 and 101 to 200
respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Government Debt&#39;</span><span class="p">,</span> <span class="s1">&#39;Tax Rate&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sim_seq_long</span><span class="p">[</span><span class="nb">id</span><span class="p">][:</span><span class="mi">99</span><span class="p">],</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">sim_bel_long</span><span class="p">[</span><span class="nb">id</span><span class="p">][:</span><span class="mi">99</span><span class="p">],</span>
                 <span class="s1">&#39;-.b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">199</span><span class="p">),</span> <span class="n">sim_seq_long</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">100</span><span class="p">:</span><span class="mi">199</span><span class="p">],</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span>
                   <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">199</span><span class="p">),</span> <span class="n">sim_bel_long</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">100</span><span class="p">:</span><span class="mi">199</span><span class="p">],</span> <span class="s1">&#39;-.b&#39;</span><span class="p">,</span>
                   <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;Complete Markets&#39;</span><span class="p">,</span> <span class="s1">&#39;Incomplete Markets&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bbacd129c751049b634b9e382ceaf19b18ce2aff6a9c5f14c478eff80de5d430.png" src="_images/bbacd129c751049b634b9e382ceaf19b18ce2aff6a9c5f14c478eff80de5d430.png" />
</div>
</div>
<figure class="align-default">
<img alt="_images/amss3_g2.png" src="_images/amss3_g2.png" />
</figure>
<p>For the short samples early in our simulated sample of  102,000 observations, fluctuations in government debt and the tax rate
conceal the weak but inexorable force that the Ramsey planner puts into both series driving them toward ergodic marginal distributions that are far from
these early observations</p>
<ul class="simple">
<li><p>early observations are more influenced by the initial value of the par value of government debt than by the ergodic mean of the par value of government debt</p></li>
<li><p>much later observations are more influenced by the ergodic mean and are independent of the par value of initial government debt</p></li>
</ul>
</section>
<section id="asymptotic-mean-and-rate-of-convergence">
<h2><span class="section-number">45.4. </span>Asymptotic Mean and Rate of Convergence<a class="headerlink" href="#asymptotic-mean-and-rate-of-convergence" title="Permalink to this heading">#</a></h2>
<p>We apply the results of BEGS <span id="id8">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> to interpret</p>
<ul class="simple">
<li><p>the mean of the ergodic distribution of government debt</p></li>
<li><p>the rate of convergence  to the ergodic distribution from an arbitrary initial government debt</p></li>
</ul>
<p>We begin by computing  objects required by the theory of section III.i
of BEGS <span id="id9">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span>.</p>
<p>As in <a class="reference internal" href="amss2.html"><span class="doc">Fiscal Insurance via Fluctuating Interest Rates</span></a>, we recall  that  BEGS <span id="id10">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> used a particular
notation to represent what we can regard as their  generalization of an AMSS model.</p>
<p>We introduce some of the  <span id="id11">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> notation so that readers can quickly relate notation that appears in key BEGS formulas to the notation
that we have used in previous lectures <a class="reference internal" href="amss.html"><span class="doc">here</span></a> and <a class="reference internal" href="amss2.html"><span class="doc">here</span></a>.</p>
<p>BEGS work with objects <span class="math notranslate nohighlight">\(B_t, {\mathcal B}_t, {\mathcal R}_t, {\mathcal X}_t\)</span> that are related to  notation that we used in
earlier lectures by</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
{\mathcal R}_t &amp; = \frac{u_{c,t}}{u_{c,t-1}} R_{t-1}  = \frac{u_{c,t}}{ \beta E_{t-1} u_{c,t}} \\
B_t &amp; = \frac{b_{t+1}(s^t)}{R_t(s^t)} \\
b_t(s^{t-1}) &amp; = {\mathcal R}_{t-1} B_{t-1} \\
{\mathcal B}_t &amp; = u_{c,t} B_t = (\beta E_t u_{c,t+1}) b_{t+1}(s^t) \\
{\mathcal X}_t &amp; = u_{c,t} [g_t - \tau_t n_t]
\end{aligned}
\end{split}\]</div>
<p>BEGS <span id="id12">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> call <span class="math notranslate nohighlight">\({\mathcal X}_t\)</span> the <strong>effective</strong> government deficit and <span class="math notranslate nohighlight">\({\mathcal B}_t\)</span> the <strong>effective</strong> government debt.</p>
<p>Equation (44) of <span id="id13">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> expresses the time <span class="math notranslate nohighlight">\(t\)</span> state <span class="math notranslate nohighlight">\(s\)</span> government budget constraint as</p>
<div class="math notranslate nohighlight" id="equation-eq-fiscal-risk-1">
<span class="eqno">(45.1)<a class="headerlink" href="#equation-eq-fiscal-risk-1" title="Permalink to this equation">#</a></span>\[{\mathcal B}(s) = {\mathcal R}_\tau(s, s_{-}) {\mathcal B}_{-} + {\mathcal X}_{\tau} (s)\]</div>
<p>where the dependence on <span class="math notranslate nohighlight">\(\tau\)</span> is meant to remind us that these objects depend on the tax rate;  <span class="math notranslate nohighlight">\(s_{-}\)</span> is last period’s Markov state.</p>
<p>BEGS interpret random variations in the right side of <a class="reference internal" href="#equation-eq-fiscal-risk-1">(45.1)</a>  as <strong>fiscal risks</strong> generated by</p>
<ul class="simple">
<li><p>interest-rate-driven fluctuations in time <span class="math notranslate nohighlight">\(t\)</span> effective payments due on the government portfolio, namely,
<span class="math notranslate nohighlight">\({\mathcal R}_\tau(s, s_{-}) {\mathcal B}_{-}\)</span>,  and</p></li>
<li><p>fluctuations in the effective government deficit <span class="math notranslate nohighlight">\({\mathcal X}_t\)</span></p></li>
</ul>
<section id="asymptotic-mean">
<h3><span class="section-number">45.4.1. </span>Asymptotic Mean<a class="headerlink" href="#asymptotic-mean" title="Permalink to this heading">#</a></h3>
<p>BEGS give conditions under which the ergodic mean of <span class="math notranslate nohighlight">\({\mathcal B}_t\)</span> is approximated by</p>
<div class="math notranslate nohighlight" id="equation-prelim-formula-1">
<span class="eqno">(45.2)<a class="headerlink" href="#equation-prelim-formula-1" title="Permalink to this equation">#</a></span>\[{\mathcal B}^* = - \frac{\rm cov^{\infty}({\mathcal R}_t, {\mathcal X_t})}{\rm var^{\infty}({\mathcal R}_t)}\]</div>
<p>where the superscript <span class="math notranslate nohighlight">\(\infty\)</span> denotes a moment taken with respect to an ergodic distribution.</p>
<p>Formula <a class="reference internal" href="#equation-prelim-formula-1">(45.2)</a> represents <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span> as a regression coefficient of <span class="math notranslate nohighlight">\({\mathcal X}_t\)</span> on <span class="math notranslate nohighlight">\({\mathcal R}_t\)</span> in the ergodic
distribution.</p>
<p>Regression coefficient <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span> solves  a variance-minimization problem:</p>
<div class="math notranslate nohighlight" id="equation-eq-criterion-fiscal-1">
<span class="eqno">(45.3)<a class="headerlink" href="#equation-eq-criterion-fiscal-1" title="Permalink to this equation">#</a></span>\[{\mathcal B}^* = {\rm argmin}_{\mathcal B}  {\rm var}^\infty ({\mathcal R} {\mathcal B} + {\mathcal X})\]</div>
<p>The minimand in criterion <a class="reference internal" href="#equation-eq-criterion-fiscal-1">(45.3)</a>  measures  <strong>fiscal risk</strong> associated with a given tax-debt policy that appears on the right side
of equation <a class="reference internal" href="#equation-eq-fiscal-risk-1">(45.1)</a>.</p>
<p>Expressing formula <a class="reference internal" href="#equation-prelim-formula-1">(45.2)</a> in terms of  our notation tells us that the ergodic mean of the par value <span class="math notranslate nohighlight">\(b\)</span> of government debt in the
AMSS model should be approximately</p>
<div class="math notranslate nohighlight" id="equation-key-formula-1">
<span class="eqno">(45.4)<a class="headerlink" href="#equation-key-formula-1" title="Permalink to this equation">#</a></span>\[\hat b = \frac{\mathcal B^*}{\beta E( E_t u_{c,t+1})} = \frac{\mathcal B^*}{\beta E( u_{c,t+1} )}\]</div>
<p>where mathematical expectations are taken with respect to the ergodic distribution.</p>
</section>
<section id="rate-of-convergence">
<h3><span class="section-number">45.4.2. </span>Rate of Convergence<a class="headerlink" href="#rate-of-convergence" title="Permalink to this heading">#</a></h3>
<p>BEGS also derive the following  approximation to the rate of convergence to <span class="math notranslate nohighlight">\({\mathcal B}^{*}\)</span> from an arbitrary initial condition.</p>
<blockquote>
<div><div class="math notranslate nohighlight" id="equation-rate-of-convergence-1">
<span class="eqno">(45.5)<a class="headerlink" href="#equation-rate-of-convergence-1" title="Permalink to this equation">#</a></span>\[\frac{ E_t  ( {\mathcal B}_{t+1} - {\mathcal B}^{*} )} { ( {\mathcal B}_{t} - {\mathcal B}^{*} )} \approx \frac{1}{1 + \beta^2 {\rm var}^\infty ({\mathcal R} )}\]</div>
</div></blockquote>
<p>(See the equation above equation (47) in BEGS <span id="id14">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span>)</p>
</section>
<section id="more-advanced-topic">
<h3><span class="section-number">45.4.3. </span>More Advanced Topic<a class="headerlink" href="#more-advanced-topic" title="Permalink to this heading">#</a></h3>
<p>The remainder of this lecture is about  technical material based on  formulas from BEGS <span id="id15">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span>.</p>
<p>The topic involves interpreting  and extending formula <a class="reference internal" href="#equation-eq-criterion-fiscal-1">(45.3)</a> for the ergodic mean <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span>.</p>
</section>
<section id="chicken-and-egg">
<h3><span class="section-number">45.4.4. </span>Chicken and Egg<a class="headerlink" href="#chicken-and-egg" title="Permalink to this heading">#</a></h3>
<p>Notice how attributes of the ergodic distribution for <span class="math notranslate nohighlight">\({\mathcal B}_t\)</span>  appear
on the right side of  formula <a class="reference internal" href="#equation-eq-criterion-fiscal-1">(45.3)</a> for approximating  the ergodic mean via <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span>.</p>
<p>Therefor,  formula  <a class="reference internal" href="#equation-eq-criterion-fiscal-1">(45.3)</a> is not useful for estimating  the mean of the ergodic <strong>in advance</strong> of actually approximating the ergodic distribution.</p>
<ul class="simple">
<li><p>we need to know the  ergodic distribution to compute the right side of formula <a class="reference internal" href="#equation-eq-criterion-fiscal-1">(45.3)</a></p></li>
</ul>
<p>So the primary use of equation <a class="reference internal" href="#equation-eq-criterion-fiscal-1">(45.3)</a> is how  it  <strong>confirms</strong> that
the ergodic distribution solves a <strong>fiscal-risk minimization problem</strong>.</p>
<p>As an example, notice how we used the formula for the mean of <span class="math notranslate nohighlight">\({\mathcal B}\)</span> in the ergodic distribution of the special AMSS economy in
<a class="reference internal" href="amss2.html"><span class="doc">Fiscal Insurance via Fluctuating Interest Rates</span></a></p>
<ul class="simple">
<li><p><strong>first</strong> we computed the ergodic distribution using a reverse-engineering construction</p></li>
<li><p><strong>then</strong> we verified that <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span>  agrees with the mean of that distribution</p></li>
</ul>
</section>
<section id="approximating-the-ergodic-mean">
<h3><span class="section-number">45.4.5. </span>Approximating the Ergodic Mean<a class="headerlink" href="#approximating-the-ergodic-mean" title="Permalink to this heading">#</a></h3>
<p>BEGS also <span id="id16">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> propose  an approximation to  <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span> that can be computed <strong>without</strong> first approximating  the
ergodic distribution.</p>
<p>To  construct the BEGS  approximation to <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span>, we just follow steps set forth on pages 648 - 650 of section III.D of
<span id="id17">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span></p>
<ul class="simple">
<li><p>notation in BEGS might be confusing at first sight, so
it is important to stare and digest before computing</p></li>
<li><p>there are also some sign errors in the <span id="id18">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> text that we’ll want
to correct here</p></li>
</ul>
<p>Here is a step-by-step description of the BEGS <span id="id19">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> approximation procedure.</p>
</section>
<section id="step-by-step">
<h3><span class="section-number">45.4.6. </span>Step by Step<a class="headerlink" href="#step-by-step" title="Permalink to this heading">#</a></h3>
<p><strong>Step 1:</strong> For a given <span class="math notranslate nohighlight">\(\tau\)</span> we  compute a vector of
values <span class="math notranslate nohighlight">\(c_\tau(s), s= 1, 2, \ldots, S\)</span> that satisfy</p>
<div class="math notranslate nohighlight">
\[
(1-\tau) c_\tau(s)^{-\sigma} - (c_{\tau}(s) + g(s))^{\gamma} = 0
\]</div>
<p>This is a nonlinear equation to be solved for
<span class="math notranslate nohighlight">\(c_{\tau}(s), s = 1, \ldots, S\)</span>.</p>
<p><span class="math notranslate nohighlight">\(S=3\)</span> in our case, but we’ll write code for a general integer
<span class="math notranslate nohighlight">\(S\)</span>.</p>
<p><strong>Typo alert:</strong> Please note that there is a sign error in equation (42)
of BEGS <span id="id20">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> – it should be a <strong>minus</strong> rather than a <strong>plus</strong> in the middle.</p>
<ul class="simple">
<li><p>We have made the appropriate correction in the above equation.</p></li>
</ul>
<p><strong>Step 2:</strong> Knowing <span class="math notranslate nohighlight">\(c_\tau(s), s=1, \ldots, S\)</span> for a given
<span class="math notranslate nohighlight">\(\tau\)</span>, we want to compute the random variables</p>
<div class="math notranslate nohighlight">
\[
{\mathcal  R}_\tau(s) = \frac{c_\tau(s)^{-\sigma}}{\beta \sum_{s'=1}^S c_\tau(s')^{-\sigma} \pi(s')}
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
{\mathcal X}_\tau(s) = (c_\tau(s) + g(s))^{1+ \gamma} - c_\tau(s)^{1-\sigma}
\]</div>
<p>each for <span class="math notranslate nohighlight">\(s= 1, \ldots, S\)</span>.</p>
<p>BEGS call <span class="math notranslate nohighlight">\({\mathcal  R}_\tau(s)\)</span>
the <strong>effective return</strong> on risk-free debt and they call
<span class="math notranslate nohighlight">\({\mathcal X}_\tau(s)\)</span> the <strong>effective government deficit</strong>.</p>
<p><strong>Step 3:</strong> With the preceding objects in hand, for a given
<span class="math notranslate nohighlight">\({\mathcal B}\)</span>, we seek a <span class="math notranslate nohighlight">\(\tau\)</span> that satisfies</p>
<div class="math notranslate nohighlight">
\[
{\mathcal B} = - \frac{\beta} {1-\beta} E {\mathcal X_\tau} \equiv - \frac{\beta} {1-\beta} \sum_{s} {\mathcal X}_\tau(s) \pi(s)
\]</div>
<p>This equation says that at a constant discount factor <span class="math notranslate nohighlight">\(\beta\)</span>,  equivalent government debt <span class="math notranslate nohighlight">\({\mathcal B}\)</span> equals the
present value of the mean effective government <strong>surplus</strong>.</p>
<p><strong>Another typo alert</strong>: there is a sign error in equation (46) of BEGS <span id="id21">[<a class="reference internal" href="zreferences.html#id228" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> –the left
side should be multiplied by <span class="math notranslate nohighlight">\(-1\)</span>.</p>
<ul class="simple">
<li><p>We have made this correction in the above equation.</p></li>
</ul>
<p>For a given <span class="math notranslate nohighlight">\({\mathcal B}\)</span>, let a <span class="math notranslate nohighlight">\(\tau\)</span> that solves the
above equation be called <span class="math notranslate nohighlight">\(\tau(\mathcal B)\)</span>.</p>
<p>We’ll use a Python root solver to find a <span class="math notranslate nohighlight">\(\tau\)</span> that solves this
equation for a given <span class="math notranslate nohighlight">\({\mathcal B}\)</span>.</p>
<p>We’ll use this function to induce a function <span class="math notranslate nohighlight">\(\tau({\mathcal B})\)</span>.</p>
<p><strong>Step 4:</strong> With a Python program that computes
<span class="math notranslate nohighlight">\(\tau(\mathcal B)\)</span> in hand, next we write a Python function to
compute the random variable.</p>
<div class="math notranslate nohighlight">
\[
J({\mathcal B})(s) =  \mathcal R_{\tau({\mathcal B})}(s) {\mathcal B} + {\mathcal X}_{\tau({\mathcal B})}(s) ,  \quad s = 1, \ldots, S
\]</div>
<p><strong>Step 5:</strong> Now that we have a way to compute the random variable
<span class="math notranslate nohighlight">\(J({\mathcal B})(s), s= 1, \ldots, S\)</span>, via  a composition of  Python
functions, we can use the population variance  function that we
defined in the code above to construct a function
<span class="math notranslate nohighlight">\({\rm var}(J({\mathcal B}))\)</span>.</p>
<p>We put <span class="math notranslate nohighlight">\({\rm var}(J({\mathcal B}))\)</span> into a Python function minimizer and
compute</p>
<div class="math notranslate nohighlight">
\[
{\mathcal B}^* = {\rm argmin}_{\mathcal B} {\rm var } (J({\mathcal B}) )
\]</div>
<p><strong>Step 6:</strong> Next we take the minimizer <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span> and the
Python functions for computing means and variances and compute</p>
<div class="math notranslate nohighlight">
\[
{\rm rate} = \frac{1}{1 + \beta^2 {\rm var}( {\mathcal R}_{\tau({\mathcal B}^*)} )}
\]</div>
<p>Ultimate outputs of this string of calculations are two scalars</p>
<div class="math notranslate nohighlight">
\[
({\mathcal B}^*, {\rm rate} )
\]</div>
<p><strong>Step 7:</strong> Compute the divisor</p>
<div class="math notranslate nohighlight">
\[
div = {\beta E u_{c,t+1}}
\]</div>
<p>and then compute the mean of the par value of government debt in the AMSS model</p>
<div class="math notranslate nohighlight">
\[
\hat b = \frac{ {\mathcal B}^*}{div}
\]</div>
<p>In the two-Markov-state AMSS economy in <a class="reference internal" href="amss2.html"><span class="doc">Fiscal Insurance via Fluctuating Interest Rates</span></a>,
<span class="math notranslate nohighlight">\(E_t u_{c,t+1} = E u_{c,t+1}\)</span> in the ergodic distribution.</p>
<p>We  have confirmed that
this formula very accurately describes a <strong>constant</strong> par value of government debt that</p>
<ul class="simple">
<li><p>supports full fiscal insurance via fluctuating interest parameters, and</p></li>
<li><p>is the limit of government debt as <span class="math notranslate nohighlight">\(t \rightarrow +\infty\)</span></p></li>
</ul>
<p>In the three-Markov-state economy of this lecture, the par value of government debt fluctuates in a history-dependent way even asymptotically.</p>
<p>In this economy, <span class="math notranslate nohighlight">\(\hat b\)</span> given by the above formula approximates the mean of the ergodic distribution of  the par value of  government debt</p>
<dl class="simple myst">
<dt>so while the approximation circumvents the chicken and egg problem that  surrounds</dt><dd><p>the much better approximation associated with the green vertical line, it does so by enlarging the approximation error</p>
</dd>
</dl>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\hat b\)</span> is represented by the red vertical line plotted in the histogram of the last 100,000 observations of our simulation of the  par value of government debt plotted above</p></li>
<li><p>the approximation is fairly accurate but not perfect</p></li>
</ul>
</section>
<section id="execution">
<h3><span class="section-number">45.4.7. </span>Execution<a class="headerlink" href="#execution" title="Permalink to this heading">#</a></h3>
<p>Now let’s move on to compute things step by step.</p>
<section id="step-1">
<h4><span class="section-number">45.4.7.1. </span>Step 1<a class="headerlink" href="#step-1" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">CRRAutility</span><span class="p">(</span><span class="n">π</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span>
                <span class="n">G</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">.3</span><span class="p">]),</span>
                <span class="n">Θ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="n">τ</span> <span class="o">=</span> <span class="mf">0.05</span>           <span class="c1"># Initial guess of τ (to displays calcs along the way)</span>
<span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">G</span><span class="p">)</span>       <span class="c1"># Number of states</span>

<span class="k">def</span> <span class="nf">solve_c</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">τ</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">τ</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="o">.</span><span class="n">σ</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">G</span><span class="p">)</span><span class="o">**</span><span class="n">u</span><span class="o">.</span><span class="n">γ</span>

<span class="c1"># .x returns the result from root</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">solve_c</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">τ</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span><span class="o">.</span><span class="n">x</span>
<span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.93852387, 0.89231015, 0.84858872])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="p">(</span><span class="n">solve_c</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">τ</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> message: The solution converged.
 success: True
  status: 1
     fun: [ 5.618e-10 -4.769e-10  1.175e-11]
       x: [ 9.385e-01  8.923e-01  8.486e-01]
    nfev: 11
    fjac: [[-9.999e-01 -4.954e-03 -1.261e-02]
           [-5.156e-03  9.999e-01  1.610e-02]
           [-1.253e-02 -1.616e-02  9.998e-01]]
       r: [ 4.269e+00  8.685e-02 -6.301e-02 -4.713e+00 -7.433e-02
           -5.508e+00]
     qtf: [ 1.556e-08  1.283e-08  7.899e-11]
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-2">
<h4><span class="section-number">45.4.7.2. </span>Step 2<a class="headerlink" href="#step-2" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">G</span>   <span class="c1"># Compute labor supply</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="note-about-code">
<h3><span class="section-number">45.4.8. </span>Note about Code<a class="headerlink" href="#note-about-code" title="Permalink to this heading">#</a></h3>
<p>Remember that in our code <span class="math notranslate nohighlight">\(\pi\)</span> is a <span class="math notranslate nohighlight">\(3 \times 3\)</span> transition
matrix.</p>
<p>But because we are studying an IID case, <span class="math notranslate nohighlight">\(\pi\)</span> has identical
rows and we need only  to compute objects for one row of <span class="math notranslate nohighlight">\(\pi\)</span>.</p>
<p>This explains why at some places below we set <span class="math notranslate nohighlight">\(s=0\)</span> just to pick
off the first row of <span class="math notranslate nohighlight">\(\pi\)</span>.</p>
</section>
<section id="running-the-code">
<h3><span class="section-number">45.4.9. </span>Running the code<a class="headerlink" href="#running-the-code" title="Permalink to this heading">#</a></h3>
<p>Let’s take the code out for a spin.</p>
<p>First, let’s compute <span class="math notranslate nohighlight">\({\mathcal R}\)</span> and <span class="math notranslate nohighlight">\({\mathcal X}\)</span>
according to our formulas</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_R_X</span><span class="p">(</span><span class="n">τ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">solve_c</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">τ</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span><span class="o">.</span><span class="n">x</span>  <span class="c1"># Solve for vector of c&#39;s</span>
    <span class="n">div</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  \
                 <span class="o">+</span>  <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> \
                 <span class="o">+</span>  <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="o">.</span><span class="n">σ</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">div</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">G</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">γ</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">u</span><span class="o">.</span><span class="n">σ</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">X</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="o">.</span><span class="n">σ</span><span class="p">)</span> <span class="o">@</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.25997521, 1.25997521, 1.25997521])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span><span class="o">.</span><span class="n">π</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.33333333, 0.33333333, 0.33333333],
       [0.33333333, 0.33333333, 0.33333333],
       [0.33333333, 0.33333333, 0.33333333]])
</pre></div>
</div>
</div>
</div>
<p>We only want unconditional expectations because we are in an IID case.</p>
<p>So we’ll set <span class="math notranslate nohighlight">\(s=0\)</span> and just pick off expectations associated with
the first row of <span class="math notranslate nohighlight">\(\pi\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">R</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">compute_R_X</span><span class="p">(</span><span class="n">τ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s look at the random variables <span class="math notranslate nohighlight">\({\mathcal R}, {\mathcal X}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">R</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.00116313, 1.10755123, 1.22461897])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1111111111111112
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.05457803, 0.18259396, 0.33685546])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.19134248445303795
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">@</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.19134248, 0.19134248, 0.19134248])
</pre></div>
</div>
</div>
</div>
<section id="step-3">
<h4><span class="section-number">45.4.9.1. </span>Step 3<a class="headerlink" href="#step-3" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">solve_τ</span><span class="p">(</span><span class="n">τ</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">R</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">compute_R_X</span><span class="p">(</span><span class="n">τ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">u</span><span class="o">.</span><span class="n">β</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">β</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span> <span class="o">-</span> <span class="n">X</span> <span class="o">@</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Note that <span class="math notranslate nohighlight">\(B\)</span> is a scalar.</p>
<p>Let’s try out our method computing <span class="math notranslate nohighlight">\(\tau\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">B</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">τ</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">solve_τ</span><span class="p">,</span> <span class="mf">.1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Very sensitive to initial value</span>
<span class="n">τ</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.2740159773695818
</pre></div>
</div>
</div>
</div>
<p>In the above cell, B is fixed at 1 and <span class="math notranslate nohighlight">\(\tau\)</span> is to be computed as
a function of B.</p>
<p>Note that 0.2 is the initial value for <span class="math notranslate nohighlight">\(\tau\)</span> in the root-finding
algorithm.</p>
</section>
<section id="step-4">
<h4><span class="section-number">45.4.9.2. </span>Step 4<a class="headerlink" href="#step-4" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">min_J</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="c1"># Very sensitive to initial value of τ</span>
    <span class="n">τ</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">solve_τ</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">R</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">compute_R_X</span><span class="p">(</span><span class="n">τ</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">variance</span><span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">B</span> <span class="o">+</span> <span class="n">X</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_J</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.035564405653720765
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-6">
<h4><span class="section-number">45.4.9.3. </span>Step 6<a class="headerlink" href="#step-6" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">B_star</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">min_J</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">B_star</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.199483167941158
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">G</span>  <span class="c1"># Compute labor supply</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">div</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  \
             <span class="o">+</span>  <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> \
             <span class="o">+</span>  <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">B_hat</span> <span class="o">=</span> <span class="n">B_star</span><span class="o">/</span><span class="n">div</span>
<span class="n">B_hat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.0577661126390971
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">τ_star</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">solve_τ</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">B_star</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">τ_star</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.09572916798461703
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">R_star</span><span class="p">,</span> <span class="n">X_star</span> <span class="o">=</span> <span class="n">compute_R_X</span><span class="p">(</span><span class="n">τ_star</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="n">R_star</span><span class="p">,</span> <span class="n">X_star</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0.9998398 , 1.10746593, 1.2260276 ]),
 array([0.0020272 , 0.12464752, 0.27315299]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rate</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">β</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">variance</span><span class="p">(</span><span class="n">R_star</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
<span class="n">rate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9931353432732218
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="p">(</span><span class="n">solve_c</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">τ_star</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.9264382 , 0.88027117, 0.83662635])
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                    </div>
                    
                </main> <!-- .page__content -->
                


                <footer class="qe-page__footer">

                    <p><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"></a></p>

                    <p>Creative Commons License &ndash; This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International.</p>

                </footer> <!-- .page__footer -->

            </div> <!-- .page -->

            

            
            <div class="qe-sidebar bd-sidebar inactive" id="site-navigation">

                <div class="qe-sidebar__header">


                    Contents

                </div>

                <nav class="qe-sidebar__nav" id="qe-sidebar-nav" aria-label="Main navigation">
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tools and Techniques
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="orth_proj.html">
   1. Orthogonal Projections and Their Applications
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="stationary_densities.html">
   2. Continuous State Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="muth_kalman.html">
   3. Reverse Engineering a la Muth
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="discrete_dp.html">
   4. Discrete State Dynamic Programming
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  LQ Control
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="cons_news.html">
   5. Information and Consumption Smoothing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="smoothing.html">
   6. Consumption Smoothing with Complete and Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="smoothing_tax.html">
   7. Tax Smoothing with Complete and Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="markov_jump_lq.html">
   8. Markov Jump Linear Quadratic Dynamic Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_1.html">
   9. How to Pay for a War: Part 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_2.html">
   10. How to Pay for a War: Part 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_3.html">
   11. How to Pay for a War: Part 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lqramsey.html">
   12. Optimal Taxation in an LQ Economy
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Multiple Agent Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="arellano.html">
   13. Default Risk and Income Fluctuations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="matsuyama.html">
   14. Globalization and Cycles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coase.html">
   15. Coase’s Theory of the Firm
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dynamic Linear Economies
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="hs_recursive_models.html">
   16. Recursive Models of Dynamic Linear Economies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="growth_in_dles.html">
   17. Growth in Dynamic Linear Economies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lucas_asset_pricing_dles.html">
   18. Lucas Asset Pricing Using DLE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="irfs_in_hall_model.html">
   19. IRFs in Hall Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="permanent_income_dles.html">
   20. Permanent Income Model using the DLE Class
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rosen_schooling_model.html">
   21. Rosen Schooling Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cattle_cycles.html">
   22. Cattle Cycles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hs_invertibility_example.html">
   23. Shock Non Invertibility
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Risk, Model Uncertainty, and Robustness
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="five_preferences.html">
   24. Risk and Model Uncertainty
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="entropy.html">
   25. Etymology of Entropy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="robustness.html">
   26. Robustness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rob_markov_perf.html">
   27. Robust Markov Perfect Equilibrium
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Time Series Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="arma.html">
   28. Covariance Stationary Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="estspec.html">
   29. Estimation of Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="additive_functionals.html">
   30. Additive and Multiplicative Functionals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lu_tricks.html">
   31. Classical Control with Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="classical_filtering.html">
   32. Classical Prediction and Filtering With Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="knowing_forecasts_of_others.html">
   33. Knowing the Forecasts of Others
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Asset Pricing and Finance
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="lucas_model.html">
   34. Asset Pricing II: The Lucas Asset Pricing Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="asset_pricing_lph.html">
   35. Elementary Asset Pricing Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="black_litterman.html">
   36. Two Modifications of Mean-Variance Portfolio Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="BCG_complete_mkts.html">
   37. Irrelevance of Capital Structures with Complete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="BCG_incomplete_mkts.html">
   38. Equilibrium Capital Structures with Incomplete Markets
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dynamic Programming Squared
 </span>
</p>
<ul class="current nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="un_insure.html">
   39. Optimal Unemployment Insurance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dyn_stack.html">
   40. Stackelberg Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="calvo.html">
   41. Ramsey Plans, Time Inconsistency, Sustainable Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="opt_tax_recur.html">
   42. Optimal Taxation with State-Contingent Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="amss.html">
   43. Optimal Taxation without State-Contingent Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="amss2.html">
   44. Fluctuating Interest Rates Deliver Fiscal Insurance
  </a>
 </li>
 <li class="toctree-l1 current active active">
  <a class="current reference internal" href="#">
   45. Fiscal Risk and Government Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chang_ramsey.html">
   46. Competitive Equilibria of a Model of Chang
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chang_credible.html">
   47. Credible Government Policies in a Model of Chang
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="troubleshooting.html">
   48. Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="zreferences.html">
   49. References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="status.html">
   50. Execution Statistics
  </a>
 </li>
</ul>

                </nav>

                <div class="qe-sidebar__footer">

                </div>

            </div> <!-- .sidebar -->
            
        </div> <!-- .main -->

        <div class="qe-toolbar">

            <div class="qe-toolbar__inner">

                <ul class="qe-toolbar__main">
                    <li data-tippy-content="Table of Contents" class="btn__sidebar"><i data-feather="menu"></i></li>
                    <li data-tippy-content="Home"><a href="intro.html"><i data-feather="home"></i></a></li>
                    <li class="btn__qelogo"><a href="https://quantecon.org" title=""><span class="show-for-sr">QuantEcon</span></a></li>
                </ul>

                <ul class="qe-toolbar__links">
                    <li class="btn__search">
                        <form action="search.html" method="get">
                            <input type="search" class="form-control" name="q" id="search-input" placeholder="Search..." aria-label="Search..." autocomplete="off" accesskey="k">
                            <i data-feather="search" id="search-icon"></i>
                        </form>
                    </li>
                    <li data-tippy-content="Fullscreen" class="btn__fullscreen"><i data-feather="maximize"></i></li>
                    <li data-tippy-content="Increase font size" class="btn__plus"><i data-feather="plus-circle"></i></li>
                    <li data-tippy-content="Decrease font size" class="btn__minus"><i data-feather="minus-circle"></i></li>
                    <li data-tippy-content="Change contrast" class="btn__contrast"><i data-feather="sunset"></i></li>
                    <li data-tippy-content="Download Notebook"><a href="/_notebooks/amss3.ipynb" download><i data-feather="download-cloud"></i></a></li>
                    <li class="settings-button" id="settingsButton"><div data-tippy-content="Launch Notebook"><i data-feather="play-circle"></i></div></li>
                        <li class="download-pdf" id="downloadButton"><i data-feather="file"></i></li>
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-python-advanced.myst/blob/main/lectures/amss3.md" download><i data-feather="github"></i></a></li>
                </ul>

            </div>

        </div> <!-- .toolbar -->
        <div id="downloadPDFModal" style="display: none;">
            <ul class="pdf-options" style="display: block;">
                <li class="download-pdf-book" onClick="window.print()">
                    <p>Lecture (PDF)</p>
                </li>
                <li class="download-pdf-file">
                    <a href="/_pdf/quantecon-python-advanced.pdf" download><p>Book (PDF)</p></a>
                </li>
            </ul>
        </div>
        <div id="settingsModal" style="display: none;">
            <p class="modal-title"> Notebook Launcher </p>
            <div class="modal-desc">
            <p>
                Choose public or private cloud service for "Launch" button.
            </p>
            </div>
            <p class="modal-subtitle">Select a server</p>
            <ul class="modal-servers">
            <li class="active launcher-public">
                <span class="label">Public</span>
                <select id="launcher-public-input">
                
                    <option value="https://colab.research.google.com/github/QuantEcon/lecture-python-advanced.notebooks/blob/master/amss3.ipynb">Colab</option>
                
                </select>
                <i class="fas fa-check-circle"></i>
            </li>
            <li class="launcher-private">
                <span class="label">Private</span>
                <input type="text" id="launcher-private-input" data-repourl="https://github.com/QuantEcon/lecture-python-advanced.notebooks" data-urlpath="tree/lecture-python-advanced.notebooks/amss3.ipynb" data-branch=master>
                <i class="fas fa-check-circle"></i>
            </li>
            </ul>
            <p class="launch"><a href="https://colab.research.google.com/github/QuantEcon/lecture-python-advanced.notebooks/blob/master/amss3.ipynb" id="advancedLaunchButton" target="_blank">Launch Notebook</a></p>
            <script>
                // QuantEcon Notebook Launcher
                const launcherTypeElements = document.querySelectorAll('#settingsModal .modal-servers li');
                // Highlight the server type if previous selection exists
                if (typeof localStorage.launcherType !== 'undefined') {
                  for (var i = 0; i < launcherTypeElements.length; i++) {
                    launcherTypeElements[i].classList.remove('active');
                    if ( launcherTypeElements[i].classList.contains(localStorage.launcherType) ) {
                      launcherTypeElements[i].classList.add('active');
                    }
                  }
                }
                // Highlight server type on click and set local storage value
                for (var i = 0; i < launcherTypeElements.length; i++) {
                  launcherTypeElements[i].addEventListener('click', function() {
                    for (var j = 0; j < launcherTypeElements.length; j++) {
                      launcherTypeElements[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    if ( this.classList.contains('launcher-private') ) {
                      localStorage.launcherType = 'launcher-private';
                    } else if ( this.classList.contains('launcher-public') ) {
                      localStorage.launcherType = 'launcher-public';
                    }
                    setLaunchServer();
                  })
                }
                const launcherPublic = document.getElementById('launcher-public-input');
                const launcherPrivate = document.getElementById('launcher-private-input');
                const pageName = "amss3";
                const repoURL = "https://github.com/QuantEcon/lecture-python-advanced.notebooks";
                const urlPath = "tree/lecture-python-advanced.notebooks/amss3.ipynb";
                const branch = "master"
                const launchNotebookLink = document.getElementById('advancedLaunchButton');

                // Highlight public server option if previous selection exists
                if (typeof localStorage.launcherPublic !== 'undefined') {
                  launcherPublic.value = localStorage.launcherPublic;
                }
                // Update local storage upon public server selection
                launcherPublic.addEventListener('change', (event) => {
                  setLaunchServer();
                });
                // Populate private server input if previous entry exists
                if (typeof localStorage.launcherPrivate !== 'undefined') {
                  launcherPrivate.value = localStorage.launcherPrivate;
                }
                // Update local storage when a private server is entered
                launcherPrivate.addEventListener('input', (event) => {
                  setLaunchServer();
                });

                // Function to update the "Launch Notebook" link href
                function setLaunchServer() {
                  launchNotebookLink.removeAttribute("style")
                  if ( localStorage.launcherType == 'launcher-private' ) {
                    let repoPrefix = "/jupyter/hub/user-redirect/git-pull?repo=" + repoURL + "&branch=" + branch + "&urlpath=" + urlPath;
                    launcherPrivateValue = launcherPrivate.value
                    if (!launcherPrivateValue) {
                        launchNotebookLink.removeAttribute("href")
                        launchNotebookLink.style.background = "grey"
                        return
                    }
                    localStorage.launcherPrivate = launcherPrivateValue;
                    privateServer = localStorage.launcherPrivate.replace(/\/$/, "")
                    if (!privateServer.includes("http")) {
                        privateServer = "http://" + privateServer
                    }
                    launchNotebookLinkURL = privateServer + repoPrefix;
                  } else if ( localStorage.launcherType == 'launcher-public' ) {
                    launcherPublicValue = launcherPublic.options[launcherPublic.selectedIndex].value;
                    localStorage.launcherPublic = launcherPublicValue;
                    launchNotebookLinkURL = localStorage.launcherPublic;
                  }
                  if (launchNotebookLinkURL) launchNotebookLink.href = launchNotebookLinkURL;
                }
                // Check if user has previously selected a server
                if ( (typeof localStorage.launcherPrivate !== 'undefined') || (typeof localStorage.launcherPublic !== 'undefined') ) {
                  setLaunchServer();
                }
                </script>

        </div>

    </div> <!-- .wrapper-->
  </body>
</html>