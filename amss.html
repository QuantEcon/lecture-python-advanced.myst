
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>46. Optimal Taxation without State-Contingent Debt &#8212; Advanced Quantitative Economics with Python</title>
    
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.js" integrity="sha384-bq5PNg/ZcfW7KMvFSmhjqCQJ/VFnec+6sZkctn/4ZLeubkn7U58Le4zFFSn3dhUu" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js" integrity="sha384-qEqAs1VsN9WH2myXDbiP2wGGIttL9bMRZBKCl54ZnzpDlVqbYANP9vMaoT/wvQcf" crossorigin="anonymous"></script>
    
        <script>
            MathJax = {
            loader: {load: ['[tex]/boldsymbol', '[tex]/textmacros']},
            tex: {
                packages: {'[+]': ['boldsymbol', 'textmacros']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    "argmax" : "arg\\,max",
                    "argmin" : "arg\\,min",
                    "col"    : "col",
                    "Span"   :  "span",
                    "epsilon": "\\varepsilon",
                    "EE": "\\mathbb{E}",
                    "PP": "\\mathbb{P}",
                    "RR": "\\mathbb{R}",
                    "NN": "\\mathbb{N}",
                    "ZZ": "\\mathbb{Z}",
                    "aA": "\\mathcal{A}",
                    "bB": "\\mathcal{B}",
                    "cC": "\\mathcal{C}",
                    "dD": "\\mathcal{D}",
                    "eE": "\\mathcal{E}",
                    "fF": "\\mathcal{F}",
                    "gG": "\\mathcal{G}",
                    "hH": "\\mathcal{H}",
                }
            },
            svg: {
                fontCache: 'global',
                scale: 0.92,
                displayAlign: "center",
            },
            };
        </script>
    
    
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" href="_static/styles/quantecon-book-theme.css?digest=22b71a9b445b7b2b6a277c0a48ea72bf6e7c90d9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/exercise.css?v=982b99e0" />
    <link rel="stylesheet" type="text/css" href="_static/proof.css?v=b4b7a797" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>


    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="_static/scripts/quantecon-book-theme.js?digest=65b86b9423025043228643fcfb616ce846cb91c1"></script>
    <script src="_static/scripts/jquery.js?v=5d32c60e"></script>
    <script src="_static/scripts/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KZLV7PM9LL"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KZLV7PM9LL');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KZLV7PM9LL');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex": {"macros": {"argmax": "arg\\,max", "argmin": "arg\\,min", "col": "col", "Span": "span", "epsilon": "\\varepsilon", "EE": "\\mathbb{E}", "PP": "\\mathbb{P}", "RR": "\\mathbb{R}", "NN": "\\mathbb{N}", "ZZ": "\\mathbb{Z}", "aA": "\\mathcal{A}", "bB": "\\mathcal{B}", "cC": "\\mathcal{C}", "dD": "\\mathcal{D}", "eE": "\\mathcal{E}", "fF": "\\mathcal{F}", "gG": "\\mathcal{G}", "hH": "\\mathcal{H}"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'amss';</script>
    <link rel="canonical" href="https://python-advanced.quantecon.org/amss.html" />
    <link rel="icon" href="_static/lectures-favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="47. Fluctuating Interest Rates Deliver Fiscal Insurance" href="amss2.html" />
    <link rel="prev" title="45. Optimal Taxation with State-Contingent Debt" href="opt_tax_recur.html" />

<!-- Normal Meta Tags -->
<meta name="author" context="Thomas J. Sargent &amp; John Stachurski" />
<meta name="keywords" content="Python, QuantEcon, Quantitative Economics, Economics, Sloan, Alfred P. Sloan Foundation, Tom J. Sargent, John Stachurski" />
<meta name="description" content=This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski. />

<!-- Twitter tags -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@quantecon" />
<meta name="twitter:title" content="Optimal Taxation without State-Contingent Debt"/>
<meta name="twitter:description" content="This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski.">
<meta name="twitter:creator" content="@quantecon">
<meta name="twitter:image" content="https://assets.quantecon.org/img/qe-twitter-logo.png">

<!-- Opengraph tags -->
<meta property="og:title" content="Optimal Taxation without State-Contingent Debt" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://python-advanced.quantecon.org/amss.html" />
<meta property="og:image" content="https://assets.quantecon.org/img/qe-og-logo.png" />
<meta property="og:description" content="This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski." />
<meta property="og:site_name" content="Advanced Quantitative Economics with Python" />
<meta name="theme-color" content="#ffffff" />

  </head>
<body>

<!-- Override QuantEcon theme colors -->

    <span id="top"></span>

    <div class="qe-wrapper">

        <div class="qe-main">

            <div class="qe-page" id=amss>

                <div class="qe-page__toc">

                    <div class="inner">

                        
                        <div class="qe-page__toc-header">
                            On this page
                        </div>


                        <nav id="bd-toc-nav" class="qe-page__toc-nav">
                            <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">46.1. Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#competitive-equilibrium-with-distorting-taxes">46.2. Competitive equilibrium with distorting taxes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-free-one-period-debt-only">46.2.1. Risk-free one-period debt only</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-with-lucas-stokey-economy">46.2.2. Comparison with Lucas-Stokey economy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ramsey-problem-without-state-contingent-debt">46.2.3. Ramsey problem without state-contingent debt</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lagrangian-formulation">46.2.3.1. Lagrangian formulation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-calculations">46.2.4. Some calculations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recursive-version-of-amss-model">46.3. Recursive version of AMSS model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recasting-state-variables">46.3.1. Recasting state variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#measurability-constraints">46.3.2. Measurability constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#two-bellman-equations">46.3.3. Two Bellman equations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#martingale-supercedes-state-variable-degeneracy">46.3.4. Martingale supercedes state-variable degeneracy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#absence-of-state-variable-degeneracy">46.3.5. Absence of state variable degeneracy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#digression-on-non-negative-transfers">46.3.6. Digression on non-negative transfers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code">46.3.7. Code</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examples">46.4. Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#anticipated-one-period-war">46.4.1. Anticipated one-period war</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#perpetual-war-alert">46.4.1.1. Perpetual war alert</a></li>
</ul>
</li>
</ul>
</li>
</ul>
                            <p class="logo">
                                
                                    
                                    <a href=https://quantecon.org><img src="_static/qe-logo-large.png" class="logo logo-img" alt="logo"></a>
                                    
                                    
                                
                            </p>

                            <p class="powered">Powered by <a href="https://jupyterbook.org/v1/">Jupyter Book</a></p>

                        </nav>

                        <div class="qe-page__toc-footer">
                            
                            
                            <p><a href="#top"><strong>Back to top</strong></a></p>
                        </div>

                    </div>

                </div>

                <div class="qe-page__header">

                    <div class="qe-page__header-copy">

                        <p class="qe-page__header-heading"><a href="intro.html">Advanced Quantitative Economics with Python</a></p>

                    </div>

                    <!-- Authors section -->
                        <p class="qe-page__header-authors" font-size="18">
                            
                                
                                    <a href="http://www.tomsargent.com/" target="_blank"><span>Thomas J. Sargent</span></a>
                                
                            
                                
                                    and <a href="https://johnstachurski.net/" target="_blank"><span>John Stachurski</span></a>
                                
                            
                        </p>

                    <!-- Last modified / Changelog dropdown -->
                        <button class="qe-page__header-changed" id="changelog-toggle" aria-expanded="false">
                            Last changed: Dec 27, 2025
                            <span class="changelog-icon">▼</span>
                        </button>

                    <!-- Changelog dropdown content -->
                    <div class="qe-page__header-changelog" id="changelog-content" aria-hidden="true">
                        <h4>Changelog (<a href="https://github.com/QuantEcon/lecture-python-advanced.myst/commits/main/lectures/amss.md">full history</a>)</h4>
                        <ul class="changelog-list">
                            
                            <li class="changelog-entry">
                                
                                <a href="https://github.com/QuantEcon/lecture-python-advanced.myst/commit/93c6040" class="changelog-hash">93c6040</a>
                                
                                <span class="changelog-author">dependabot[bot]</span>
                                <span class="changelog-time">1 hour ago</span>
                                <span class="changelog-message">⬆️ Bump sphinx-exercise from 1.0.1 to 1.2.1 (#296)</span>
                            </li>
                            
                        </ul>
                    </div>

                </div> <!-- .page__header -->



                
                <main class="qe-page__content" role="main">
                    
                    <div>
                        
  <div id="qe-notebook-header" align="right" style="text-align:right;">
        <a href="https://quantecon.org/" title="quantecon.org">
                <img style="width:250px;display:inline;" width="250px" src="https://assets.quantecon.org/img/qe-menubar-logo.svg" alt="QuantEcon">
        </a>
</div><section class="tex2jax_ignore mathjax_ignore" id="optimal-taxation-without-state-contingent-debt">
<h1><span class="section-number">46. </span>Optimal Taxation without State-Contingent Debt<a class="headerlink" href="#optimal-taxation-without-state-contingent-debt" title="Link to this heading">#</a></h1>
<p>In addition to what’s in Anaconda, this lecture will need the following libraries:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>quantecon
</pre></div>
</div>
</div>
<details class="admonition hide below-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell output</p>
<p class="expanded admonition-title">Hide code cell output</p>
</summary>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: quantecon in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (0.10.1)
Requirement already satisfied: numba&gt;=0.49.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (0.61.0)
Requirement already satisfied: numpy&gt;=1.17.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (2.1.3)
Requirement already satisfied: requests in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (2.32.3)
Requirement already satisfied: scipy&gt;=1.5.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (1.15.3)
Requirement already satisfied: sympy in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (1.13.3)
Requirement already satisfied: llvmlite&lt;0.45,&gt;=0.44.0dev0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from numba&gt;=0.49.0-&gt;quantecon) (0.44.0)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (3.7)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (2.3.0)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (2025.4.26)
Requirement already satisfied: mpmath&lt;1.4,&gt;=1.1.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from sympy-&gt;quantecon) (1.3.0)
</pre></div>
</div>
</div>
</details>
</div>
<section id="overview">
<h2><span class="section-number">46.1. </span>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>Let’s start with following imports:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">root</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">quantecon</span><span class="w"> </span><span class="kn">import</span> <span class="n">optimize</span><span class="p">,</span> <span class="n">MarkovChain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span><span class="p">,</span> <span class="n">float64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba.experimental</span><span class="w"> </span><span class="kn">import</span> <span class="n">jitclass</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s define numba-compatible interpolation functions for this lecture.</p>
<p>We will soon use the following interpolation functions to interpolate the value function and the policy functions</p>
<div class="cell tag_collapse-20 docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_grid_nodes</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the actual grid points from a grid tuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span> <span class="o">=</span> <span class="n">grid</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span><span class="p">)</span>

<span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">linear_interp_1d_scalar</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">x_val</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for scalar interpolation&quot;&quot;&quot;</span>
    <span class="n">x_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span><span class="p">)</span>
    
    <span class="c1"># Extrapolation with linear extension</span>
    <span class="k">if</span> <span class="n">x_val</span> <span class="o">&lt;=</span> <span class="n">x_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># Linear extrapolation using first two points</span>
        <span class="k">if</span> <span class="n">x_num</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
              <span class="o">/</span> <span class="p">(</span><span class="n">x_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">y_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_val</span> <span class="o">-</span> <span class="n">x_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">x_val</span> <span class="o">&gt;=</span> <span class="n">x_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1"># Linear extrapolation using last two points</span>
        <span class="k">if</span> <span class="n">x_num</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_values</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> \
              <span class="o">/</span> <span class="p">(</span><span class="n">x_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">y_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_val</span> <span class="o">-</span> <span class="n">x_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Binary search for the right interval</span>
    <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">x_num</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">x_nodes</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_val</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span>
    
    <span class="c1"># Linear interpolation</span>
    <span class="n">x_left</span> <span class="o">=</span> <span class="n">x_nodes</span><span class="p">[</span><span class="n">left</span><span class="p">]</span>
    <span class="n">x_right</span> <span class="o">=</span> <span class="n">x_nodes</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>
    <span class="n">y_left</span> <span class="o">=</span> <span class="n">y_values</span><span class="p">[</span><span class="n">left</span><span class="p">]</span>
    <span class="n">y_right</span> <span class="o">=</span> <span class="n">y_values</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>
    
    <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_val</span> <span class="o">-</span> <span class="n">x_left</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_right</span> <span class="o">-</span> <span class="n">x_left</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y_left</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">weight</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_right</span> <span class="o">*</span> <span class="n">weight</span>

<span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">linear_interp_1d</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">x_query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform 1D linear interpolation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span> <span class="o">=</span> <span class="n">x_grid</span>
    <span class="k">return</span> <span class="n">linear_interp_1d_scalar</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">x_query</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s start with following imports:</p>
<p>In <a class="reference internal" href="opt_tax_recur.html"><span class="doc">an earlier lecture</span></a>, we described a model of
optimal taxation with state-contingent debt due to
Robert E. Lucas, Jr.,  and Nancy Stokey  <span id="id1">[<a class="reference internal" href="zreferences.html#id179" title="Robert E Lucas, Jr. and Nancy L Stokey. Optimal Fiscal and Monetary Policy in an Economy without Capital. Journal of monetary Economics, 12(3):55–93, 1983.">Lucas and Stokey, 1983</a>]</span>.</p>
<p>Aiyagari, Marcet, Sargent, and Seppälä <span id="id2">[<a class="reference internal" href="zreferences.html#id133" title="S Rao Aiyagari, Albert Marcet, Thomas J Sargent, and Juha Seppälä. Optimal taxation without state-contingent debt. Journal of Political Economy, 110(6):1220–1254, 2002.">Aiyagari <em>et al.</em>, 2002</a>]</span>  (hereafter, AMSS)
studied optimal taxation in a model without state-contingent debt.</p>
<p>In this lecture, we</p>
<ul class="simple">
<li><p>describe assumptions and equilibrium concepts</p></li>
<li><p>solve the model</p></li>
<li><p>implement the model numerically</p></li>
<li><p>conduct some policy experiments</p></li>
<li><p>compare outcomes with those in a corresponding complete-markets model</p></li>
</ul>
<p>We begin with an introduction to the model.</p>
</section>
<section id="competitive-equilibrium-with-distorting-taxes">
<h2><span class="section-number">46.2. </span>Competitive equilibrium with distorting taxes<a class="headerlink" href="#competitive-equilibrium-with-distorting-taxes" title="Link to this heading">#</a></h2>
<p>Many but not all features of the economy are identical to those of <a class="reference internal" href="opt_tax_recur.html"><span class="doc">the Lucas-Stokey economy</span></a>.</p>
<p>Let’s start with things that are identical.</p>
<p>For <span class="math notranslate nohighlight">\(t \geq 0\)</span>, a history of the state is represented by <span class="math notranslate nohighlight">\(s^t = [s_t, s_{t-1}, \ldots, s_0]\)</span>.</p>
<p>Government purchases <span class="math notranslate nohighlight">\(g(s)\)</span> are an exact time-invariant function of <span class="math notranslate nohighlight">\(s\)</span>.</p>
<p>Let <span class="math notranslate nohighlight">\(c_t(s^t)\)</span>,  <span class="math notranslate nohighlight">\(\ell_t(s^t)\)</span>, and <span class="math notranslate nohighlight">\(n_t(s^t)\)</span> denote consumption,
leisure, and labor supply, respectively, at history <span class="math notranslate nohighlight">\(s^t\)</span> at time <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p>Each period a representative  household is endowed with one unit of time that can be divided between  leisure
<span class="math notranslate nohighlight">\(\ell_t\)</span> and labor <span class="math notranslate nohighlight">\(n_t\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-feas1-amss">
<span class="eqno">(46.1)<a class="headerlink" href="#equation-feas1-amss" title="Link to this equation">#</a></span>\[n_t(s^t) + \ell_t(s^t) = 1\]</div>
<p>Output equals <span class="math notranslate nohighlight">\(n_t(s^t)\)</span> and can be divided between consumption <span class="math notranslate nohighlight">\(c_t(s^t)\)</span> and <span class="math notranslate nohighlight">\(g(s_t)\)</span></p>
<div class="math notranslate nohighlight" id="equation-tss-techr-amss">
<span class="eqno">(46.2)<a class="headerlink" href="#equation-tss-techr-amss" title="Link to this equation">#</a></span>\[c_t(s^t) + g(s_t) = n_t(s^t)\]</div>
<p>Output is not storable.</p>
<p>The technology pins down a pre-tax wage rate to unity for all <span class="math notranslate nohighlight">\(t, s^t\)</span>.</p>
<p>A representative  household’s preferences over <span class="math notranslate nohighlight">\(\{c_t(s^t), \ell_t(s^t)\}_{t=0}^\infty\)</span> are ordered by</p>
<div class="math notranslate nohighlight" id="equation-ts-prefr-amss">
<span class="eqno">(46.3)<a class="headerlink" href="#equation-ts-prefr-amss" title="Link to this equation">#</a></span>\[\sum_{t=0}^\infty \sum_{s^t} \beta^t \pi_t(s^t) u[c_t(s^t), \ell_t(s^t)]\]</div>
<p>where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\pi_t(s^t)\)</span> is a joint probability distribution over the sequence <span class="math notranslate nohighlight">\(s^t\)</span>, and</p></li>
<li><p>the utility function <span class="math notranslate nohighlight">\(u\)</span> is  increasing, strictly concave, and three times  continuously differentiable in both arguments.</p></li>
</ul>
<p>The government imposes a flat rate tax <span class="math notranslate nohighlight">\(\tau_t(s^t)\)</span> on labor income at time <span class="math notranslate nohighlight">\(t\)</span>, history <span class="math notranslate nohighlight">\(s^t\)</span>.</p>
<p>Lucas and Stokey assumed that there are complete markets in one-period Arrow securities; also see <a class="reference internal" href="smoothing.html"><span class="doc">smoothing models</span></a>.</p>
<p>It is at this point that AMSS <span id="id3">[<a class="reference internal" href="zreferences.html#id133" title="S Rao Aiyagari, Albert Marcet, Thomas J Sargent, and Juha Seppälä. Optimal taxation without state-contingent debt. Journal of Political Economy, 110(6):1220–1254, 2002.">Aiyagari <em>et al.</em>, 2002</a>]</span> modify the Lucas and Stokey economy.</p>
<p>AMSS allow the government to issue only one-period risk-free debt each period.</p>
<p>Ruling out complete markets in this way is a step in the direction of making total tax collections behave more like that prescribed in Robert Barro (1979) <span id="id4">[<a class="reference internal" href="zreferences.html#id139" title="Robert J Barro. On the Determination of the Public Debt. Journal of Political Economy, 87(5):940–971, 1979.">Barro, 1979</a>]</span> than they do in Lucas and Stokey (1983) <span id="id5">[<a class="reference internal" href="zreferences.html#id179" title="Robert E Lucas, Jr. and Nancy L Stokey. Optimal Fiscal and Monetary Policy in an Economy without Capital. Journal of monetary Economics, 12(3):55–93, 1983.">Lucas and Stokey, 1983</a>]</span>.</p>
<section id="risk-free-one-period-debt-only">
<h3><span class="section-number">46.2.1. </span>Risk-free one-period debt only<a class="headerlink" href="#risk-free-one-period-debt-only" title="Link to this heading">#</a></h3>
<p>In period <span class="math notranslate nohighlight">\(t\)</span> and history <span class="math notranslate nohighlight">\(s^t\)</span>, let</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(b_{t+1}(s^t)\)</span> be the amount of the time <span class="math notranslate nohighlight">\(t+1\)</span> consumption good that at time <span class="math notranslate nohighlight">\(t\)</span>, history <span class="math notranslate nohighlight">\(s^t\)</span> the government promised to pay</p></li>
<li><p><span class="math notranslate nohighlight">\(R_t(s^t)\)</span> be the gross interest rate on  risk-free one-period debt between periods <span class="math notranslate nohighlight">\(t\)</span> and <span class="math notranslate nohighlight">\(t+1\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(T_t(s^t)\)</span> be a non-negative lump-sum <em>transfer</em> to the representative household <a class="footnote-reference brackets" href="#fn-a" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p></li>
</ul>
<p>That <span class="math notranslate nohighlight">\(b_{t+1}(s^t)\)</span> is the same for all realizations of <span class="math notranslate nohighlight">\(s_{t+1}\)</span> captures its <em>risk-free</em> character.</p>
<p>The market value at time <span class="math notranslate nohighlight">\(t\)</span> of government debt maturing at time <span class="math notranslate nohighlight">\(t+1\)</span> equals <span class="math notranslate nohighlight">\(b_{t+1}(s^t)\)</span> divided by <span class="math notranslate nohighlight">\(R_t(s^t)\)</span>.</p>
<p>The government’s budget constraint in period <span class="math notranslate nohighlight">\(t\)</span> at history <span class="math notranslate nohighlight">\(s^t\)</span> is</p>
<div class="math notranslate nohighlight" id="equation-ts-gov-wo">
<span class="eqno">(46.4)<a class="headerlink" href="#equation-ts-gov-wo" title="Link to this equation">#</a></span>\[\begin{split}\begin{aligned}
b_t(s^{t-1})
    &amp; =    \tau^n_t(s^t) n_t(s^t) - g(s_t) - T_t(s^t) +
                   {b_{t+1}(s^t) \over R_t(s^t )}
    \\
    &amp; \equiv z_t(s^t) + {b_{t+1}(s^t) \over R_t(s^t )},
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(z_t(s^t)\)</span> is the net-of-interest government surplus.</p>
<p>To rule out Ponzi schemes, we assume that the government is subject to a <strong>natural debt limit</strong> (to be discussed in a forthcoming lecture).</p>
<p>The consumption Euler equation for a representative household able to trade only one-period risk-free debt
with one-period gross interest rate <span class="math notranslate nohighlight">\(R_t(s^t)\)</span> is</p>
<div class="math notranslate nohighlight">
\[
{1 \over R_t(s^t)}
= \sum_{s^{t+1}\vert s^t} \beta  \pi_{t+1}(s^{t+1} | s^t)
                        { u_c(s^{t+1}) \over u_c(s^{t}) }
\]</div>
<p>Substituting this expression into the government’s budget constraint <a class="reference internal" href="#equation-ts-gov-wo">(46.4)</a>
yields:</p>
<div class="math notranslate nohighlight" id="equation-ts-gov-wo2">
<span class="eqno">(46.5)<a class="headerlink" href="#equation-ts-gov-wo2" title="Link to this equation">#</a></span>\[b_t(s^{t-1}) =  z_t(s^t) + \beta  \sum_{s^{t+1}\vert s^t}  \pi_{t+1}(s^{t+1} | s^t)
                       { u_c(s^{t+1}) \over u_c(s^{t}) } \; b_{t+1}(s^t)\]</div>
<p>Components of <span class="math notranslate nohighlight">\(z_t(s^t)\)</span> on the right side depend on <span class="math notranslate nohighlight">\(s^t\)</span>, but the left side is required to depend only
on <span class="math notranslate nohighlight">\(s^{t-1}\)</span> .</p>
<p><strong>This is what it means for one-period government debt to be risk-free</strong>.</p>
<p>Therefore, the right side of equation <a class="reference internal" href="#equation-ts-gov-wo2">(46.5)</a> also has to depend only on <span class="math notranslate nohighlight">\(s^{t-1}\)</span>.</p>
<p>This requirement will give rise to <strong>measurability constraints</strong> on the Ramsey allocation to be discussed soon.</p>
<p>If we replace <span class="math notranslate nohighlight">\(b_{t+1}(s^t)\)</span> on the right side of equation <a class="reference internal" href="#equation-ts-gov-wo2">(46.5)</a> by the right
side of next period’s budget constraint (associated with a
particular realization <span class="math notranslate nohighlight">\(s_{t}\)</span>) we get</p>
<div class="math notranslate nohighlight">
\[
b_t(s^{t-1}) =  z_t(s^t) + \sum_{s^{t+1}\vert s^t} \beta  \pi_{t+1}(s^{t+1} | s^t)
                       { u_c(s^{t+1}) \over u_c(s^{t}) }
\, \left[z_{t+1}(s^{t+1}) + {b_{t+2}(s^{t+1}) \over R_{t+1}(s^{t+1})}\right]
\]</div>
<p>After making similar repeated substitutions for all future occurrences of
government indebtedness, and by invoking a natural debt limit, we
arrive at:</p>
<div class="math notranslate nohighlight" id="equation-ts-gov-wo3">
<span class="eqno">(46.6)<a class="headerlink" href="#equation-ts-gov-wo3" title="Link to this equation">#</a></span>\[\begin{aligned}
b_t(s^{t-1})
    &amp;=  \sum_{j=0}^\infty \sum_{s^{t+j} | s^t} \beta^j  \pi_{t+j}(s^{t+j} | s^t)
              { u_c(s^{t+j}) \over u_c(s^{t}) } \;z_{t+j}(s^{t+j})
        \end{aligned}\]</div>
<p>Notice how the conditioning sets in equation <a class="reference internal" href="#equation-ts-gov-wo3">(46.6)</a> differ: they are <span class="math notranslate nohighlight">\(s^{t-1}\)</span> on the left side and
<span class="math notranslate nohighlight">\(s^t\)</span> on the right side.</p>
<p>Now let’s</p>
<ul class="simple">
<li><p>substitute the resource constraint into the net-of-interest government surplus, and</p></li>
<li><p>use the household’s first-order condition <span class="math notranslate nohighlight">\(1-\tau^n_t(s^t)= u_{\ell}(s^t) /u_c(s^t)\)</span> to eliminate the labor tax rate</p></li>
</ul>
<p>so that we can express the net-of-interest government surplus <span class="math notranslate nohighlight">\(z_t(s^t)\)</span> as</p>
<div class="math notranslate nohighlight" id="equation-amss-44-2">
<span class="eqno">(46.7)<a class="headerlink" href="#equation-amss-44-2" title="Link to this equation">#</a></span>\[z_t(s^t)
    = \left[1 - {u_{\ell}(s^t) \over u_c(s^t)}\right] \left[c_t(s^t)+g(s_t)\right]
        -g(s_t) - T_t(s^t)\,.\]</div>
<p>If we substitute  appropriate versions of the right side of <a class="reference internal" href="#equation-amss-44-2">(46.7)</a> for <span class="math notranslate nohighlight">\(z_{t+j}(s^{t+j})\)</span> into equation <a class="reference internal" href="#equation-ts-gov-wo3">(46.6)</a>,
we obtain a sequence of <em>implementability constraints</em> on a Ramsey allocation in an AMSS economy.</p>
<p>Expression <a class="reference internal" href="#equation-ts-gov-wo3">(46.6)</a> at time <span class="math notranslate nohighlight">\(t=0\)</span> and initial state <span class="math notranslate nohighlight">\(s^0\)</span>
was also  an <em>implementability constraint</em> on a Ramsey allocation in a Lucas-Stokey economy:</p>
<div class="math notranslate nohighlight" id="equation-ts-gov-wo4">
<span class="eqno">(46.8)<a class="headerlink" href="#equation-ts-gov-wo4" title="Link to this equation">#</a></span>\[b_0(s^{-1}) = \mathbb E_0 \sum_{j=0}^\infty \beta^j
               { u_c(s^{j}) \over u_c(s^{0}) } \;z_j(s^{j})\]</div>
<p>Indeed, it was the <em>only</em> implementability constraint there.</p>
<p>But now we also have a large number of additional implementability constraints</p>
<div class="math notranslate nohighlight" id="equation-ts-gov-wo4a">
<span class="eqno">(46.9)<a class="headerlink" href="#equation-ts-gov-wo4a" title="Link to this equation">#</a></span>\[b_t(s^{t-1}) =  \mathbb E_t \sum_{j=0}^\infty \beta^j
              { u_c(s^{t+j}) \over u_c(s^{t}) } \;z_{t+j}(s^{t+j})\]</div>
<p>Equation <a class="reference internal" href="#equation-ts-gov-wo4a">(46.9)</a> must hold for each <span class="math notranslate nohighlight">\(s^t\)</span> for each <span class="math notranslate nohighlight">\(t \geq 1\)</span>.</p>
</section>
<section id="comparison-with-lucas-stokey-economy">
<h3><span class="section-number">46.2.2. </span>Comparison with Lucas-Stokey economy<a class="headerlink" href="#comparison-with-lucas-stokey-economy" title="Link to this heading">#</a></h3>
<p>The expression on the right side of <a class="reference internal" href="#equation-ts-gov-wo4a">(46.9)</a> in the Lucas-Stokey (1983) economy would  equal the present value of a continuation stream of government net-of-interest surpluses evaluated at what would be competitive equilibrium Arrow-Debreu prices at date <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p>In the Lucas-Stokey economy, that present value is measurable with respect to <span class="math notranslate nohighlight">\(s^t\)</span>.</p>
<p>In the AMSS economy, the restriction that government debt be risk-free imposes that that same present value must be measurable with respect to <span class="math notranslate nohighlight">\(s^{t-1}\)</span>.</p>
<p>In a language used in the literature on incomplete markets models, it can be said that the AMSS model requires that at each <span class="math notranslate nohighlight">\((t, s^t)\)</span> what would be the present value of continuation government net-of-interest surpluses in the Lucas-Stokey model must belong to  the <strong>marketable subspace</strong> of the AMSS model.</p>
</section>
<section id="ramsey-problem-without-state-contingent-debt">
<h3><span class="section-number">46.2.3. </span>Ramsey problem without state-contingent debt<a class="headerlink" href="#ramsey-problem-without-state-contingent-debt" title="Link to this heading">#</a></h3>
<p>After we have substituted the resource constraint into the utility function, we can express the Ramsey problem as being to choose an allocation that solves</p>
<div class="math notranslate nohighlight">
\[
\max_{\{c_t(s^t),b_{t+1}(s^t)\}}
\mathbb E_0 \sum_{t=0}^\infty \beta^t
                        u\left(c_t(s^t),1-c_t(s^t)-g(s_t)\right)
\]</div>
<p>where the maximization is subject to</p>
<div class="math notranslate nohighlight" id="equation-amss-44">
<span class="eqno">(46.10)<a class="headerlink" href="#equation-amss-44" title="Link to this equation">#</a></span>\[\mathbb E_{0} \sum_{j=0}^\infty \beta^j
      { u_c(s^{j}) \over u_c(s^{0}) } \;z_j(s^{j}) \geq b_0(s^{-1})\]</div>
<p>and</p>
<div class="math notranslate nohighlight" id="equation-amss-46">
<span class="eqno">(46.11)<a class="headerlink" href="#equation-amss-46" title="Link to this equation">#</a></span>\[\mathbb E_{t} \sum_{j=0}^\infty \beta^j
    { u_c(s^{t+j}) \over u_c(s^{t}) } \;
    z_{t+j}(s^{t+j}) = b_t(s^{t-1})
      \quad \forall \, t,  s^t\]</div>
<p>given <span class="math notranslate nohighlight">\(b_0(s^{-1})\)</span>.</p>
<section id="lagrangian-formulation">
<h4><span class="section-number">46.2.3.1. </span>Lagrangian formulation<a class="headerlink" href="#lagrangian-formulation" title="Link to this heading">#</a></h4>
<p>Let <span class="math notranslate nohighlight">\(\gamma_0(s^0)\)</span> be a non-negative Lagrange multiplier on constraint <a class="reference internal" href="#equation-amss-44">(46.10)</a>.</p>
<p>As in the Lucas-Stokey economy, this multiplier is strictly positive when the government must resort to
distortionary taxation; otherwise it equals zero.</p>
<p>A consequence of the assumption that there are no markets in state-contingent securities  and that a market exists only in a risk-free security is that we have to attach a stochastic process <span class="math notranslate nohighlight">\(\{\gamma_t(s^t)\}_{t=1}^\infty\)</span> of
Lagrange multipliers to the implementability constraints <a class="reference internal" href="#equation-amss-46">(46.11)</a>.</p>
<p>Depending on how the constraints  bind, these multipliers can be positive or negative:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
   \gamma_t(s^t)
   &amp;\;\geq\; (\leq)\;\, 0 \quad \text{if the constraint binds in the following direction }
   \\
   &amp; \mathbb E_{t} \sum_{j=0}^\infty \beta^j
    { u_c(s^{t+j}) \over u_c(s^{t}) } \;z_{t+j}(s^{t+j}) \;\geq \;(\leq)\;\, b_t(s^{t-1})
\end{aligned}
\end{split}\]</div>
<p>A negative multiplier <span class="math notranslate nohighlight">\(\gamma_t(s^t)&lt;0\)</span> means that if we could
relax constraint <a class="reference internal" href="#equation-amss-46">(46.11)</a>, we would like to <em>increase</em> the beginning-of-period
indebtedness for that particular realization of history <span class="math notranslate nohighlight">\(s^t\)</span>.</p>
<p>That would let us reduce the beginning-of-period indebtedness for some other history <a class="footnote-reference brackets" href="#fn-b" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p>
<p>These features flow from  the fact that the government cannot use state-contingent debt and therefore cannot allocate its indebtedness  efficiently across future states.</p>
</section>
</section>
<section id="some-calculations">
<h3><span class="section-number">46.2.4. </span>Some calculations<a class="headerlink" href="#some-calculations" title="Link to this heading">#</a></h3>
<p>It is helpful to apply two transformations to the Lagrangian.</p>
<p>Multiply constraint <a class="reference internal" href="#equation-amss-44">(46.10)</a> by <span class="math notranslate nohighlight">\(u_c(s^0)\)</span> and the constraints <a class="reference internal" href="#equation-amss-46">(46.11)</a> by <span class="math notranslate nohighlight">\(\beta^t u_c(s^{t})\)</span>.</p>
<p>Then a Lagrangian for the Ramsey problem can  be represented as</p>
<div class="math notranslate nohighlight" id="equation-amss-lagr-a">
<span class="eqno">(46.12)<a class="headerlink" href="#equation-amss-lagr-a" title="Link to this equation">#</a></span>\[\begin{split}\begin{aligned}
   J &amp;= \mathbb E_{0} \sum_{t=0}^\infty \beta^t
                        \biggl\{ u\left(c_t(s^t), 1-c_t(s^t)-g(s_t)\right)\\
   &amp;  \qquad + \gamma_t(s^t) \Bigl[ \mathbb E_{t} \sum_{j=0}^\infty \beta^j
         u_c(s^{t+j}) \,z_{t+j}(s^{t+j}) - u_c(s^{t}) \,b_t(s^{t-1}) \biggr\}
         \\
   &amp;= \mathbb E_{0} \sum_{t=0}^\infty \beta^t
                         \biggl\{ u\left(c_t(s^t), 1-c_t(s^t)-g(s_t)\right)
        \\
   &amp;  \qquad + \Psi_t(s^t)\, u_c(s^{t}) \,z_t(s^{t}) -
                   \gamma_t(s^t)\, u_c(s^{t}) \, b_t(s^{t-1})  \biggr\}
\end{aligned}\end{split}\]</div>
<p>where</p>
<div class="math notranslate nohighlight" id="equation-amss-lagr">
<span class="eqno">(46.13)<a class="headerlink" href="#equation-amss-lagr" title="Link to this equation">#</a></span>\[\Psi_t(s^t)=\Psi_{t-1}(s^{t-1})+\gamma_t(s^t)
 \quad \text{and} \quad
\Psi_{-1}(s^{-1})=0\]</div>
<p>In <a class="reference internal" href="#equation-amss-lagr-a">(46.12)</a>,  the second equality uses  the law of iterated expectations
and Abel’s summation formula (also called <em>summation by parts</em>, see
<a class="reference external" href="https://en.wikipedia.org/wiki/Abel%27s_summation_formula">this page</a>).</p>
<p>First-order conditions with respect
to <span class="math notranslate nohighlight">\(c_t(s^t)\)</span> can be expressed as</p>
<div class="math notranslate nohighlight" id="equation-amss-foc-a">
<span class="eqno">(46.14)<a class="headerlink" href="#equation-amss-foc-a" title="Link to this equation">#</a></span>\[\begin{split}\begin{aligned}
  u_c(s^t)-u_{\ell}(s^t) &amp;+ \Psi_t(s^t)\left\{ \left[
    u_{cc}(s^t) - u_{c\ell}(s^{t})\right]z_t(s^{t}) +
    u_{c}(s^{t})\,z_c(s^{t}) \right\}
    \\
    &amp; \hspace{35mm} - \gamma_t(s^t)\left[
    u_{cc}(s^{t}) - u_{c\ell}(s^{t})\right]b_t(s^{t-1}) =0
\end{aligned}\end{split}\]</div>
<p>and with respect to <span class="math notranslate nohighlight">\(b_t(s^t)\)</span> as</p>
<div class="math notranslate nohighlight" id="equation-amss-foc-b">
<span class="eqno">(46.15)<a class="headerlink" href="#equation-amss-foc-b" title="Link to this equation">#</a></span>\[\mathbb E_{t} \left[\gamma_{t+1}(s^{t+1})\,u_c(s^{t+1})\right] = 0\]</div>
<p>If we substitute <span class="math notranslate nohighlight">\(z_t(s^t)\)</span> from <a class="reference internal" href="#equation-amss-44-2">(46.7)</a> and its derivative
<span class="math notranslate nohighlight">\(z_c(s^t)\)</span> into the first-order condition <a class="reference internal" href="#equation-amss-foc-a">(46.14)</a>, we  find  two
differences from the corresponding condition for the optimal allocation
in a Lucas-Stokey economy with state-contingent government debt.</p>
<ol class="arabic simple">
<li><p>The term involving <span class="math notranslate nohighlight">\(b_t(s^{t-1})\)</span> in the first-order condition
<a class="reference internal" href="#equation-amss-foc-a">(46.14)</a> does not appear in the corresponding expression
for the Lucas-Stokey economy.</p>
<ul class="simple">
<li><p>This term reflects the constraint that
beginning-of-period government indebtedness must be the same across all
realizations of next period’s state, a constraint that would  not be present if
government debt could be state-contingent.</p></li>
</ul>
</li>
<li><p>The Lagrange multiplier <span class="math notranslate nohighlight">\(\Psi_t(s^t)\)</span> in the first-order condition
<a class="reference internal" href="#equation-amss-foc-a">(46.14)</a> may change over time in response to realizations of the state,
while the multiplier <span class="math notranslate nohighlight">\(\Phi\)</span> in the Lucas-Stokey economy is time-invariant.</p></li>
</ol>
<p>We need some code from  <a class="reference internal" href="opt_tax_recur.html"><span class="doc">an earlier lecture</span></a>
on optimal taxation with state-contingent debt  sequential allocation implementation:</p>
<div class="cell tag_collapse-20 docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SequentialLS</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class that takes a preference object, state transition matrix,</span>
<span class="sd">    and state contingent government expenditure plan as inputs, and</span>
<span class="sd">    solves the sequential allocation problem described above.</span>
<span class="sd">    It returns optimal allocations about consumption and labor supply,</span>
<span class="sd">    as well as the multiplier on the implementability constraint Φ.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">pref</span><span class="p">,</span>
                 <span class="n">π</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">),</span>
                 <span class="n">g</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])):</span>

        <span class="c1"># Initialize from pref object attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="n">π</span><span class="p">,</span> <span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">π</span><span class="p">)</span>  <span class="c1"># Number of states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pref</span> <span class="o">=</span> <span class="n">pref</span>

        <span class="c1"># Find the first best allocation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_first_best</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">FOC_first_best</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        First order conditions that characterize</span>
<span class="sd">        the first best allocation.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pref</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Ul</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">g</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_first_best</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the first best allocation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FOC_first_best</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">g</span><span class="p">,))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find first best&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span> <span class="o">+</span> <span class="n">g</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">FOC_time1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">Φ</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        First order conditions that characterize</span>
<span class="sd">        optimal time 1 allocation problems.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pref</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Ucc</span><span class="p">,</span> <span class="n">Ul</span><span class="p">,</span> <span class="n">Ull</span><span class="p">,</span> <span class="n">Ulc</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ucc</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ull</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ulc</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">g</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n</span>

        <span class="n">LHS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Φ</span><span class="p">)</span> <span class="o">*</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">Φ</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">Ucc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span class="n">Ulc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
        <span class="n">RHS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Φ</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">Φ</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">Ulc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span class="n">Ull</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">LHS</span> <span class="o">-</span> <span class="n">RHS</span>

        <span class="k">return</span> <span class="n">diff</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">time1_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Φ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes optimal allocation for time t &gt;= 1 for a given Φ</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pref</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>

        <span class="c1"># use the first best allocation as intial guess</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FOC_time1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">Φ</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find LS allocation.&#39;</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">g</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n</span>

        <span class="c1"># Compute x</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">FOC_time0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">Φ</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">b0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        First order conditions that characterize</span>
<span class="sd">        time 0 allocation problem.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pref</span>
        <span class="n">Ucc</span><span class="p">,</span> <span class="n">Ulc</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ucc</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ulc</span>

        <span class="n">n0</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">g0</span>
        <span class="n">l0</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n0</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FOC_time1</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">Φ</span><span class="p">,</span> <span class="n">g0</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">-=</span> <span class="n">Φ</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ucc</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">l0</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ulc</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">l0</span><span class="p">))</span> <span class="o">*</span> <span class="n">b0</span>

        <span class="k">return</span> <span class="n">diff</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">implementability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Φ</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">cn0_arr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the differences between the RHS and LHS</span>
<span class="sd">        of the implementability constraint given Φ,</span>
<span class="sd">        initial debt, and initial state.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">pref</span><span class="p">,</span> <span class="n">π</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">β</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Ul</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span>
        <span class="n">g0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">[</span><span class="n">s0</span><span class="p">]</span>

        <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">Φ</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FOC_time0</span><span class="p">,</span> <span class="n">cn0_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">Φ</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">b0</span><span class="p">))</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
        <span class="n">n0</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">g0</span>
        <span class="n">l0</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n0</span>

        <span class="n">cn0_arr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">c0</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">n0</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="n">LHS</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="n">b0</span>
        <span class="n">RHS</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">Ul</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">l0</span><span class="p">)</span> <span class="o">*</span> <span class="n">n0</span> <span class="o">+</span> <span class="n">β</span> <span class="o">*</span> <span class="n">π</span><span class="p">[</span><span class="n">s0</span><span class="p">]</span> <span class="o">@</span> <span class="n">x</span>

        <span class="k">return</span> <span class="n">RHS</span> <span class="o">-</span> <span class="n">LHS</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">time0_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">s0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the optimal time 0 allocation given</span>
<span class="sd">        initial government debt b0 and state s0</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># use the first best allocation as initial guess</span>
        <span class="n">cn0_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">[</span><span class="n">s0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">[</span><span class="n">s0</span><span class="p">]])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">implementability</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">cn0_arr</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find time 0 LS allocation.&#39;</span><span class="p">)</span>

        <span class="n">Φ</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">c0</span><span class="p">,</span> <span class="n">n0</span> <span class="o">=</span> <span class="n">cn0_arr</span>

        <span class="k">return</span> <span class="n">Φ</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">n0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">τ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes τ given c, n</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pref</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Ul</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span>

        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Ul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sHist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Simulates planners policies for T periods</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pref</span><span class="p">,</span> <span class="n">π</span><span class="p">,</span> <span class="n">β</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span>
        <span class="n">Uc</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">Uc</span>

        <span class="k">if</span> <span class="n">sHist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sHist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span>

        <span class="n">cHist</span><span class="p">,</span> <span class="n">nHist</span><span class="p">,</span> <span class="n">Bhist</span><span class="p">,</span> <span class="n">τHist</span><span class="p">,</span> <span class="n">ΦHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
        <span class="n">RHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Time 0</span>
        <span class="n">Φ</span><span class="p">,</span> <span class="n">cHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time0_allocation</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span>
        <span class="n">τHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">τ</span><span class="p">(</span><span class="n">cHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">Bhist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b0</span>
        <span class="n">ΦHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Φ</span>

        <span class="c1"># Time 1 onward</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">Φ</span><span class="p">)</span>
            <span class="n">τ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">τ</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">u_c</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">Eu_c</span> <span class="o">=</span> <span class="n">π</span><span class="p">[</span><span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">@</span> <span class="n">u_c</span>
            <span class="n">cHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">Bhist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">τHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/</span> <span class="n">u_c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">τ</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">RHist</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">cHist</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">-</span><span class="n">nHist</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">Eu_c</span><span class="p">)</span>
            <span class="n">ΦHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">Φ</span>

        <span class="n">gHist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">[</span><span class="n">sHist</span><span class="p">]</span>
        <span class="n">yHist</span> <span class="o">=</span> <span class="n">nHist</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">cHist</span><span class="p">,</span> <span class="n">nHist</span><span class="p">,</span> <span class="n">Bhist</span><span class="p">,</span> <span class="n">τHist</span><span class="p">,</span> <span class="n">gHist</span><span class="p">,</span> <span class="n">yHist</span><span class="p">,</span> <span class="n">sHist</span><span class="p">,</span> <span class="n">ΦHist</span><span class="p">,</span> <span class="n">RHist</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>To analyze the AMSS model, we find it useful to adopt a recursive formulation
using techniques like those in our lectures on <a class="reference internal" href="dyn_stack.html"><span class="doc">dynamic Stackelberg models</span></a> and <a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state-contingent debt</span></a>.</p>
</section>
</section>
<section id="recursive-version-of-amss-model">
<h2><span class="section-number">46.3. </span>Recursive version of AMSS model<a class="headerlink" href="#recursive-version-of-amss-model" title="Link to this heading">#</a></h2>
<p>We now describe a recursive formulation of the AMSS economy.</p>
<p>We have noted that from the point of view of the Ramsey planner, the restriction
to one-period risk-free securities</p>
<ul class="simple">
<li><p>leaves intact the single implementability constraint on allocations
<a class="reference internal" href="#equation-ts-gov-wo4">(46.8)</a> from the Lucas-Stokey economy, but</p></li>
<li><p>adds measurability constraints <a class="reference internal" href="#equation-ts-gov-wo3">(46.6)</a> on functions of tails of
allocations at each time and history</p></li>
</ul>
<p>We now explore how these constraints alter  Bellman equations for a time
<span class="math notranslate nohighlight">\(0\)</span> Ramsey planner and for time <span class="math notranslate nohighlight">\(t \geq 1\)</span>, history <span class="math notranslate nohighlight">\(s^t\)</span>
continuation Ramsey planners.</p>
<section id="recasting-state-variables">
<h3><span class="section-number">46.3.1. </span>Recasting state variables<a class="headerlink" href="#recasting-state-variables" title="Link to this heading">#</a></h3>
<p>In the AMSS setting, the government faces a sequence of budget constraints</p>
<div class="math notranslate nohighlight">
\[
\tau_t(s^t) n_t(s^t) + T_t(s^t) +  b_{t+1}(s^t)/ R_t (s^t) =  g_t + b_t(s^{t-1})
\]</div>
<p>where <span class="math notranslate nohighlight">\(R_t(s^t)\)</span> is the gross risk-free rate of interest between <span class="math notranslate nohighlight">\(t\)</span>
and <span class="math notranslate nohighlight">\(t+1\)</span> at history <span class="math notranslate nohighlight">\(s^t\)</span> and <span class="math notranslate nohighlight">\(T_t(s^t)\)</span> are non-negative transfers.</p>
<p>Throughout this lecture, we shall set transfers to zero (for some issues about the limiting behavior of debt, this is  possibly an important  difference from AMSS <span id="id8">[<a class="reference internal" href="zreferences.html#id133" title="S Rao Aiyagari, Albert Marcet, Thomas J Sargent, and Juha Seppälä. Optimal taxation without state-contingent debt. Journal of Political Economy, 110(6):1220–1254, 2002.">Aiyagari <em>et al.</em>, 2002</a>]</span>, who restricted transfers
to be non-negative).</p>
<p>In this case, the household faces a sequence of budget constraints</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp1">
<span class="eqno">(46.16)<a class="headerlink" href="#equation-eqn-amssapp1" title="Link to this equation">#</a></span>\[b_t(s^{t-1}) + (1-\tau_t(s^t)) n_t(s^t) = c_t(s^t) + b_{t+1}(s^t)/R_t(s^t)\]</div>
<p>The household’s first-order conditions are <span class="math notranslate nohighlight">\(u_{c,t} = \beta R_t \mathbb E_t u_{c,t+1}\)</span>
and <span class="math notranslate nohighlight">\((1-\tau_t) u_{c,t} = u_{l,t}\)</span>.</p>
<p>Using these to eliminate <span class="math notranslate nohighlight">\(R_t\)</span> and <span class="math notranslate nohighlight">\(\tau_t\)</span> from  budget constraint
<a class="reference internal" href="#equation-eqn-amssapp1">(46.16)</a> gives</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp2a">
<span class="eqno">(46.17)<a class="headerlink" href="#equation-eqn-amssapp2a" title="Link to this equation">#</a></span>\[b_t(s^{t-1}) + \frac{u_{l,t}(s^t)}{u_{c,t}(s^t)} n_t(s^t)
= c_t(s^t) + {\frac{\beta (\mathbb E_t u_{c,t+1}) b_{t+1}(s^t)}{u_{c,t}(s^t)}}\]</div>
<p>or</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp2">
<span class="eqno">(46.18)<a class="headerlink" href="#equation-eqn-amssapp2" title="Link to this equation">#</a></span>\[u_{c,t}(s^t) b_t(s^{t-1}) + u_{l,t}(s^t) n_t(s^t)
= u_{c,t}(s^t) c_t(s^t) + \beta (\mathbb E_t u_{c,t+1}) b_{t+1}(s^t)\]</div>
<p>Now define</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp3">
<span class="eqno">(46.19)<a class="headerlink" href="#equation-eqn-amssapp3" title="Link to this equation">#</a></span>\[x_t \equiv \beta b_{t+1}(s^t) \mathbb E_t u_{c,t+1} = u_{c,t} (s^t) {\frac{b_{t+1}(s^t)}{R_t(s^t)}}\]</div>
<p>and represent the household’s budget constraint at time <span class="math notranslate nohighlight">\(t\)</span>,
history <span class="math notranslate nohighlight">\(s^t\)</span> as</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp4">
<span class="eqno">(46.20)<a class="headerlink" href="#equation-eqn-amssapp4" title="Link to this equation">#</a></span>\[{\frac{u_{c,t} x_{t-1}}{\beta \mathbb E_{t-1} u_{c,t}}} = u_{c,t} c_t - u_{l,t} n_t + x_t\]</div>
<p>for <span class="math notranslate nohighlight">\(t \geq 1\)</span>.</p>
</section>
<section id="measurability-constraints">
<h3><span class="section-number">46.3.2. </span>Measurability constraints<a class="headerlink" href="#measurability-constraints" title="Link to this heading">#</a></h3>
<p>Write equation <a class="reference internal" href="#equation-eqn-amssapp2">(46.18)</a> as</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp2b">
<span class="eqno">(46.21)<a class="headerlink" href="#equation-eqn-amssapp2b" title="Link to this equation">#</a></span>\[b_t(s^{t-1})  = c_t(s^t) -  { \frac{u_{l,t}(s^t)}{u_{c,t}(s^t)}} n_t(s^t) +
{\frac{\beta (\mathbb E_t u_{c,t+1}) b_{t+1}(s^t)}{u_{c,t}}}\]</div>
<p>The right side of equation <a class="reference internal" href="#equation-eqn-amssapp2b">(46.21)</a> expresses the time <span class="math notranslate nohighlight">\(t\)</span> value of government debt
in terms of a linear combination of terms whose individual components
are measurable with respect to <span class="math notranslate nohighlight">\(s^t\)</span>.</p>
<p>The sum  of terms on the right side  of equation <a class="reference internal" href="#equation-eqn-amssapp2b">(46.21)</a> must equal
<span class="math notranslate nohighlight">\(b_t(s^{t-1})\)</span>.</p>
<p>That implies that it has to be <em>measurable</em> with respect to <span class="math notranslate nohighlight">\(s^{t-1}\)</span>.</p>
<p>Equations <a class="reference internal" href="#equation-eqn-amssapp2b">(46.21)</a> are the <em>measurability constraints</em> that the AMSS model adds to the single time <span class="math notranslate nohighlight">\(0\)</span> implementation
constraint imposed in the Lucas and Stokey model.</p>
</section>
<section id="two-bellman-equations">
<h3><span class="section-number">46.3.3. </span>Two Bellman equations<a class="headerlink" href="#two-bellman-equations" title="Link to this heading">#</a></h3>
<p>Let <span class="math notranslate nohighlight">\(\Pi(s|s_-)\)</span> be a Markov transition matrix whose entries tell probabilities of moving from state <span class="math notranslate nohighlight">\(s_-\)</span> to state <span class="math notranslate nohighlight">\(s\)</span> in one period.</p>
<p>Let</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(V(x_-, s_-)\)</span> be the continuation value of a continuation
Ramsey plan at <span class="math notranslate nohighlight">\(x_{t-1} = x_-, s_{t-1} =s_-\)</span> for <span class="math notranslate nohighlight">\(t \geq 1\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(W(b, s)\)</span> be the value of the Ramsey plan at time <span class="math notranslate nohighlight">\(0\)</span> at
<span class="math notranslate nohighlight">\(b_0=b\)</span> and <span class="math notranslate nohighlight">\(s_0 = s\)</span></p></li>
</ul>
<p>We distinguish between two types of planners:</p>
<p>For <span class="math notranslate nohighlight">\(t \geq 1\)</span>, the value function for a <strong>continuation Ramsey planner</strong>
satisfies the Bellman equation</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp5">
<span class="eqno">(46.22)<a class="headerlink" href="#equation-eqn-amssapp5" title="Link to this equation">#</a></span>\[V(x_-,s_-) = \max_{\{n(s), x(s)\}} \sum_s \Pi(s|s_-) \left[ u(n(s) -
g(s), 1-n(s)) + \beta V(x(s),s) \right]\]</div>
<p>subject to the following collection of implementability constraints, one
for each <span class="math notranslate nohighlight">\(s \in {\cal S}\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp6">
<span class="eqno">(46.23)<a class="headerlink" href="#equation-eqn-amssapp6" title="Link to this equation">#</a></span>\[{\frac{u_c(s) x_- }{\beta \sum_{\tilde s} \Pi(\tilde s|s_-) u_c(\tilde s) }}
= u_c(s) (n(s) - g(s)) - u_l(s) n(s) + x(s)\]</div>
<p>A continuation Ramsey planner at <span class="math notranslate nohighlight">\(t \geq 1\)</span> takes
<span class="math notranslate nohighlight">\((x_{t-1}, s_{t-1}) = (x_-, s_-)\)</span> as given and before
<span class="math notranslate nohighlight">\(s\)</span> is realized chooses
<span class="math notranslate nohighlight">\((n_t(s_t), x_t(s_t)) = (n(s), x(s))\)</span> for <span class="math notranslate nohighlight">\(s \in  {\cal S}\)</span>.</p>
<p>The <strong>Ramsey planner</strong> takes <span class="math notranslate nohighlight">\((b_0, s_0)\)</span> as given and chooses <span class="math notranslate nohighlight">\((n_0, x_0)\)</span>.</p>
<p>The value function <span class="math notranslate nohighlight">\(W(b_0, s_0)\)</span>   for the time <span class="math notranslate nohighlight">\(t=0\)</span> Ramsey planner
satisfies the Bellman equation</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp100">
<span class="eqno">(46.24)<a class="headerlink" href="#equation-eqn-amssapp100" title="Link to this equation">#</a></span>\[W(b_0, s_0) = \max_{n_0, x_0} u(n_0 - g_0, 1-n_0) + \beta V(x_0,s_0)\]</div>
<p>where maximization is subject to</p>
<div class="math notranslate nohighlight" id="equation-eqn-ammssapp101">
<span class="eqno">(46.25)<a class="headerlink" href="#equation-eqn-ammssapp101" title="Link to this equation">#</a></span>\[u_{c,0} b_0 = u_{c,0} (n_0-g_0) - u_{l,0} n_0 + x_0\]</div>
</section>
<section id="martingale-supercedes-state-variable-degeneracy">
<h3><span class="section-number">46.3.4. </span>Martingale supercedes state-variable degeneracy<a class="headerlink" href="#martingale-supercedes-state-variable-degeneracy" title="Link to this heading">#</a></h3>
<p>Let <span class="math notranslate nohighlight">\(\mu(s|s_-) \Pi(s|s_-)\)</span> be a Lagrange multiplier on the constraint <a class="reference internal" href="#equation-eqn-amssapp6">(46.23)</a>
for state <span class="math notranslate nohighlight">\(s\)</span>.</p>
<p>After forming an appropriate Lagrangian, we find that the continuation Ramsey planner’s first-order
condition with respect to <span class="math notranslate nohighlight">\(x(s)\)</span> is</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp7">
<span class="eqno">(46.26)<a class="headerlink" href="#equation-eqn-amssapp7" title="Link to this equation">#</a></span>\[\beta V_x(x(s),s) = \mu(s|s_-)\]</div>
<p>Applying an envelope theorem to Bellman equation <a class="reference internal" href="#equation-eqn-amssapp5">(46.22)</a> gives</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp8">
<span class="eqno">(46.27)<a class="headerlink" href="#equation-eqn-amssapp8" title="Link to this equation">#</a></span>\[V_x(x_-,s_-) = \sum_s \Pi(s|s_-) \mu(s|s_-) {\frac{u_c(s)}{\beta \sum_{\tilde s}
\Pi(\tilde s|s_-) u_c(\tilde s) }}\]</div>
<p>Equations <a class="reference internal" href="#equation-eqn-amssapp7">(46.26)</a> and <a class="reference internal" href="#equation-eqn-amssapp8">(46.27)</a> imply that</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp9">
<span class="eqno">(46.28)<a class="headerlink" href="#equation-eqn-amssapp9" title="Link to this equation">#</a></span>\[V_x(x_-, s_-) = \sum_{s} \left( \Pi(s|s_-) {\frac{u_c(s)}{\sum_{\tilde s}
\Pi(\tilde s| s_-) u_c(\tilde s)}} \right) V_x(x, s)\]</div>
<p>Equation <a class="reference internal" href="#equation-eqn-amssapp9">(46.28)</a> states that <span class="math notranslate nohighlight">\(V_x(x, s)\)</span> is a <em>risk-adjusted martingale</em>.</p>
<p>Saying that <span class="math notranslate nohighlight">\(V_x(x, s)\)</span> is a risk-adjusted martingale  means  that
<span class="math notranslate nohighlight">\(V_x(x, s)\)</span>  is a martingale with respect to the probability distribution
over <span class="math notranslate nohighlight">\(s^t\)</span> sequences that are generated by the <em>twisted</em> transition probability matrix:</p>
<div class="math notranslate nohighlight">
\[
\check \Pi(s|s_-) \equiv \Pi(s|s_-) {\frac{u_c(s)}{\sum_{\tilde s}
\Pi(\tilde s| s_-) u_c(\tilde s)}}
\]</div>
<div class="exercise admonition" id="amss_ex1">

<p class="admonition-title"><span class="caption-number">Exercise 46.1 </span></p>
<section id="exercise-content">
<p>Please verify that <span class="math notranslate nohighlight">\(\check \Pi(s|s_-)\)</span> is a valid Markov
transition density, i.e., that its elements are all non-negative and
that for each <span class="math notranslate nohighlight">\(s_-\)</span>, the sum over <span class="math notranslate nohighlight">\(s\)</span> equals unity.</p>
</section>
</div>
</section>
<section id="absence-of-state-variable-degeneracy">
<h3><span class="section-number">46.3.5. </span>Absence of state variable degeneracy<a class="headerlink" href="#absence-of-state-variable-degeneracy" title="Link to this heading">#</a></h3>
<p>Along a Ramsey plan, the state variable <span class="math notranslate nohighlight">\(x_t = x_t(s^t, b_0)\)</span>
becomes a function of the history <span class="math notranslate nohighlight">\(s^t\)</span> and initial
government debt <span class="math notranslate nohighlight">\(b_0\)</span>.</p>
<p>In <a class="reference internal" href="opt_tax_recur.html"><span class="doc">Lucas-Stokey model</span></a>, we
found that</p>
<ul class="simple">
<li><p>a counterpart to <span class="math notranslate nohighlight">\(V_x(x,s)\)</span> is time-invariant and equal to
the Lagrange multiplier on the Lucas-Stokey implementability constraint</p></li>
<li><p>time invariance of <span class="math notranslate nohighlight">\(V_x(x,s)\)</span>  is the source of a key
feature of the Lucas-Stokey model, namely, <strong>state variable degeneracy</strong> in which <span class="math notranslate nohighlight">\(x_t\)</span> is an exact time-invariant function of <span class="math notranslate nohighlight">\(s_t\)</span>.</p></li>
</ul>
<p>That <span class="math notranslate nohighlight">\(V_x(x,s)\)</span> varies over time according to a twisted martingale
means that there is no state-variable degeneracy in the AMSS model.</p>
<p>In the AMSS model, both <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(s\)</span> are needed to describe the state.</p>
<p>This property of the AMSS model  transmits a twisted martingale
component to consumption, employment, and the tax rate.</p>
</section>
<section id="digression-on-non-negative-transfers">
<h3><span class="section-number">46.3.6. </span>Digression on non-negative transfers<a class="headerlink" href="#digression-on-non-negative-transfers" title="Link to this heading">#</a></h3>
<p>Throughout this lecture, we have imposed that transfers <span class="math notranslate nohighlight">\(T_t = 0\)</span>.</p>
<p>AMSS <span id="id9">[<a class="reference internal" href="zreferences.html#id133" title="S Rao Aiyagari, Albert Marcet, Thomas J Sargent, and Juha Seppälä. Optimal taxation without state-contingent debt. Journal of Political Economy, 110(6):1220–1254, 2002.">Aiyagari <em>et al.</em>, 2002</a>]</span> instead imposed a nonnegativity
constraint <span class="math notranslate nohighlight">\(T_t\geq 0\)</span> on transfers.</p>
<p>They also considered a special case of quasi-linear preferences,
<span class="math notranslate nohighlight">\(u(c,l)= c + H(l)\)</span>.</p>
<p>In this case, <span class="math notranslate nohighlight">\(V_x(x,s)\leq 0\)</span> is a non-positive martingale.</p>
<p>By the <em>martingale convergence theorem</em>  <span class="math notranslate nohighlight">\(V_x(x,s)\)</span> converges almost surely.</p>
<p>Furthermore, when the Markov chain <span class="math notranslate nohighlight">\(\Pi(s| s_-)\)</span> and the government
expenditure function <span class="math notranslate nohighlight">\(g(s)\)</span> are such that <span class="math notranslate nohighlight">\(g_t\)</span> is perpetually
random, <span class="math notranslate nohighlight">\(V_x(x, s)\)</span> almost surely converges to zero.</p>
<p>For quasi-linear preferences, the first-order condition for maximizing <a class="reference internal" href="#equation-eqn-amssapp5">(46.22)</a> subject to  <a class="reference internal" href="#equation-eqn-amssapp6">(46.23)</a> with respect to <span class="math notranslate nohighlight">\(n(s)\)</span> becomes</p>
<div class="math notranslate nohighlight">
\[
(1-\mu(s|s_-) ) (1 - u_l(s)) + \mu(s|s_-) n(s) u_{ll}(s) =0
\]</div>
<p>When <span class="math notranslate nohighlight">\(\mu(s|s_-) = \beta V_x(x(s),x)\)</span> converges to zero, in the limit
<span class="math notranslate nohighlight">\(u_l(s)= 1 =u_c(s)\)</span>, so that <span class="math notranslate nohighlight">\(\tau(x(s),s) =0\)</span>.</p>
<p>Thus, in the limit, if <span class="math notranslate nohighlight">\(g_t\)</span> is perpetually random,  the government
accumulates sufficient assets to finance all expenditures from earnings on those
assets, returning any excess revenues to the household as non-negative lump-sum transfers.</p>
</section>
<section id="code">
<h3><span class="section-number">46.3.7. </span>Code<a class="headerlink" href="#code" title="Link to this heading">#</a></h3>
<p>The recursive formulation is implemented as follows</p>
<div class="cell tag_collapse-20 docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">quantecon</span><span class="w"> </span><span class="kn">import</span> <span class="n">optimize</span>

<span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_grid_nodes</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the actual grid points from a grid tuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span> <span class="o">=</span> <span class="n">grid</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span><span class="p">)</span>

<span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">linear_interp_1d_scalar</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">x_val</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for scalar interpolation&quot;&quot;&quot;</span>
    <span class="n">x_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span><span class="p">)</span>
    
    <span class="c1"># Extrapolation with linear extension</span>
    <span class="k">if</span> <span class="n">x_val</span> <span class="o">&lt;=</span> <span class="n">x_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># Linear extrapolation using first two points</span>
        <span class="k">if</span> <span class="n">x_num</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">y_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_val</span> <span class="o">-</span> <span class="n">x_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">x_val</span> <span class="o">&gt;=</span> <span class="n">x_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1"># Linear extrapolation using last two points</span>
        <span class="k">if</span> <span class="n">x_num</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_values</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">y_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_val</span> <span class="o">-</span> <span class="n">x_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Binary search for the right interval</span>
    <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">x_num</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">x_nodes</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_val</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span>
    
    <span class="c1"># Linear interpolation</span>
    <span class="n">x_left</span> <span class="o">=</span> <span class="n">x_nodes</span><span class="p">[</span><span class="n">left</span><span class="p">]</span>
    <span class="n">x_right</span> <span class="o">=</span> <span class="n">x_nodes</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>
    <span class="n">y_left</span> <span class="o">=</span> <span class="n">y_values</span><span class="p">[</span><span class="n">left</span><span class="p">]</span>
    <span class="n">y_right</span> <span class="o">=</span> <span class="n">y_values</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>
    
    <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_val</span> <span class="o">-</span> <span class="n">x_left</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_right</span> <span class="o">-</span> <span class="n">x_left</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y_left</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">weight</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_right</span> <span class="o">*</span> <span class="n">weight</span>

<span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">linear_interp_1d</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">x_query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform 1D linear interpolation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span> <span class="o">=</span> <span class="n">x_grid</span>
    <span class="k">return</span> <span class="n">linear_interp_1d_scalar</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">x_query</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AMSS</span><span class="p">:</span>
    <span class="c1"># WARNING: THE CODE IS EXTREMELY SENSITIVE TO CHOCIES OF PARAMETERS.</span>
    <span class="c1"># DO NOT CHANGE THE PARAMETERS AND EXPECT IT TO WORK</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pref</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">Π</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">bounds_v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">β</span><span class="p">,</span> <span class="n">Π</span><span class="p">,</span> <span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span> <span class="o">=</span> <span class="n">x_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Π</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds_v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pref</span> <span class="o">=</span> <span class="n">pref</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">T_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_w</span> <span class="o">=</span> <span class="n">bellman_operator_factory</span><span class="p">(</span><span class="n">Π</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span>
                                                      <span class="n">bounds_v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">V_solved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_solved</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_V</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">σ_v_star</span><span class="p">,</span> <span class="n">tol_vfi</span><span class="p">,</span> <span class="n">maxitr</span><span class="p">,</span> <span class="n">print_itr</span><span class="p">):</span>

        <span class="n">T_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">V_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

        <span class="n">Δ</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">itr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxitr</span><span class="p">):</span>
            <span class="n">T_v</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">V_new</span><span class="p">,</span> <span class="n">σ_v_star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pref</span><span class="p">)</span>

            <span class="n">Δ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">V_new</span> <span class="o">-</span> <span class="n">V</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">Δ</span> <span class="o">&lt;</span> <span class="n">tol_vfi</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_solved</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully completed VFI after </span><span class="si">%i</span><span class="s1"> iterations&#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">itr</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">itr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">print_itr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error at iteration </span><span class="si">%i</span><span class="s1"> : &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">itr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Δ</span><span class="p">)</span>

            <span class="n">V</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">V_new</span><span class="p">[:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">σ_v_star</span> <span class="o">=</span> <span class="n">σ_v_star</span>

        <span class="k">return</span> <span class="n">V</span><span class="p">,</span> <span class="n">σ_v_star</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_W</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b_0</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">σ_w_star</span><span class="p">):</span>
        <span class="n">T_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_w</span>
        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span>

        <span class="n">T_w</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">σ_w_star</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">b_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pref</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">σ_w_star</span> <span class="o">=</span> <span class="n">σ_w_star</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_solved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Succesfully solved the time 0 problem.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">W</span><span class="p">,</span> <span class="n">σ_w_star</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">σ_v_star</span><span class="p">,</span>  <span class="n">b_0</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">σ_w_star</span><span class="p">,</span> <span class="n">tol_vfi</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span>
              <span class="n">maxitr</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">print_itr</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===============&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solve time 1 problem&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===============&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_V</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">σ_v_star</span><span class="p">,</span> <span class="n">tol_vfi</span><span class="p">,</span> <span class="n">maxitr</span><span class="p">,</span> <span class="n">print_itr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===============&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solve time 0 problem&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===============&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_W</span><span class="p">(</span><span class="n">b_0</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">σ_w_star</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s_hist</span><span class="p">,</span> <span class="n">b_0</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_solved</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_solved</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;V and W need to be successfully computed before simulation.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">pref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pref</span>
        <span class="n">x_grid</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span>
        <span class="n">σ_v_star</span><span class="p">,</span> <span class="n">σ_w_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">σ_v_star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">σ_w_star</span>
        <span class="n">Π</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Π</span>

        <span class="c1"># Extract the grid tuple from the list</span>
        <span class="n">grid_tuple</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x_grid</span>

        <span class="n">T</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_hist</span><span class="p">)</span>
        <span class="n">s_0</span> <span class="o">=</span> <span class="n">s_hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Pre-allocate</span>
        <span class="n">n_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">x_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">c_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">τ_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">b_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">g_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># Compute t = 0</span>
        <span class="n">l_0</span><span class="p">,</span> <span class="n">T_0</span> <span class="o">=</span> <span class="n">σ_w_star</span><span class="p">[</span><span class="n">s_0</span><span class="p">]</span>
        <span class="n">c_0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l_0</span><span class="p">)</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="n">s_0</span><span class="p">]</span>
        <span class="n">x_0</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c_0</span><span class="p">,</span> <span class="n">l_0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">c_0</span> <span class="o">-</span> <span class="n">T_0</span> <span class="o">-</span> <span class="n">b_0</span><span class="p">)</span> <span class="o">+</span>
               <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span><span class="p">(</span><span class="n">c_0</span><span class="p">,</span> <span class="n">l_0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l_0</span><span class="p">))</span>

        <span class="n">n_hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l_0</span><span class="p">)</span>
        <span class="n">x_hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_0</span>
        <span class="n">c_hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_0</span>
        <span class="n">τ_hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span><span class="p">(</span><span class="n">c_0</span><span class="p">,</span> <span class="n">l_0</span><span class="p">)</span> <span class="o">/</span> <span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c_0</span><span class="p">,</span> <span class="n">l_0</span><span class="p">)</span>
        <span class="n">b_hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_0</span>
        <span class="n">g_hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">s_0</span><span class="p">]</span>

        <span class="c1"># Compute t &gt; 0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">x_</span> <span class="o">=</span> <span class="n">x_hist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">s_</span> <span class="o">=</span> <span class="n">s_hist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
                <span class="n">x_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_</span><span class="p">])</span>
                <span class="n">l</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_interp_1d</span><span class="p">(</span><span class="n">grid_tuple</span><span class="p">,</span> <span class="n">σ_v_star</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:,</span> <span class="n">s</span><span class="p">],</span> <span class="n">x_arr</span><span class="p">)</span>
                <span class="n">T</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_interp_1d</span><span class="p">(</span><span class="n">grid_tuple</span><span class="p">,</span> <span class="n">σ_v_star</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:,</span> <span class="n">S</span><span class="o">+</span><span class="n">s</span><span class="p">],</span> <span class="n">x_arr</span><span class="p">)</span>

            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">g</span>
            <span class="n">u_c</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
            <span class="n">Eu_c</span> <span class="o">=</span> <span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="n">u_c</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">u_c</span> <span class="o">*</span> <span class="n">x_</span> <span class="o">/</span> <span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">Eu_c</span><span class="p">)</span> <span class="o">-</span> <span class="n">u_c</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>

            <span class="n">c_next</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">s_hist</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">l_next</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">s_hist</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>

            <span class="n">x_hist</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">s_hist</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">n_hist</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">l_next</span>
            <span class="n">c_hist</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_next</span>
            <span class="n">τ_hist</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span><span class="p">(</span><span class="n">c_next</span><span class="p">,</span> <span class="n">l_next</span><span class="p">)</span> <span class="o">/</span> <span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c_next</span><span class="p">,</span> <span class="n">l_next</span><span class="p">)</span>
            <span class="n">b_hist</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_</span> <span class="o">/</span> <span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">Eu_c</span><span class="p">)</span>
            <span class="n">g_hist</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">s_hist</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">c_hist</span><span class="p">,</span> <span class="n">n_hist</span><span class="p">,</span> <span class="n">b_hist</span><span class="p">,</span> <span class="n">τ_hist</span><span class="p">,</span> <span class="n">g_hist</span><span class="p">,</span> <span class="n">n_hist</span>


<span class="k">def</span><span class="w"> </span><span class="nf">obj_factory</span><span class="p">(</span><span class="n">Π</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
    <span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Π</span><span class="p">)</span>
    <span class="c1"># Extract the grid tuple from the list</span>
    <span class="n">grid_tuple</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x_grid</span>

    <span class="nd">@njit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">obj_V</span><span class="p">(</span><span class="n">σ</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">pref</span><span class="p">):</span>
        <span class="c1"># Unpack state</span>
        <span class="n">s_</span><span class="p">,</span> <span class="n">x_</span> <span class="o">=</span> <span class="n">state</span>

        <span class="n">l</span> <span class="o">=</span> <span class="n">σ</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">σ</span><span class="p">[</span><span class="n">S</span><span class="p">:]</span>

        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">g</span>
        <span class="n">u_c</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
        <span class="n">Eu_c</span> <span class="o">=</span> <span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="n">u_c</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">u_c</span> <span class="o">*</span> <span class="n">x_</span> <span class="o">/</span> <span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">Eu_c</span><span class="p">)</span> <span class="o">-</span> <span class="n">u_c</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>

        <span class="n">V_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="n">V_next</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear_interp_1d</span><span class="p">(</span><span class="n">grid_tuple</span><span class="p">,</span> <span class="n">V</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]]))</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">pref</span><span class="o">.</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">β</span> <span class="o">*</span> <span class="n">V_next</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@njit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">obj_W</span><span class="p">(</span><span class="n">σ</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">pref</span><span class="p">):</span>
        <span class="c1"># Unpack state</span>
        <span class="n">s_</span><span class="p">,</span> <span class="n">b_0</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">σ</span>

        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">pref</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">T</span> <span class="o">-</span> <span class="n">b_0</span><span class="p">)</span> <span class="o">+</span> <span class="n">pref</span><span class="o">.</span><span class="n">Ul</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>

        <span class="n">V_next</span> <span class="o">=</span> <span class="n">linear_interp_1d</span><span class="p">(</span><span class="n">grid_tuple</span><span class="p">,</span> <span class="n">V</span><span class="p">[</span><span class="n">s_</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">]))</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">pref</span><span class="o">.</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">β</span> <span class="o">*</span> <span class="n">V_next</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">return</span> <span class="n">obj_V</span><span class="p">,</span> <span class="n">obj_W</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bellman_operator_factory</span><span class="p">(</span><span class="n">Π</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">bounds_v</span><span class="p">):</span>
    <span class="n">obj_V</span><span class="p">,</span> <span class="n">obj_W</span> <span class="o">=</span> <span class="n">obj_factory</span><span class="p">(</span><span class="n">Π</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
    <span class="c1"># Extract the grid tuple from the list</span>
    <span class="n">grid_tuple</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x_grid</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">grid_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Π</span><span class="p">)</span>
    <span class="n">x_nodes</span> <span class="o">=</span> <span class="n">get_grid_nodes</span><span class="p">(</span><span class="n">grid_tuple</span><span class="p">)</span>

    <span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">T_v</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">V_new</span><span class="p">,</span> <span class="n">σ_star</span><span class="p">,</span> <span class="n">pref</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x_i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_</span><span class="p">,</span> <span class="n">x_nodes</span><span class="p">[</span><span class="n">x_i</span><span class="p">])</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">σ_star</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="n">x_i</span><span class="p">]</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">nelder_mead</span><span class="p">(</span><span class="n">obj_V</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds_v</span><span class="p">,</span>
                                           <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">pref</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                    <span class="n">V_new</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="n">x_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fun</span>
                    <span class="n">σ_star</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="n">x_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimization routine failed.&quot;</span><span class="p">)</span>

    <span class="n">bounds_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">9.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">]])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">T_w</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">σ_star</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">b_0</span><span class="p">,</span> <span class="n">pref</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_</span><span class="p">,</span> <span class="n">b_0</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">σ_star</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">nelder_mead</span><span class="p">(</span><span class="n">obj_W</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds_w</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">pref</span><span class="p">))</span>

            <span class="n">W</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fun</span>
            <span class="n">σ_star</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

    <span class="k">return</span> <span class="n">T_v</span><span class="p">,</span> <span class="n">T_w</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="examples">
<h2><span class="section-number">46.4. </span>Examples<a class="headerlink" href="#examples" title="Link to this heading">#</a></h2>
<p>We now turn to some examples.</p>
<section id="anticipated-one-period-war">
<h3><span class="section-number">46.4.1. </span>Anticipated one-period war<a class="headerlink" href="#anticipated-one-period-war" title="Link to this heading">#</a></h3>
<p>In our lecture on <a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state-contingent debt</span></a>
we studied how the government manages uncertainty in a simple setting.</p>
<p>As in that lecture, we assume the one-period utility function</p>
<div class="math notranslate nohighlight">
\[
u(c,n) = {\frac{c^{1-\sigma}}{1-\sigma}} - {\frac{n^{1+\gamma}}{1+\gamma}}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For convenience in  matching our computer code, we have expressed
utility as a function of <span class="math notranslate nohighlight">\(n\)</span> rather than leisure <span class="math notranslate nohighlight">\(l\)</span>.</p>
</div>
<p>We first consider a government expenditure process that we  studied earlier in a lecture on
<a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state-contingent debt</span></a>.</p>
<p>Government expenditures are known for sure in all periods except one.</p>
<ul class="simple">
<li><p>For <span class="math notranslate nohighlight">\(t&lt;3\)</span> or <span class="math notranslate nohighlight">\(t &gt; 3\)</span> we assume that <span class="math notranslate nohighlight">\(g_t = g_l = 0.1\)</span>.</p></li>
<li><p>At <span class="math notranslate nohighlight">\(t = 3\)</span> a war occurs with probability 0.5.</p>
<ul>
<li><p>If there is war, <span class="math notranslate nohighlight">\(g_3 = g_h = 0.2\)</span>.</p></li>
<li><p>If there is no war <span class="math notranslate nohighlight">\(g_3 = g_l = 0.1\)</span>.</p></li>
</ul>
</li>
</ul>
<p>A useful trick is to define  components of the state vector as the following six
<span class="math notranslate nohighlight">\((t,g)\)</span> pairs:</p>
<div class="math notranslate nohighlight">
\[
(0,g_l), (1,g_l), (2,g_l), (3,g_l), (3,g_h), (t\geq 4,g_l)
\]</div>
<p>We think of these 6 states as corresponding to <span class="math notranslate nohighlight">\(s=1,2,3,4,5,6\)</span>.</p>
<p>The transition matrix is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
P = \begin{pmatrix}
  0 &amp; 1 &amp; 0 &amp; 0   &amp; 0   &amp; 0\\
  0 &amp; 0 &amp; 1 &amp; 0   &amp; 0   &amp; 0\\
  0 &amp; 0 &amp; 0 &amp; 0.5 &amp; 0.5 &amp; 0\\
  0 &amp; 0 &amp; 0 &amp; 0   &amp; 0   &amp; 1\\
  0 &amp; 0 &amp; 0 &amp; 0   &amp; 0   &amp; 1\\
  0 &amp; 0 &amp; 0 &amp; 0   &amp; 0   &amp; 1
\end{pmatrix}
\end{split}\]</div>
<p>The government expenditure at  each state is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
g = \left(\begin{matrix} 0.1\\0.1\\0.1\\0.1\\0.2\\0.1 \end{matrix}\right)
\end{split}\]</div>
<p>We assume the same utility parameters as in the <a class="reference internal" href="opt_tax_recur.html"><span class="doc">Lucas-Stokey economy</span></a>.</p>
<p>This utility function is implemented in the following class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crra_util_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;β&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;σ&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;γ&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">)</span>
<span class="p">]</span>

<span class="nd">@jitclass</span><span class="p">(</span><span class="n">crra_util_data</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CRRAutility</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">β</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                 <span class="n">σ</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">γ</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">σ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span> <span class="o">=</span> <span class="n">β</span><span class="p">,</span> <span class="n">σ</span><span class="p">,</span> <span class="n">γ</span>

    <span class="c1"># Utility function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">U</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="c1"># Note: `l` should not be interpreted as labor, it is an auxiliary</span>
        <span class="c1"># variable used to conveniently match the code and the equations</span>
        <span class="c1"># in the lecture</span>
        <span class="n">σ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">σ</span>
        <span class="k">if</span> <span class="n">σ</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">U</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">σ</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">σ</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">U</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">l</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="p">)</span>

    <span class="c1"># Derivatives of utility function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Uc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">c</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">σ</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ucc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">σ</span> <span class="o">*</span> <span class="n">c</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">σ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">l</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">l</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ucl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ulc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>The following figure plots  Ramsey plans under complete and incomplete
markets for both possible realizations of the state at time <span class="math notranslate nohighlight">\(t=3\)</span>.</p>
<p>Ramsey outcomes and  policies when  the government has  access to state-contingent debt are
represented by black lines and  by red lines when there is only a risk-free bond.</p>
<p>Paths with circles are histories in which there is peace, while those with
triangle denote war.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WARNING: DO NOT EXPECT THE CODE TO WORK IF YOU CHANGE PARAMETERS</span>
<span class="n">σ</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">γ</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">β</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">Π</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]])</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>

<span class="n">x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5555</span>
<span class="n">x_max</span> <span class="o">=</span> <span class="mf">17.339</span>
<span class="n">x_num</span> <span class="o">=</span> <span class="mi">300</span>

<span class="n">x_grid</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span><span class="p">)]</span>

<span class="n">crra_pref</span> <span class="o">=</span> <span class="n">CRRAutility</span><span class="p">(</span><span class="n">β</span><span class="o">=</span><span class="n">β</span><span class="p">,</span> <span class="n">σ</span><span class="o">=</span><span class="n">σ</span><span class="p">,</span> <span class="n">γ</span><span class="o">=</span><span class="n">γ</span><span class="p">)</span>

<span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Π</span><span class="p">)</span>
<span class="n">bounds_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">S</span><span class="p">)]),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="n">g</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)])])</span><span class="o">.</span><span class="n">T</span>

<span class="n">amss_model</span> <span class="o">=</span> <span class="n">AMSS</span><span class="p">(</span><span class="n">crra_pref</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">Π</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">bounds_v</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WARNING: DO NOT EXPECT THE CODE TO WORK IF YOU CHANGE PARAMETERS</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Π</span><span class="p">),</span> <span class="n">x_num</span><span class="p">))</span>
<span class="n">V</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">get_grid_nodes</span><span class="p">(</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>

<span class="n">σ_v_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">S</span><span class="p">,</span> <span class="n">x_num</span><span class="p">,</span> <span class="n">S</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">σ_v_star</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Π</span><span class="p">))</span>
<span class="n">b_0</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">σ_w_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">S</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">σ_w_star</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.05</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">amss_model</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">σ_v_star</span><span class="p">,</span> <span class="n">b_0</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">σ_w_star</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===============
Solve time 1 problem
===============
Error at iteration 10 :  1.1100648401378521
Error at iteration 20 :  0.3078488587643786
Error at iteration 30 :  0.03221851531398201
Error at iteration 40 :  0.014347598008733087
Error at iteration 50 :  0.00312194446313363
Error at iteration 60 :  0.00107836473551437
Error at iteration 70 :  0.0003761255356202753
Error at iteration 80 :  0.0001318127597098595
Error at iteration 90 :  4.650031579700453e-05
Error at iteration 100 :  1.8013777079772808e-05
Error at iteration 110 :  6.175872597324883e-06
Error at iteration 120 :  2.445029183562042e-06
Error at iteration 130 :  1.0836745936160241e-06
Error at iteration 140 :  5.6828771199946e-07
Error at iteration 150 :  3.567560948880555e-07
Error at iteration 160 :  2.5837734796141376e-07
Error at iteration 170 :  2.0475366468986067e-07
Error at iteration 180 :  1.7066849622437985e-07
Error at iteration 190 :  1.4622036381695125e-07
Error at iteration 200 :  1.2738777854792716e-07
Error at iteration 210 :  1.1226231499961159e-07
Successfully completed VFI after 220 iterations
===============
Solve time 0 problem
===============
Succesfully solved the time 0 problem.
CPU times: user 3min 34s, sys: 1.57 s, total: 3min 35s
Wall time: 1min 49s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solve the LS model</span>
<span class="n">ls_model</span> <span class="o">=</span> <span class="n">SequentialLS</span><span class="p">(</span><span class="n">crra_pref</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">π</span><span class="o">=</span><span class="n">Π</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WARNING: DO NOT EXPECT THE CODE TO WORK IF YOU CHANGE PARAMETERS</span>
<span class="n">s_hist_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">s_hist_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

<span class="n">sim_h_amss</span> <span class="o">=</span> <span class="n">amss_model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">s_hist_h</span><span class="p">,</span> <span class="n">b_0</span><span class="p">)</span>
<span class="n">sim_l_amss</span> <span class="o">=</span> <span class="n">amss_model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">s_hist_l</span><span class="p">,</span> <span class="n">b_0</span><span class="p">)</span>

<span class="n">sim_h_ls</span> <span class="o">=</span> <span class="n">ls_model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">b_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">s_hist_h</span><span class="p">)</span>
<span class="n">sim_l_ls</span> <span class="o">=</span> <span class="n">ls_model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">b_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">s_hist_l</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Consumption&#39;</span><span class="p">,</span> <span class="s1">&#39;Labor Supply&#39;</span><span class="p">,</span> <span class="s1">&#39;Government Debt&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Tax Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;Government Spending&#39;</span><span class="p">,</span> <span class="s1">&#39;Output&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ls_l</span><span class="p">,</span> <span class="n">ls_h</span><span class="p">,</span> <span class="n">amss_l</span><span class="p">,</span> <span class="n">amss_h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">titles</span><span class="p">,</span>
                                                 <span class="n">sim_l_ls</span><span class="p">,</span> <span class="n">sim_h_ls</span><span class="p">,</span>
                                                 <span class="n">sim_l_amss</span><span class="p">,</span> <span class="n">sim_h_amss</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls_l</span><span class="p">,</span> <span class="s1">&#39;-ok&#39;</span><span class="p">,</span> <span class="n">ls_h</span><span class="p">,</span> <span class="s1">&#39;-^k&#39;</span><span class="p">,</span> <span class="n">amss_l</span><span class="p">,</span> <span class="s1">&#39;-or&#39;</span><span class="p">,</span> <span class="n">amss_h</span><span class="p">,</span> <span class="s1">&#39;-^r&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3fe1f1b598f9fce076a94f434f92a3c7014f39b3e44b1cb5ba81470d6322bc36.png" src="_images/3fe1f1b598f9fce076a94f434f92a3c7014f39b3e44b1cb5ba81470d6322bc36.png" />
</div>
</div>
<p>How a Ramsey planner responds to  war depends on the structure of the asset market.</p>
<p>If it is able to trade state-contingent debt, then at time <span class="math notranslate nohighlight">\(t=2\)</span></p>
<ul class="simple">
<li><p>the government <strong>purchases</strong> an Arrow security that pays off when <span class="math notranslate nohighlight">\(g_3 = g_h\)</span></p></li>
<li><p>the government <strong>sells</strong> an Arrow security that  pays off when <span class="math notranslate nohighlight">\(g_3 = g_l\)</span></p></li>
<li><p>the Ramsey planner designs these purchases and sales  designed so  that, regardless of whether or not there is a war at <span class="math notranslate nohighlight">\(t=3\)</span>, the government  begins  period <span class="math notranslate nohighlight">\(t=4\)</span> with the <em>same</em> government debt</p></li>
</ul>
<p>This pattern facilities smoothing tax rates across  states.</p>
<p>The government without state-contingent debt cannot do this.</p>
<p>Instead, it must enter   time <span class="math notranslate nohighlight">\(t=3\)</span> with the same level of debt falling due whether there is peace or war at <span class="math notranslate nohighlight">\(t=3\)</span>.</p>
<p>The risk-free rate between time <span class="math notranslate nohighlight">\(2\)</span> and time <span class="math notranslate nohighlight">\(3\)</span> is unusually <strong>low</strong> because at time <span class="math notranslate nohighlight">\(2\)</span> consumption at time <span class="math notranslate nohighlight">\(3\)</span> is expected to be unusually <strong>low</strong>.</p>
<p>A <strong>low</strong> risk-free rate of return on government debt between time <span class="math notranslate nohighlight">\(2\)</span> and time <span class="math notranslate nohighlight">\(3\)</span> allows the government to enter period <span class="math notranslate nohighlight">\(3\)</span> with <strong>lower</strong> government debt than it entered period <span class="math notranslate nohighlight">\(2\)</span>.</p>
<p>To finance a war at time <span class="math notranslate nohighlight">\(3\)</span> it raises taxes and issues more debt to carry into perpetual peace that begins in period <span class="math notranslate nohighlight">\(4\)</span>.</p>
<p>To service the additional debt burden, it raises taxes in all future periods.</p>
<p>The absence of state-contingent debt leads to an important difference in the
optimal tax policy.</p>
<p>When the Ramsey planner has access to state-contingent debt, the optimal tax
policy is history independent</p>
<ul class="simple">
<li><p>the tax rate is a function  of the current level of government spending only,
given the Lagrange multiplier on the implementability constraint</p></li>
</ul>
<p>Without state-contingent debt, the optimal tax rate is history dependent.</p>
<ul class="simple">
<li><p>A war at time <span class="math notranslate nohighlight">\(t=3\)</span> causes a permanent <strong>increase</strong> in the tax rate.</p></li>
<li><p>Peace at time <span class="math notranslate nohighlight">\(t=3\)</span> causes a permanent <strong>reduction</strong> in the tax rate.</p></li>
</ul>
<section id="perpetual-war-alert">
<h4><span class="section-number">46.4.1.1. </span>Perpetual war alert<a class="headerlink" href="#perpetual-war-alert" title="Link to this heading">#</a></h4>
<p>History dependence occurs more dramatically in a case in which the government
perpetually faces the prospect  of war.</p>
<p>This case was studied in the final example of the lecture on
<a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state-contingent debt</span></a>.</p>
<p>There, each period the government faces a constant probability, <span class="math notranslate nohighlight">\(0.5\)</span>, of war.</p>
<p>In addition, this example features the following preferences</p>
<div class="math notranslate nohighlight">
\[
u(c,n) = \log(c) + 0.69 \log(1-n)
\]</div>
<p>In accordance, we will re-define our utility function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">log_util_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;β&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ψ&#39;</span><span class="p">,</span> <span class="n">float64</span><span class="p">)</span>
<span class="p">]</span>

<span class="nd">@jitclass</span><span class="p">(</span><span class="n">log_util_data</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LogUtility</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">β</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                 <span class="n">ψ</span><span class="o">=</span><span class="mf">0.69</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ψ</span> <span class="o">=</span> <span class="n">β</span><span class="p">,</span> <span class="n">ψ</span>

    <span class="c1"># Utility function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">U</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ψ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="c1"># Derivatives of utility function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Uc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ucc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ψ</span> <span class="o">/</span> <span class="n">l</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ψ</span> <span class="o">/</span> <span class="n">l</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ucl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ulc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>With these preferences, Ramsey tax rates will vary even in the Lucas-Stokey
model with state-contingent debt.</p>
<p>The figure below plots optimal tax policies for both the economy with
state-contingent debt (circles) and the economy with only a risk-free bond
(triangles).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WARNING: DO NOT EXPECT THE CODE TO WORK IF YOU CHANGE PARAMETERS</span>
<span class="n">ψ</span> <span class="o">=</span> <span class="mf">0.69</span>
<span class="n">Π</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">β</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

<span class="n">x_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.4107</span>
<span class="n">x_max</span> <span class="o">=</span> <span class="mf">3.709</span>
<span class="n">x_num</span> <span class="o">=</span> <span class="mi">300</span>

<span class="n">x_grid</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_num</span><span class="p">)]</span>
<span class="n">log_pref</span> <span class="o">=</span> <span class="n">LogUtility</span><span class="p">(</span><span class="n">β</span><span class="o">=</span><span class="n">β</span><span class="p">,</span> <span class="n">ψ</span><span class="o">=</span><span class="n">ψ</span><span class="p">)</span>

<span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Π</span><span class="p">)</span>
<span class="n">bounds_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">1</span> <span class="o">-</span> <span class="n">g</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">S</span><span class="p">)])</span> <span class="p">])</span><span class="o">.</span><span class="n">T</span>

<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Π</span><span class="p">),</span> <span class="n">x_num</span><span class="p">))</span>
<span class="n">V</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">get_grid_nodes</span><span class="p">(</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">14</span>

<span class="n">σ_v_star</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">S</span><span class="p">,</span> <span class="n">x_num</span><span class="p">,</span> <span class="n">S</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.55</span><span class="p">)</span>

<span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Π</span><span class="p">))</span>
<span class="n">b_0</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">σ_w_star</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">S</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.55</span><span class="p">)</span>

<span class="n">amss_model</span> <span class="o">=</span> <span class="n">AMSS</span><span class="p">(</span><span class="n">log_pref</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">Π</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">bounds_v</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">amss_model</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">σ_v_star</span><span class="p">,</span> <span class="n">b_0</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">σ_w_star</span><span class="p">,</span> <span class="n">tol_vfi</span><span class="o">=</span><span class="mf">3e-5</span><span class="p">,</span> <span class="n">maxitr</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span>
                 <span class="n">print_itr</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===============
Solve time 1 problem
===============
Error at iteration 100 :  0.001156912305173563
Error at iteration 200 :  0.0005024950334071576
Error at iteration 300 :  0.0002995618583927495
Error at iteration 400 :  0.00020755613888212565
Error at iteration 500 :  0.00015558458529163488
Error at iteration 600 :  0.00012279319674135536
Error at iteration 700 :  0.00010068073823887858
Error at iteration 800 :  8.470541148142274e-05
Error at iteration 900 :  7.284396057016806e-05
Error at iteration 1000 :  6.370146950018807e-05
Error at iteration 1100 :  5.646858935470789e-05
Error at iteration 1200 :  5.048391475170888e-05
Error at iteration 1300 :  4.564400250117728e-05
Error at iteration 1400 :  4.146706198682182e-05
Error at iteration 1500 :  3.805415133761869e-05
Error at iteration 1600 :  3.521425495733865e-05
Error at iteration 1700 :  3.262771505951889e-05
Error at iteration 1800 :  3.0383804183742313e-05
Successfully completed VFI after 1819 iterations
===============
Solve time 0 problem
===============
Succesfully solved the time 0 problem.
CPU times: user 2min 30s, sys: 1.16 s, total: 2min 31s
Wall time: 1min 36s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ls_model</span> <span class="o">=</span> <span class="n">SequentialLS</span><span class="p">(</span><span class="n">log_pref</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">π</span><span class="o">=</span><span class="n">Π</span><span class="p">)</span>  <span class="c1"># Solve sequential problem</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WARNING: DO NOT EXPECT THE CODE TO WORK IF YOU CHANGE PARAMETERS</span>
<span class="n">s_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

<span class="n">T</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_hist</span><span class="p">)</span>

<span class="n">sim_amss</span> <span class="o">=</span> <span class="n">amss_model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">s_hist</span><span class="p">,</span> <span class="n">b_0</span><span class="p">)</span>
<span class="n">sim_ls</span> <span class="o">=</span> <span class="n">ls_model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">s_hist</span><span class="p">)</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Consumption&#39;</span><span class="p">,</span> <span class="s1">&#39;Labor Supply&#39;</span><span class="p">,</span> <span class="s1">&#39;Government Debt&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Tax Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;Government Spending&#39;</span><span class="p">,</span> <span class="s1">&#39;Output&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">amss</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">titles</span><span class="p">,</span> <span class="n">sim_ls</span><span class="p">,</span> <span class="n">sim_amss</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="s1">&#39;-ok&#39;</span><span class="p">,</span> <span class="n">amss</span><span class="p">,</span> <span class="s1">&#39;-^b&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;Complete Markets&#39;</span><span class="p">,</span> <span class="s1">&#39;Incomplete Markets&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8e0c9143631356f4cbf0205a255e1a5d56a3f72f4c4e8ce2de6a015973996c44.png" src="_images/8e0c9143631356f4cbf0205a255e1a5d56a3f72f4c4e8ce2de6a015973996c44.png" />
</div>
</div>
<p>When the government experiences a prolonged period of peace, it is able to reduce
government debt and set persistently lower tax rates.</p>
<p>However, the government  finances a long war by borrowing and raising taxes.</p>
<p>This results in a drift away from  policies with state-contingent debt that
depends on the history of shocks.</p>
<p>This is even more evident in the following figure that plots the evolution of
the two policies over 200 periods.</p>
<p>This outcome reflects the presence of a force for <strong>precautionary saving</strong> that the incomplete markets structure imparts to the Ramsey plan.</p>
<p>In <a class="reference internal" href="amss2.html"><span class="doc">this subsequent lecture</span></a> and  <a class="reference internal" href="amss3.html"><span class="doc">this subsequent lecture</span></a>, some ultimate consequences of that force are explored.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">s_0</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">mc</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span><span class="n">Π</span><span class="p">)</span>

<span class="n">s_hist_long</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">s_0</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim_amss</span> <span class="o">=</span> <span class="n">amss_model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">s_hist_long</span><span class="p">,</span> <span class="n">b_0</span><span class="p">)</span>
<span class="n">sim_ls</span> <span class="o">=</span> <span class="n">ls_model</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">s_hist_long</span><span class="p">)</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Consumption&#39;</span><span class="p">,</span> <span class="s1">&#39;Labor Supply&#39;</span><span class="p">,</span> <span class="s1">&#39;Government Debt&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Tax Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;Government Spending&#39;</span><span class="p">,</span> <span class="s1">&#39;Output&#39;</span><span class="p">]</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">amss</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">titles</span><span class="p">,</span> <span class="n">sim_ls</span><span class="p">,</span> \
        <span class="n">sim_amss</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">amss</span><span class="p">,</span> <span class="s1">&#39;-.b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;Complete Markets&#39;</span><span class="p">,</span><span class="s1">&#39;Incomplete Markets&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/68af30095fd5deb7d009d80c9f7cc2556249cde4f474a9fcf2fa59a8d8de70a9.png" src="_images/68af30095fd5deb7d009d80c9f7cc2556249cde4f474a9fcf2fa59a8d8de70a9.png" />
</div>
</div>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="fn-a" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">1</a><span class="fn-bracket">]</span></span>
<p>In an allocation that solves the Ramsey problem and that levies distorting
taxes on labor, why would the government ever want to hand revenues back
to the private sector? It would not in an economy with state-contingent debt, since
any such allocation could be improved by lowering distortionary taxes
rather than handing out lump-sum transfers. But, without state-contingent
debt there can be circumstances when a government would like to make
lump-sum transfers to the private sector.</p>
</aside>
<aside class="footnote brackets" id="fn-b" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">2</a><span class="fn-bracket">]</span></span>
<p>From the first-order conditions for the Ramsey
problem, there exists another realization <span class="math notranslate nohighlight">\(\tilde s^t\)</span> with
the same history up until the previous period, i.e., <span class="math notranslate nohighlight">\(\tilde s^{t-1}=
s^{t-1}\)</span>, but where the multiplier on constraint <a class="reference internal" href="#equation-amss-46">(46.11)</a> takes  a positive value, so
<span class="math notranslate nohighlight">\(\gamma_t(\tilde s^t)&gt;0\)</span>.</p>
</aside>
</aside>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                    </div>
                    
                </main> <!-- .page__content -->
                


                <footer class="qe-page__footer">

                    <p><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"></a></p>

                    <p>Creative Commons License &ndash; This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International.</p>

                    <p>A theme by <a href="https://quantecon.org">QuantEcon</a></p>

                </footer> <!-- .page__footer -->

            </div> <!-- .page -->

            

            
            <div class="qe-sidebar bd-sidebar inactive" id="site-navigation">

                <div class="qe-sidebar__header">


                    Contents

                </div>

                <nav class="qe-sidebar__nav" id="qe-sidebar-nav" aria-label="Main navigation">
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tools and Techniques
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="orth_proj.html">
   1. Orthogonal Projections and Their Applications
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="stationary_densities.html">
   2. Continuous State Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="muth_kalman.html">
   3. Reverse Engineering a la Muth
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="discrete_dp.html">
   4. Discrete State Dynamic Programming
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  LQ Control
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="cons_news.html">
   5. Information and Consumption Smoothing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="smoothing.html">
   6. Consumption Smoothing with Complete and Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="smoothing_tax.html">
   7. Tax Smoothing with Complete and Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="markov_jump_lq.html">
   8. Markov Jump Linear Quadratic Dynamic Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_1.html">
   9. How to Pay for a War: Part 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_2.html">
   10. How to Pay for a War: Part 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_3.html">
   11. How to Pay for a War: Part 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lqramsey.html">
   12. Optimal Taxation in an LQ Economy
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Multiple Agent Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="arellano.html">
   13. Default Risk and Income Fluctuations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="matsuyama.html">
   14. Globalization and Cycles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coase.html">
   15. Coase’s Theory of the Firm
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="match_transport.html">
   16. Composite Sorting
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dynamic Linear Economies
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="hs_recursive_models.html">
   17. Recursive Models of Dynamic Linear Economies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="growth_in_dles.html">
   18. Growth in Dynamic Linear Economies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lucas_asset_pricing_dles.html">
   19. Lucas Asset Pricing Using DLE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="irfs_in_hall_model.html">
   20. IRFs in Hall Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="permanent_income_dles.html">
   21. Permanent Income Model using the DLE Class
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rosen_schooling_model.html">
   22. Rosen Schooling Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cattle_cycles.html">
   23. Cattle Cycles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hs_invertibility_example.html">
   24. Shock Non Invertibility
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Risk, Model Uncertainty, and Robustness
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="five_preferences.html">
   25. Risk and Model Uncertainty
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="entropy.html">
   26. Etymology of Entropy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="robustness.html">
   27. Robustness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rob_markov_perf.html">
   28. Robust Markov Perfect Equilibrium
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Time Series Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="arma.html">
   29. Covariance Stationary Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="estspec.html">
   30. Estimation of Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="additive_functionals.html">
   31. Additive and Multiplicative Functionals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lu_tricks.html">
   32. Classical Control with Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="classical_filtering.html">
   33. Classical Prediction and Filtering With Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="knowing_forecasts_of_others.html">
   34. Knowing the Forecasts of Others
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Asset Pricing and Finance
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="lucas_model.html">
   35. Asset Pricing II: The Lucas Asset Pricing Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="asset_pricing_lph.html">
   36. Elementary Asset Pricing Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="black_litterman.html">
   37. Two Modifications of Mean-Variance Portfolio Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="BCG_complete_mkts.html">
   38. Irrelevance of Capital Structures with Complete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="BCG_incomplete_mkts.html">
   39. Equilibrium Capital Structures with Incomplete Markets
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dynamic Programming Squared
 </span>
</p>
<ul class="current nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="un_insure.html">
   40. Optimal Unemployment Insurance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dyn_stack.html">
   41. Stackelberg Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="calvo_machine_learn.html">
   42. Machine Learning a Ramsey Plan
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="calvo.html">
   43. Time Inconsistency of Ramsey Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="calvo_abreu.html">
   44. Sustainable Plans for a Calvo Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="opt_tax_recur.html">
   45. Optimal Taxation with State-Contingent Debt
  </a>
 </li>
 <li class="toctree-l1 current active active">
  <a class="current reference internal" href="#">
   46. Optimal Taxation without State-Contingent Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="amss2.html">
   47. Fluctuating Interest Rates Deliver Fiscal Insurance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="amss3.html">
   48. Fiscal Risk and Government Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chang_ramsey.html">
   49. Competitive Equilibria of a Model of Chang
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chang_credible.html">
   50. Credible Government Policies in a Model of Chang
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="troubleshooting.html">
   51. Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="zreferences.html">
   52. References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="status.html">
   53. Execution Statistics
  </a>
 </li>
</ul>

                </nav>

                <div class="qe-sidebar__footer">

                </div>

            </div> <!-- .sidebar -->
            
        </div> <!-- .main -->

        <div class="qe-toolbar">

            <div class="qe-toolbar__inner">

                <ul class="qe-toolbar__main">
                    <li data-tippy-content="Table of Contents" class="btn__sidebar"><i data-feather="menu"></i></li>
                    <li data-tippy-content="Home"><a href="intro.html"><i data-feather="home"></i></a></li>
                    <li class="btn__qelogo"><a href="https://quantecon.org" title=""><span class="show-for-sr">QuantEcon</span></a></li>
                </ul>

                <ul class="qe-toolbar__links">
                    <li class="btn__search">
                        <form action="search.html" method="get">
                            <input type="search" class="form-control" name="q" id="search-input" placeholder="Search..." aria-label="Search..." autocomplete="off" accesskey="k">
                            <i data-feather="search" id="search-icon"></i>
                        </form>
                    </li>
                    <li data-tippy-content="Fullscreen" class="btn__fullscreen"><i data-feather="maximize"></i></li>
                    <li data-tippy-content="Increase font size" class="btn__plus"><i data-feather="plus-circle"></i></li>
                    <li data-tippy-content="Decrease font size" class="btn__minus"><i data-feather="minus-circle"></i></li>
                    <li data-tippy-content="Change contrast" class="btn__contrast"><i data-feather="sunset"></i></li>
                    <li data-tippy-content="Download Notebook"><a href="/_notebooks/amss.ipynb" download><i data-feather="download-cloud"></i></a></li>
                    <li class="settings-button" id="settingsButton"><div data-tippy-content="Launch Notebook"><i data-feather="play-circle"></i></div></li>
                        <li class="download-pdf" id="downloadButton"><i data-feather="file"></i></li>
                    <!--
                    # Enable if looking for link to specific document hosted on GitHub
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-python-advanced.myst/blob/main/lectures/amss.md" download><i data-feather="github"></i></a></li>
                    -->
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-python-advanced.myst" download><i data-feather="github"></i></a></li>
                </ul>

            </div>

        </div> <!-- .toolbar -->
        <div id="downloadPDFModal" style="display: none;">
            <ul class="pdf-options" style="display: block;">
                <li class="download-pdf-book" onClick="window.print()">
                    <p>Lecture (PDF)</p>
                </li>
                <li class="download-pdf-file">
                    <a href="/_pdf/quantecon-python-advanced.pdf" download><p>Book (PDF)</p></a>
                </li>
            </ul>
        </div>
        <div id="settingsModal" style="display: none;">
            <p class="modal-title"> Notebook Launcher </p>
            <div class="modal-desc">
            <p>
                Choose public or private cloud service for "Launch" button.
            </p>
            </div>
            <p class="modal-subtitle">Select a server</p>
            <ul class="modal-servers">
            <li class="active launcher-public">
                <span class="label">Public</span>
                <select id="launcher-public-input">
                
                    <option value="https://colab.research.google.com/github/QuantEcon/lecture-python-advanced.notebooks/blob/main/amss.ipynb">Colab</option>
                
                </select>
                <i class="fas fa-check-circle"></i>
            </li>
            <li class="launcher-private">
                <span class="label">Private</span>
                <input type="text" id="launcher-private-input" data-repourl="https://github.com/QuantEcon/lecture-python-advanced.notebooks" data-urlpath="tree/lecture-python-advanced.notebooks/amss.ipynb" data-branch=main>
                <i class="fas fa-check-circle"></i>
            </li>
            </ul>
            <p class="launch"><a href="https://colab.research.google.com/github/QuantEcon/lecture-python-advanced.notebooks/blob/main/amss.ipynb" id="advancedLaunchButton" target="_blank">Launch Notebook</a></p>
            <script>
                // QuantEcon Notebook Launcher
                const launcherTypeElements = document.querySelectorAll('#settingsModal .modal-servers li');
                // Highlight the server type if previous selection exists
                if (typeof localStorage.launcherType !== 'undefined') {
                  for (var i = 0; i < launcherTypeElements.length; i++) {
                    launcherTypeElements[i].classList.remove('active');
                    if ( launcherTypeElements[i].classList.contains(localStorage.launcherType) ) {
                      launcherTypeElements[i].classList.add('active');
                    }
                  }
                }
                // Highlight server type on click and set local storage value
                for (var i = 0; i < launcherTypeElements.length; i++) {
                  launcherTypeElements[i].addEventListener('click', function() {
                    for (var j = 0; j < launcherTypeElements.length; j++) {
                      launcherTypeElements[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    if ( this.classList.contains('launcher-private') ) {
                      localStorage.launcherType = 'launcher-private';
                    } else if ( this.classList.contains('launcher-public') ) {
                      localStorage.launcherType = 'launcher-public';
                    }
                    setLaunchServer();
                  })
                }
                const launcherPublic = document.getElementById('launcher-public-input');
                const launcherPrivate = document.getElementById('launcher-private-input');
                const pageName = "amss";
                const repoURL = "https://github.com/QuantEcon/lecture-python-advanced.notebooks";
                const urlPath = "tree/lecture-python-advanced.notebooks/amss.ipynb";
                const branch = "main"
                const launchNotebookLink = document.getElementById('advancedLaunchButton');

                // Highlight public server option if previous selection exists
                if (typeof localStorage.launcherPublic !== 'undefined') {
                  launcherPublic.value = localStorage.launcherPublic;
                }
                // Update local storage upon public server selection
                launcherPublic.addEventListener('change', (event) => {
                  setLaunchServer();
                });
                // Populate private server input if previous entry exists
                if (typeof localStorage.launcherPrivate !== 'undefined') {
                  launcherPrivate.value = localStorage.launcherPrivate;
                }
                // Update local storage when a private server is entered
                launcherPrivate.addEventListener('input', (event) => {
                  setLaunchServer();
                });

                // Function to update the "Launch Notebook" link href
                function setLaunchServer() {
                  launchNotebookLink.removeAttribute("style")
                  if ( localStorage.launcherType == 'launcher-private' ) {
                    let repoPrefix = "/user-redirect/git-pull?repo=" + repoURL + "&branch=" + branch + "&urlpath=" + urlPath;
                    launcherPrivateValue = launcherPrivate.value
                    if (!launcherPrivateValue) {
                        launchNotebookLink.removeAttribute("href")
                        launchNotebookLink.style.background = "grey"
                        return
                    }
                    localStorage.launcherPrivate = launcherPrivateValue;
                    privateServer = localStorage.launcherPrivate.replace(/\/$/, "")
                    if (!privateServer.includes("http")) {
                        privateServer = "http://" + privateServer
                    }
                    launchNotebookLinkURL = privateServer + repoPrefix;
                  } else if ( localStorage.launcherType == 'launcher-public' ) {
                    launcherPublicValue = launcherPublic.options[launcherPublic.selectedIndex].value;
                    localStorage.launcherPublic = launcherPublicValue;
                    launchNotebookLinkURL = localStorage.launcherPublic;
                  }
                  if (launchNotebookLinkURL) launchNotebookLink.href = launchNotebookLinkURL;
                }
                // Check if user has previously selected a server
                if ( (typeof localStorage.launcherPrivate !== 'undefined') || (typeof localStorage.launcherPublic !== 'undefined') ) {
                  setLaunchServer();
                }
                </script>

        </div>

    </div> <!-- .wrapper-->
  </body>
</html>