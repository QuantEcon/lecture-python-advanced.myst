
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>47. Fluctuating Interest Rates Deliver Fiscal Insurance &#8212; Advanced Quantitative Economics with Python</title>
    <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
        <script>
            MathJax = {
            loader: {load: ['[tex]/boldsymbol', '[tex]/textmacros']},
            tex: {
                packages: {'[+]': ['boldsymbol', 'textmacros']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    "argmax" : "arg\\,max",
                    "argmin" : "arg\\,min",
                    "col"    : "col",
                    "Span"   :  "span",
                    "epsilon": "\\varepsilon",
                    "EE": "\\mathbb{E}",
                    "PP": "\\mathbb{P}",
                    "RR": "\\mathbb{R}",
                    "NN": "\\mathbb{N}",
                    "ZZ": "\\mathbb{Z}",
                    "aA": "\\mathcal{A}",
                    "bB": "\\mathcal{B}",
                    "cC": "\\mathcal{C}",
                    "dD": "\\mathcal{D}",
                    "eE": "\\mathcal{E}",
                    "fF": "\\mathcal{F}",
                    "gG": "\\mathcal{G}",
                    "hH": "\\mathcal{H}",
                }
            },
            svg: {
                fontCache: 'global',
                scale: 0.92,
                displayAlign: "center",
            },
            };
        </script>
    
    
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" href="_static/styles/quantecon-book-theme.css?digest=9a92145369e9a304bdc7848b31c103894a5801ea" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/exercise.css?v=982b99e0" />
    <link rel="stylesheet" type="text/css" href="_static/proof.css?v=b4b7a797" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>


    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="_static/scripts/quantecon-book-theme.js?digest=06ebc90d5139b434c2742937a4ef3b185cb93e2f"></script>
    <script src="_static/scripts/jquery.js?v=5d32c60e"></script>
    <script src="_static/scripts/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KZLV7PM9LL"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KZLV7PM9LL');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KZLV7PM9LL');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex": {"macros": {"argmax": "arg\\,max", "argmin": "arg\\,min", "col": "col", "Span": "span", "epsilon": "\\varepsilon", "EE": "\\mathbb{E}", "PP": "\\mathbb{P}", "RR": "\\mathbb{R}", "NN": "\\mathbb{N}", "ZZ": "\\mathbb{Z}", "aA": "\\mathcal{A}", "bB": "\\mathcal{B}", "cC": "\\mathcal{C}", "dD": "\\mathcal{D}", "eE": "\\mathcal{E}", "fF": "\\mathcal{F}", "gG": "\\mathcal{G}", "hH": "\\mathcal{H}"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'amss2';</script>
    <link rel="canonical" href="https://python-advanced.quantecon.org/amss2.html" />
    <link rel="icon" href="_static/lectures-favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="48. Fiscal Risk and Government Debt" href="amss3.html" />
    <link rel="prev" title="46. Optimal Taxation without State-Contingent Debt" href="amss.html" />

<!-- Normal Meta Tags -->
<meta name="author" context="Thomas J. Sargent &amp; John Stachurski" />
<meta name="keywords" content="Python, QuantEcon, Quantitative Economics, Economics, Sloan, Alfred P. Sloan Foundation, Tom J. Sargent, John Stachurski" />
<meta name="description" content=This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski. />

<!-- Twitter tags -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@quantecon" />
<meta name="twitter:title" content="Fluctuating Interest Rates Deliver Fiscal Insurance"/>
<meta name="twitter:description" content="This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski.">
<meta name="twitter:creator" content="@quantecon">
<meta name="twitter:image" content="https://assets.quantecon.org/img/qe-twitter-logo.png">

<!-- Opengraph tags -->
<meta property="og:title" content="Fluctuating Interest Rates Deliver Fiscal Insurance" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://python-advanced.quantecon.org/amss2.html" />
<meta property="og:image" content="https://assets.quantecon.org/img/qe-og-logo.png" />
<meta property="og:description" content="This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski." />
<meta property="og:site_name" content="Advanced Quantitative Economics with Python" />
<meta name="theme-color" content="#ffffff" />

  </head>
<body>

<!-- Override QuantEcon theme colors -->

    <span id="top"></span>

    <div class="qe-wrapper">

        <div class="qe-main">

            <div class="qe-page" id=amss2>

                <div class="qe-page__toc">

                    <div class="inner">

                        
                        <div class="qe-page__toc-header">
                            On this page
                        </div>


                        <nav id="bd-toc-nav" class="qe-page__toc-nav">
                            <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">47.1. Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forces-at-work">47.2. Forces at work</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#logical-flow-of-lecture">47.3. Logical flow of lecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#equations-from-lucas-stokey-1983-model">47.3.1. Equations from Lucas-Stokey (1983) model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specification-with-crra-utility">47.3.2. Specification with CRRA utility</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-economy">47.4. Example economy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reverse-engineering-strategy">47.5. Reverse engineering strategy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#code-for-reverse-engineering">47.6. Code for reverse engineering</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#short-simulation-for-reverse-engineered-initial-debt">47.7. Short simulation for reverse-engineered: initial debt</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#long-simulation">47.8. Long simulation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remarks-about-long-simulation">47.8.1. Remarks about long simulation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#begs-approximations-of-limiting-debt-and-convergence-rate">47.9. BEGS approximations of limiting debt and convergence rate</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#asymptotic-mean">47.9.1. Asymptotic mean</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rate-of-convergence">47.9.2. Rate of convergence</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#formulas-and-code-details">47.9.3. Formulas and code details</a></li>
</ul>
</li>
</ul>
                            <p class="logo">
                                
                                    
                                    <a href=https://quantecon.org><img src="_static/qe-logo-large.png" class="logo logo-img" alt="logo"></a>
                                    
                                    
                                
                            </p>

                            <p class="powered">Powered by <a href="https://jupyterbook.org/en/stable/">Jupyter Book</a></p>

                        </nav>

                        <div class="qe-page__toc-footer">
                            
                            
                            <p><a href="#top"><strong>Back to top</strong></a></p>
                        </div>

                    </div>

                </div>

                <div class="qe-page__header">

                    <div class="qe-page__header-copy">

                        <p class="qe-page__header-heading"><a href="intro.html">Advanced Quantitative Economics with Python</a></p>

                        <p class="qe-page__header-subheading">Fluctuating Interest Rates Deliver Fiscal Insurance</p>

                    </div>
                    <!-- length 2, since its a string and empty dict has length 2 - {} -->
                        <p class="qe-page__header-authors" font-size="18">
                            
                                
                                    <a href="http://www.tomsargent.com/" target="_blank"><span>Thomas J. Sargent</span></a>
                                
                            
                                
                                    and <a href="https://johnstachurski.net/" target="_blank"><span>John Stachurski</span></a>
                                
                            
                        </p>


                </div> <!-- .page__header -->



                
                <main class="qe-page__content" role="main">
                    
                    <div>
                        
  <div id="qe-notebook-header" align="right" style="text-align:right;">
        <a href="https://quantecon.org/" title="quantecon.org">
                <img style="width:250px;display:inline;" width="250px" src="https://assets.quantecon.org/img/qe-menubar-logo.svg" alt="QuantEcon">
        </a>
</div><section class="tex2jax_ignore mathjax_ignore" id="fluctuating-interest-rates-deliver-fiscal-insurance">
<h1><span class="section-number">47. </span>Fluctuating Interest Rates Deliver Fiscal Insurance<a class="headerlink" href="#fluctuating-interest-rates-deliver-fiscal-insurance" title="Link to this heading">#</a></h1>
<p>In addition to what’s in Anaconda, this lecture will need the following libraries:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>quantecon
</pre></div>
</div>
</div>
<details class="admonition hide below-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell output</p>
<p class="expanded admonition-title">Hide code cell output</p>
</summary>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: quantecon in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (0.10.1)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: numba&gt;=0.49.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (0.61.0)
Requirement already satisfied: numpy&gt;=1.17.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (2.1.3)
Requirement already satisfied: requests in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (2.32.3)
Requirement already satisfied: scipy&gt;=1.5.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (1.15.3)
Requirement already satisfied: sympy in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (1.13.3)
Requirement already satisfied: llvmlite&lt;0.45,&gt;=0.44.0dev0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from numba&gt;=0.49.0-&gt;quantecon) (0.44.0)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (3.7)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (2.3.0)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (2025.4.26)
Requirement already satisfied: mpmath&lt;1.4,&gt;=1.1.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from sympy-&gt;quantecon) (1.3.0)
</pre></div>
</div>
</div>
</details>
</div>
<section id="overview">
<h2><span class="section-number">47.1. </span>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>This lecture extends our investigations of how optimal policies for levying a flat-rate tax on labor income and  issuing government debt depend
on whether there are complete  markets for debt.</p>
<p>A Ramsey allocation and Ramsey policy in the AMSS <span id="id1">[<a class="reference internal" href="zreferences.html#id133" title="S Rao Aiyagari, Albert Marcet, Thomas J Sargent, and Juha Seppälä. Optimal taxation without state-contingent debt. Journal of Political Economy, 110(6):1220–1254, 2002.">Aiyagari <em>et al.</em>, 2002</a>]</span> model described in <a class="reference internal" href="amss.html"><span class="doc">optimal taxation without state-contingent debt</span></a> generally differs
from a Ramsey allocation and Ramsey policy in the  Lucas-Stokey <span id="id2">[<a class="reference internal" href="zreferences.html#id179" title="Robert E Lucas, Jr. and Nancy L Stokey. Optimal Fiscal and Monetary Policy in an Economy without Capital. Journal of monetary Economics, 12(3):55–93, 1983.">Lucas and Stokey, 1983</a>]</span> model described in <a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state-contingent debt</span></a>.</p>
<p>This is because the implementability restriction that a competitive equilibrium with a distorting tax  imposes on  allocations in the Lucas-Stokey model is just one among a set of
implementability conditions imposed in  the AMSS model.</p>
<p>These additional constraints require that time <span class="math notranslate nohighlight">\(t\)</span> components of a Ramsey allocation
for the AMSS model be <strong>measurable</strong> with respect to time <span class="math notranslate nohighlight">\(t-1\)</span> information.</p>
<p>The  measurability constraints imposed by the AMSS model are inherited from the   restriction that  only one-period risk-free bonds
can be traded.</p>
<p>Differences between the  Ramsey allocations in the two models   indicate that at least some of the <strong>implementability constraints</strong> of the AMSS model of
<a class="reference internal" href="amss.html"><span class="doc">optimal taxation without state-contingent debt</span></a> are violated at the Ramsey allocation of a corresponding  <span id="id3">[<a class="reference internal" href="zreferences.html#id179" title="Robert E Lucas, Jr. and Nancy L Stokey. Optimal Fiscal and Monetary Policy in an Economy without Capital. Journal of monetary Economics, 12(3):55–93, 1983.">Lucas and Stokey, 1983</a>]</span> model with state-contingent debt.</p>
<p>Another way to say this is that differences between the Ramsey allocations of the two models indicate that some of the <strong>measurability constraints</strong> imposed by the
AMSS model are violated at the  Ramsey allocation of the Lucas-Stokey model.</p>
<p>Nonzero Lagrange multipliers on those constraints make the Ramsey allocation for the AMSS model differ from the Ramsey allocation for the Lucas-Stokey model.</p>
<p>This lecture studies a special  AMSS model in which</p>
<ul class="simple">
<li><p>The exogenous state variable <span class="math notranslate nohighlight">\(s_t\)</span> is governed by  a finite-state Markov chain.</p></li>
<li><p>With an arbitrary budget-feasible initial level of government debt, the measurability  constraints</p>
<ul>
<li><p>bind for many periods, but <span class="math notranslate nohighlight">\(\ldots\)</span>.</p></li>
<li><p>eventually, they stop binding evermore, so that <span class="math notranslate nohighlight">\(\ldots\)</span></p></li>
<li><p>in the tail of the Ramsey plan, the Lagrange multipliers <span class="math notranslate nohighlight">\(\gamma_t(s^t)\)</span> on the AMSS implementability constraints <a class="reference internal" href="amss.html#equation-ts-gov-wo4">(46.8)</a>  are zero.</p></li>
</ul>
</li>
<li><p>After the implementability constraints <a class="reference internal" href="amss.html#equation-ts-gov-wo4">(46.8)</a> no longer bind in the tail of the AMSS Ramsey plan</p>
<ul>
<li><p>history dependence of the AMSS state variable <span class="math notranslate nohighlight">\(x_t\)</span> vanishes and  <span class="math notranslate nohighlight">\(x_t\)</span> becomes a time-invariant function of the Markov state <span class="math notranslate nohighlight">\(s_t\)</span>.</p></li>
<li><p>the par value of government debt becomes <strong>constant over time</strong> so that <span class="math notranslate nohighlight">\(b_{t+1}(s^t) = \bar b\)</span> for <span class="math notranslate nohighlight">\(t \geq T\)</span> for a sufficiently large <span class="math notranslate nohighlight">\(T\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\bar b &lt;0\)</span>, so that the tail of the Ramsey plan instructs  the government always to make a constant par value of risk-free one-period loans <strong>to</strong> the private sector.</p></li>
<li><p>the one-period gross interest rate <span class="math notranslate nohighlight">\(R_t(s^t)\)</span> on risk-free debt  converges to a time-invariant function of the Markov state <span class="math notranslate nohighlight">\(s_t\)</span>.</p></li>
</ul>
</li>
<li><p>For a <strong>particular</strong> <span class="math notranslate nohighlight">\(b_0 &lt; 0\)</span> (i.e., a positive level of initial government <strong>loans</strong> to the private sector), the measurability constraints <strong>never</strong> bind.</p></li>
<li><p>In this special case</p>
<ul>
<li><p>the <strong>par value</strong> <span class="math notranslate nohighlight">\(b_{t+1}(s_t) = \bar b\)</span>  of government debt at time <span class="math notranslate nohighlight">\(t\)</span> and Markov state <span class="math notranslate nohighlight">\(s_t\)</span>  is constant across time and states,
but <span class="math notranslate nohighlight">\(\ldots\)</span>.</p></li>
<li><p>the <strong>market value</strong> <span class="math notranslate nohighlight">\(\frac{\bar b}{R_t(s_t)}\)</span> of government debt at time <span class="math notranslate nohighlight">\(t\)</span>  varies as a time-invariant function of the Markov state <span class="math notranslate nohighlight">\(s_t\)</span>.</p></li>
<li><p>fluctuations in the interest rate make gross earnings on government debt <span class="math notranslate nohighlight">\(\frac{\bar b}{R_t(s_t)}\)</span> fully insure the gross-of-gross-interest-payments government budget against fluctuations in government expenditures.</p></li>
<li><p>the state variable <span class="math notranslate nohighlight">\(x\)</span> in a recursive representation of a Ramsey plan is a time-invariant function of the Markov state for <span class="math notranslate nohighlight">\(t \geq 0\)</span>.</p></li>
</ul>
</li>
<li><p>In this special case, the Ramsey allocation in the AMSS model agrees with that in a Lucas-Stokey <span id="id4">[<a class="reference internal" href="zreferences.html#id179" title="Robert E Lucas, Jr. and Nancy L Stokey. Optimal Fiscal and Monetary Policy in an Economy without Capital. Journal of monetary Economics, 12(3):55–93, 1983.">Lucas and Stokey, 1983</a>]</span> complete markets model in which
the same amount of state-contingent debt falls due in all states tomorrow</p>
<ul>
<li><p>it is a situation in which  the Ramsey planner loses nothing from not being  able to  trade state-contingent debt and being restricted to exchange only risk-free debt  debt.</p></li>
</ul>
</li>
<li><p>This outcome emerges only when we initialize government debt at a particular <span class="math notranslate nohighlight">\(b_0 &lt; 0\)</span>.</p></li>
</ul>
<p>In a nutshell, the reason for this striking outcome is that at a particular level of risk-free government <strong>assets</strong>, fluctuations in the one-period risk-free interest
rate provide the government with complete insurance against stochastically varying government expenditures.</p>
<p>Let’s start with some imports:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">fsolve</span><span class="p">,</span> <span class="n">fmin</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="forces-at-work">
<h2><span class="section-number">47.2. </span>Forces at work<a class="headerlink" href="#forces-at-work" title="Link to this heading">#</a></h2>
<p>The forces  driving asymptotic  outcomes here are examples of dynamics present in a more general class of incomplete markets models analyzed in <span id="id5">[<a class="reference internal" href="zreferences.html#id231" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> (BEGS).</p>
<p>BEGS provide conditions under which government debt under a Ramsey plan converges to an invariant distribution.</p>
<p>BEGS  construct approximations to that asymptotically invariant  distribution  of government debt under a  Ramsey plan.</p>
<p>BEGS also compute an approximation to a Ramsey plan’s rate of convergence  to that limiting invariant distribution.</p>
<p>We  shall use the BEGS approximating limiting distribution and their approximating  rate of convergence   to help interpret  outcomes here.</p>
<p>For a long time, the Ramsey plan puts a nontrivial martingale-like component into the par value of  government debt as part of the way that the Ramsey plan imperfectly
smooths distortions from the labor tax rate across  time and Markov states.</p>
<p>But BEGS show that binding implementability constraints slowly push government debt in a direction designed to let the government use fluctuations in  equilibrium interest
rates  rather than fluctuations in  par values of debt to insure against shocks to government expenditures.</p>
<ul class="simple">
<li><p>This is a <strong>weak</strong> (but unrelenting) force that, starting from a positive initial debt level, for a long time is dominated by the stochastic martingale-like component of debt
dynamics that the Ramsey planner uses to facilitate imperfect tax-smoothing across time and states.</p></li>
<li><p>This weak force slowly drives the par value of government <strong>assets</strong> to a <strong>constant</strong> level at which the government can completely insure against government expenditure shocks while
shutting down the stochastic component of debt dynamics.</p></li>
<li><p>At that point, the tail of the par value of government debt becomes a trivial martingale: it is constant over time.</p></li>
</ul>
</section>
<section id="logical-flow-of-lecture">
<h2><span class="section-number">47.3. </span>Logical flow of lecture<a class="headerlink" href="#logical-flow-of-lecture" title="Link to this heading">#</a></h2>
<p>We present ideas  in the following order</p>
<ul class="simple">
<li><p>We describe a two-state  AMSS economy and generate a long simulation starting from a positive  initial government debt.</p></li>
<li><p>We observe that in a long simulation starting from positive government debt, the par value of  government debt eventually converges to a constant <span class="math notranslate nohighlight">\(\bar b\)</span>.</p></li>
<li><p>In fact, the par value of government debt  converges to the same constant level <span class="math notranslate nohighlight">\(\bar b\)</span> for alternative realizations of the Markov government expenditure process and for alternative settings of initial government
debt <span class="math notranslate nohighlight">\(b_0\)</span>.</p></li>
<li><p>We reverse engineer a particular value of initial government debt <span class="math notranslate nohighlight">\(b_0\)</span> (it turns out to be negative) for which the  continuation debt moves
to <span class="math notranslate nohighlight">\(\bar b\)</span> immediately.</p></li>
<li><p>We note that for this particular initial debt <span class="math notranslate nohighlight">\(b_0\)</span>, the Ramsey allocations  for the AMSS economy and the Lucas-Stokey model are identical</p>
<ul>
<li><p>we verify that the LS Ramsey planner chooses to purchase <strong>identical</strong> claims to time <span class="math notranslate nohighlight">\(t+1\)</span> consumption for all Markov states tomorrow for each Markov state today.</p></li>
</ul>
</li>
<li><p>We compute the BEGS approximations to check how accurately they describe the dynamics of the long-simulation.</p></li>
</ul>
<section id="equations-from-lucas-stokey-1983-model">
<h3><span class="section-number">47.3.1. </span>Equations from Lucas-Stokey (1983) model<a class="headerlink" href="#equations-from-lucas-stokey-1983-model" title="Link to this heading">#</a></h3>
<p>Although we are studying an AMSS <span id="id6">[<a class="reference internal" href="zreferences.html#id133" title="S Rao Aiyagari, Albert Marcet, Thomas J Sargent, and Juha Seppälä. Optimal taxation without state-contingent debt. Journal of Political Economy, 110(6):1220–1254, 2002.">Aiyagari <em>et al.</em>, 2002</a>]</span> economy,  a Lucas-Stokey <span id="id7">[<a class="reference internal" href="zreferences.html#id179" title="Robert E Lucas, Jr. and Nancy L Stokey. Optimal Fiscal and Monetary Policy in an Economy without Capital. Journal of monetary Economics, 12(3):55–93, 1983.">Lucas and Stokey, 1983</a>]</span> economy plays
an important  role in the reverse-engineering calculation to be described below.</p>
<p>For that reason, it is helpful  to have key equations underlying a Ramsey plan for the Lucas-Stokey economy readily available.</p>
<p>Recall first-order conditions for a Ramsey allocation for the Lucas-Stokey economy.</p>
<p>For <span class="math notranslate nohighlight">\(t \geq 1\)</span>, these take the form</p>
<div class="math notranslate nohighlight" id="equation-ts-barg10a">
<span class="eqno">(47.1)<a class="headerlink" href="#equation-ts-barg10a" title="Link to this equation">#</a></span>\[\begin{split}\begin{aligned}
  (1+\Phi) &amp;u_c(c,1-c-g) + \Phi \bigl[c u_{cc}(c,1-c-g) -
    (c+g) u_{\ell c}(c,1-c-g) \bigr]
    \\
    &amp;= (1+\Phi) u_{\ell}(c,1-c-g) + \Phi \bigl[c u_{c\ell}(c,1-c-g) -
    (c+g) u_{\ell \ell}(c,1-c-g)  \bigr]
\end{aligned}\end{split}\]</div>
<p>There is one such equation for each value of the Markov state <span class="math notranslate nohighlight">\(s_t\)</span>.</p>
<p>Given an initial Markov state, the time <span class="math notranslate nohighlight">\(t=0\)</span> quantities <span class="math notranslate nohighlight">\(c_0\)</span> and <span class="math notranslate nohighlight">\(b_0\)</span> satisfy</p>
<div class="math notranslate nohighlight" id="equation-ts-barg11b">
<span class="eqno">(47.2)<a class="headerlink" href="#equation-ts-barg11b" title="Link to this equation">#</a></span>\[\begin{split}\begin{aligned}
      (1+\Phi) &amp;u_c(c,1-c-g) + \Phi \bigl[c u_{cc}(c,1-c-g) -
        (c+g) u_{\ell c}(c,1-c-g) \bigr]
        \\
        &amp;= (1+\Phi) u_{\ell}(c,1-c-g) + \Phi \bigl[c u_{c\ell}(c,1-c-g) -
        (c+g) u_{\ell \ell}(c,1-c-g)  \bigr] + \Phi (u_{cc} - u_{c,\ell}) b_0
\end{aligned}\end{split}\]</div>
<p>In addition, the time <span class="math notranslate nohighlight">\(t=0\)</span> budget constraint is satisfied at <span class="math notranslate nohighlight">\(c_0\)</span> and initial government debt
<span class="math notranslate nohighlight">\(b_0\)</span></p>
<div class="math notranslate nohighlight" id="equation-eqn-amss2-10">
<span class="eqno">(47.3)<a class="headerlink" href="#equation-eqn-amss2-10" title="Link to this equation">#</a></span>\[b_0 + g_0 = \tau_0 (c_0 + g_0) + \frac{\bar b}{R_0}\]</div>
<p>where <span class="math notranslate nohighlight">\(R_0\)</span> is the gross interest rate for the Markov state <span class="math notranslate nohighlight">\(s_0\)</span> that is assumed to prevail at time <span class="math notranslate nohighlight">\(t =0\)</span>
and <span class="math notranslate nohighlight">\(\tau_0\)</span> is the time <span class="math notranslate nohighlight">\(t=0\)</span> tax rate.</p>
<p>In equation <a class="reference internal" href="#equation-eqn-amss2-10">(47.3)</a>, it is understood that</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
\tau_0 = 1 - \frac{u_{l,0}}{u_{c,0}} \\
R_0^{-1} =  \beta  \sum_{s=1}^S \Pi(s | s_0) \frac{u_c(s)}{u_{c,0}}
\end{aligned}
\end{split}\]</div>
<p>It is useful to transform  some of the above equations to forms that are more natural for analyzing the
case of a CRRA utility specification that we shall use in our example economies.</p>
</section>
<section id="specification-with-crra-utility">
<h3><span class="section-number">47.3.2. </span>Specification with CRRA utility<a class="headerlink" href="#specification-with-crra-utility" title="Link to this heading">#</a></h3>
<p>As in lectures <a class="reference internal" href="amss.html"><span class="doc">optimal taxation without state-contingent debt</span></a> and <a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state-contingent debt</span></a>,
we assume that the representative agent has utility function</p>
<div class="math notranslate nohighlight">
\[
u(c,n) = {\frac{c^{1-\sigma}}{1-\sigma}} - {\frac{n^{1+\gamma}}{1+\gamma}}
\]</div>
<p>and set  <span class="math notranslate nohighlight">\(\sigma = 2\)</span>, <span class="math notranslate nohighlight">\(\gamma = 2\)</span>, and the  discount factor <span class="math notranslate nohighlight">\(\beta = 0.9\)</span>.</p>
<p>We eliminate leisure from the model and continue to assume that</p>
<div class="math notranslate nohighlight">
\[
c_t + g_t = n_t
\]</div>
<p>The analysis of Lucas and Stokey prevails once we make the following replacements</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
u_\ell(c, \ell) &amp;\sim - u_n(c, n) \\
u_c(c,\ell) &amp;\sim u_c(c,n) \\
u_{\ell,\ell}(c,\ell) &amp;\sim u_{nn}(c,n) \\
u_{c,c}(c,\ell)&amp; \sim u_{c,c}(c,n) \\
u_{c,\ell} (c,\ell) &amp;\sim 0
\end{aligned}
\end{split}\]</div>
<p>With these understandings, equations <a class="reference internal" href="#equation-ts-barg10a">(47.1)</a> and <a class="reference internal" href="#equation-ts-barg11b">(47.2)</a> simplify in the case of the CRRA utility function.</p>
<p>They become</p>
<div class="math notranslate nohighlight" id="equation-amss2-ts-barg10">
<span class="eqno">(47.4)<a class="headerlink" href="#equation-amss2-ts-barg10" title="Link to this equation">#</a></span>\[(1+\Phi) [u_c(c) + u_n(c+g)] + \Phi[c u_{cc}(c) + (c+g) u_{nn}(c+g)] = 0\]</div>
<p>and</p>
<div class="math notranslate nohighlight" id="equation-amss2-ts-barg11">
<span class="eqno">(47.5)<a class="headerlink" href="#equation-amss2-ts-barg11" title="Link to this equation">#</a></span>\[(1+\Phi) [u_c(c_0) + u_n(c_0+g_0)] + \Phi[c_0 u_{cc}(c_0) + (c_0+g_0) u_{nn}(c_0+g_0)] - \Phi u_{cc}(c_0) b_0 = 0\]</div>
<p>In equation <a class="reference internal" href="#equation-amss2-ts-barg10">(47.4)</a>, it is understood that <span class="math notranslate nohighlight">\(c\)</span> and <span class="math notranslate nohighlight">\(g\)</span> are each functions of the Markov state <span class="math notranslate nohighlight">\(s\)</span>.</p>
<p>The CRRA utility function is represented in the following class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CRRAutility</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">β</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                 <span class="n">σ</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">γ</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">π</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">),</span>
                 <span class="n">G</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]),</span>
                 <span class="n">Θ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                 <span class="n">transfers</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">σ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span> <span class="o">=</span> <span class="n">β</span><span class="p">,</span> <span class="n">σ</span><span class="p">,</span> <span class="n">γ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfers</span> <span class="o">=</span> <span class="n">π</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">transfers</span>

    <span class="c1"># Utility function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">U</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">σ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">σ</span>
        <span class="k">if</span> <span class="n">σ</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">U</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">σ</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">σ</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">U</span> <span class="o">-</span> <span class="n">n</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="p">)</span>

    <span class="c1"># Derivatives of utility function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Uc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">σ</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Ucc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">σ</span> <span class="o">*</span> <span class="n">c</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">σ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Un</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">n</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Unn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span> <span class="o">*</span> <span class="n">n</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="example-economy">
<h2><span class="section-number">47.4. </span>Example economy<a class="headerlink" href="#example-economy" title="Link to this heading">#</a></h2>
<p>We set the following parameter values.</p>
<p>The Markov state <span class="math notranslate nohighlight">\(s_t\)</span> takes two values, namely,  <span class="math notranslate nohighlight">\(0,1\)</span>.</p>
<p>The initial Markov state is <span class="math notranslate nohighlight">\(0\)</span>.</p>
<p>The Markov transition matrix is <span class="math notranslate nohighlight">\(.5 I\)</span> where <span class="math notranslate nohighlight">\(I\)</span> is a <span class="math notranslate nohighlight">\(2 \times 2\)</span> identity matrix, so the <span class="math notranslate nohighlight">\(s_t\)</span> process is IID.</p>
<p>Government expenditures <span class="math notranslate nohighlight">\(g(s)\)</span> equal <span class="math notranslate nohighlight">\(.1\)</span> in Markov state <span class="math notranslate nohighlight">\(0\)</span> and <span class="math notranslate nohighlight">\(.2\)</span> in Markov state <span class="math notranslate nohighlight">\(1\)</span>.</p>
<p>We set preference parameters as follows:</p>
<div class="math notranslate nohighlight">
\[
\begin{aligned}
\beta &amp; = .9 \cr
\sigma &amp; = 2  \cr
\gamma &amp; = 2
\end{aligned}
\]</div>
<p>Here are several classes that do most of the work for us.</p>
<p>The code is  mostly taken or adapted from the earlier lectures <a class="reference internal" href="amss.html"><span class="doc">optimal taxation without state-contingent debt</span></a> and
<a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state-contingent debt</span></a>.</p>
<div class="cell tag_collapse-20 docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">root</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">quantecon</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarkovChain</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SequentialAllocation</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class that takes CESutility or BGPutility object as input returns</span>
<span class="sd">    planner&#39;s allocation as a function of the multiplier on the</span>
<span class="sd">    implementability constraint μ.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>

        <span class="c1"># Initialize from model object attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">G</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">Θ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">)</span>  <span class="c1"># Number of states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="c1"># Find the first best allocation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_first_best</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_first_best</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the first best allocation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">res</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find first best&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">S</span><span class="p">:]</span>

        <span class="c1"># Multiplier on the resource constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ΞFB</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zFB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ΞFB</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">time1_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">μ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes optimal allocation for time t &gt;= 1 for a given μ</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Ucc</span><span class="p">,</span> <span class="n">Un</span><span class="p">,</span> <span class="n">Unn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Ucc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Unn</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">FOC</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">]</span>
            <span class="n">Ξ</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">:]</span>
            <span class="c1"># FOC of c</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">μ</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ucc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">-</span> <span class="n">Ξ</span><span class="p">,</span>
                              <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">μ</span> <span class="o">*</span> <span class="p">(</span><span class="n">Unn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> \
                              <span class="o">+</span> <span class="n">Θ</span> <span class="o">*</span> <span class="n">Ξ</span><span class="p">,</span>  <span class="c1"># FOC of n</span>
                              <span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">])</span>

        <span class="c1"># Find the root of the first-order condition</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">FOC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zFB</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find LS allocation.&#39;</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">Ξ</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">:]</span>

        <span class="c1"># Compute x</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span> <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Ξ</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">time0_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">s_0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the optimal allocation given initial government debt B_ and</span>
<span class="sd">        state s_0</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">π</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">β</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Ucc</span><span class="p">,</span> <span class="n">Un</span><span class="p">,</span> <span class="n">Unn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Ucc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Unn</span>

        <span class="c1"># First order conditions of planner&#39;s problem</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">FOC</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">μ</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">Ξ</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">xprime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">μ</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">B_</span><span class="p">)</span> <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">β</span> <span class="o">*</span> <span class="n">π</span><span class="p">[</span><span class="n">s_0</span><span class="p">]</span>
                                            <span class="o">@</span> <span class="n">xprime</span><span class="p">,</span>
                              <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">μ</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ucc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                                            <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">B_</span><span class="p">)</span> <span class="o">+</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">-</span> <span class="n">Ξ</span><span class="p">,</span>
                              <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">μ</span> <span class="o">*</span> <span class="p">(</span><span class="n">Unn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span>
                                            <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="n">Θ</span><span class="p">[</span><span class="n">s_0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ξ</span><span class="p">,</span>
                              <span class="p">(</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">)[</span><span class="n">s_0</span><span class="p">]])</span>

        <span class="c1"># Find root</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">FOC</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">[</span><span class="n">s_0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">[</span><span class="n">s_0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ΞFB</span><span class="p">[</span><span class="n">s_0</span><span class="p">]]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find time 0 LS allocation.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">time1_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">μ</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the value associated with multiplier μ</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Ξ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">μ</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">V</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Τ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes Τ given c, n</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>  <span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">Un</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">Uc</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">s_0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sHist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Simulates planners policies for T periods</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">π</span><span class="p">,</span> <span class="n">β</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span>
        <span class="n">Uc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span>

        <span class="k">if</span> <span class="n">sHist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sHist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">s_0</span><span class="p">)</span>

        <span class="n">cHist</span><span class="p">,</span> <span class="n">nHist</span><span class="p">,</span> <span class="n">Bhist</span><span class="p">,</span> <span class="n">ΤHist</span><span class="p">,</span> <span class="n">μHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
        <span class="n">RHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Time 0</span>
        <span class="n">μ</span><span class="p">,</span> <span class="n">cHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time0_allocation</span><span class="p">(</span><span class="n">B_</span><span class="p">,</span> <span class="n">s_0</span><span class="p">)</span>
        <span class="n">ΤHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Τ</span><span class="p">(</span><span class="n">cHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">s_0</span><span class="p">]</span>
        <span class="n">Bhist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B_</span>
        <span class="n">μHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">μ</span>

        <span class="c1"># Time 1 onward</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Ξ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">μ</span><span class="p">)</span>
            <span class="n">Τ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Τ</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">u_c</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">Eu_c</span> <span class="o">=</span> <span class="n">π</span><span class="p">[</span><span class="n">sHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">@</span> <span class="n">u_c</span>
            <span class="n">cHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">Bhist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">ΤHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/</span> <span class="n">u_c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> \
                                                     <span class="n">Τ</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">RHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">cHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">Eu_c</span><span class="p">)</span>
            <span class="n">μHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">μ</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">cHist</span><span class="p">,</span> <span class="n">nHist</span><span class="p">,</span> <span class="n">Bhist</span><span class="p">,</span> <span class="n">ΤHist</span><span class="p">,</span> <span class="n">sHist</span><span class="p">,</span> <span class="n">μHist</span><span class="p">,</span> <span class="n">RHist</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_collapse-20 docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">fmin_slsqp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">root</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">quantecon</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarkovChain</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RecursiveAllocationAMSS</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">μgrid</span><span class="p">,</span> <span class="n">tol_diff</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">G</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">)</span>  <span class="c1"># Number of states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">μgrid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">μgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol_diff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol_diff</span><span class="p">,</span> <span class="n">tol</span>

        <span class="c1"># Find the first best allocation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_time1_bellman</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">time_0</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Bellman equation now solves time 0 problem</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve_time1_bellman</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Solve the time  1 Bellman equation for calibration model and</span>
<span class="sd">        initial grid μgrid0</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">μgrid0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">μgrid</span>
        <span class="n">π</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">π</span>
        <span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">)</span>

        <span class="c1"># First get initial fit from Lucas Stokey solution.</span>
        <span class="c1"># Need to change things to be ex ante</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">SequentialAllocation</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolator_factory</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">incomplete_allocation</span><span class="p">(</span><span class="n">μ_</span><span class="p">,</span> <span class="n">s_</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">time1_value</span><span class="p">(</span><span class="n">μ_</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="n">x</span><span class="p">,</span> <span class="n">π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="n">V</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">Vf</span><span class="p">,</span> <span class="n">xprimef</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">μ</span><span class="p">:</span> <span class="n">incomplete_allocation</span><span class="p">(</span><span class="n">μ</span><span class="p">,</span> <span class="n">s_</span><span class="p">),</span> <span class="n">μgrid0</span><span class="p">))</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
            <span class="n">xprimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span>
            <span class="n">cf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
            <span class="n">Vf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">V</span><span class="p">))</span>
            <span class="n">xgrid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">xprimef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xprimes</span><span class="p">))</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xprimef</span> <span class="o">=</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">cf</span><span class="p">),</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">nf</span><span class="p">),</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">xprimef</span><span class="p">)</span>
        <span class="n">Vf</span> <span class="o">=</span> <span class="n">fun_hstack</span><span class="p">(</span><span class="n">Vf</span><span class="p">)</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="p">[</span><span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xprimef</span><span class="p">]</span>

        <span class="c1"># Create xgrid</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">xbar</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xbar</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xbar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">μgrid0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xgrid</span> <span class="o">=</span> <span class="n">xgrid</span>

        <span class="c1"># Now iterate on Bellman equation</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">BellmanEquation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">policies</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol_diff</span><span class="p">:</span>
            <span class="n">PF</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">Vf</span><span class="p">)</span>

            <span class="n">Vfnew</span><span class="p">,</span> <span class="n">policies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_policy_function</span><span class="p">(</span><span class="n">PF</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">Vf</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span> <span class="o">-</span> <span class="n">Vfnew</span><span class="p">(</span><span class="n">xgrid</span><span class="p">))</span> <span class="o">/</span> <span class="n">Vf</span><span class="p">(</span><span class="n">xgrid</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="n">Vf</span> <span class="o">=</span> <span class="n">Vfnew</span>

        <span class="c1"># Store value function policies and Bellman Equations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vf</span> <span class="o">=</span> <span class="n">Vf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="o">=</span> <span class="n">policies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_policy_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PF</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fits the policy functions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">xgrid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xgrid</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolator_factory</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xprimef</span><span class="p">,</span> <span class="n">Tf</span><span class="p">,</span> <span class="n">Vf</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="n">PFvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">PF</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xgrid</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Vf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">PFvec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="n">cf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span> <span class="o">+</span> <span class="n">S</span><span class="p">]))</span>
            <span class="n">nf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">S</span><span class="p">:</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">]))</span>
            <span class="n">xprimef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">:</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">S</span><span class="p">]))</span>
            <span class="n">Tf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">S</span><span class="p">:]))</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">cf</span><span class="p">),</span> <span class="n">fun_vstack</span><span class="p">(</span>
            <span class="n">nf</span><span class="p">),</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">xprimef</span><span class="p">),</span> <span class="n">fun_vstack</span><span class="p">(</span><span class="n">Tf</span><span class="p">)</span>
        <span class="n">Vf</span> <span class="o">=</span> <span class="n">fun_hstack</span><span class="p">(</span><span class="n">Vf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Vf</span><span class="p">,</span> <span class="n">policies</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Τ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes Τ given c and n</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">Un</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">Uc</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">time0_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">s0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the optimal allocation given initial government debt B_ and</span>
<span class="sd">        state s_0</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">PF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vf</span><span class="p">)</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">PF</span><span class="p">(</span><span class="n">B_</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span>
        <span class="n">c0</span><span class="p">,</span> <span class="n">n0</span><span class="p">,</span> <span class="n">xprime0</span><span class="p">,</span> <span class="n">T0</span> <span class="o">=</span> <span class="n">z0</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">c0</span><span class="p">,</span> <span class="n">n0</span><span class="p">,</span> <span class="n">xprime0</span><span class="p">,</span> <span class="n">T0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">s_0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sHist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Simulates planners policies for T periods</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">π</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span>
        <span class="n">Uc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xprimef</span><span class="p">,</span> <span class="n">Tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span>

        <span class="k">if</span> <span class="n">sHist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sHist</span> <span class="o">=</span> <span class="n">simulate_markov</span><span class="p">(</span><span class="n">π</span><span class="p">,</span> <span class="n">s_0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="n">cHist</span><span class="p">,</span> <span class="n">nHist</span><span class="p">,</span> <span class="n">Bhist</span><span class="p">,</span> <span class="n">xHist</span><span class="p">,</span> <span class="n">ΤHist</span><span class="p">,</span> <span class="n">THist</span><span class="p">,</span> <span class="n">μHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
        <span class="c1"># Time 0</span>
        <span class="n">cHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">THist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time0_allocation</span><span class="p">(</span><span class="n">B_</span><span class="p">,</span> <span class="n">s_0</span><span class="p">)</span>
        <span class="n">ΤHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Τ</span><span class="p">(</span><span class="n">cHist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">s_0</span><span class="p">]</span>
        <span class="n">Bhist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B_</span>
        <span class="n">μHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vf</span><span class="p">[</span><span class="n">s_0</span><span class="p">](</span><span class="n">xHist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Time 1 onward</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
            <span class="n">s_</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xprime</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">),</span> <span class="n">nf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span>
                <span class="n">x</span><span class="p">),</span> <span class="n">xprimef</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">),</span> <span class="n">Tf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">)</span>

            <span class="n">Τ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Τ</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">u_c</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">Eu_c</span> <span class="o">=</span> <span class="n">π</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:]</span> <span class="o">@</span> <span class="n">u_c</span>

            <span class="n">μHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vf</span><span class="p">[</span><span class="n">s</span><span class="p">](</span><span class="n">xprime</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

            <span class="n">cHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">nHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">Bhist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">ΤHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">x</span> <span class="o">/</span> <span class="n">Eu_c</span><span class="p">,</span> <span class="n">Τ</span>
            <span class="n">xHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">THist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">xprime</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cHist</span><span class="p">,</span> <span class="n">nHist</span><span class="p">,</span> <span class="n">Bhist</span><span class="p">,</span> <span class="n">ΤHist</span><span class="p">,</span> <span class="n">THist</span><span class="p">,</span> <span class="n">μHist</span><span class="p">,</span> <span class="n">sHist</span><span class="p">,</span> <span class="n">xHist</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BellmanEquation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Bellman equation for the continuation of the Lucas-Stokey Problem</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">policies0</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">G</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">π</span><span class="p">)</span>  <span class="c1"># Number of states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxiter</span> <span class="o">=</span> <span class="n">maxiter</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xbar</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">xgrid</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_0</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z0</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cf</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">xprimef</span> <span class="o">=</span> <span class="n">policies0</span>

        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xgrid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">cf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">),</span>
                                            <span class="n">nf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">),</span>
                                            <span class="n">xprimef</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span> <span class="p">:](</span><span class="n">x</span><span class="p">),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">find_first_best</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_first_best</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the first best allocation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">res</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not find first best&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">S</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">S</span><span class="p">:]</span>
        <span class="n">IFB</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cFB</span> <span class="o">+</span> \
            <span class="n">Un</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xFB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">IFB</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zFB</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cFB</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFB</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">xFB</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Vf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given continuation value function next period return value function this</span>
<span class="sd">        period return T(V) and optimal policies</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_0</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">PF</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_policies_time1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">PF</span><span class="p">(</span><span class="n">B_</span><span class="p">,</span> <span class="n">s0</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_policies_time0</span><span class="p">(</span><span class="n">B_</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">Vf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PF</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_policies_time1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">,</span> <span class="n">Vf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the optimal policies </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">π</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">objf</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xprime</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">:</span><span class="mi">3</span> <span class="o">*</span> <span class="n">S</span><span class="p">]</span>

            <span class="n">Vprime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
                <span class="n">Vprime</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vf</span><span class="p">[</span><span class="n">s</span><span class="p">](</span><span class="n">xprime</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

            <span class="k">return</span> <span class="o">-</span><span class="n">π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">β</span> <span class="o">*</span> <span class="n">Vprime</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">objf_prime</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>

            <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-7</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">objf</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">f0</span><span class="p">)])</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)):</span>
                <span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon</span>
                <span class="n">jac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">objf</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">dx</span><span class="p">)</span> <span class="o">-</span> <span class="n">f0</span><span class="p">)</span><span class="o">/</span><span class="n">epsilon</span>
                <span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">return</span> <span class="n">jac</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cons</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xprime</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">S</span><span class="p">:</span><span class="mi">3</span> <span class="o">*</span> <span class="n">S</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">S</span><span class="p">:]</span>
            <span class="n">u_c</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">Eu_c</span> <span class="o">=</span> <span class="n">π</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span> <span class="o">@</span> <span class="n">u_c</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span>
                <span class="n">x</span> <span class="o">*</span> <span class="n">u_c</span> <span class="o">/</span> <span class="n">Eu_c</span> <span class="o">-</span> <span class="n">u_c</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">β</span> <span class="o">*</span> <span class="n">xprime</span><span class="p">,</span>
                <span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">transfers</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> \
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xbar</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> \
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xbar</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span> <span class="o">+</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)]</span> <span class="o">*</span> <span class="n">S</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">imode</span><span class="p">,</span> <span class="n">smode</span> <span class="o">=</span> <span class="n">fmin_slsqp</span><span class="p">(</span><span class="n">objf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">],</span>
                                              <span class="n">f_eqcons</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                                              <span class="n">fprime</span><span class="o">=</span><span class="n">objf_prime</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">iprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxiter</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">smode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="o">-</span><span class="n">fx</span><span class="p">,</span> <span class="n">out</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_policies_time0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B_</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">Vf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the optimal policies </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">Θ</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">β</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">Uc</span><span class="p">,</span> <span class="n">Un</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Un</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">objf</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xprime</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">β</span> <span class="o">*</span> <span class="n">Vf</span><span class="p">[</span><span class="n">s0</span><span class="p">](</span><span class="n">xprime</span><span class="p">))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cons</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xprime</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">z</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span>
                <span class="o">-</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">B_</span> <span class="o">-</span> <span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">β</span> <span class="o">*</span> <span class="n">xprime</span><span class="p">,</span>
                <span class="p">(</span><span class="n">Θ</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="n">c</span> <span class="o">-</span> <span class="n">G</span><span class="p">)[</span><span class="n">s0</span><span class="p">]])</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">transfers</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbar</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbar</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)]</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">imode</span><span class="p">,</span> <span class="n">smode</span> <span class="o">=</span> <span class="n">fmin_slsqp</span><span class="p">(</span><span class="n">objf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s0</span><span class="p">],</span> <span class="n">f_eqcons</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span>
                                              <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">iprint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">smode</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="o">-</span><span class="n">fx</span><span class="p">,</span> <span class="n">out</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_collapse-20 docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnivariateSpline</span>


<span class="k">class</span><span class="w"> </span><span class="nc">interpolate_wrapper</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">F</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">interpolate_wrapper</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xvec</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">xvec</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
            <span class="k">return</span> <span class="n">fhat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
            <span class="k">return</span> <span class="n">fhat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">shape</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">interpolator_factory</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">Fs</span><span class="p">):</span>
        <span class="n">shape</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Fs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Fs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Fs</span> <span class="o">=</span> <span class="n">Fs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span>  <span class="c1"># Sort xgrid</span>
        <span class="k">for</span> <span class="n">Fhat</span> <span class="ow">in</span> <span class="n">Fs</span><span class="p">:</span>
            <span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">Fhat</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">interpolate_wrapper</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">F</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fun_vstack</span><span class="p">(</span><span class="n">fun_list</span><span class="p">):</span>

    <span class="n">Fs</span> <span class="o">=</span> <span class="p">[</span><span class="n">IW</span><span class="o">.</span><span class="n">F</span> <span class="k">for</span> <span class="n">IW</span> <span class="ow">in</span> <span class="n">fun_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">interpolate_wrapper</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Fs</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fun_hstack</span><span class="p">(</span><span class="n">fun_list</span><span class="p">):</span>

    <span class="n">Fs</span> <span class="o">=</span> <span class="p">[</span><span class="n">IW</span><span class="o">.</span><span class="n">F</span> <span class="k">for</span> <span class="n">IW</span> <span class="ow">in</span> <span class="n">fun_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">interpolate_wrapper</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">Fs</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">simulate_markov</span><span class="p">(</span><span class="n">π</span><span class="p">,</span> <span class="n">s_0</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>

    <span class="n">sHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">sHist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_0</span>
    <span class="n">S</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">π</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
        <span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">π</span><span class="p">[</span><span class="n">sHist</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">sHist</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="reverse-engineering-strategy">
<h2><span class="section-number">47.5. </span>Reverse engineering strategy<a class="headerlink" href="#reverse-engineering-strategy" title="Link to this heading">#</a></h2>
<p>We can reverse engineer a value <span class="math notranslate nohighlight">\(b_0\)</span> of initial debt due   that renders the AMSS measurability constraints not binding from time <span class="math notranslate nohighlight">\(t =0\)</span> onward.</p>
<p>We accomplish this by recognizing that if the AMSS measurability constraints never bind, then the AMSS allocation and Ramsey plan is equivalent
with that for a Lucas-Stokey economy in which for each period <span class="math notranslate nohighlight">\(t \geq 0\)</span>, the government promises to pay the <strong>same</strong> state-contingent
amount  <span class="math notranslate nohighlight">\(\bar b\)</span> in each state tomorrow.</p>
<p>This insight tells us to find a <span class="math notranslate nohighlight">\(b_0\)</span> and other fundamentals for the Lucas-Stokey <span id="id8">[<a class="reference internal" href="zreferences.html#id179" title="Robert E Lucas, Jr. and Nancy L Stokey. Optimal Fiscal and Monetary Policy in an Economy without Capital. Journal of monetary Economics, 12(3):55–93, 1983.">Lucas and Stokey, 1983</a>]</span> model that make the Ramsey planner
want to borrow the same value <span class="math notranslate nohighlight">\(\bar b\)</span> next period for all states and all dates.</p>
<p>We accomplish this by using various equations for the Lucas-Stokey <span id="id9">[<a class="reference internal" href="zreferences.html#id179" title="Robert E Lucas, Jr. and Nancy L Stokey. Optimal Fiscal and Monetary Policy in an Economy without Capital. Journal of monetary Economics, 12(3):55–93, 1983.">Lucas and Stokey, 1983</a>]</span> model
presented in <a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state-contingent debt</span></a>.</p>
<p>We use the following steps.</p>
<p><strong>Step 1:</strong>  Pick an initial <span class="math notranslate nohighlight">\(\Phi\)</span>.</p>
<p><strong>Step 2:</strong> Given that <span class="math notranslate nohighlight">\(\Phi\)</span>, jointly solve two versions of equation <a class="reference internal" href="#equation-amss2-ts-barg10">(47.4)</a> for <span class="math notranslate nohighlight">\(c(s), s=1, 2\)</span> associated with the two values
for <span class="math notranslate nohighlight">\(g(s), s=1,2\)</span>.</p>
<p><strong>Step 3:</strong>  Solve the following equation for <span class="math notranslate nohighlight">\(\vec x\)</span></p>
<div class="math notranslate nohighlight" id="equation-lsa-xsola">
<span class="eqno">(47.6)<a class="headerlink" href="#equation-lsa-xsola" title="Link to this equation">#</a></span>\[\vec x= (I - \beta \Pi )^{-1} [ \vec u_c (\vec n-\vec g) - \vec u_l \vec n]\]</div>
<p><strong>Step 4:</strong> After solving for <span class="math notranslate nohighlight">\(\vec x\)</span>, we can find <span class="math notranslate nohighlight">\(b(s_t|s^{t-1})\)</span> in Markov
state <span class="math notranslate nohighlight">\(s_t=s\)</span> from <span class="math notranslate nohighlight">\(b(s) = {\frac{x(s)}{u_c(s)}}\)</span> or the matrix equation</p>
<div class="math notranslate nohighlight" id="equation-amss2-lsa-bsol">
<span class="eqno">(47.7)<a class="headerlink" href="#equation-amss2-lsa-bsol" title="Link to this equation">#</a></span>\[\vec b = {\frac{ \vec x }{\vec u_c}}\]</div>
<p><strong>Step 5:</strong> Compute <span class="math notranslate nohighlight">\(J(\Phi) = (b(1) - b(2))^2\)</span>.</p>
<p><strong>Step 6:</strong> Put steps 2 through 6 in a function minimizer and find a <span class="math notranslate nohighlight">\(\Phi\)</span> that minimizes <span class="math notranslate nohighlight">\(J(\Phi)\)</span>.</p>
<p><strong>Step 7:</strong> At the value of <span class="math notranslate nohighlight">\(\Phi\)</span> and the value of <span class="math notranslate nohighlight">\(\bar b\)</span> that emerged from step 6, solve equations
<a class="reference internal" href="#equation-amss2-ts-barg11">(47.5)</a> and <a class="reference internal" href="#equation-eqn-amss2-10">(47.3)</a> jointly for <span class="math notranslate nohighlight">\(c_0, b_0\)</span>.</p>
</section>
<section id="code-for-reverse-engineering">
<h2><span class="section-number">47.6. </span>Code for reverse engineering<a class="headerlink" href="#code-for-reverse-engineering" title="Link to this heading">#</a></h2>
<p>Here is code to do the calculations for us.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">CRRAutility</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">min_Φ</span><span class="p">(</span><span class="n">Φ</span><span class="p">):</span>

    <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">G</span>  <span class="c1"># Government spending in s=0 and s=1</span>

    <span class="c1"># Solve Φ(c)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">equations</span><span class="p">(</span><span class="n">unknowns</span><span class="p">,</span> <span class="n">Φ</span><span class="p">):</span>
        <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">unknowns</span>
        <span class="c1"># First argument of .Uc and second argument of .Un are redundant</span>

        <span class="c1"># Set up simultaneous equations</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Φ</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="o">-</span><span class="n">u</span><span class="o">.</span><span class="n">Un</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="n">g</span><span class="p">))</span> <span class="o">+</span> \
                            <span class="n">Φ</span> <span class="o">*</span> <span class="p">((</span><span class="n">c</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Ucc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Return equation evaluated at s=1 and s=2</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eq</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">g1</span><span class="p">),</span> <span class="n">eq</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">g2</span><span class="p">)])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">global</span> <span class="n">c1</span>                 <span class="c1"># Update c1 globally</span>
    <span class="k">global</span> <span class="n">c2</span>                 <span class="c1"># Update c2 globally</span>

    <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">Φ</span><span class="p">))</span>

    <span class="n">uc</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>                            <span class="c1"># uc(n - g)</span>
    <span class="c1"># ul(n) = -un(c + g)</span>
    <span class="n">ul</span> <span class="o">=</span> <span class="o">-</span><span class="n">u</span><span class="o">.</span><span class="n">Un</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c1</span> <span class="o">+</span> <span class="n">g1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">+</span> <span class="n">g2</span><span class="p">]))</span> <span class="o">*</span> <span class="p">[</span><span class="n">c1</span> <span class="o">+</span> <span class="n">g1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">+</span> <span class="n">g2</span><span class="p">]</span>
    <span class="c1"># Solve for x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">((</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">u</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="n">uc</span> <span class="o">*</span> <span class="p">[</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">]</span> <span class="o">-</span> <span class="n">ul</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">b</span>                 <span class="c1"># Update b globally</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">uc</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">loss</span>

<span class="n">Φ_star</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">(</span><span class="n">min_Φ</span><span class="p">,</span> <span class="mf">.1</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully.
         Current function value: 0.000000
         Iterations: 24
         Function evaluations: 48
</pre></div>
</div>
</div>
</div>
<p>To recover and print out <span class="math notranslate nohighlight">\(\bar b\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b_bar</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">b_bar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(-1.0757576567504166)
</pre></div>
</div>
</div>
</div>
<p>To complete the reverse engineering exercise by jointly determining <span class="math notranslate nohighlight">\(c_0, b_0\)</span>,  we
set up a function that returns two simultaneous equations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">solve_cb</span><span class="p">(</span><span class="n">unknowns</span><span class="p">,</span> <span class="n">Φ</span><span class="p">,</span> <span class="n">b_bar</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">c0</span><span class="p">,</span> <span class="n">b0</span> <span class="o">=</span> <span class="n">unknowns</span>

    <span class="n">g0</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">R_0</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">@</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">R_0</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">R_0</span>

    <span class="n">τ_0</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">Un</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">g0</span><span class="p">)</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">eq1</span> <span class="o">=</span> <span class="n">τ_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">c0</span> <span class="o">+</span> <span class="n">g0</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_bar</span> <span class="o">/</span> <span class="n">R_0</span> <span class="o">-</span> <span class="n">b0</span> <span class="o">-</span> <span class="n">g0</span>
    <span class="n">eq2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Φ</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">Un</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">g0</span><span class="p">))</span> \
           <span class="o">+</span> <span class="n">Φ</span> <span class="o">*</span> <span class="p">(</span><span class="n">c0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Ucc</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">c0</span> <span class="o">+</span> <span class="n">g0</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">g0</span><span class="p">))</span> \
           <span class="o">-</span> <span class="n">Φ</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Ucc</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">b0</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eq1</span><span class="p">,</span> <span class="n">eq2</span><span class="o">.</span><span class="n">item</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To solve the equations for <span class="math notranslate nohighlight">\(c_0, b_0\)</span>, we use SciPy’s fsolve function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c0</span><span class="p">,</span> <span class="n">b0</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">solve_cb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">),</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">Φ_star</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">)</span>
<span class="n">c0</span><span class="p">,</span> <span class="n">b0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(0.9344994030900681), np.float64(-1.0386984075517638))
</pre></div>
</div>
</div>
</div>
<p>Thus, we have reverse engineered an initial <span class="math notranslate nohighlight">\(b0 = -1.038698407551764\)</span> that ought to render the AMSS measurability constraints slack.</p>
</section>
<section id="short-simulation-for-reverse-engineered-initial-debt">
<h2><span class="section-number">47.7. </span>Short simulation for reverse-engineered: initial debt<a class="headerlink" href="#short-simulation-for-reverse-engineered-initial-debt" title="Link to this heading">#</a></h2>
<p>The following graph shows simulations of outcomes for both a Lucas-Stokey economy and for an AMSS economy starting from initial government
debt equal to <span class="math notranslate nohighlight">\(b_0 = -1.038698407551764\)</span>.</p>
<p>These graphs report outcomes for both the Lucas-Stokey economy with complete markets and the AMSS economy with one-period risk-free debt only.</p>
<div class="cell tag_scroll-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μ_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">log_example</span> <span class="o">=</span> <span class="n">CRRAutility</span><span class="p">()</span>

<span class="n">log_example</span><span class="o">.</span><span class="n">transfers</span> <span class="o">=</span> <span class="kc">True</span>                    <span class="c1"># Government can use transfers</span>
<span class="n">log_sequential</span> <span class="o">=</span> <span class="n">SequentialAllocation</span><span class="p">(</span><span class="n">log_example</span><span class="p">)</span>  <span class="c1"># Solve sequential problem</span>
<span class="n">log_bellman</span> <span class="o">=</span> <span class="n">RecursiveAllocationAMSS</span><span class="p">(</span><span class="n">log_example</span><span class="p">,</span> <span class="n">μ_grid</span><span class="p">,</span>
                                      <span class="n">tol_diff</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>

<span class="n">T</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">sHist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>


<span class="n">sim_seq</span> <span class="o">=</span> <span class="n">log_sequential</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="o">-</span><span class="mf">1.03869841</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sHist</span><span class="p">)</span>
<span class="n">sim_bel</span> <span class="o">=</span> <span class="n">log_bellman</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="o">-</span><span class="mf">1.03869841</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sHist</span><span class="p">)</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Consumption&#39;</span><span class="p">,</span> <span class="s1">&#39;Labor Supply&#39;</span><span class="p">,</span> <span class="s1">&#39;Government Debt&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Tax Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;Government Spending&#39;</span><span class="p">,</span> <span class="s1">&#39;Output&#39;</span><span class="p">]</span>

<span class="c1"># Government spending paths</span>
<span class="n">sim_seq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_example</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">sHist</span><span class="p">]</span>
<span class="n">sim_bel</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_example</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">sHist</span><span class="p">]</span>

<span class="c1"># Output paths</span>
<span class="n">sim_seq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_example</span><span class="o">.</span><span class="n">Θ</span><span class="p">[</span><span class="n">sHist</span><span class="p">]</span> <span class="o">*</span> <span class="n">sim_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">sim_bel</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_example</span><span class="o">.</span><span class="n">Θ</span><span class="p">[</span><span class="n">sHist</span><span class="p">]</span> <span class="o">*</span> <span class="n">sim_bel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">bel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">titles</span><span class="p">,</span> <span class="n">sim_seq</span><span class="p">,</span> <span class="n">sim_bel</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s1">&#39;-ok&#39;</span><span class="p">,</span> <span class="n">bel</span><span class="p">,</span> <span class="s1">&#39;-^b&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;Complete Markets&#39;</span><span class="p">,</span> <span class="s1">&#39;Incomplete Markets&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages/scipy/optimize/_slsqp_py.py:435: RuntimeWarning: Values in x were outside bounds during a minimize step, clipping to bounds
  fx = wrapped_fun(x)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages/scipy/optimize/_slsqp_py.py:439: RuntimeWarning: Values in x were outside bounds during a minimize step, clipping to bounds
  g = append(wrapped_grad(x), 0.0)
/home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages/scipy/optimize/_slsqp_py.py:493: RuntimeWarning: Values in x were outside bounds during a minimize step, clipping to bounds
  a_eq = vstack([con[&#39;jac&#39;](x, *con[&#39;args&#39;])
/tmp/ipykernel_6502/108196118.py:24: RuntimeWarning: divide by zero encountered in reciprocal
  U = (c**(1 - σ) - 1) / (1 - σ)
/tmp/ipykernel_6502/108196118.py:29: RuntimeWarning: divide by zero encountered in power
  return c**(-self.σ)
/tmp/ipykernel_6502/1190972211.py:249: RuntimeWarning: invalid value encountered in divide
  x * u_c / Eu_c - u_c * (c - T) - Un(c, n) * n - β * xprime,
/tmp/ipykernel_6502/1190972211.py:249: RuntimeWarning: invalid value encountered in multiply
  x * u_c / Eu_c - u_c * (c - T) - Un(c, n) * n - β * xprime,
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.04094445433232818
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0016732111461359516
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0014846748479142155
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0013137721371463743
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0011814037131640195
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0010559653360912552
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0009446661650337737
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0008463807317142531
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0007560453789689492
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0006756001034248314
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0006041528456252944
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0005396004516941961
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00048207169101576434
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00043082732113835755
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0003848185137143967
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00034383521772799684
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00030724369355911575
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0002745009146200466
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00024531773289314455
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00021923324306209695
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00019593539315430138
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0001751430347162758
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00015655939849412392
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00013996737081192084
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00012514457789997936
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00011190070822025791
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00010007020011577877
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.949728534225255e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.004975323730602e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.16058523565831e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.405840603001651e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.7311605204912085e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.1279701409611166e-05
4.588651735399559e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.1063904852478396e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.675097004631475e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.289357327472656e-05
2.9443322648602943e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.6356778309637052e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.359547687706916e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.1124867580466462e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.8914292431331397e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.693598956049794e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.5165570360317311e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.3581075206606912e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2162766095160964e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0893227517161743e-05
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.75667813254887e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.739234294033434e-06
7.828320763543716e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.012602925637963e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.2821987520463745e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.628118985512823e-06
5.042427596805075e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.517800346135924e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.048011569753487e-06
3.6271820865430584e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.250227988093786e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.912555318927758e-06
2.6100632262387435e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.3390963981843707e-06
2.0963001002587826e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.8787856495313032e-06
1.6838896559640456e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.5092762924134947e-06
1.3527904915646859e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2125869837481988e-06
1.086936736188399e-06
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.743293428665199e-07
8.7342583535598e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.829793949996804e-07
7.019280196192437e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.292786585717679e-07
5.641636305202874e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.05800808400645e-07
4.534842746907917e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.065906231037718e-07
3.6455314910230184e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.268700268088774e-07
2.930882109456634e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.6280346359417933e-07
2.3565294952317464e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.1131169544317173e-07
1.8948852395749044e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.6992246254088333e-07
1.5237965896391666e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.36650550533465e-07
1.2254729739411068e-07
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0990158313840169e-07
9.856252384508452e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.839490730246918e-08
7.927751446579128e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.110170274004418e-08
6.377012685288535e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.7195436643372687e-08
5.1299443512188436e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.6011938447508174e-08
4.1270242118079466e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.7017918970304916e-08
3.320421380069723e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.9783851926932304e-08
2.6716194571802195e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.396483518428605e-08
2.149711961269502e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.9283767111035456e-08
1.7298536198511216e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.5517877653528116e-08
1.3920701554006985e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2488069735026342e-08
1.1203020025781439e-08
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0050328421300043e-08
9.016349313398815e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.088844595004973e-09
7.256836582054117e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.510486143798715e-09
5.840962662020841e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.240351194451015e-09
4.701552336373395e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.218197728847639e-09
3.784577214965798e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.39556790845528e-09
3.0465768226953068e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.7334822827570134e-09
2.452589940973661e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.2005842723575347e-09
1.9744924134791953e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.771646784378817e-09
1.5896560553537582e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4263742013735938e-09
1.2798754674494482e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.1484350711066115e-09
1.0305008645671185e-09
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.2468498987524e-10
8.297604018691073e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.445429967374545e-10
6.681600390366476e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.995640723605881e-10
5.380685564085074e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.828605606916098e-10
4.333371675604615e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.8889198232708733e-10
3.490107516971501e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.13222163741532e-10
2.811041065579007e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.522829728644378e-10
2.2641592712749346e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0320307518046e-10
1.8237112216482996e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.636747633439505e-10
1.4689685795488672e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.318383458103175e-10
1.1832381055284515e-10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0619591640088209e-10
9.531158341145558e-11
</pre></div>
</div>
<img alt="_images/dc8ec3e7af30a358c37bc234669f57773f6bd4c23f75dfd686faf38394f515e4.png" src="_images/dc8ec3e7af30a358c37bc234669f57773f6bd4c23f75dfd686faf38394f515e4.png" />
</div>
</div>
<p>The Ramsey allocations and Ramsey outcomes are <strong>identical</strong> for the Lucas-Stokey and AMSS economies.</p>
<p>This outcome confirms the success of our reverse-engineering exercises.</p>
<p>Notice how for <span class="math notranslate nohighlight">\(t \geq 1\)</span>, the tax rate is a constant - so is the par value of government debt.</p>
<p>However, output and labor supply are both nontrivial time-invariant functions of the Markov state.</p>
</section>
<section id="long-simulation">
<h2><span class="section-number">47.8. </span>Long simulation<a class="headerlink" href="#long-simulation" title="Link to this heading">#</a></h2>
<p>The following graph shows the par value of government debt and the flat-rate tax on labor income  for a long simulation for our sample economy.</p>
<p>For the <strong>same</strong> realization of a government expenditure path, the graph reports outcomes for two economies</p>
<ul class="simple">
<li><p>the gray lines are for the Lucas-Stokey economy with complete markets</p></li>
<li><p>the blue lines are for the AMSS economy with risk-free one-period debt only</p></li>
</ul>
<p>For both economies, initial government debt due at time <span class="math notranslate nohighlight">\(0\)</span> is <span class="math notranslate nohighlight">\(b_0 = .5\)</span>.</p>
<p>For the Lucas-Stokey complete markets economy, the government debt plotted is <span class="math notranslate nohighlight">\(b_{t+1}(s_{t+1})\)</span>.</p>
<ul class="simple">
<li><p>Notice that this is a time-invariant function of the Markov state from the beginning.</p></li>
</ul>
<p>For the AMSS incomplete markets economy, the government debt plotted is <span class="math notranslate nohighlight">\(b_{t+1}(s^t)\)</span>.</p>
<ul class="simple">
<li><p>Notice that this is a martingale-like random process that eventually seems to converge to a constant <span class="math notranslate nohighlight">\(\bar b \approx - 1.07\)</span>.</p></li>
<li><p>Notice that the limiting value <span class="math notranslate nohighlight">\(\bar b &lt; 0\)</span> so that asymptotically the government makes a constant level of risk-free loans to the public.</p></li>
<li><p>In the simulation displayed as well as  other simulations we have run, the par value of government debt converges to about <span class="math notranslate nohighlight">\(1.07\)</span> after between 1400 to 2000 periods.</p></li>
</ul>
<p>For the AMSS incomplete markets economy, the marginal tax rate on labor income  <span class="math notranslate nohighlight">\(\tau_t\)</span> converges to a constant</p>
<ul class="simple">
<li><p>labor supply and output each converge to time-invariant functions of the Markov state</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># Set T to 200 periods</span>

<span class="n">sim_seq_long</span> <span class="o">=</span> <span class="n">log_sequential</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="n">sHist_long</span> <span class="o">=</span> <span class="n">sim_seq_long</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
<span class="n">sim_bel_long</span> <span class="o">=</span> <span class="n">log_bellman</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sHist_long</span><span class="p">)</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Government Debt&#39;</span><span class="p">,</span> <span class="s1">&#39;Tax Rate&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">titles</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sim_seq_long</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">sim_bel_long</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="s1">&#39;-.b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;Complete Markets&#39;</span><span class="p">,</span> <span class="s1">&#39;Incomplete Markets&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/600c7d00fffda7c6924967aec1eb55cad5cbbc4da3e2d50eb1d33c73e0aa7de5.png" src="_images/600c7d00fffda7c6924967aec1eb55cad5cbbc4da3e2d50eb1d33c73e0aa7de5.png" />
</div>
</div>
<section id="remarks-about-long-simulation">
<h3><span class="section-number">47.8.1. </span>Remarks about long simulation<a class="headerlink" href="#remarks-about-long-simulation" title="Link to this heading">#</a></h3>
<p>As remarked above, after <span class="math notranslate nohighlight">\(b_{t+1}(s^t)\)</span> has converged to a constant, the measurability constraints in the AMSS model cease to bind</p>
<ul class="simple">
<li><p>the associated Lagrange multipliers on those implementability constraints converge to zero</p></li>
</ul>
<p>This leads us to seek an initial value of government debt <span class="math notranslate nohighlight">\(b_0\)</span> that renders the measurability constraints slack from time <span class="math notranslate nohighlight">\(t=0\)</span> onward</p>
<ul class="simple">
<li><p>a tell-tale sign of this situation is that the Ramsey planner in a corresponding Lucas-Stokey economy would instruct the government to issue a
constant level of government debt <span class="math notranslate nohighlight">\(b_{t+1}(s_{t+1})\)</span> across the two Markov states</p></li>
</ul>
<p>We  now describe how to find such an initial level of government debt.</p>
</section>
</section>
<section id="begs-approximations-of-limiting-debt-and-convergence-rate">
<h2><span class="section-number">47.9. </span>BEGS approximations of limiting debt and convergence rate<a class="headerlink" href="#begs-approximations-of-limiting-debt-and-convergence-rate" title="Link to this heading">#</a></h2>
<p>It is useful to link the outcome of our reverse engineering exercise to limiting approximations constructed by BEGS <span id="id10">[<a class="reference internal" href="zreferences.html#id231" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span>.</p>
<p>BEGS <span id="id11">[<a class="reference internal" href="zreferences.html#id231" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> used a slightly different notation to represent a generalization of the AMSS model.</p>
<p>We’ll introduce a version of their notation so that readers can quickly relate notation that appears in their key formulas to the notation
that we have used.</p>
<p>BEGS work with objects <span class="math notranslate nohighlight">\(B_t, {\mathcal B}_t, {\mathcal R}_t, {\mathcal X}_t\)</span> that are related to our notation by</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
{\mathcal R}_t &amp; = \frac{u_{c,t}}{u_{c,t-1}} R_{t-1}  = \frac{u_{c,t}}{ \beta E_{t-1} u_{c,t}} \\
B_t &amp; = \frac{b_{t+1}(s^t)}{R_t(s^t)} \\
b_t(s^{t-1}) &amp; = {\mathcal R}_{t-1} B_{t-1} \\
{\mathcal B}_t &amp; = u_{c,t} B_t = (\beta E_t u_{c,t+1}) b_{t+1}(s^t) \\
{\mathcal X}_t &amp; = u_{c,t} [g_t - \tau_t n_t]
\end{aligned}
\end{split}\]</div>
<p>In terms of their notation, equation (44) of <span id="id12">[<a class="reference internal" href="zreferences.html#id231" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span> expresses the time <span class="math notranslate nohighlight">\(t\)</span> state <span class="math notranslate nohighlight">\(s\)</span> government budget constraint as</p>
<div class="math notranslate nohighlight" id="equation-eq-fiscal-risk">
<span class="eqno">(47.8)<a class="headerlink" href="#equation-eq-fiscal-risk" title="Link to this equation">#</a></span>\[{\mathcal B}(s) = {\mathcal R}_\tau(s, s_{-}) {\mathcal B}_{-} + {\mathcal X}_{\tau(s)} (s)\]</div>
<p>where the dependence on <span class="math notranslate nohighlight">\(\tau\)</span> is to remind us that these objects depend on the tax rate and <span class="math notranslate nohighlight">\(s_{-}\)</span> is last period’s Markov state.</p>
<p>BEGS interpret random variations in the right side of <a class="reference internal" href="#equation-eq-fiscal-risk">(47.8)</a> as a measure of <strong>fiscal risk</strong> composed of</p>
<ul class="simple">
<li><p>interest-rate-driven fluctuations in time <span class="math notranslate nohighlight">\(t\)</span> effective payments due on the government portfolio, namely,
<span class="math notranslate nohighlight">\({\mathcal R}_\tau(s, s_{-}) {\mathcal B}_{-}\)</span>,  and</p></li>
<li><p>fluctuations in the effective government deficit <span class="math notranslate nohighlight">\({\mathcal X}_t\)</span></p></li>
</ul>
<section id="asymptotic-mean">
<h3><span class="section-number">47.9.1. </span>Asymptotic mean<a class="headerlink" href="#asymptotic-mean" title="Link to this heading">#</a></h3>
<p>BEGS give conditions under which the ergodic mean of <span class="math notranslate nohighlight">\({\mathcal B}_t\)</span> is</p>
<div class="math notranslate nohighlight" id="equation-prelim-formula">
<span class="eqno">(47.9)<a class="headerlink" href="#equation-prelim-formula" title="Link to this equation">#</a></span>\[{\mathcal B}^* = - \frac{\rm cov^{\infty}(\mathcal R, \mathcal X)}{\rm var^{\infty}(\mathcal R)}\]</div>
<p>where the superscript <span class="math notranslate nohighlight">\(\infty\)</span> denotes a moment taken with respect to an ergodic distribution.</p>
<p>Formula <a class="reference internal" href="#equation-prelim-formula">(47.9)</a> presents <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span> as a regression coefficient of <span class="math notranslate nohighlight">\({\mathcal X}_t\)</span> on <span class="math notranslate nohighlight">\({\mathcal R}_t\)</span> in the ergodic
distribution.</p>
<p>This regression coefficient emerges as the minimizer for a variance-minimization problem:</p>
<div class="math notranslate nohighlight" id="equation-eq-criterion-fiscal">
<span class="eqno">(47.10)<a class="headerlink" href="#equation-eq-criterion-fiscal" title="Link to this equation">#</a></span>\[{\mathcal B}^* = {\rm argmin}_{\mathcal B}  {\rm var} ({\mathcal R} {\mathcal B} + {\mathcal X})\]</div>
<p>The minimand in criterion <a class="reference internal" href="#equation-eq-criterion-fiscal">(47.10)</a> is the  measure of fiscal risk associated with a given tax-debt policy that appears on the right side
of equation <a class="reference internal" href="#equation-eq-fiscal-risk">(47.8)</a>.</p>
<p>Expressing formula <a class="reference internal" href="#equation-prelim-formula">(47.9)</a> in terms of  our notation tells us that <span class="math notranslate nohighlight">\(\bar b\)</span> should approximately equal</p>
<div class="math notranslate nohighlight" id="equation-key-formula">
<span class="eqno">(47.11)<a class="headerlink" href="#equation-key-formula" title="Link to this equation">#</a></span>\[\hat b = \frac{\mathcal B^*}{\beta E_t u_{c,t+1}}\]</div>
</section>
<section id="rate-of-convergence">
<h3><span class="section-number">47.9.2. </span>Rate of convergence<a class="headerlink" href="#rate-of-convergence" title="Link to this heading">#</a></h3>
<p>BEGS also derive the following  approximation to the rate of convergence to <span class="math notranslate nohighlight">\({\mathcal B}^{*}\)</span> from an arbitrary initial condition.</p>
<div class="math notranslate nohighlight" id="equation-rate-of-convergence">
<span class="eqno">(47.12)<a class="headerlink" href="#equation-rate-of-convergence" title="Link to this equation">#</a></span>\[\frac{ E_t  ( {\mathcal B}_{t+1} - {\mathcal B}^{*} )} { ( {\mathcal B}_{t} - {\mathcal B}^{*} )} \approx \frac{1}{1 + \beta^2 {\rm var} ({\mathcal R} )}\]</div>
<p>(See the equation above equation (47) in <span id="id13">[<a class="reference internal" href="zreferences.html#id231" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span>)</p>
</section>
<section id="formulas-and-code-details">
<h3><span class="section-number">47.9.3. </span>Formulas and code details<a class="headerlink" href="#formulas-and-code-details" title="Link to this heading">#</a></h3>
<p>For our example, we describe some code that we use to compute the steady state mean and the rate of convergence to it.</p>
<p>The  values of <span class="math notranslate nohighlight">\(\pi(s)\)</span> are 0.5, 0.5.</p>
<p>We can then construct <span class="math notranslate nohighlight">\({\mathcal X}(s), {\mathcal R}(s), u_c(s)\)</span> for our two states using  the definitions above.</p>
<p>We can then construct <span class="math notranslate nohighlight">\(\beta E_{t-1} u_c = \beta \sum_s u_c(s) \pi(s)\)</span>, <span class="math notranslate nohighlight">\({\rm cov}({\mathcal R}(s), \mathcal{X}(s))\)</span> and
<span class="math notranslate nohighlight">\({\rm var}({\mathcal R}(s))\)</span> to be plugged into formula <a class="reference internal" href="#equation-key-formula">(47.11)</a>.</p>
<p>We also want to  compute <span class="math notranslate nohighlight">\({\rm var}({\mathcal X})\)</span>.</p>
<p>To compute the variances and covariance, we use the following standard formulas.</p>
<p>Temporarily let <span class="math notranslate nohighlight">\(x(s), s =1,2\)</span> be an arbitrary random variables.</p>
<p>Then we define</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
\mu_x &amp; = \sum_s x(s) \pi(s) \\
{\rm var}(x) &amp;= \left(\sum_s \sum_s x(s)^2 \pi(s) \right) - \mu_x^2 \\
{\rm cov}(x,y)  &amp; = \left(\sum_s x(s) y(s) \pi(s) \right) - \mu_x \mu_y
\end{aligned}
\end{split}\]</div>
<p>After we compute these moments, we  compute the BEGS approximation to the asymptotic mean <span class="math notranslate nohighlight">\(\hat b\)</span> in formula <a class="reference internal" href="#equation-key-formula">(47.11)</a>.</p>
<p>After that, we move on to compute <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span> in formula <a class="reference internal" href="#equation-prelim-formula">(47.9)</a>.</p>
<p>We’ll also evaluate  the BEGS criterion <a class="reference internal" href="#equation-eq-fiscal-risk">(47.8)</a> at the limiting value <span class="math notranslate nohighlight">\({\mathcal B}^*\)</span></p>
<div class="math notranslate nohighlight" id="equation-eqn-jcriterion">
<span class="eqno">(47.13)<a class="headerlink" href="#equation-eqn-jcriterion" title="Link to this equation">#</a></span>\[J ( {\mathcal B}^*)=  {\rm var}(\mathcal{R}) \left( {\mathcal B}^* \right)^2 + 2 {\mathcal B}^* {\rm cov}(\mathcal{R},\mathcal{X}) + {\rm var}(\mathcal X)\]</div>
<p>Here are some functions that we’ll use to compute key objects that we want</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns mean for x given initial state&#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">@</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">variance</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">@</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">covariance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">@</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s form the two random variables <span class="math notranslate nohighlight">\({\mathcal R}, {\mathcal X}\)</span> appearing in the BEGS approximating formulas</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">CRRAutility</span><span class="p">()</span>

<span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.940580824225584</span><span class="p">,</span> <span class="mf">0.8943592757759343</span><span class="p">]</span>  <span class="c1"># Vector for c</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">G</span>       <span class="c1"># Vector for g</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">g</span>     <span class="c1"># Total population</span>
<span class="n">τ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">Un</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">R_s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> \
                <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="n">X_s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">τ</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

<span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="n">R_s</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">R_s</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">X_s</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">X_s</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R, X = </span><span class="si">{</span><span class="n">R</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R, X = [np.float64(1.055169547122964), np.float64(1.1670526750992583)], [np.float64(0.06357685646224803), np.float64(0.19251010100512958)]
</pre></div>
</div>
</div>
</div>
<p>Now let’s compute the ingredient of the approximating limit and the approximating rate of convergence</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bstar</span> <span class="o">=</span> <span class="o">-</span><span class="n">covariance</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="n">variance</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
<span class="n">div</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">β</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">π</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">bhat</span> <span class="o">=</span> <span class="n">bstar</span> <span class="o">/</span> <span class="n">div</span>
<span class="n">bhat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(-1.0757585378303758)
</pre></div>
</div>
</div>
</div>
<p>Print out <span class="math notranslate nohighlight">\(\hat b\)</span> and <span class="math notranslate nohighlight">\(\bar b\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bhat</span><span class="p">,</span> <span class="n">b_bar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(-1.0757585378303758), np.float64(-1.0757576567504166))
</pre></div>
</div>
</div>
</div>
<p>So we have</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bhat</span> <span class="o">-</span> <span class="n">b_bar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(-8.810799592140484e-07)
</pre></div>
</div>
</div>
</div>
<p>These outcomes show that <span class="math notranslate nohighlight">\(\hat b\)</span> does a remarkably good job of approximating <span class="math notranslate nohighlight">\(\bar b\)</span>.</p>
<p>Next, let’s compute the BEGS fiscal criterion that <span class="math notranslate nohighlight">\(\hat b\)</span> is minimizing</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Jmin</span> <span class="o">=</span> <span class="n">variance</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="n">bstar</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bstar</span> <span class="o">*</span> <span class="n">covariance</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">variance</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">Jmin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(-9.020562075079397e-17)
</pre></div>
</div>
</div>
</div>
<p>This is <em>machine zero</em>, a verification that <span class="math notranslate nohighlight">\(\hat b\)</span> succeeds in minimizing the nonnegative fiscal cost criterion <span class="math notranslate nohighlight">\(J ( {\mathcal B}^*)\)</span> defined in
BEGS and in equation <a class="reference internal" href="#equation-eqn-jcriterion">(47.13)</a> above.</p>
<p>Let’s push our luck and compute the mean reversion speed in the formula above equation (47) in <span id="id14">[<a class="reference internal" href="zreferences.html#id231" title="Anmol Bhandari, David Evans, Mikhail Golosov, and Thomas J. Sargent. Fiscal Policy and Debt Management with Incomplete Markets. The Quarterly Journal of Economics, 132(2):617-663, 2017.">Bhandari <em>et al.</em>, 2017</a>]</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">den2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">β</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">variance</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
<span class="n">speedrever</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">den2</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean reversion speed = </span><span class="si">{</span><span class="n">speedrever</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean reversion speed = 0.9974715478249827
</pre></div>
</div>
</div>
</div>
<p>Now let’s compute the implied meantime to get to within 0.01 of the limit</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ttime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">.01</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">speedrever</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time to get within .01 of limit = </span><span class="si">{</span><span class="n">ttime</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time to get within .01 of limit = 1819.0360880098472
</pre></div>
</div>
</div>
</div>
<p>The slow rate of convergence and the implied time of getting within one percent of the limiting value do a good job of approximating
our long simulation above.</p>
<p>In <a class="reference internal" href="amss3.html"><span class="doc">a subsequent lecture</span></a> we shall study an extension of the model in which the force highlighted in this lecture causes  government debt to  converge to a nontrivial distribution instead of the single debt level discovered here.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                    </div>
                    
                </main> <!-- .page__content -->
                


                <footer class="qe-page__footer">

                    <p><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"></a></p>

                    <p>Creative Commons License &ndash; This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International.</p>

                    <p>A theme by <a href="https://quantecon.org">QuantEcon</a></p>

                </footer> <!-- .page__footer -->

            </div> <!-- .page -->

            

            
            <div class="qe-sidebar bd-sidebar inactive" id="site-navigation">

                <div class="qe-sidebar__header">


                    Contents

                </div>

                <nav class="qe-sidebar__nav" id="qe-sidebar-nav" aria-label="Main navigation">
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tools and Techniques
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="orth_proj.html">
   1. Orthogonal Projections and Their Applications
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="stationary_densities.html">
   2. Continuous State Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="muth_kalman.html">
   3. Reverse Engineering a la Muth
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="discrete_dp.html">
   4. Discrete State Dynamic Programming
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  LQ Control
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="cons_news.html">
   5. Information and Consumption Smoothing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="smoothing.html">
   6. Consumption Smoothing with Complete and Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="smoothing_tax.html">
   7. Tax Smoothing with Complete and Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="markov_jump_lq.html">
   8. Markov Jump Linear Quadratic Dynamic Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_1.html">
   9. How to Pay for a War: Part 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_2.html">
   10. How to Pay for a War: Part 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_3.html">
   11. How to Pay for a War: Part 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lqramsey.html">
   12. Optimal Taxation in an LQ Economy
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Multiple Agent Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="arellano.html">
   13. Default Risk and Income Fluctuations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="matsuyama.html">
   14. Globalization and Cycles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coase.html">
   15. Coase’s Theory of the Firm
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="match_transport.html">
   16. Composite Sorting
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dynamic Linear Economies
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="hs_recursive_models.html">
   17. Recursive Models of Dynamic Linear Economies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="growth_in_dles.html">
   18. Growth in Dynamic Linear Economies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lucas_asset_pricing_dles.html">
   19. Lucas Asset Pricing Using DLE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="irfs_in_hall_model.html">
   20. IRFs in Hall Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="permanent_income_dles.html">
   21. Permanent Income Model using the DLE Class
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rosen_schooling_model.html">
   22. Rosen Schooling Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cattle_cycles.html">
   23. Cattle Cycles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hs_invertibility_example.html">
   24. Shock Non Invertibility
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Risk, Model Uncertainty, and Robustness
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="five_preferences.html">
   25. Risk and Model Uncertainty
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="entropy.html">
   26. Etymology of Entropy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="robustness.html">
   27. Robustness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rob_markov_perf.html">
   28. Robust Markov Perfect Equilibrium
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Time Series Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="arma.html">
   29. Covariance Stationary Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="estspec.html">
   30. Estimation of Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="additive_functionals.html">
   31. Additive and Multiplicative Functionals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lu_tricks.html">
   32. Classical Control with Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="classical_filtering.html">
   33. Classical Prediction and Filtering With Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="knowing_forecasts_of_others.html">
   34. Knowing the Forecasts of Others
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Asset Pricing and Finance
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="lucas_model.html">
   35. Asset Pricing II: The Lucas Asset Pricing Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="asset_pricing_lph.html">
   36. Elementary Asset Pricing Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="black_litterman.html">
   37. Two Modifications of Mean-Variance Portfolio Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="BCG_complete_mkts.html">
   38. Irrelevance of Capital Structures with Complete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="BCG_incomplete_mkts.html">
   39. Equilibrium Capital Structures with Incomplete Markets
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dynamic Programming Squared
 </span>
</p>
<ul class="current nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="un_insure.html">
   40. Optimal Unemployment Insurance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dyn_stack.html">
   41. Stackelberg Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="calvo_machine_learn.html">
   42. Machine Learning a Ramsey Plan
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="calvo.html">
   43. Time Inconsistency of Ramsey Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="calvo_abreu.html">
   44. Sustainable Plans for a Calvo Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="opt_tax_recur.html">
   45. Optimal Taxation with State-Contingent Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="amss.html">
   46. Optimal Taxation without State-Contingent Debt
  </a>
 </li>
 <li class="toctree-l1 current active active">
  <a class="current reference internal" href="#">
   47. Fluctuating Interest Rates Deliver Fiscal Insurance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="amss3.html">
   48. Fiscal Risk and Government Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chang_ramsey.html">
   49. Competitive Equilibria of a Model of Chang
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chang_credible.html">
   50. Credible Government Policies in a Model of Chang
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="troubleshooting.html">
   51. Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="zreferences.html">
   52. References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="status.html">
   53. Execution Statistics
  </a>
 </li>
</ul>

                </nav>

                <div class="qe-sidebar__footer">

                </div>

            </div> <!-- .sidebar -->
            
        </div> <!-- .main -->

        <div class="qe-toolbar">

            <div class="qe-toolbar__inner">

                <ul class="qe-toolbar__main">
                    <li data-tippy-content="Table of Contents" class="btn__sidebar"><i data-feather="menu"></i></li>
                    <li data-tippy-content="Home"><a href="intro.html"><i data-feather="home"></i></a></li>
                    <li class="btn__qelogo"><a href="https://quantecon.org" title=""><span class="show-for-sr">QuantEcon</span></a></li>
                </ul>

                <ul class="qe-toolbar__links">
                    <li class="btn__search">
                        <form action="search.html" method="get">
                            <input type="search" class="form-control" name="q" id="search-input" placeholder="Search..." aria-label="Search..." autocomplete="off" accesskey="k">
                            <i data-feather="search" id="search-icon"></i>
                        </form>
                    </li>
                    <li data-tippy-content="Fullscreen" class="btn__fullscreen"><i data-feather="maximize"></i></li>
                    <li data-tippy-content="Increase font size" class="btn__plus"><i data-feather="plus-circle"></i></li>
                    <li data-tippy-content="Decrease font size" class="btn__minus"><i data-feather="minus-circle"></i></li>
                    <li data-tippy-content="Change contrast" class="btn__contrast"><i data-feather="sunset"></i></li>
                    <li data-tippy-content="Download Notebook"><a href="/_notebooks/amss2.ipynb" download><i data-feather="download-cloud"></i></a></li>
                    <li class="settings-button" id="settingsButton"><div data-tippy-content="Launch Notebook"><i data-feather="play-circle"></i></div></li>
                        <li class="download-pdf" id="downloadButton"><i data-feather="file"></i></li>
                    <!--
                    # Enable if looking for link to specific document hosted on GitHub
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-python-advanced.myst/blob/main/lectures/amss2.md" download><i data-feather="github"></i></a></li>
                    -->
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-python-advanced.myst" download><i data-feather="github"></i></a></li>
                </ul>

            </div>

        </div> <!-- .toolbar -->
        <div id="downloadPDFModal" style="display: none;">
            <ul class="pdf-options" style="display: block;">
                <li class="download-pdf-book" onClick="window.print()">
                    <p>Lecture (PDF)</p>
                </li>
                <li class="download-pdf-file">
                    <a href="/_pdf/quantecon-python-advanced.pdf" download><p>Book (PDF)</p></a>
                </li>
            </ul>
        </div>
        <div id="settingsModal" style="display: none;">
            <p class="modal-title"> Notebook Launcher </p>
            <div class="modal-desc">
            <p>
                Choose public or private cloud service for "Launch" button.
            </p>
            </div>
            <p class="modal-subtitle">Select a server</p>
            <ul class="modal-servers">
            <li class="active launcher-public">
                <span class="label">Public</span>
                <select id="launcher-public-input">
                
                    <option value="https://colab.research.google.com/github/QuantEcon/lecture-python-advanced.notebooks/blob/main/amss2.ipynb">Colab</option>
                
                </select>
                <i class="fas fa-check-circle"></i>
            </li>
            <li class="launcher-private">
                <span class="label">Private</span>
                <input type="text" id="launcher-private-input" data-repourl="https://github.com/QuantEcon/lecture-python-advanced.notebooks" data-urlpath="tree/lecture-python-advanced.notebooks/amss2.ipynb" data-branch=main>
                <i class="fas fa-check-circle"></i>
            </li>
            </ul>
            <p class="launch"><a href="https://colab.research.google.com/github/QuantEcon/lecture-python-advanced.notebooks/blob/main/amss2.ipynb" id="advancedLaunchButton" target="_blank">Launch Notebook</a></p>
            <script>
                // QuantEcon Notebook Launcher
                const launcherTypeElements = document.querySelectorAll('#settingsModal .modal-servers li');
                // Highlight the server type if previous selection exists
                if (typeof localStorage.launcherType !== 'undefined') {
                  for (var i = 0; i < launcherTypeElements.length; i++) {
                    launcherTypeElements[i].classList.remove('active');
                    if ( launcherTypeElements[i].classList.contains(localStorage.launcherType) ) {
                      launcherTypeElements[i].classList.add('active');
                    }
                  }
                }
                // Highlight server type on click and set local storage value
                for (var i = 0; i < launcherTypeElements.length; i++) {
                  launcherTypeElements[i].addEventListener('click', function() {
                    for (var j = 0; j < launcherTypeElements.length; j++) {
                      launcherTypeElements[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    if ( this.classList.contains('launcher-private') ) {
                      localStorage.launcherType = 'launcher-private';
                    } else if ( this.classList.contains('launcher-public') ) {
                      localStorage.launcherType = 'launcher-public';
                    }
                    setLaunchServer();
                  })
                }
                const launcherPublic = document.getElementById('launcher-public-input');
                const launcherPrivate = document.getElementById('launcher-private-input');
                const pageName = "amss2";
                const repoURL = "https://github.com/QuantEcon/lecture-python-advanced.notebooks";
                const urlPath = "tree/lecture-python-advanced.notebooks/amss2.ipynb";
                const branch = "main"
                const launchNotebookLink = document.getElementById('advancedLaunchButton');

                // Highlight public server option if previous selection exists
                if (typeof localStorage.launcherPublic !== 'undefined') {
                  launcherPublic.value = localStorage.launcherPublic;
                }
                // Update local storage upon public server selection
                launcherPublic.addEventListener('change', (event) => {
                  setLaunchServer();
                });
                // Populate private server input if previous entry exists
                if (typeof localStorage.launcherPrivate !== 'undefined') {
                  launcherPrivate.value = localStorage.launcherPrivate;
                }
                // Update local storage when a private server is entered
                launcherPrivate.addEventListener('input', (event) => {
                  setLaunchServer();
                });

                // Function to update the "Launch Notebook" link href
                function setLaunchServer() {
                  launchNotebookLink.removeAttribute("style")
                  if ( localStorage.launcherType == 'launcher-private' ) {
                    let repoPrefix = "/user-redirect/git-pull?repo=" + repoURL + "&branch=" + branch + "&urlpath=" + urlPath;
                    launcherPrivateValue = launcherPrivate.value
                    if (!launcherPrivateValue) {
                        launchNotebookLink.removeAttribute("href")
                        launchNotebookLink.style.background = "grey"
                        return
                    }
                    localStorage.launcherPrivate = launcherPrivateValue;
                    privateServer = localStorage.launcherPrivate.replace(/\/$/, "")
                    if (!privateServer.includes("http")) {
                        privateServer = "http://" + privateServer
                    }
                    launchNotebookLinkURL = privateServer + repoPrefix;
                  } else if ( localStorage.launcherType == 'launcher-public' ) {
                    launcherPublicValue = launcherPublic.options[launcherPublic.selectedIndex].value;
                    localStorage.launcherPublic = launcherPublicValue;
                    launchNotebookLinkURL = localStorage.launcherPublic;
                  }
                  if (launchNotebookLinkURL) launchNotebookLink.href = launchNotebookLinkURL;
                }
                // Check if user has previously selected a server
                if ( (typeof localStorage.launcherPrivate !== 'undefined') || (typeof localStorage.launcherPublic !== 'undefined') ) {
                  setLaunchServer();
                }
                </script>

        </div>

    </div> <!-- .wrapper-->
  </body>
</html>