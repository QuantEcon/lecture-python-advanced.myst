
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>22. Gorman Aggregation &#8212; Advanced Quantitative Economics with Python</title>
    
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.js" integrity="sha384-bq5PNg/ZcfW7KMvFSmhjqCQJ/VFnec+6sZkctn/4ZLeubkn7U58Le4zFFSn3dhUu" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js" integrity="sha384-qEqAs1VsN9WH2myXDbiP2wGGIttL9bMRZBKCl54ZnzpDlVqbYANP9vMaoT/wvQcf" crossorigin="anonymous"></script>
    
        <script>
            MathJax = {
            loader: {load: ['[tex]/boldsymbol', '[tex]/textmacros']},
            tex: {
                packages: {'[+]': ['boldsymbol', 'textmacros']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    "argmax" : "arg\\,max",
                    "argmin" : "arg\\,min",
                    "col"    : "col",
                    "Span"   :  "span",
                    "epsilon": "\\varepsilon",
                    "EE": "\\mathbb{E}",
                    "PP": "\\mathbb{P}",
                    "RR": "\\mathbb{R}",
                    "NN": "\\mathbb{N}",
                    "ZZ": "\\mathbb{Z}",
                    "aA": "\\mathcal{A}",
                    "bB": "\\mathcal{B}",
                    "cC": "\\mathcal{C}",
                    "dD": "\\mathcal{D}",
                    "eE": "\\mathcal{E}",
                    "fF": "\\mathcal{F}",
                    "gG": "\\mathcal{G}",
                    "hH": "\\mathcal{H}",
                }
            },
            svg: {
                fontCache: 'global',
                scale: 0.92,
                displayAlign: "center",
            },
            };
        </script>
    
    
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" href="_static/styles/quantecon-book-theme.css?digest=22b71a9b445b7b2b6a277c0a48ea72bf6e7c90d9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/exercise.css?v=982b99e0" />
    <link rel="stylesheet" type="text/css" href="_static/proof.css?v=b4b7a797" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>


    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="_static/scripts/quantecon-book-theme.js?digest=65b86b9423025043228643fcfb616ce846cb91c1"></script>
    <script src="_static/scripts/jquery.js?v=5d32c60e"></script>
    <script src="_static/scripts/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KZLV7PM9LL"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KZLV7PM9LL');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KZLV7PM9LL');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex": {"macros": {"argmax": "arg\\,max", "argmin": "arg\\,min", "col": "col", "Span": "span", "epsilon": "\\varepsilon", "EE": "\\mathbb{E}", "PP": "\\mathbb{P}", "RR": "\\mathbb{R}", "NN": "\\mathbb{N}", "ZZ": "\\mathbb{Z}", "aA": "\\mathcal{A}", "bB": "\\mathcal{B}", "cC": "\\mathcal{C}", "dD": "\\mathcal{D}", "eE": "\\mathcal{E}", "fF": "\\mathcal{F}", "gG": "\\mathcal{G}", "hH": "\\mathcal{H}"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'gorman_heterogeneous_households';</script>
    <link rel="canonical" href="https://python-advanced.quantecon.org/gorman_heterogeneous_households.html" />
    <link rel="icon" href="_static/lectures-favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="23. Rosen Schooling Model" href="rosen_schooling_model.html" />
    <link rel="prev" title="21. Permanent Income Model using the DLE Class" href="permanent_income_dles.html" />

<!-- Normal Meta Tags -->
<meta name="author" context="Thomas J. Sargent &amp; John Stachurski" />
<meta name="keywords" content="Python, QuantEcon, Quantitative Economics, Economics, Sloan, Alfred P. Sloan Foundation, Tom J. Sargent, John Stachurski" />
<meta name="description" content=This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski. />

<!-- Twitter tags -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@quantecon" />
<meta name="twitter:title" content="Gorman Aggregation"/>
<meta name="twitter:description" content="This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski.">
<meta name="twitter:creator" content="@quantecon">
<meta name="twitter:image" content="https://assets.quantecon.org/img/qe-twitter-logo.png">

<!-- Opengraph tags -->
<meta property="og:title" content="Gorman Aggregation" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://python-advanced.quantecon.org/gorman_heterogeneous_households.html" />
<meta property="og:image" content="https://assets.quantecon.org/img/qe-og-logo.png" />
<meta property="og:description" content="This website presents a set of lectures on advanced quantitative economic modeling, designed and written by Thomas J. Sargent and John Stachurski." />
<meta property="og:site_name" content="Advanced Quantitative Economics with Python" />
<meta name="theme-color" content="#ffffff" />

  </head>
<body>

<!-- Override QuantEcon theme colors -->

    <span id="top"></span>

    <div class="qe-wrapper">

        <div class="qe-main">

            <div class="qe-page" id=gorman_heterogeneous_households>

                <div class="qe-page__toc">

                    <div class="inner">

                        
                        <div class="qe-page__toc-header">
                            On this page
                        </div>


                        <nav id="bd-toc-nav" class="qe-page__toc-nav">
                            <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">22.1. Overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gorman-aggregation-in-a-static-economy">22.1.1. Gorman aggregation in a static economy</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-stochastic-economy">22.2. Dynamic, Stochastic Economy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exogenous-state">22.2.1. Exogenous state</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#technologies">22.2.2. Technologies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-individual-household-problem">22.2.3. The individual household problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-representative-agent-problem">22.2.4. The representative agent problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consumption-sharing-rules">22.2.5. Consumption sharing rules</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#household-services-allocation-rule">22.2.5.1. Household services allocation rule</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inverse-canonical-representation">22.2.5.2. Inverse canonical representation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#computational-details">22.2.5.3. Computational details</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#labor-allocation-rule">22.2.5.4. Labor allocation rule</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-sharing">22.2.5.5. Risk sharing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#household-allocations">22.3. Household allocations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-household-allocations">22.3.1. Computing household allocations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-compute-deviation-consumption">22.3.1.1. Step 1: compute deviation consumption</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-compute-each-pareto-weight">22.3.1.2. Step 2: compute each Pareto weight</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limited-markets">22.4. Limited markets</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-trading-arrangement">22.4.1. The trading arrangement</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-bond-position">22.4.2. Initial bond position</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-two-household-economy">22.5. Example: two-household economy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-many-household-gorman-economies">22.6. Example: many-household Gorman economies</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specification">22.6.1. Specification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#household-economy">22.6.2. 100-household  economy</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#state-space-representation">22.7. State-space representation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#closed-loop-state-space-system">22.7.1. Closed-loop state-space system</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#redistributing-by-adjusting-pareto-weights">22.8. Redistributing by adjusting  Pareto weights</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#redistribution-via-pareto-weights">22.8.1. Redistribution via Pareto weights</a></li>
</ul>
</li>
</ul>
                            <p class="logo">
                                
                                    
                                    <a href=https://quantecon.org><img src="_static/qe-logo-large.png" class="logo logo-img" alt="logo"></a>
                                    
                                    
                                
                            </p>

                            <p class="powered">Powered by <a href="https://jupyterbook.org/v1/">Jupyter Book</a></p>

                        </nav>

                        <div class="qe-page__toc-footer">
                            
                            
                            <p><a href="#top"><strong>Back to top</strong></a></p>
                        </div>

                    </div>

                </div>

                <div class="qe-page__header">

                    <div class="qe-page__header-copy">

                        <p class="qe-page__header-heading"><a href="intro.html">Advanced Quantitative Economics with Python</a></p>

                    </div>

                    <!-- Authors section -->
                        <p class="qe-page__header-authors" font-size="18">
                            
                                
                                    <a href="http://www.tomsargent.com/" target="_blank"><span>Thomas J. Sargent</span></a>
                                
                            
                                
                                    and <a href="https://johnstachurski.net/" target="_blank"><span>John Stachurski</span></a>
                                
                            
                        </p>

                    <!-- Last modified / Changelog dropdown -->
                        <button class="qe-page__header-changed" id="changelog-toggle" aria-expanded="false">
                            Last changed: Jan 28, 2026
                            <span class="changelog-icon">▼</span>
                        </button>

                    <!-- Changelog dropdown content -->
                    <div class="qe-page__header-changelog" id="changelog-content" aria-hidden="true">
                        <h4>Changelog (<a href="https://github.com/QuantEcon/lecture-python-advanced.myst/commits/main/lectures/gorman_heterogeneous_households.md">full history</a>)</h4>
                        <ul class="changelog-list">
                            
                            <li class="changelog-entry">
                                
                                <a href="https://github.com/QuantEcon/lecture-python-advanced.myst/commit/dd1c4199" class="changelog-hash">dd1c4199</a>
                                
                                <span class="changelog-author">Humphrey Yang</span>
                                <span class="changelog-time">3 weeks ago</span>
                                <span class="changelog-message">[gorman_heterogeneous_households] Update parameters to match the parameters used in paper (#303)</span>
                            </li>
                            
                            <li class="changelog-entry">
                                
                                <a href="https://github.com/QuantEcon/lecture-python-advanced.myst/commit/742f60ac" class="changelog-hash">742f60ac</a>
                                
                                <span class="changelog-author">thomassargent30</span>
                                <span class="changelog-time">1 month ago</span>
                                <span class="changelog-message">Tom's Jan 19 edits of Gorman lecture</span>
                            </li>
                            
                            <li class="changelog-entry">
                                
                                <a href="https://github.com/QuantEcon/lecture-python-advanced.myst/commit/885ed679" class="changelog-hash">885ed679</a>
                                
                                <span class="changelog-author">Humphrey Yang</span>
                                <span class="changelog-time">1 month ago</span>
                                <span class="changelog-message">[gorman_heterogeneous_households] New lecture on Gorman aggregation (#299)</span>
                            </li>
                            
                        </ul>
                    </div>

                </div> <!-- .page__header -->



                
                <main class="qe-page__content" role="main">
                    
                    <div>
                        
  <div id="qe-notebook-header" align="right" style="text-align:right;">
        <a href="https://quantecon.org/" title="quantecon.org">
                <img style="width:250px;display:inline;" width="250px" src="https://assets.quantecon.org/img/qe-menubar-logo.svg" alt="QuantEcon">
        </a>
</div><section class="tex2jax_ignore mathjax_ignore" id="gorman-aggregation">
<span id="index-0"></span><h1><span class="section-number">22. </span>Gorman Aggregation<a class="headerlink" href="#gorman-aggregation" title="Link to this heading">#</a></h1>
<section id="overview">
<h2><span class="section-number">22.1. </span>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p><span id="id1">Gorman [<a class="reference internal" href="zreferences.html#id3" title="William M. Gorman. Community preference fields. Econometrica: Journal of the Econometric Society, 21(1):63–80, 1953.">1953</a>]</span> described a class of models with preferences having the useful property that there exists a “representative household” in the sense that competitive equilibrium allocations can be computed in the following way:</p>
<ul class="simple">
<li><p>take the heterogeneous  preferences of a diverse collection of households and from them synthesize the preferences of a single “representative household”</p></li>
<li><p>assign the endowments of all households to the representative household</p></li>
<li><p>construct a competitive equilibrium allocation and price system for the representative agent economy</p></li>
<li><p>at the  competitive equilibrium price system, compute the wealth – i.e., the present value – of each household’s initial endowment</p></li>
<li><p>find a consumption plan for each household that maximizes its utility functional subject to the wealth that you computed in the previous step</p></li>
</ul>
<p>This procedure allows us to compute the competitive equilibrium price system  for the heterogeneous household economy <em>prior</em> to computing the
competitive equilibrium allocation.</p>
<p>That substantially simplifies calculating a competitive equilibrium.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In general, computing a competitive equilibrium requires solving for the price system and the allocation simultaneously, not recursively.</p>
</div>
<p>Chapter 12 of <span id="id2">Hansen and Sargent [<a class="reference internal" href="zreferences.html#id162" title="L P Hansen and T J Sargent. Recursive Models of Dynamic Linear Economies. The Gorman Lectures in Economics. Princeton University Press, 2013.">2013</a>]</span> described how to adapt preference specifications of <span id="id3">Gorman [<a class="reference internal" href="zreferences.html#id3" title="William M. Gorman. Community preference fields. Econometrica: Journal of the Econometric Society, 21(1):63–80, 1953.">1953</a>]</span>
to a linear-quadratic class of environments.</p>
<p>This lecture uses  the <code class="docutils literal notranslate"><span class="pre">quantecon.DLE</span></code> class to study economies that satisfy necessary conditions for Gorman
aggregation of preferences.</p>
<p>To compute a competitive equilibrium, our first step  will be to form a representative agent.</p>
<p>After that, we can use some of our DLE tools to compute  competitive equilibrium</p>
<ul class="simple">
<li><p>prices without knowing the allocation of consumption to individual households</p></li>
<li><p>households’ individual wealth levels</p></li>
<li><p>households’ consumption levels</p></li>
</ul>
<p>Thus, this lecture builds on tools and Python code described in  <a class="reference internal" href="hs_recursive_models.html"><span class="doc">Recursive Models of Dynamic Linear Economies</span></a>, <a class="reference internal" href="growth_in_dles.html"><span class="doc">Growth in Dynamic Linear Economies</span></a>, and <a class="reference internal" href="irfs_in_hall_model.html"><span class="doc">IRFs in Hall Models</span></a>.</p>
<p>In a little more detail, when conditions for Gorman aggregation of preferences are satisfied, we can compute a competitive equilibrium of a heterogeneous-household economy in two steps: solve a representative-agent linear-quadratic planning problem for aggregates, then recover household allocations via a sharing-formula that makes each  household’s consumption a household-specific constant share of aggregate consumption.</p>
<ul class="simple">
<li><p>a household’s share parameter will depend on the implicit Pareto weight implied by the initial distribution of endowment.</p></li>
</ul>
<p>The key is that the Gorman-aggregation  conditions ensure all households have parallel Engel curves.</p>
<p>That feature is what lets us determine the aggregate allocations and price system before we compute the distribution of the aggregate allocation among individual households.</p>
<p>This eliminates the usual  feature that  the utility possibility frontier shifts with endowment changes, making it impossible to rank allocations without specifying distributional weights.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Computing a competitive equilibrium typically entails solving a fixed point problem.</p>
<p><span id="id4">Negishi [<a class="reference internal" href="zreferences.html#id4" title="Takashi Negishi. Welfare economics and existence of an equilibrium for a competitive economy. Metroeconomica, 12(2-3):92–97, 1960.">1960</a>]</span> described a social welfare function that is maximized, subject to resource and technological constraints, by a competitive equilibrium allocation.</p>
<p>For Negishi, that social welfare function is a “linear combination of the individual utility functions of households, with the weights in the combination in inverse proportion to the marginal utilities of income.”</p>
<p>Because Negishi’s weights depend on the allocation through the marginal utilities of income, computing a competitive equilibrium via constrained maximization of a Negishi-style welfare function requires finding a fixed point in the weights.</p>
<p>When they apply, the beauty of Gorman’s aggregation conditions is that time series aggregates and market prices can be computed <em>without</em> resorting to Negishi’s fixed point approach.</p>
</div>
<p>With the help of this powerful result, we proceed in two steps:</p>
<ol class="arabic simple">
<li><p>Solve the planner’s problem and compute selection matrices that map the aggregate state into allocations and prices.</p></li>
<li><p>Compute household-specific policies and the Gorman sharing rule.</p></li>
</ol>
<p>For a special case described  in Section 12.6 of <span id="id5">Hansen and Sargent [<a class="reference internal" href="zreferences.html#id162" title="L P Hansen and T J Sargent. Recursive Models of Dynamic Linear Economies. The Gorman Lectures in Economics. Princeton University Press, 2013.">2013</a>]</span>, where preference shocks are inactive, we can also</p>
<ol class="arabic simple" start="3">
<li><p>Implement the  Arrow-Debreu allocation by allowing households to trade  a risk-free one-period bond and a single mutual fund that owns all of the economy’s physical capital.</p></li>
</ol>
<p>We shall provide examples of these steps in economies with  two and then with many households.</p>
<p>Before studying these things in the context of the DLE class,  we’ll first introduce Gorman aggregation in a static economy.</p>
<p>In addition to what’s in Anaconda, this lecture uses the <code class="docutils literal notranslate"><span class="pre">quantecon</span></code> library</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>quantecon
</pre></div>
</div>
</div>
<details class="admonition hide below-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell output</p>
<p class="expanded admonition-title">Hide code cell output</p>
</summary>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: quantecon in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (0.10.1)
Requirement already satisfied: numba&gt;=0.49.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (0.62.1)
Requirement already satisfied: numpy&gt;=1.17.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (2.3.5)
Requirement already satisfied: requests in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (2.32.5)
Requirement already satisfied: scipy&gt;=1.5.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (1.16.3)
Requirement already satisfied: sympy in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from quantecon) (1.14.0)
Requirement already satisfied: llvmlite&lt;0.46,&gt;=0.45.0dev0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from numba&gt;=0.49.0-&gt;quantecon) (0.45.1)
Requirement already satisfied: charset_normalizer&lt;4,&gt;=2 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (3.4.4)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (3.11)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (2.5.0)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from requests-&gt;quantecon) (2025.11.12)
Requirement already satisfied: mpmath&lt;1.4,&gt;=1.1.0 in /home/runner/miniconda3/envs/quantecon/lib/python3.13/site-packages (from sympy-&gt;quantecon) (1.3.0)
</pre></div>
</div>
</div>
</details>
</div>
<p>We make the following imports</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">solve_discrete_are</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">quantecon</span><span class="w"> </span><span class="kn">import</span> <span class="n">DLE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">quantecon</span><span class="w"> </span><span class="kn">import</span> <span class="n">LQ</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<section id="gorman-aggregation-in-a-static-economy">
<span id="static-gorman"></span><h3><span class="section-number">22.1.1. </span>Gorman aggregation in a static economy<a class="headerlink" href="#gorman-aggregation-in-a-static-economy" title="Link to this heading">#</a></h3>
<p>To indicate  where our competitive equilibrium  sharing rule originates, we start with a static economy with <span class="math notranslate nohighlight">\(n\)</span> goods, price vector <span class="math notranslate nohighlight">\(p\)</span>, and households <span class="math notranslate nohighlight">\(j = 1, \ldots, J\)</span>.</p>
<p>Let <span class="math notranslate nohighlight">\(c^a\)</span> denote the aggregate amount of consumption to be allocated among households.</p>
<p>Associated with <span class="math notranslate nohighlight">\(c^a\)</span> is an Edgeworth box and a set of Pareto optimal allocations.</p>
<p>From the Pareto optimal allocations, one can construct utility allocation surfaces that describe the frontier of alternative feasible utility assignments to individual households.</p>
<p>Imagine moving from the aggregate vector <span class="math notranslate nohighlight">\(c^a\)</span> to some other vector <span class="math notranslate nohighlight">\(\tilde{c}^a\)</span> and hence to a new Edgeworth box.</p>
<p>If neither the original box nor the new box contains the other, then it is possible that the utility allocation surfaces for the two boxes may <em>cross</em>, in which case there exists no ordering of aggregate consumption that is independent of the utility weights assigned to individual households.</p>
<p>Here is an example showing when aggregation fails.</p>
<p>Consider a two-person, two-good, pure-exchange economy where agent A has utility function <span class="math notranslate nohighlight">\(U^A = X_A^{1/3} Y_A^{2/3}\)</span>, while consumer B has utility function <span class="math notranslate nohighlight">\(U^B = X_B^{2/3} Y_B^{1/3}\)</span>.</p>
<p>With aggregate endowment pairs <span class="math notranslate nohighlight">\(E = (8,3)\)</span> and <span class="math notranslate nohighlight">\(E = (3,8)\)</span>, the utility possibility frontiers cross, indicating that these two aggregate endowment vectors cannot be ranked in a way that ignores how utility is distributed between consumers A and B.</p>
<p>Furthermore, for a given endowment, the slope of the consumers’ indifference curves at the tangencies that determine the contract curve varies as one moves along the contract curve.</p>
<p>This means that for a given aggregate endowment, the competitive equilibrium price depends on the allocation between consumers A and B.</p>
<p>It follows that for this economy, one cannot determine equilibrium prices independently of the equilibrium allocation.</p>
<p>The crossing of the utility possibility frontiers can be seen by plotting the efficient utility pairs for each aggregate endowment</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">frontier</span><span class="p">(</span><span class="n">X_total</span><span class="p">,</span> <span class="n">Y_total</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a utility possibility frontier by tracing the contract curve.</span>

<span class="sd">    Preferences:</span>
<span class="sd">      U^A = X_A^(1/3) Y_A^(2/3)</span>
<span class="sd">      U^B = X_B^(2/3) Y_B^(1/3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">X_total</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">)</span>
    <span class="n">yA</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">xA</span> <span class="o">*</span> <span class="n">Y_total</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">X_total</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">xA</span><span class="p">)</span>  <span class="c1"># contract curve</span>
    <span class="n">xB</span><span class="p">,</span> <span class="n">yB</span> <span class="o">=</span> <span class="n">X_total</span> <span class="o">-</span> <span class="n">xA</span><span class="p">,</span> <span class="n">Y_total</span> <span class="o">-</span> <span class="n">yA</span>

    <span class="n">UA</span> <span class="o">=</span> <span class="p">(</span><span class="n">xA</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">yA</span> <span class="o">**</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">UB</span> <span class="o">=</span> <span class="p">(</span><span class="n">xB</span> <span class="o">**</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">yB</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">UA</span><span class="p">,</span> <span class="n">UB</span>


<span class="n">UA1</span><span class="p">,</span> <span class="n">UB1</span> <span class="o">=</span> <span class="n">frontier</span><span class="p">(</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
<span class="n">UA2</span><span class="p">,</span> <span class="n">UB2</span> <span class="o">=</span> <span class="n">frontier</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">UA1</span><span class="p">,</span> <span class="n">UB1</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$E=(8,3)$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">UA2</span><span class="p">,</span> <span class="n">UB2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$E=(3,8)$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;utility of agent A&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;utility of agent B&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<figure class="align-default" id="fig-gorman-utility-frontier-crossing">
<img alt="_images/ade75b1fbbe46c7b912b45b07a9deb6e2f6b756e260c51b5b851394754203a55.png" src="_images/ade75b1fbbe46c7b912b45b07a9deb6e2f6b756e260c51b5b851394754203a55.png" />
<figcaption>
<p><span class="caption-number">Fig. 22.1 </span><span class="caption-text">utility possibility frontiers cross when aggregation fails</span><a class="headerlink" href="#fig-gorman-utility-frontier-crossing" title="Link to this image">#</a></p>
</figcaption>
</figure>
</div>
</div>
<p><span id="id6">Gorman [<a class="reference internal" href="zreferences.html#id3" title="William M. Gorman. Community preference fields. Econometrica: Journal of the Econometric Society, 21(1):63–80, 1953.">1953</a>]</span> described restrictions on preferences under which it <em>is</em> possible to obtain a community preference ordering.</p>
<p>Whenever Gorman’s conditions are satisfied, there occur substantial simplifications in solving multiple-consumer optimal resource allocation problems: in intertemporal contexts, it becomes possible first to determine the optimal allocation of aggregate resources over time, and then allocate aggregate consumption among consumers by assigning utility levels to each person.</p>
<p>There is flexibility in the choice of monotonic transformations that we can use to represent utility levels.</p>
<p>We restrict the utility index to be either nonnegative or nonpositive.</p>
<p>In both cases, we define consumer-specific baseline indifference curves <span class="math notranslate nohighlight">\(\psi_j(p)\)</span> associated with a utility level of zero.</p>
<p>The functions <span class="math notranslate nohighlight">\(\psi_j\)</span> are gradients of concave functions that are positively homogeneous of degree one.</p>
<p>To represent a common departure for all consumers from their baseline indifference curves, we introduce a function <span class="math notranslate nohighlight">\(\psi_c(p)\)</span>.</p>
<p>This lets the compensated demand function for consumer <span class="math notranslate nohighlight">\(j\)</span> be represented as</p>
<div class="math notranslate nohighlight">
\[
c^j = \psi_j(p) + u^j \psi_c(p),
\]</div>
<p>where <span class="math notranslate nohighlight">\(u^j\)</span> is a scalar utility index for consumer <span class="math notranslate nohighlight">\(j\)</span>.</p>
<p>The function <span class="math notranslate nohighlight">\(\psi_c\)</span> is the gradient of a positively homogeneous of degree one function that is concave when the utility indices are restricted to be nonnegative and convex when they are restricted to be nonpositive.</p>
<p>It follows that <span class="math notranslate nohighlight">\(\psi_j\)</span> and <span class="math notranslate nohighlight">\(\psi_c\)</span> are homogeneous of degree zero in prices, which means that the implied indifference curves depend only on ratios of prices to an arbitrarily chosen numeraire.</p>
<p>The baseline indifference curves are either the highest or lowest indifference curves, corresponding respectively to cases in which the utility indices <span class="math notranslate nohighlight">\(u^j\)</span> are restricted to be nonpositive or nonnegative.</p>
<p>As noted by Gorman, when preferences are of this form, there is a well-defined compensated demand function for a fictitious representative agent obtained by aggregating individual demands:</p>
<div class="math notranslate nohighlight">
\[
c^a = \psi_a(p) + u^a \psi_c(p),
\]</div>
<p>where</p>
<div class="math notranslate nohighlight" id="equation-eq-agg-demand">
<span class="eqno">(22.1)<a class="headerlink" href="#equation-eq-agg-demand" title="Link to this equation">#</a></span>\[
u^a = \sum_{j=1}^J u^j \quad \text{and} \quad \psi_a(p) = \sum_{j=1}^J \psi_j(p).
\]</div>
<p>In this case, optimal resource allocation in a heterogeneous consumer economy simplifies as follows.</p>
<p>Preferences for aggregate consumption define a community preference ordering.</p>
<p>This preference ordering can be combined with a specification of the technology for producing consumption goods to determine the optimal allocation of aggregate consumption.</p>
<p>The mapping <span class="math notranslate nohighlight">\(c^a = \psi_a(p) + u^a \psi_c(p)\)</span> can be inverted to obtain a gradient vector <span class="math notranslate nohighlight">\(p\)</span> that is independent of how utilities are allocated across consumers.</p>
<p>Since <span class="math notranslate nohighlight">\(\psi_c\)</span> and <span class="math notranslate nohighlight">\(\psi_a\)</span> are homogeneous of degree zero, gradients are determined only up to a scalar multiple.</p>
<p>Armed with <span class="math notranslate nohighlight">\(p\)</span>, we can then allocate utility among <span class="math notranslate nohighlight">\(J\)</span> consumers while respecting the adding-up constraint <a class="reference internal" href="#equation-eq-agg-demand">(22.1)</a>.</p>
<p>The allocation of aggregate consumption across goods and the associated gradient are determined independently of how aggregate utility is divided among consumers.</p>
<p>A decentralized version of this analysis proceeds as follows.</p>
<p>Let <span class="math notranslate nohighlight">\(W^j\)</span> denote the wealth of consumer <span class="math notranslate nohighlight">\(j\)</span> and <span class="math notranslate nohighlight">\(W^a\)</span> denote aggregate wealth.
Then <span class="math notranslate nohighlight">\(W^j\)</span> should satisfy</p>
<div class="math notranslate nohighlight">
\[
W^j = p \cdot c^j = p \cdot \psi_j(p) + u^j p \cdot \psi_c(p).
\]</div>
<p>Solving for <span class="math notranslate nohighlight">\(u^j\)</span> gives</p>
<div class="math notranslate nohighlight">
\[
u^j = \frac{W^j - p \cdot \psi_j(p)}{p \cdot \psi_c(p)}.
\]</div>
<p>Hence, the Engel curve for consumer <span class="math notranslate nohighlight">\(j\)</span> is</p>
<div class="math notranslate nohighlight">
\[
c^j = \psi_j(p) - \frac{p \cdot \psi_j(p)}{p \cdot \psi_c(p)} \psi_c(p) + W^j \frac{\psi_c(p)}{p \cdot \psi_c(p)}.
\]</div>
<p>Notice that the coefficient on <span class="math notranslate nohighlight">\(W^j\)</span> is the same for all <span class="math notranslate nohighlight">\(j\)</span> since <span class="math notranslate nohighlight">\(\psi_c(p)/(p \cdot \psi_c(p))\)</span> is a function only of the price vector <span class="math notranslate nohighlight">\(p\)</span>.</p>
<p>The individual allocations can be determined from the Engel curves by substituting for <span class="math notranslate nohighlight">\(p\)</span> the gradient vector obtained from the representative agent’s optimal allocation problem.</p>
<p>In the quadratic specifications used in this lecture (and in <span id="id7">Hansen and Sargent [<a class="reference internal" href="zreferences.html#id162" title="L P Hansen and T J Sargent. Recursive Models of Dynamic Linear Economies. The Gorman Lectures in Economics. Princeton University Press, 2013.">2013</a>]</span>), the baseline components are degenerate in the sense that <span class="math notranslate nohighlight">\(\psi_j(p) = \chi^j\)</span> is independent of <span class="math notranslate nohighlight">\(p\)</span>, where <span class="math notranslate nohighlight">\(\chi^j\)</span> is a consumer-specific bliss point represented by a vector with the same dimension as <span class="math notranslate nohighlight">\(c^j\)</span>.</p>
<p>In that case, the demand functions simplify to</p>
<div class="math notranslate nohighlight">
\[
c^j = \chi^j + u^j \psi_c(p), \qquad c^a = \chi^a + u^a \psi_c(p),
\]</div>
<p>where <span class="math notranslate nohighlight">\(\chi^a = \sum_j \chi^j\)</span>.</p>
<p>Solving the aggregate equation for the common term <span class="math notranslate nohighlight">\(\psi_c(p) = (c^a - \chi^a)/u^a\)</span> and substituting into the individual equation gives</p>
<div class="math notranslate nohighlight">
\[
c^j = \chi^j + u^j \cdot \frac{c^a - \chi^a}{u^a},
\]</div>
<p>which rearranges to the static sharing rule</p>
<div class="math notranslate nohighlight">
\[
c^j - \chi^j = \frac{u^j}{u^a}\,(c^a - \chi^a),
\]</div>
<p>so that there is a common scale factor <span class="math notranslate nohighlight">\((u^j/u^a)\)</span> across all goods for person <span class="math notranslate nohighlight">\(j\)</span>.</p>
<p>Hence the fraction of total utility assigned to consumer <span class="math notranslate nohighlight">\(j\)</span> determines his fraction of the vector <span class="math notranslate nohighlight">\((c^a - \chi^a)\)</span>.</p>
<p>This is exactly the form we will see in <a class="reference internal" href="#equation-eq-sharing-rule">(22.11)</a> below, except that goods are indexed by both dates and states in subscripts.</p>
<p>In the dynamic setting, we set the utility index <span class="math notranslate nohighlight">\(u^j\)</span> equal to household <span class="math notranslate nohighlight">\(j\)</span>’s time-zero marginal utility of wealth <span class="math notranslate nohighlight">\(\mu_{0j}^w\)</span>, the Lagrange multiplier on the intertemporal budget constraint.</p>
<p>The ratio <span class="math notranslate nohighlight">\(\mu_{0j}^w / \mu_{0a}^w\)</span> (where <span class="math notranslate nohighlight">\(\mu_{0a}^w = \sum_j \mu_{0j}^w\)</span>) then serves as the time-invariant Pareto weight that determines household <span class="math notranslate nohighlight">\(j\)</span>’s share of aggregate consumption in excess of baseline.</p>
</section>
</section>
<section id="dynamic-stochastic-economy">
<h2><span class="section-number">22.2. </span>Dynamic, Stochastic Economy<a class="headerlink" href="#dynamic-stochastic-economy" title="Link to this heading">#</a></h2>
<p>We now introduce our basic setup for our dynamic heterogeneous-household economy.</p>
<p>Time is discrete, <span class="math notranslate nohighlight">\(t = 0,1,2,\dots\)</span>.</p>
<p>All households share a common discount factor <span class="math notranslate nohighlight">\(\beta \in (0,1)\)</span>.</p>
<p>Households are indexed by <span class="math notranslate nohighlight">\(j = 1, \ldots, J\)</span>, where <span class="math notranslate nohighlight">\(J\)</span> denotes the total number of households in the economy.</p>
<section id="exogenous-state">
<h3><span class="section-number">22.2.1. </span>Exogenous state<a class="headerlink" href="#exogenous-state" title="Link to this heading">#</a></h3>
<p>The exogenous state <span class="math notranslate nohighlight">\(z_t\)</span> follows a first-order vector autoregression</p>
<div class="math notranslate nohighlight" id="equation-eq-exogenous-var">
<span class="eqno">(22.2)<a class="headerlink" href="#equation-eq-exogenous-var" title="Link to this equation">#</a></span>\[
z_{t+1} = A_{22} z_t + C_2 w_{t+1},
\]</div>
<p>where <span class="math notranslate nohighlight">\(A_{22}\)</span> governs persistence and <span class="math notranslate nohighlight">\(C_2\)</span> maps i.i.d. shocks <span class="math notranslate nohighlight">\(w_{t+1}\)</span> into the state.</p>
<p>Here we take <span class="math notranslate nohighlight">\(\mathbb{E}[w_{t+1}] = 0\)</span> and <span class="math notranslate nohighlight">\(\mathbb{E}[w_{t+1} w_{t+1}^\top] = I\)</span>.</p>
<p>The vector <span class="math notranslate nohighlight">\(z_t\)</span> typically contains three types of components.</p>
<ol class="arabic simple">
<li><p>Constant: The first element is set to 1 and remains constant.</p></li>
<li><p>Aggregate shocks: Components with persistent dynamics that affect all households.</p>
<ul class="simple">
<li><p>In <a class="reference internal" href="#gorman-twohh"><span class="std std-ref">Example: two-household economy</span></a>, an AR(2) process drives aggregate endowment fluctuations.</p></li>
</ul>
</li>
<li><p>Idiosyncratic shocks: Components that enter individual endowments with loadings summing to zero across households.</p>
<ul class="simple">
<li><p>These generate cross-sectional heterogeneity while preserving aggregate resource constraints.</p></li>
</ul>
</li>
</ol>
<p>The selection matrices <span class="math notranslate nohighlight">\(U_b\)</span> and <span class="math notranslate nohighlight">\(U_d\)</span> pick out which components of <span class="math notranslate nohighlight">\(z_t\)</span> affect
household preferences (bliss points) and endowments.</p>
<p>This structure allows us to model both aggregate and idiosyncratic shocks within a unified framework at a later stage.</p>
</section>
<section id="technologies">
<h3><span class="section-number">22.2.2. </span>Technologies<a class="headerlink" href="#technologies" title="Link to this heading">#</a></h3>
<p>The economy’s resource constraint is</p>
<div class="math notranslate nohighlight" id="equation-eq-resource-constraint">
<span class="eqno">(22.3)<a class="headerlink" href="#equation-eq-resource-constraint" title="Link to this equation">#</a></span>\[
\Phi_c c_t + \Phi_g g_t + \Phi_i i_t = \Gamma k_{t-1} + d_t, \quad
k_t = \Delta_k k_{t-1} + \Theta_k i_t,
\]</div>
<p>and</p>
<div class="math notranslate nohighlight" id="equation-eq-household-service-tech">
<span class="eqno">(22.4)<a class="headerlink" href="#equation-eq-household-service-tech" title="Link to this equation">#</a></span>\[
h_t = \Delta_h h_{t-1} + \Theta_h c_t, \quad
s_t = \Lambda h_{t-1} + \Pi_h c_t, \quad
b_t = U_b z_t, \quad
d_t = U_d z_t.
\]</div>
<p>Here <span class="math notranslate nohighlight">\(h_t\)</span> is the aggregate household service,
<span class="math notranslate nohighlight">\(s_t\)</span> is the aggregate service flow derived from household capital,
<span class="math notranslate nohighlight">\(c_t\)</span> is aggregate consumption, <span class="math notranslate nohighlight">\(i_t\)</span> is investment, <span class="math notranslate nohighlight">\(k_t\)</span> is the aggregate physical capital stock, <span class="math notranslate nohighlight">\(d_t\)</span> is the aggregate endowment (or dividend) stream, and <span class="math notranslate nohighlight">\(g_t\)</span> is the aggregate “intermediate good” (interpreted as total labor supply in this lecture).</p>
<p>The matrices <span class="math notranslate nohighlight">\(\Phi_c, \Phi_g, \Phi_i\)</span> and <span class="math notranslate nohighlight">\(\Gamma\)</span> allow for multiple goods and a general linear mapping from stocks and endowments into resources.</p>
<p>In the one-good case used in the limited-markets section, these reduce to scalars and the resource constraint becomes <span class="math notranslate nohighlight">\(c_t + i_t = \gamma_1 k_{t-1} + d_t\)</span>.</p>
<p>We write <span class="math notranslate nohighlight">\(\Pi_h\)</span> for the household service-technology matrix <span class="math notranslate nohighlight">\(\Pi\)</span> in <span id="id8">Hansen and Sargent [<a class="reference internal" href="zreferences.html#id162" title="L P Hansen and T J Sargent. Recursive Models of Dynamic Linear Economies. The Gorman Lectures in Economics. Princeton University Press, 2013.">2013</a>]</span>.</p>
</section>
<section id="the-individual-household-problem">
<h3><span class="section-number">22.2.3. </span>The individual household problem<a class="headerlink" href="#the-individual-household-problem" title="Link to this heading">#</a></h3>
<p>Recall that we operate in an economy with <span class="math notranslate nohighlight">\(J\)</span> households indexed by <span class="math notranslate nohighlight">\(j = 1, 2, \ldots, J\)</span>.</p>
<p>Households differ in preferences and endowments but share a common information set.</p>
<p>Household <span class="math notranslate nohighlight">\(j\)</span> maximizes</p>
<div class="math notranslate nohighlight" id="equation-eq-hh-objective">
<span class="eqno">(22.5)<a class="headerlink" href="#equation-eq-hh-objective" title="Link to this equation">#</a></span>\[
-\frac{1}{2} \mathbb{E}_0 \sum_{t=0}^\infty \beta^t \left[(s_{jt} - b_{jt})^\top (s_{jt} - b_{jt}) + \ell_{jt}^\top \ell_{jt}\right]
\]</div>
<p>subject to the household service technology</p>
<div class="math notranslate nohighlight" id="equation-eq-hh-service-tech">
<span class="eqno">(22.6)<a class="headerlink" href="#equation-eq-hh-service-tech" title="Link to this equation">#</a></span>\[\begin{split}
\begin{aligned}
s_{jt} &amp;= \Lambda h_{j,t-1} + \Pi_h c_{jt}, \\
h_{jt} &amp;= \Delta_h h_{j,t-1} + \Theta_h c_{jt},
\end{aligned}
\end{split}\]</div>
<p>and the intertemporal budget constraint</p>
<div class="math notranslate nohighlight" id="equation-eq-hh-budget">
<span class="eqno">(22.7)<a class="headerlink" href="#equation-eq-hh-budget" title="Link to this equation">#</a></span>\[
\mathbb{E}_0 \sum_{t=0}^\infty \beta^t p_{0t} \cdot c_{jt}
= \mathbb{E}_0 \sum_{t=0}^\infty \beta^t (w_{0t} \ell_{jt} + \alpha_{0t} \cdot d_{jt}) + v_0 \cdot k_{j,-1},
\]</div>
<p>where <span class="math notranslate nohighlight">\(b_{jt} = U_b^j z_t\)</span> is household <span class="math notranslate nohighlight">\(j\)</span>’s preference shock, <span class="math notranslate nohighlight">\(d_{jt} = U_d^j z_t\)</span> is household <span class="math notranslate nohighlight">\(j\)</span>’s endowment stream, <span class="math notranslate nohighlight">\(h_{j,-1}\)</span> and <span class="math notranslate nohighlight">\(k_{j,-1}\)</span> are given initial capital stocks, and <span class="math notranslate nohighlight">\(\ell_{jt}\)</span> is household labor supply.</p>
<p>Here <span class="math notranslate nohighlight">\(\mathbb{E}_0\)</span> is expectation conditional on time-zero information <span class="math notranslate nohighlight">\(\mathcal{J}_0\)</span>.</p>
<p>The prices are:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(p_{0t}\)</span>: the time-0 Arrow-Debreu price vector for date-<span class="math notranslate nohighlight">\(t\)</span> consumption goods (across states), so <span class="math notranslate nohighlight">\(p_{0t} \cdot c_{jt}\)</span> is the time-0 value of date-<span class="math notranslate nohighlight">\(t\)</span> consumption</p></li>
<li><p><span class="math notranslate nohighlight">\(w_{0t}\)</span>: the time-0 value of date-<span class="math notranslate nohighlight">\(t\)</span> labor</p></li>
<li><p><span class="math notranslate nohighlight">\(\alpha_{0t}\)</span>: the time-0 price vector for date-<span class="math notranslate nohighlight">\(t\)</span> endowments (dividends)</p></li>
<li><p><span class="math notranslate nohighlight">\(v_0\)</span>: the time-0 value of initial capital</p></li>
</ul>
<p>These prices are determined in equilibrium.</p>
<p>In the DLE implementation below, these time-0 prices are recovered from the aggregate solution and encoded in the pricing objects <code class="docutils literal notranslate"><span class="pre">M_c</span></code>, <code class="docutils literal notranslate"><span class="pre">M_d</span></code>, <code class="docutils literal notranslate"><span class="pre">M_g</span></code>, and <code class="docutils literal notranslate"><span class="pre">M_k</span></code>.</p>
<p>This specification confines heterogeneity among households to four sources:</p>
<ol class="arabic simple">
<li><p>Differences in the preference processes <span class="math notranslate nohighlight">\(\{b_{jt}\}\)</span>, represented by different selections of <span class="math notranslate nohighlight">\(U_b^j\)</span>.</p></li>
<li><p>Differences in the endowment processes <span class="math notranslate nohighlight">\(\{d_{jt}\}\)</span>, represented by different selections of <span class="math notranslate nohighlight">\(U_d^j\)</span>.</p></li>
<li><p>Differences in initial household capital <span class="math notranslate nohighlight">\(h_{j,-1}\)</span>.</p></li>
<li><p>Differences in initial physical capital <span class="math notranslate nohighlight">\(k_{j,-1}\)</span>.</p></li>
</ol>
<p>The matrices <span class="math notranslate nohighlight">\(\Lambda, \Pi_h, \Delta_h, \Theta_h\)</span> do <em>not</em> depend on <span class="math notranslate nohighlight">\(j\)</span>.</p>
<p>Because the technology matrices are common across households, every household’s demand system has the same functional form.</p>
<p>All households observe the same aggregate information set <span class="math notranslate nohighlight">\(\{\mathcal{J}_t\}\)</span>; in our Markov setting we can take <span class="math notranslate nohighlight">\(\mathcal{J}_t\)</span> to be generated by the current aggregate state <span class="math notranslate nohighlight">\(x_t\)</span>.</p>
<p>These restrictions enable Gorman aggregation by ensuring that household demands are affine in wealth.</p>
<p>This will allow us to solve for aggregate allocations and prices without knowing the distribution of wealth across households,  as we shall see in <a class="reference internal" href="#sharing-rules"><span class="std std-ref">Consumption sharing rules</span></a>.</p>
</section>
<section id="the-representative-agent-problem">
<h3><span class="section-number">22.2.4. </span>The representative agent problem<a class="headerlink" href="#the-representative-agent-problem" title="Link to this heading">#</a></h3>
<p>We construct aggregates by summing across households:</p>
<div class="math notranslate nohighlight" id="equation-eq-agg-preference-aggregates">
<span class="eqno">(22.8)<a class="headerlink" href="#equation-eq-agg-preference-aggregates" title="Link to this equation">#</a></span>\[
h_{-1} = \sum_j h_{j,-1}, \quad
k_{-1} = \sum_j k_{j,-1}, \quad
U_b = \sum_j U_b^j, \quad
U_d = \sum_j U_d^j.
\]</div>
<p>Aggregates are economy-wide totals: <span class="math notranslate nohighlight">\(c_t := \sum_j c_{jt}\)</span>, <span class="math notranslate nohighlight">\(b_t := \sum_j b_{jt}\)</span>, <span class="math notranslate nohighlight">\(d_t := \sum_j d_{jt}\)</span>, and similarly for <span class="math notranslate nohighlight">\((i_t, k_t, h_t, s_t, g_t)\)</span>.</p>
<p>Under the Gorman/LQ restrictions, we can compute equilibrium prices and aggregate quantities by synthesizing a fictitious <em>representative agent</em> whose first-order conditions generate    equations that determine correct equilibrium prices and a correct <em>aggregate</em> consumption allocation and aggregate capital process.</p>
<ul class="simple">
<li><p>these equations will not be sufficient to determine the allocation of aggregate consumption among individual households.</p></li>
</ul>
<p>Posing a social planning problem for a representative agent is thus a device for computing the correct <em>aggregate</em> allocation along with correct competitive equilibrium prices.</p>
<p>The social planner in our representative agent economy maximizes</p>
<div class="math notranslate nohighlight" id="equation-eq-planner-objective">
<span class="eqno">(22.9)<a class="headerlink" href="#equation-eq-planner-objective" title="Link to this equation">#</a></span>\[
-\frac{1}{2} \mathbb{E}_0 \sum_{t=0}^\infty \beta^t
\left[(s_t - b_t)^\top(s_t - b_t) + g_t^\top g_t\right]
\]</div>
<p>subject to the technology constraints <a class="reference internal" href="#equation-eq-resource-constraint">(22.3)</a> and <a class="reference internal" href="#equation-eq-household-service-tech">(22.4)</a>, and the exogenous state process <a class="reference internal" href="#equation-eq-exogenous-var">(22.2)</a>.</p>
<p>The variable <span class="math notranslate nohighlight">\(g_t\)</span> is the aggregate intermediate good.</p>
<p>With quadratic labor costs and linear budget terms, household <span class="math notranslate nohighlight">\(j\)</span>’s intratemporal first-order condition implies <span class="math notranslate nohighlight">\(\ell_{jt} = \mu^w_{0j} w_{0t}\)</span>, where <span class="math notranslate nohighlight">\(\mu^w_{0j}\)</span> is household <span class="math notranslate nohighlight">\(j\)</span>’s time-zero marginal utility of wealth.</p>
<p>Aggregating gives <span class="math notranslate nohighlight">\(g_t := \sum_j \ell_{jt} = \mu^w_{0a} w_{0t}\)</span>, where <span class="math notranslate nohighlight">\(\mu^w_{0a}=\sum_j \mu^w_{0j}\)</span>.</p>
<p>Hence, the representative agent is constructed so that its first-order condition delivers the same aggregate relation <span class="math notranslate nohighlight">\(g_t=\mu^w_{0a} w_{0t}\)</span>.</p>
<p>Note that constraints above involve lagged stocks <span class="math notranslate nohighlight">\((h_{t-1}, k_{t-1})\)</span> and the current exogenous state <span class="math notranslate nohighlight">\(z_t\)</span>.</p>
<p>These predetermined variables form the planner’s state:</p>
<div class="math notranslate nohighlight">
\[
x_t = [h_{t-1}^\top, k_{t-1}^\top, z_t^\top]^\top.
\]</div>
<p>The solution expresses each aggregate quantity as a linear function of the state via selection matrices:</p>
<div class="math notranslate nohighlight">
\[
q_t = S_q x_t \quad \text{for } q \in \{c, i, k, h, s, g, b, d\}.
\]</div>
<p>Similarly, shadow prices are linear in <span class="math notranslate nohighlight">\(x_t\)</span>:</p>
<div class="math notranslate nohighlight">
\[
M_q x_t \quad \text{for } q \in \{c, k, h, s\}.
\]</div>
<p>These shadow prices correspond to competitive equilibrium prices.</p>
</section>
<section id="consumption-sharing-rules">
<span id="sharing-rules"></span><h3><span class="section-number">22.2.5. </span>Consumption sharing rules<a class="headerlink" href="#consumption-sharing-rules" title="Link to this heading">#</a></h3>
<p>This section presents the Gorman consumption sharing rules.</p>
<p>Our preference specification is an infinite-dimensional generalization of the static Gorman setup described in <a class="reference internal" href="#static-gorman"><span class="std std-ref">Gorman aggregation in a static economy</span></a>, where goods are indexed by both dates and states of the world.</p>
<p>Let <span class="math notranslate nohighlight">\(\mu_{0j}^w\)</span> denote household <span class="math notranslate nohighlight">\(j\)</span>’s <em>time-zero marginal utility of wealth</em>, the Lagrange multiplier on its intertemporal budget constraint.</p>
<p>Define the aggregate multiplier as</p>
<div class="math notranslate nohighlight">
\[
\mu_{0a}^w := \sum_{j=1}^J \mu_{0j}^w.
\]</div>
<p>The ratio <span class="math notranslate nohighlight">\(\mu_{0j}^w / \mu_{0a}^w\)</span> is time-invariant and depends only on information available at time zero.</p>
<p>For  convenience, we write</p>
<div class="math notranslate nohighlight">
\[
\mu_j := \frac{\mu_{0j}^w}{\mu_{0a}^w},
\]</div>
<p>so that <span class="math notranslate nohighlight">\(\sum_j \mu_j = 1\)</span>.</p>
<p>This is household <span class="math notranslate nohighlight">\(j\)</span>’s <strong>Pareto weight</strong>.</p>
<p>The allocation rule for consumption has the form</p>
<div class="math notranslate nohighlight" id="equation-eq-sharing-rule-baseline">
<span class="eqno">(22.10)<a class="headerlink" href="#equation-eq-sharing-rule-baseline" title="Link to this equation">#</a></span>\[
c_{jt} - \chi_{jt} = \mu_j (c_t - \chi_t),
\]</div>
<p>or equivalently,</p>
<div class="math notranslate nohighlight" id="equation-eq-sharing-rule">
<span class="eqno">(22.11)<a class="headerlink" href="#equation-eq-sharing-rule" title="Link to this equation">#</a></span>\[
c_{jt} = \mu_j c_t + \tilde{\chi}_{jt}, \qquad \tilde{\chi}_{jt} := \chi_{jt} - \mu_j \chi_t.
\]</div>
<p>Here <span class="math notranslate nohighlight">\(\mu_j c_t\)</span> is household <span class="math notranslate nohighlight">\(j\)</span>’s proportional share of aggregate consumption and <span class="math notranslate nohighlight">\(\tilde{\chi}_{jt}\)</span> is the <em>deviation</em> from this proportional share.</p>
<p>These deviations sum to zero: <span class="math notranslate nohighlight">\(\sum_j \tilde{\chi}_{jt} = 0\)</span>.</p>
<p>The baseline term <span class="math notranslate nohighlight">\(\chi_{jt}\)</span> is determined by the preference shock process <span class="math notranslate nohighlight">\(\{b_{jt}\}\)</span> and initial household capital <span class="math notranslate nohighlight">\(h_{j,-1}\)</span>.</p>
<p>We write the aggregate baseline as <span class="math notranslate nohighlight">\(\chi_t := \sum_{j=1}^J \chi_{jt}\)</span>.</p>
<p>The beauty of this representation is that the weight <span class="math notranslate nohighlight">\(\mu_j\)</span> is time-invariant.</p>
<p>Nonseparabilities in preferences (over time or across goods) affect only the construction of the baseline process <span class="math notranslate nohighlight">\(\{\chi_{jt}\}\)</span> and the calculation of the weight <span class="math notranslate nohighlight">\(\mu_j\)</span> implied by the distribution of wealth.</p>
<section id="household-services-allocation-rule">
<h4><span class="section-number">22.2.5.1. </span>Household services allocation rule<a class="headerlink" href="#household-services-allocation-rule" title="Link to this heading">#</a></h4>
<p>First-order necessary conditions for consumption services imply</p>
<div class="math notranslate nohighlight" id="equation-eq-foc-services">
<span class="eqno">(22.12)<a class="headerlink" href="#equation-eq-foc-services" title="Link to this equation">#</a></span>\[
s_{jt} - b_{jt} = \mu_{0j}^w \rho_{0t},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\rho_{0t}\)</span> is the time-0 shadow price for date-<span class="math notranslate nohighlight">\(t\)</span> services from the aggregate problem.</p>
<p>Since the aggregate first-order condition is <span class="math notranslate nohighlight">\(s_t - b_t = \mu_{0a}^w \rho_{0t}\)</span>, we can eliminate <span class="math notranslate nohighlight">\(\rho_{0t}\)</span> to obtain:</p>
<div class="math notranslate nohighlight" id="equation-eq-service-allocation">
<span class="eqno">(22.13)<a class="headerlink" href="#equation-eq-service-allocation" title="Link to this equation">#</a></span>\[
s_{jt} - b_{jt} = \mu_j (s_t - b_t),
\]</div>
<p>or equivalently <span class="math notranslate nohighlight">\(\tilde{s}_{jt} = \tilde{b}_{jt}\)</span>, where <span class="math notranslate nohighlight">\(\tilde{y}_{jt} := y_{jt} - \mu_j y_t\)</span> for any variable <span class="math notranslate nohighlight">\(y\)</span>.</p>
<p>This representation does not involve prices directly.</p>
</section>
<section id="inverse-canonical-representation">
<h4><span class="section-number">22.2.5.2. </span>Inverse canonical representation<a class="headerlink" href="#inverse-canonical-representation" title="Link to this heading">#</a></h4>
<p>Given <span class="math notranslate nohighlight">\(\rho_{0t}\)</span> from the aggregate solution, we can solve <a class="reference internal" href="#equation-eq-foc-services">(22.12)</a> for <span class="math notranslate nohighlight">\(s_{jt}\)</span>, then use the inverse canonical representation from Chapter 9 of <span id="id9">Hansen and Sargent [<a class="reference internal" href="zreferences.html#id162" title="L P Hansen and T J Sargent. Recursive Models of Dynamic Linear Economies. The Gorman Lectures in Economics. Princeton University Press, 2013.">2013</a>]</span> to compute <span class="math notranslate nohighlight">\(c_{jt}\)</span> and <span class="math notranslate nohighlight">\(h_{jt}\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-eq-inverse-canonical-full">
<span class="eqno">(22.14)<a class="headerlink" href="#equation-eq-inverse-canonical-full" title="Link to this equation">#</a></span>\[\begin{split}
\begin{aligned}
c_{jt} &amp;= -\Pi_h^{-1} \Lambda h_{j,t-1} + \Pi_h^{-1} s_{jt}, \\
h_{jt} &amp;= (\Delta_h - \Theta_h \Pi_h^{-1} \Lambda) h_{j,t-1} + \Theta_h \Pi_h^{-1} s_{jt},
\end{aligned}
\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(h_{j,-1}\)</span> given.</p>
<p>This recursion requires a canonical household technology with square, invertible <span class="math notranslate nohighlight">\(\Pi_h\)</span>.</p>
</section>
<section id="computational-details">
<h4><span class="section-number">22.2.5.3. </span>Computational details<a class="headerlink" href="#computational-details" title="Link to this heading">#</a></h4>
<p>Define deviation processes <span class="math notranslate nohighlight">\(\tilde{y}_{jt} := y_{jt} - \mu_j y_t\)</span> for any variable <span class="math notranslate nohighlight">\(y\)</span>.</p>
<p>In particular, the deviation durable stock is <span class="math notranslate nohighlight">\(\tilde{h}_{jt} := h_{jt} - \mu_j h_t\)</span>.</p>
<p>The deviation form of the inverse canonical representation <a class="reference internal" href="#equation-eq-inverse-canonical-full">(22.14)</a> is</p>
<div class="math notranslate nohighlight" id="equation-eq-inverse-canonical-dev">
<span class="eqno">(22.15)<a class="headerlink" href="#equation-eq-inverse-canonical-dev" title="Link to this equation">#</a></span>\[\begin{split}
\begin{aligned}
\tilde{c}_{jt} &amp;= -\Pi_h^{-1} \Lambda \tilde{h}_{j,t-1} + \Pi_h^{-1} \tilde{s}_{jt}, \\
\tilde{h}_{jt} &amp;= (\Delta_h - \Theta_h \Pi_h^{-1} \Lambda) \tilde{h}_{j,t-1} + \Theta_h \Pi_h^{-1} \tilde{s}_{jt},
\end{aligned}
\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(\tilde{h}_{j,-1} = h_{j,-1} - \mu_j h_{-1}\)</span> given.</p>
<p>Associated with <span class="math notranslate nohighlight">\(\tilde{s}_{jt}\)</span> is a synthetic consumption process <span class="math notranslate nohighlight">\(\tilde{\chi}_{jt}\)</span> that makes <span class="math notranslate nohighlight">\(\tilde{c}_{jt} = \tilde{\chi}_{jt}\)</span> be the optimal sharing rule.</p>
<p>To construct <span class="math notranslate nohighlight">\(\tilde{\chi}_{jt}\)</span>, we substitute <span class="math notranslate nohighlight">\(\tilde{s}_{jt} = \tilde{b}_{jt}\)</span> into the inverse canonical representation:</p>
<div class="math notranslate nohighlight" id="equation-eq-inverse-canonical">
<span class="eqno">(22.16)<a class="headerlink" href="#equation-eq-inverse-canonical" title="Link to this equation">#</a></span>\[\begin{split}
\begin{aligned}
\tilde{\chi}_{jt} &amp;= -\Pi_h^{-1} \Lambda \tilde{\eta}_{j,t-1} + \Pi_h^{-1} \tilde{b}_{jt}, \\
\tilde{\eta}_{jt} &amp;= (\Delta_h - \Theta_h \Pi_h^{-1} \Lambda) \tilde{\eta}_{j,t-1} + \Theta_h \Pi_h^{-1} \tilde{b}_{jt},
\end{aligned}
\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(\tilde{\eta}_{j,-1} = \tilde{h}_{j,-1}\)</span>.</p>
<p>Since <span class="math notranslate nohighlight">\(\tilde{s}_{jt} = \tilde{b}_{jt}\)</span> and <span class="math notranslate nohighlight">\(\tilde{\eta}_{j,-1} = \tilde{h}_{j,-1}\)</span>, it follows from <a class="reference internal" href="#equation-eq-inverse-canonical-dev">(22.15)</a> and <a class="reference internal" href="#equation-eq-inverse-canonical">(22.16)</a> that <span class="math notranslate nohighlight">\(\tilde{c}_{jt} = \tilde{\chi}_{jt}\)</span>.</p>
<p>Since the allocation rule for consumption can be expressed as</p>
<div class="math notranslate nohighlight" id="equation-eq-cjt-recursion">
<span class="eqno">(22.17)<a class="headerlink" href="#equation-eq-cjt-recursion" title="Link to this equation">#</a></span>\[
c_{jt} = \mu_j c_t + \tilde{\chi}_{jt},
\]</div>
<p>we can append the recursion for <span class="math notranslate nohighlight">\(c_t\)</span> from the aggregate problem to obtain a recursion generating <span class="math notranslate nohighlight">\(c_{jt}\)</span>.</p>
</section>
<section id="labor-allocation-rule">
<h4><span class="section-number">22.2.5.4. </span>Labor allocation rule<a class="headerlink" href="#labor-allocation-rule" title="Link to this heading">#</a></h4>
<p>Once the aggregate allocation and prices are obtained from the representative problem, individual labor allocations follow from the ratio of individual to aggregate marginal utilities of wealth:</p>
<div class="math notranslate nohighlight" id="equation-eq-labor-allocation">
<span class="eqno">(22.18)<a class="headerlink" href="#equation-eq-labor-allocation" title="Link to this equation">#</a></span>\[
\ell_{jt} = \frac{\mu_{0j}^w}{\mu_{0a}^w} \, g_t \equiv \mu_j \, g_t,
\]</div>
<p>where <span class="math notranslate nohighlight">\(g_t\)</span> is the aggregate intermediate good determined by the representative agent’s first-order condition.</p>
<p>This step recovers household labor supplies consistent with the competitive equilibrium.</p>
</section>
<section id="risk-sharing">
<h4><span class="section-number">22.2.5.5. </span>Risk sharing<a class="headerlink" href="#risk-sharing" title="Link to this heading">#</a></h4>
<p>Because the coefficient <span class="math notranslate nohighlight">\(\mu_j\)</span> is invariant over time and across goods, allocation rule <a class="reference internal" href="#equation-eq-sharing-rule-baseline">(22.10)</a> implies a form of risk pooling in the deviation process <span class="math notranslate nohighlight">\(\{c_{jt} - \chi_{jt}\}\)</span>.</p>
<p>In the special case where the preference shock processes <span class="math notranslate nohighlight">\(\{b_{jt}\}\)</span> are deterministic (in the sense that they reside in the information set <span class="math notranslate nohighlight">\(\mathcal{J}_0\)</span>), individual consumption goods will be perfectly correlated with their aggregate counterparts.</p>
</section>
</section>
</section>
<section id="household-allocations">
<h2><span class="section-number">22.3. </span>Household allocations<a class="headerlink" href="#household-allocations" title="Link to this heading">#</a></h2>
<p>A direct way to compute allocations to individuals would be to solve the problem each household faces in competitive equilibrium at equilibrium prices.</p>
<p>For a fixed Lagrange multiplier <span class="math notranslate nohighlight">\(\mu_{0j}^w\)</span> on the household’s budget constraint, the household’s problem can be expressed as an optimal linear regulator with a state vector augmented to reflect aggregate state variables determining scaled Arrow-Debreu prices.</p>
<p>One could compute individual allocations by iterating to find the multiplier <span class="math notranslate nohighlight">\(\mu_{0j}^w\)</span> that satisfies the budget constraint.</p>
<p>But there is a more elegant approach that uses the Gorman allocation rules.</p>
<section id="computing-household-allocations">
<h3><span class="section-number">22.3.1. </span>Computing household allocations<a class="headerlink" href="#computing-household-allocations" title="Link to this heading">#</a></h3>
<p>We apply our consumption sharing rules <a class="reference internal" href="#equation-eq-sharing-rule">(22.11)</a> and <a class="reference internal" href="#equation-eq-sharing-rule-baseline">(22.10)</a>  in two steps.</p>
<section id="step-1-compute-deviation-consumption">
<h4><span class="section-number">22.3.1.1. </span>Step 1: compute deviation consumption<a class="headerlink" href="#step-1-compute-deviation-consumption" title="Link to this heading">#</a></h4>
<p>Using the inverse canonical representation <a class="reference internal" href="#equation-eq-inverse-canonical">(22.16)</a>, we compute the deviation consumption process <span class="math notranslate nohighlight">\(\{\tilde{\chi}_{jt}\}\)</span> from household <span class="math notranslate nohighlight">\(j\)</span>’s deviation bliss points <span class="math notranslate nohighlight">\(\{\tilde{b}_{jt}\}\)</span> and initial deviation state <span class="math notranslate nohighlight">\(\tilde{\eta}_{j,-1} = h_{j,-1} - \mu_j h_{-1}\)</span>.</p>
<p>When preferences include durables or habits (<span class="math notranslate nohighlight">\(\Lambda \neq 0\)</span>), the deviation consumption depends on the lagged deviation state <span class="math notranslate nohighlight">\(\tilde{\eta}_{j,t-1}\)</span>.</p>
<p>The code solves this as a linear-quadratic control problem using a scaling trick: multiplying the transition matrices by <span class="math notranslate nohighlight">\(\sqrt{\beta}\)</span> converts the discounted problem into an undiscounted one that can be solved with a standard discrete algebraic Riccati equation.</p>
</section>
<section id="step-2-compute-each-pareto-weight">
<h4><span class="section-number">22.3.1.2. </span>Step 2: compute each Pareto weight<a class="headerlink" href="#step-2-compute-each-pareto-weight" title="Link to this heading">#</a></h4>
<p>We compute the Pareto weight <span class="math notranslate nohighlight">\(\mu_j\)</span> from household <span class="math notranslate nohighlight">\(j\)</span>’s budget constraint.</p>
<p>We compute five present values:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(W_d\)</span>: present value of household <span class="math notranslate nohighlight">\(j\)</span>’s endowment stream <span class="math notranslate nohighlight">\(\{d_{jt}\}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(W_k\)</span>: value of household <span class="math notranslate nohighlight">\(j\)</span>’s initial capital <span class="math notranslate nohighlight">\(k_{j,-1}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(W_{c1}\)</span>: present value of the “unit” consumption stream (what it costs to consume <span class="math notranslate nohighlight">\(c_t\)</span>)</p></li>
<li><p><span class="math notranslate nohighlight">\(W_{c2}\)</span>: present value of the deviation consumption stream <span class="math notranslate nohighlight">\(\{\tilde{\chi}_{jt}\}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(W_g\)</span>: present value of the intermediate good stream <span class="math notranslate nohighlight">\(\{g_t\}\)</span></p></li>
</ul>
<p>Formally, (suppressing state indices inside the dot products),</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
W_d   &amp;= \mathbb{E}_0 \sum_{t=0}^\infty \beta^t \, \alpha_{0t} \cdot d_{jt}, \\
W_k   &amp;= v_0 \cdot k_{j,-1}, \\
W_{c1} &amp;= \mathbb{E}_0 \sum_{t=0}^\infty \beta^t \, p_{0t} \cdot c_t, \\
W_{c2} &amp;= \mathbb{E}_0 \sum_{t=0}^\infty \beta^t \, p_{0t} \cdot \tilde{\chi}_{jt}, \\
W_g   &amp;= \mathbb{E}_0 \sum_{t=0}^\infty \beta^t \, w_{0t} \, g_t.
\end{aligned}
\end{split}\]</div>
<p>We compute each present value by  using <code class="docutils literal notranslate"><span class="pre">doublej2</span></code>  to sum infinite series.</p>
<p>The budget constraint <a class="reference internal" href="#equation-eq-hh-budget">(22.7)</a> requires that the present value of consumption equals wealth:</p>
<div class="math notranslate nohighlight">
\[
\underbrace{\mathbb{E}_0 \sum_{t=0}^\infty \beta^t p_{0t} \cdot c_{jt}}_{\text{consumption expenditure}} = \underbrace{v_0 \cdot k_{j,-1}}_{W_k} + \underbrace{\mathbb{E}_0 \sum_{t=0}^\infty \beta^t \alpha_{0t} \cdot d_{jt}}_{W_d} + \underbrace{\mathbb{E}_0 \sum_{t=0}^\infty \beta^t w_{0t} \ell_{jt}}_{\text{labor income}}.
\]</div>
<p>From the Gorman allocation rule <span class="math notranslate nohighlight">\(\ell_{jt} = \mu_j g_t\)</span>, the present value of labor income is</p>
<div class="math notranslate nohighlight">
\[
\mathbb{E}_0 \sum_{t=0}^\infty \beta^t w_{0t} \ell_{jt} = \mu_j \underbrace{\mathbb{E}_0 \sum_{t=0}^\infty \beta^t w_{0t} g_t}_{W_g} = \mu_j W_g.
\]</div>
<p>Substituting the sharing rule <span class="math notranslate nohighlight">\(c_{jt} = \mu_j c_t + \tilde{\chi}_{jt}\)</span> into the left side gives</p>
<div class="math notranslate nohighlight">
\[
\mu_j W_{c1} + W_{c2} = W_k + W_d + \mu_j W_g.
\]</div>
<p>Solving for <span class="math notranslate nohighlight">\(\mu_j\)</span>:</p>
<div class="math notranslate nohighlight">
\[
\mu_j = \frac{W_k + W_d - W_{c2}}{W_{c1} - W_g}.
\]</div>
<p>The numerator is household <span class="math notranslate nohighlight">\(j\)</span>’s wealth – i.e., initial capital plus present value of endowments minus the cost of the deviation consumption stream.</p>
<p>The denominator is the net cost of consuming one unit of aggregate consumption, i.e., the value of consumption minus the value of the intermediate good supplied.</p>
<p>Finally, the code constructs selection matrices <span class="math notranslate nohighlight">\(S_{ci}, S_{hi}, S_{si}\)</span> that map the augmented state <span class="math notranslate nohighlight">\(X_t = [h_{j,t-1}^\top, x_t^\top]^\top\)</span> into household <span class="math notranslate nohighlight">\(j\)</span>’s allocations:</p>
<div class="math notranslate nohighlight">
\[
c_{jt} = S_{ci} X_t, \quad h_{jt} = S_{hi} X_t, \quad s_{jt} = S_{si} X_t.
\]</div>
<p>Because the deviation term <span class="math notranslate nohighlight">\(\tilde{\chi}_{jt}\)</span> depends on it through the inverse canonical representation, the augmented state includes household <span class="math notranslate nohighlight">\(j\)</span>’s own lagged durable stock <span class="math notranslate nohighlight">\(h_{j,t-1}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">doublej2</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">B2</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10_000</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute V = Σ_{t=0}^∞ A1^t B1 B2&#39; (A2&#39;)^t via a doubling algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">A2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">B1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">B1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">B2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">B2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">α1</span><span class="p">,</span> <span class="n">α2</span> <span class="o">=</span> <span class="n">A1</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">A2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">B1</span> <span class="o">@</span> <span class="n">B2</span><span class="o">.</span><span class="n">T</span>
    <span class="n">diff</span><span class="p">,</span> <span class="n">it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>
        <span class="n">α1_next</span> <span class="o">=</span> <span class="n">α1</span> <span class="o">@</span> <span class="n">α1</span>
        <span class="n">α2_next</span> <span class="o">=</span> <span class="n">α2</span> <span class="o">@</span> <span class="n">α2</span>
        <span class="n">V_next</span> <span class="o">=</span> <span class="n">V</span> <span class="o">+</span> <span class="n">α1</span> <span class="o">@</span> <span class="n">V</span> <span class="o">@</span> <span class="n">α2</span><span class="o">.</span><span class="n">T</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">V_next</span> <span class="o">-</span> <span class="n">V</span><span class="p">))</span>
        <span class="n">α1</span><span class="p">,</span> <span class="n">α2</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">α1_next</span><span class="p">,</span> <span class="n">α2_next</span><span class="p">,</span> <span class="n">V_next</span>
        <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">V</span>

<span class="k">def</span><span class="w"> </span><span class="nf">heter</span><span class="p">(</span>
    <span class="n">Λ</span><span class="p">,</span> <span class="n">Θ_h</span><span class="p">,</span> <span class="n">Δ_h</span><span class="p">,</span> <span class="n">Π_h</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span>
    <span class="n">Θ_k</span><span class="p">,</span> <span class="n">Δ_k</span><span class="p">,</span> <span class="n">A_22</span><span class="p">,</span> <span class="n">C_2</span><span class="p">,</span>
    <span class="n">U_bi</span><span class="p">,</span> <span class="n">U_di</span><span class="p">,</span>
    <span class="n">A0</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">M_d</span><span class="p">,</span> <span class="n">M_g</span><span class="p">,</span> <span class="n">M_k</span><span class="p">,</span> <span class="n">Γ</span><span class="p">,</span> <span class="n">M_c</span><span class="p">,</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">h0i</span><span class="p">,</span> <span class="n">k0i</span><span class="p">,</span>
    <span class="n">S_h</span><span class="p">,</span> <span class="n">S_k</span><span class="p">,</span> <span class="n">S_i</span><span class="p">,</span> <span class="n">S_g</span><span class="p">,</span> <span class="n">S_d</span><span class="p">,</span> <span class="n">S_b</span><span class="p">,</span> <span class="n">S_c</span><span class="p">,</span> <span class="n">S_s</span><span class="p">,</span>
    <span class="n">M_h</span><span class="p">,</span> <span class="n">M_s</span><span class="p">,</span> <span class="n">M_i</span><span class="p">,</span>
    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute household i selection matrices, the Pareto weight μ_i,</span>
<span class="sd">    and valuation objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Dimensions</span>
    <span class="n">n_s</span><span class="p">,</span> <span class="n">n_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Λ</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">n_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Θ_h</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">n_z</span><span class="p">,</span> <span class="n">n_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">C_2</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">n_k</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Θ_k</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">n_d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">U_di</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">n_x</span> <span class="o">=</span> <span class="n">n_h</span> <span class="o">+</span> <span class="n">n_k</span> <span class="o">+</span> <span class="n">n_z</span>

    <span class="n">β</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">β</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>

    <span class="c1">## Household deviation problem </span>

    <span class="c1"># scaling trick in Chapter 3 of Hansen and Sargent (2013)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Δ_h</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">β</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Θ_h</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">β</span><span class="p">)</span>

    <span class="n">Λ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Λ</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">Π_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Π_h</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">U_bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">U_bi</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">R_hh</span> <span class="o">=</span> <span class="n">Λ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Λ</span> <span class="o">+</span> <span class="n">tol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_h</span><span class="p">)</span>
    <span class="n">Q_hh</span> <span class="o">=</span> <span class="n">Π_h</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Π_h</span>
    <span class="n">S_hh</span> <span class="o">=</span> <span class="n">Π_h</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Λ</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">Q_hh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">Q_hh</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The Π_h&#39;Π_h block is singular.&quot;</span><span class="p">)</span>

    <span class="n">Q_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Q_hh</span><span class="p">)</span>

    <span class="c1"># Eliminate cross term</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">B</span> <span class="o">@</span> <span class="n">Q_inv</span> <span class="o">@</span> <span class="n">S_hh</span>
    <span class="n">R_hh</span> <span class="o">=</span> <span class="n">R_hh</span> <span class="o">-</span> <span class="n">S_hh</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Q_inv</span> <span class="o">@</span> <span class="n">S_hh</span>

    <span class="n">V11</span> <span class="o">=</span> <span class="n">solve_discrete_are</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">R_hh</span><span class="p">,</span> <span class="n">Q_hh</span><span class="p">)</span>
    <span class="n">Λ_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Q_hh</span> <span class="o">+</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">V11</span> <span class="o">@</span> <span class="n">B</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">V11</span> <span class="o">@</span> <span class="n">A</span><span class="p">)</span>

    <span class="n">A0_dev</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">B</span> <span class="o">@</span> <span class="n">Λ_s</span>
    <span class="n">Λ_s</span> <span class="o">=</span> <span class="n">Λ_s</span> <span class="o">+</span> <span class="n">Q_inv</span> <span class="o">@</span> <span class="n">S_hh</span>

    <span class="c1"># Feedforward for U_bi z_t</span>
    <span class="n">A12</span> <span class="o">=</span> <span class="o">-</span><span class="n">B</span> <span class="o">@</span> <span class="n">Q_inv</span> <span class="o">@</span> <span class="n">Π_h</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U_bi</span>
    <span class="n">R12</span> <span class="o">=</span> <span class="n">Λ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U_bi</span> <span class="o">-</span> <span class="n">Λ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Π_h</span> <span class="o">@</span> <span class="n">Q_inv</span> <span class="o">@</span> <span class="n">Π_h</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U_bi</span> <span class="o">+</span> <span class="n">A0_dev</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">V11</span> <span class="o">@</span> <span class="n">A12</span>

    <span class="n">V12</span> <span class="o">=</span> <span class="n">doublej2</span><span class="p">(</span><span class="n">A0_dev</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">R12</span><span class="p">,</span> <span class="n">A_22</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_z</span><span class="p">))</span>
    <span class="n">Q_opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Q_hh</span> <span class="o">+</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">V11</span> <span class="o">@</span> <span class="n">B</span><span class="p">)</span>
    <span class="n">U_b_s</span> <span class="o">=</span> <span class="n">Q_opt</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">V12</span> <span class="o">@</span> <span class="n">A_22</span> <span class="o">+</span> <span class="n">V11</span> <span class="o">@</span> <span class="n">A12</span><span class="p">)</span> <span class="o">+</span> <span class="n">Q_inv</span> <span class="o">@</span> <span class="n">Π_h</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U_bi</span>

    <span class="c1"># Undo sqrt β scaling</span>
    <span class="n">A0_dev</span> <span class="o">=</span> <span class="n">A0_dev</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">β</span><span class="p">)</span>

    <span class="c1"># Long-run covariance under aggregate law of motion</span>
    <span class="n">V_mat</span> <span class="o">=</span> <span class="n">doublej2</span><span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">A0</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="o">*</span> <span class="n">β</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">β</span><span class="p">)</span>

    <span class="c1"># Present value of household endowment stream</span>
    <span class="n">U_di</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">U_di</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">S_di</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_d</span><span class="p">,</span> <span class="n">n_h</span> <span class="o">+</span> <span class="n">n_k</span><span class="p">)),</span> <span class="n">U_di</span><span class="p">))</span>
    <span class="n">W_d</span> <span class="o">=</span> <span class="n">doublej2</span><span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">M_d</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">S_di</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">W_d</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W_d</span> <span class="o">@</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">M_d</span> <span class="o">@</span> <span class="n">V_mat</span> <span class="o">@</span> <span class="n">S_di</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Present value of intermediate good</span>
    <span class="n">W_g</span> <span class="o">=</span> <span class="n">doublej2</span><span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">M_g</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">S_g</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">W_g</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W_g</span> <span class="o">@</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">M_g</span> <span class="o">@</span> <span class="n">V_mat</span> <span class="o">@</span> <span class="n">S_g</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Shadow price object for durables</span>
    <span class="n">M_hs</span> <span class="o">=</span> <span class="n">β</span> <span class="o">*</span> <span class="n">doublej2</span><span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">A0_dev</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Λ_s</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">M_c</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">@</span> <span class="n">A0</span>
    <span class="n">S_c1</span> <span class="o">=</span> <span class="n">Θ_h</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">M_hs</span> <span class="o">-</span> <span class="n">M_c</span>

    <span class="c1"># Augmented system for consumption valuation</span>
    <span class="n">A_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">A0_dev</span><span class="p">,</span> <span class="n">Θ_h</span> <span class="o">@</span> <span class="n">S_c1</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">A0</span><span class="p">]])</span>
    <span class="n">C_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_h</span><span class="p">,</span> <span class="n">n_w</span><span class="p">)),</span> <span class="n">C</span><span class="p">))</span>

    <span class="n">M_cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M_c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">M_c</span><span class="p">))</span>
    <span class="n">S_cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">Λ_s</span><span class="p">,</span> <span class="n">S_c1</span><span class="p">))</span>

    <span class="n">x0s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_h</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">x0</span><span class="p">))</span>

    <span class="n">W_c1</span> <span class="o">=</span> <span class="n">doublej2</span><span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">A_s</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">M_cs</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A_s</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">S_cs</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">V_s</span> <span class="o">=</span> <span class="n">doublej2</span><span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">A_s</span><span class="p">,</span> <span class="n">C_s</span><span class="p">,</span> <span class="n">A_s</span><span class="p">,</span> <span class="n">C_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">β</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">β</span><span class="p">)</span>
    <span class="n">W_c1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
        <span class="p">(</span><span class="n">x0s</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W_c1</span> <span class="o">@</span> <span class="n">x0s</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">M_cs</span> <span class="o">@</span> <span class="n">V_s</span> <span class="o">@</span> <span class="n">S_cs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>

    <span class="n">S_c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M_c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span> <span class="o">+</span> <span class="n">n_k</span><span class="p">)),</span> <span class="n">U_b_s</span><span class="p">))</span>
    <span class="n">A_s2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">A0_dev</span><span class="p">,</span> <span class="n">Θ_h</span> <span class="o">@</span> <span class="n">S_c2</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">A0</span><span class="p">]])</span>
    <span class="n">S_cs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">Λ_s</span><span class="p">,</span> <span class="n">S_c2</span><span class="p">))</span>
    <span class="n">x0s2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">h0i</span><span class="p">,</span> <span class="n">x0</span><span class="p">))</span>

    <span class="n">W_c2</span> <span class="o">=</span> <span class="n">doublej2</span><span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">A_s2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">M_cs</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A_s2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">S_cs2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">V_s2</span> <span class="o">=</span> <span class="n">doublej2</span><span class="p">(</span><span class="n">β</span> <span class="o">*</span> <span class="n">A_s2</span><span class="p">,</span> <span class="n">C_s</span><span class="p">,</span> <span class="n">A_s2</span><span class="p">,</span> <span class="n">C_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">β</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">β</span><span class="p">)</span>
    <span class="n">W_c2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
        <span class="p">(</span><span class="n">x0s2</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">W_c2</span> <span class="o">@</span> <span class="n">x0s2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">M_cs</span> <span class="o">@</span> <span class="n">V_s2</span> <span class="o">@</span> <span class="n">S_cs2</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>

    <span class="c1"># Present value of initial capital</span>
    <span class="n">W_k</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">k0i</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Δ_k</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">M_k</span> <span class="o">+</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Γ</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">M_d</span><span class="p">)</span> <span class="o">@</span> <span class="n">x0</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>

    <span class="c1">## Compute the Pareto weight</span>
    <span class="n">μ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(((</span><span class="n">W_k</span> <span class="o">+</span> <span class="n">W_d</span> <span class="o">-</span> <span class="n">W_c2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">W_c1</span> <span class="o">-</span> <span class="n">W_g</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>

    <span class="c1"># Household selection matrices on augmented state X_t = [h^i_{t-1}, x_t]</span>
    <span class="n">S_cs</span> <span class="o">=</span> <span class="n">μ</span> <span class="o">*</span> <span class="n">S_c1</span> <span class="o">+</span> <span class="n">S_c2</span>
    <span class="n">A0_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">A0_dev</span><span class="p">,</span> <span class="n">Θ_h</span> <span class="o">@</span> <span class="n">S_cs</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">A0</span><span class="p">]])</span>
    <span class="n">S_ci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">Λ_s</span><span class="p">,</span> <span class="n">S_cs</span><span class="p">))</span>
    <span class="n">S_hi</span> <span class="o">=</span> <span class="n">A0_i</span><span class="p">[:</span><span class="n">n_h</span><span class="p">,</span> <span class="p">:</span><span class="n">n_h</span> <span class="o">+</span> <span class="n">n_x</span><span class="p">]</span>
    <span class="n">S_si</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Λ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_s</span><span class="p">,</span> <span class="n">n_x</span><span class="p">))))</span> <span class="o">+</span> <span class="n">Π_h</span> <span class="o">@</span> <span class="n">S_ci</span>
    <span class="n">S_bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_s</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_h</span> <span class="o">+</span> <span class="n">n_k</span><span class="p">)),</span> <span class="n">U_bi</span><span class="p">))</span>
    <span class="n">S_di</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_d</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_h</span> <span class="o">+</span> <span class="n">n_k</span><span class="p">)),</span> <span class="n">U_di</span><span class="p">))</span>

    <span class="c1"># Embed aggregate selection and pricing objects on X_t</span>
    <span class="n">S_ha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_h</span><span class="p">,</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">S_h</span><span class="p">))</span>
    <span class="n">S_ka</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_k</span><span class="p">,</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">S_k</span><span class="p">))</span>
    <span class="n">S_ia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">S_i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">S_i</span><span class="p">))</span>
    <span class="n">S_ga</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">S_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">S_g</span><span class="p">))</span>
    <span class="n">S_da</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_d</span><span class="p">,</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">S_d</span><span class="p">))</span>
    <span class="n">S_ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_s</span><span class="p">,</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">S_b</span><span class="p">))</span>
    <span class="n">S_ca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">S_c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">S_c</span><span class="p">))</span>
    <span class="n">S_sa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_s</span><span class="p">,</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">S_s</span><span class="p">))</span>

    <span class="n">M_ha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M_h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">M_h</span><span class="p">))</span>
    <span class="n">M_ka</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M_k</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">M_k</span><span class="p">))</span>
    <span class="n">M_sa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">M_s</span><span class="p">))</span>
    <span class="n">M_ga</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">M_g</span><span class="p">))</span>
    <span class="n">M_ia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M_i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">M_i</span><span class="p">))</span>
    <span class="n">M_da</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M_d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_h</span><span class="p">)),</span> <span class="n">M_d</span><span class="p">))</span>
    <span class="n">M_ca</span> <span class="o">=</span> <span class="n">M_cs</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;μ&quot;</span><span class="p">:</span> <span class="n">μ</span><span class="p">,</span>
        <span class="s2">&quot;S_ci&quot;</span><span class="p">:</span> <span class="n">S_ci</span><span class="p">,</span>
        <span class="s2">&quot;S_hi&quot;</span><span class="p">:</span> <span class="n">S_hi</span><span class="p">,</span>
        <span class="s2">&quot;S_si&quot;</span><span class="p">:</span> <span class="n">S_si</span><span class="p">,</span>
        <span class="s2">&quot;S_bi&quot;</span><span class="p">:</span> <span class="n">S_bi</span><span class="p">,</span>
        <span class="s2">&quot;S_di&quot;</span><span class="p">:</span> <span class="n">S_di</span><span class="p">,</span>
        <span class="s2">&quot;S_ha&quot;</span><span class="p">:</span> <span class="n">S_ha</span><span class="p">,</span>
        <span class="s2">&quot;S_ka&quot;</span><span class="p">:</span> <span class="n">S_ka</span><span class="p">,</span>
        <span class="s2">&quot;S_ia&quot;</span><span class="p">:</span> <span class="n">S_ia</span><span class="p">,</span>
        <span class="s2">&quot;S_ga&quot;</span><span class="p">:</span> <span class="n">S_ga</span><span class="p">,</span>
        <span class="s2">&quot;S_da&quot;</span><span class="p">:</span> <span class="n">S_da</span><span class="p">,</span>
        <span class="s2">&quot;S_ba&quot;</span><span class="p">:</span> <span class="n">S_ba</span><span class="p">,</span>
        <span class="s2">&quot;S_ca&quot;</span><span class="p">:</span> <span class="n">S_ca</span><span class="p">,</span>
        <span class="s2">&quot;S_sa&quot;</span><span class="p">:</span> <span class="n">S_sa</span><span class="p">,</span>
        <span class="s2">&quot;M_ha&quot;</span><span class="p">:</span> <span class="n">M_ha</span><span class="p">,</span>
        <span class="s2">&quot;M_ka&quot;</span><span class="p">:</span> <span class="n">M_ka</span><span class="p">,</span>
        <span class="s2">&quot;M_sa&quot;</span><span class="p">:</span> <span class="n">M_sa</span><span class="p">,</span>
        <span class="s2">&quot;M_ga&quot;</span><span class="p">:</span> <span class="n">M_ga</span><span class="p">,</span>
        <span class="s2">&quot;M_ia&quot;</span><span class="p">:</span> <span class="n">M_ia</span><span class="p">,</span>
        <span class="s2">&quot;M_da&quot;</span><span class="p">:</span> <span class="n">M_da</span><span class="p">,</span>
        <span class="s2">&quot;M_ca&quot;</span><span class="p">:</span> <span class="n">M_ca</span><span class="p">,</span>
        <span class="s2">&quot;A0_i&quot;</span><span class="p">:</span> <span class="n">A0_i</span><span class="p">,</span>
        <span class="s2">&quot;C_s&quot;</span><span class="p">:</span> <span class="n">C_s</span><span class="p">,</span>
        <span class="s2">&quot;x0s&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">h0i</span><span class="p">,</span> <span class="n">x0</span><span class="p">)),</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="limited-markets">
<h2><span class="section-number">22.4. </span>Limited markets<a class="headerlink" href="#limited-markets" title="Link to this heading">#</a></h2>
<p>This section studies a special case from Section 12.6 of <span id="id10">Hansen and Sargent [<a class="reference internal" href="zreferences.html#id162" title="L P Hansen and T J Sargent. Recursive Models of Dynamic Linear Economies. The Gorman Lectures in Economics. Princeton University Press, 2013.">2013</a>]</span> in which the Arrow-Debreu allocation can be implemented by opening competitive markets only in a mutual fund and a one-period bond.</p>
<ul class="simple">
<li><p>So in our setting, we don’t literally require that markets in  a complete set of contingent claims be present.</p></li>
</ul>
<p>To match the implementation result in Chapter 12.6 of <span id="id11">Hansen and Sargent [<a class="reference internal" href="zreferences.html#id162" title="L P Hansen and T J Sargent. Recursive Models of Dynamic Linear Economies. The Gorman Lectures in Economics. Princeton University Press, 2013.">2013</a>]</span>, we specialize to the one-good, constant-return case</p>
<div class="math notranslate nohighlight">
\[
c_t + i_t = \gamma_1 k_{t-1} + d_t, \qquad
k_t = \delta_k k_{t-1} + i_t, \qquad
\beta = \frac{1}{\gamma_1 + \delta_k}.
\]</div>
<p>In this case, the one-period riskless gross return is constant, <span class="math notranslate nohighlight">\(R = \gamma_1 + \delta_k = 1/\beta\)</span>.</p>
<p>We also impose the Chapter 12.6 <span id="id12">Hansen and Sargent [<a class="reference internal" href="zreferences.html#id162" title="L P Hansen and T J Sargent. Recursive Models of Dynamic Linear Economies. The Gorman Lectures in Economics. Princeton University Press, 2013.">2013</a>]</span> measurability restriction that the deviation baseline <span class="math notranslate nohighlight">\(\{\tilde{\chi}_{jt}\}\)</span> is <span class="math notranslate nohighlight">\(\mathcal{J}_0\)</span>-measurable (for example, the preference-shock processes <span class="math notranslate nohighlight">\(\{b_{jt}\}\)</span> are deterministic).</p>
<section id="the-trading-arrangement">
<h3><span class="section-number">22.4.1. </span>The trading arrangement<a class="headerlink" href="#the-trading-arrangement" title="Link to this heading">#</a></h3>
<p>Consider again an economy where each household <span class="math notranslate nohighlight">\(j\)</span> initially owns claims to its own endowment stream <span class="math notranslate nohighlight">\(\{d_{jt}\}\)</span>.</p>
<p>Instead of trading in a complete set of Arrow-Debreu markets, we open:</p>
<ol class="arabic simple">
<li><p>A stock market with securities paying dividends <span class="math notranslate nohighlight">\(\{d_{jt}\}\)</span> for each endowment process</p></li>
<li><p>A market for one-period riskless bonds</p></li>
</ol>
<p>At time zero, household <span class="math notranslate nohighlight">\(j\)</span> executes the following trades:</p>
<ol class="arabic simple">
<li><p>Household <span class="math notranslate nohighlight">\(j\)</span> sells all shares of its own endowment security.</p></li>
<li><p>Household <span class="math notranslate nohighlight">\(j\)</span> purchases <span class="math notranslate nohighlight">\(\mu_j\)</span> shares of all securities (equivalently, <span class="math notranslate nohighlight">\(\mu_j\)</span> shares of a mutual fund holding the aggregate endowment).</p></li>
<li><p>Household <span class="math notranslate nohighlight">\(j\)</span> takes position <span class="math notranslate nohighlight">\(\hat{k}_{j0}\)</span> in the one-period bond.</p></li>
</ol>
<p>After this initial rebalancing, household <span class="math notranslate nohighlight">\(j\)</span> maintains a constant risky portfolio share <span class="math notranslate nohighlight">\(\mu_j\)</span> forever, while using the one-period bond for dynamic rebalancing.</p>
<p>The bond position <span class="math notranslate nohighlight">\(\hat{k}_{jt}\)</span> evolves each period according to the recursion derived below.</p>
<p>The portfolio weight <span class="math notranslate nohighlight">\(\mu_j\)</span> is not arbitrary: it is the unique weight that allows the limited-markets portfolio to replicate the Arrow-Debreu consumption allocation.</p>
<p>With Gorman aggregation, household <span class="math notranslate nohighlight">\(j\)</span>’s equilibrium consumption satisfies</p>
<div class="math notranslate nohighlight">
\[
c_{jt} = \mu_j c_t + \tilde{\chi}_{jt}.
\]</div>
<p>We need a portfolio strategy that delivers exactly this consumption stream.</p>
<p>The mutual fund holds claims to all individual endowment streams.</p>
<p>Total dividends paid by the fund each period are</p>
<div class="math notranslate nohighlight">
\[
\sum_{i=1}^J d_{it} = d_t,
\]</div>
<p>which is the aggregate endowment.</p>
<p>If household <span class="math notranslate nohighlight">\(j\)</span> holds fraction <span class="math notranslate nohighlight">\(\mu_j\)</span> of this fund, it receives <span class="math notranslate nohighlight">\(\mu_j d_t\)</span> in dividends.</p>
<p>The proportional part of consumption <span class="math notranslate nohighlight">\(\mu_j c_t\)</span> must be financed by the mutual fund and by holding a proportional share of aggregate capital.</p>
<p>Combining the resource constraint and capital accumulation gives</p>
<div class="math notranslate nohighlight">
\[
c_t + k_t = R k_{t-1} + d_t.
\]</div>
<p>Multiplying by <span class="math notranslate nohighlight">\(\mu_j\)</span> yields</p>
<div class="math notranslate nohighlight">
\[
\mu_j c_t + \mu_j k_t = R (\mu_j k_{t-1}) + \mu_j d_t,
\]</div>
<p>so mutual-fund dividends <span class="math notranslate nohighlight">\(\mu_j d_t\)</span> and the return on a proportional capital position <span class="math notranslate nohighlight">\(\mu_j k_{t-1}\)</span> finance household <span class="math notranslate nohighlight">\(j\)</span>’s proportional claim <span class="math notranslate nohighlight">\(\mu_j c_t\)</span> plus the reinvestment needed to maintain its share <span class="math notranslate nohighlight">\(\mu_j k_t\)</span>.</p>
<p>The remaining term <span class="math notranslate nohighlight">\(\tilde{\chi}_{jt}\)</span> is financed by adjusting an <em>additional</em> bond position <span class="math notranslate nohighlight">\(\hat{k}_{jt}\)</span> according to the recursion derived below.</p>
<p>Holding <span class="math notranslate nohighlight">\(\mu_j\)</span> shares of the mutual fund thus finances exactly the proportional component <span class="math notranslate nohighlight">\(\mu_j c_t\)</span> (together with rolling over the proportional capital position), while the bond handles the deviation <span class="math notranslate nohighlight">\(\tilde{\chi}_{jt}\)</span>.</p>
<p>This transforms heterogeneous endowment risk into proportional shares of aggregate risk.</p>
<p>We now derive the law of motion for the bond position <span class="math notranslate nohighlight">\(\hat{k}_{jt}\)</span>.</p>
<p>First, write the budget constraint.</p>
<p>Household <span class="math notranslate nohighlight">\(j\)</span>’s time-<span class="math notranslate nohighlight">\(t\)</span> resources are its mutual fund dividend <span class="math notranslate nohighlight">\(\mu_j d_t\)</span> plus the return on its bond position <span class="math notranslate nohighlight">\(R(\mu_j k_{t-1} + \hat{k}_{j,t-1})\)</span>.</p>
<p>Its uses of funds are consumption <span class="math notranslate nohighlight">\(c_{jt}\)</span> plus the new bond position <span class="math notranslate nohighlight">\((\mu_j k_t + \hat{k}_{jt})\)</span>, so</p>
<div class="math notranslate nohighlight">
\[
\underbrace{\mu_j d_t}_{\text{mutual fund dividend}} + \underbrace{R(\mu_j k_{t-1} + \hat{k}_{j,t-1})}_{\text{bond return}} = \underbrace{c_{jt}}_{\text{consumption}} + \underbrace{(\mu_j k_t + \hat{k}_{jt})}_{\text{new bonds}}
\]</div>
<p>Substituting the sharing rule by replacing <span class="math notranslate nohighlight">\(c_{jt}\)</span> with <span class="math notranslate nohighlight">\(\mu_j c_t + \tilde{\chi}_{jt}\)</span> gives:</p>
<div class="math notranslate nohighlight">
\[
\mu_j d_t + R(\mu_j k_{t-1} + \hat{k}_{j,t-1}) = \mu_j c_t + \tilde{\chi}_{jt} + (\mu_j k_t + \hat{k}_{jt})
\]</div>
<p>Using <span class="math notranslate nohighlight">\(\mu_j c_t + \mu_j k_t = R(\mu_j k_{t-1}) + \mu_j d_t\)</span>, the proportional terms cancel and we obtain</p>
<div class="math notranslate nohighlight">
\[
R \hat{k}_{j,t-1} = \tilde{\chi}_{jt} + \hat{k}_{jt}
\]</div>
<p>Rearranging gives the bond recursion:</p>
<div class="math notranslate nohighlight" id="equation-eq-bond-recursion">
<span class="eqno">(22.19)<a class="headerlink" href="#equation-eq-bond-recursion" title="Link to this equation">#</a></span>\[
\hat{k}_{jt} = R \hat{k}_{j,t-1} - \tilde{\chi}_{jt}.
\]</div>
<p>Equation <a class="reference internal" href="#equation-eq-bond-recursion">(22.19)</a> says that the bond position grows at rate <span class="math notranslate nohighlight">\(R\)</span> but is drawn down by the deviation consumption <span class="math notranslate nohighlight">\(\tilde{\chi}_{jt}\)</span>.</p>
<p>When <span class="math notranslate nohighlight">\(\tilde{\chi}_{jt} &gt; 0\)</span> (i.e., household <span class="math notranslate nohighlight">\(j\)</span> consumes more than its share), it finances this by running down its bond holdings.</p>
<p>The household’s total asset position is hence <span class="math notranslate nohighlight">\(a_{jt} = \mu_j k_t + \hat{k}_{jt}\)</span>.</p>
</section>
<section id="initial-bond-position">
<h3><span class="section-number">22.4.2. </span>Initial bond position<a class="headerlink" href="#initial-bond-position" title="Link to this heading">#</a></h3>
<p>To find <span class="math notranslate nohighlight">\(\hat{k}_{j0}\)</span>, we solve the recursion <a class="reference internal" href="#equation-eq-bond-recursion">(22.19)</a> forward.</p>
<p>Iterating forward from <span class="math notranslate nohighlight">\(\hat{k}_{jt} = R \hat{k}_{j,t-1} - \tilde{\chi}_{jt}\)</span>, we get:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
\hat{k}_{j1} &amp;= R \hat{k}_{j0} - \tilde{\chi}_{j1} \\
\hat{k}_{j2} &amp;= R \hat{k}_{j1} - \tilde{\chi}_{j2} = R^2 \hat{k}_{j0} - R\tilde{\chi}_{j1} - \tilde{\chi}_{j2} \\
&amp;\vdots \\
\hat{k}_{jT} &amp;= R^T \hat{k}_{j0} - \sum_{t=1}^T R^{T-t} \tilde{\chi}_{jt}
\end{aligned}
\end{split}\]</div>
<p>For the budget constraint to hold with equality, we apply transversality and require <span class="math notranslate nohighlight">\(\lim_{T \to \infty} R^{-T} \hat{k}_{jT} = 0\)</span>.</p>
<p>Dividing by <span class="math notranslate nohighlight">\(R^T\)</span>:</p>
<div class="math notranslate nohighlight">
\[
R^{-T} \hat{k}_{jT} = \hat{k}_{j0} - \sum_{t=1}^T R^{-t} \tilde{\chi}_{jt}
\]</div>
<p>Taking <span class="math notranslate nohighlight">\(T \to \infty\)</span> and using transversality:</p>
<div class="math notranslate nohighlight">
\[
0 = \hat{k}_{j0} - \sum_{t=1}^\infty R^{-t} \tilde{\chi}_{jt}
\]</div>
<p>Solving for the initial position gives:</p>
<div class="math notranslate nohighlight">
\[
\hat{k}_{j0} = \sum_{t=1}^\infty R^{-t} \tilde{\chi}_{jt} = \sum_{t=1}^\infty \beta^t \tilde{\chi}_{jt}.
\]</div>
<p>This is the present value of future deviation consumption.</p>
<p>Under the measurability restriction (<span class="math notranslate nohighlight">\(\tilde{\chi}_{jt} \in \mathcal{J}_0\)</span>), this sum is known at date zero and can be used to set the initial bond position.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This construction embodies a multiperiod counterpart to an aggregation result for security markets derived by <span id="id13">Rubinstein [<a class="reference internal" href="zreferences.html#id5" title="Mark Rubinstein. An aggregation theorem for securities markets. Journal of Financial Economics, 1(3):225–244, 1974.">1974</a>]</span>.</p>
<p>In a two-period model, Rubinstein provided sufficient conditions on preferences of households and asset market payoffs that  implement a complete-markets  Arrow-Debreu contingent claims allocation with incomplete security markets.</p>
<p>In Rubinstein’s implementation, all households hold the same portfolio of risky assets.</p>
<p>In our construction, households also hold the same portfolio of risky assets, and portfolio weights do not vary over time.</p>
<p>All changes over time in portfolio composition take place through transactions in the bond market.</p>
</div>
<p>The code below  computes household allocations and limited-markets portfolios  according to the market structure we have just  described.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_household_paths</span><span class="p">(</span>
            <span class="n">econ</span><span class="p">,</span> <span class="n">U_b_list</span><span class="p">,</span> <span class="n">U_d_list</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x_path</span><span class="p">,</span> 
            <span class="n">γ_1</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">h0i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k0i</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute household allocations and limited-markets portfolios</span>
<span class="sd">    along a fixed aggregate path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Organize inputs</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">x_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">Θ_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">thetah</span><span class="p">)</span>
    <span class="n">Δ_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">deltah</span><span class="p">)</span>
    <span class="n">Π_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">pih</span><span class="p">)</span>
    <span class="n">Λ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">Λ</span><span class="p">)</span>

    <span class="n">n_h</span> <span class="o">=</span> <span class="n">Θ_h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">thetak</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">z_path</span> <span class="o">=</span> <span class="n">x_path</span><span class="p">[</span><span class="n">n_h</span> <span class="o">+</span> <span class="n">n_k</span><span class="p">:,</span> <span class="p">:]</span>

    
    <span class="c1"># Select consumption, capital, bonds, and dividends</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">econ</span><span class="o">.</span><span class="n">Sc</span> <span class="o">@</span> <span class="n">x_path</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">econ</span><span class="o">.</span><span class="n">Sk</span> <span class="o">@</span> <span class="n">x_path</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">econ</span><span class="o">.</span><span class="n">Sb</span> <span class="o">@</span> <span class="n">x_path</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">econ</span><span class="o">.</span><span class="n">Sd</span> <span class="o">@</span> <span class="n">x_path</span>

    <span class="n">δ_k</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">deltak</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">δ_k</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">γ_1</span><span class="p">)</span>

    <span class="n">Π_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Π_h</span><span class="p">)</span>
    <span class="n">A_h</span> <span class="o">=</span> <span class="n">Δ_h</span> <span class="o">-</span> <span class="n">Θ_h</span> <span class="o">@</span> <span class="n">Π_inv</span> <span class="o">@</span> <span class="n">Λ</span>
    <span class="n">B_h</span> <span class="o">=</span> <span class="n">Θ_h</span> <span class="o">@</span> <span class="n">Π_inv</span>

    <span class="k">if</span> <span class="n">h0i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h0i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_h</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">k0i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">k0i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Prepare data containers</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">U_b_list</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="n">μ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">χ_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
    <span class="n">c_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
    <span class="n">d_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
    <span class="n">d_share</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>  <span class="c1"># Dividend income under limited markets</span>
    <span class="n">k_share</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
    <span class="n">k_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
    <span class="n">a_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>

    <span class="c1"># For each household, compute Pareto weight and paths</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">U_bj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">U_b_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">U_dj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">U_d_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">heter</span><span class="p">(</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">llambda</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">thetah</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">deltah</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">pih</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">thetak</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">deltak</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">a22</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">c2</span><span class="p">,</span>
            <span class="n">U_bj</span><span class="p">,</span>
            <span class="n">U_dj</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">A0</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">C</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Md</span><span class="p">,</span>
            <span class="c1"># The book sets the intermediate-good multiplier to $M_g = S_g$</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Sg</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Mk</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Mc</span><span class="p">,</span>
            <span class="n">x0</span><span class="p">,</span>
            <span class="n">h0i</span><span class="p">,</span>
            <span class="n">k0i</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Sh</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Sk</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Si</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Sg</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Sd</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Sb</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Sc</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Ss</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Mh</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Ms</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">Mi</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">μ</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;μ&quot;</span><span class="p">]</span>

        <span class="n">b_tilde</span> <span class="o">=</span> <span class="n">U_bj</span> <span class="o">@</span> <span class="n">z_path</span> <span class="o">-</span> <span class="n">μ</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>

        <span class="n">η</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_h</span><span class="p">,</span> <span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">η</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">h0i</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># At t=0, assume η_{-1} = 0</span>
        <span class="n">χ_tilde</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Π_inv</span> <span class="o">@</span> <span class="n">b_tilde</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
            <span class="n">χ_tilde</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">Π_inv</span> <span class="o">@</span> <span class="n">Λ</span> <span class="o">@</span> <span class="n">η</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Π_inv</span> <span class="o">@</span> <span class="n">b_tilde</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">η</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A_h</span> <span class="o">@</span> <span class="n">η</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">B_h</span> <span class="o">@</span> <span class="n">b_tilde</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="n">c_j</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">μ</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">χ_tilde</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Original endowment claim (before trading)</span>
        <span class="n">d_j</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">U_dj</span> <span class="o">@</span> <span class="n">z_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Dividend income under limited markets: μ_j aggregate endowment</span>
        <span class="n">d_share</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">μ</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Capital share in mutual fund</span>
        <span class="n">k_share</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">μ</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Solve for bond path by backward iteration from terminal condition.</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1e-14</span><span class="p">:</span>
            <span class="n">k_hat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">χ_tilde</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">k_hat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">k_hat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">χ_tilde</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span> <span class="o">/</span> <span class="n">R</span>

        <span class="n">a_total</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_share</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">k_hat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="c1"># Validate that Gorman weights sum to 1</span>
    <span class="n">μ_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">μ</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">μ_sum</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pareto weights μ sum to </span><span class="si">{</span><span class="n">μ_sum</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, not 1.0. &quot;</span>
                      <span class="s2">&quot;This may indicate calibration issues.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;μ&quot;</span><span class="p">:</span> <span class="n">μ</span><span class="p">,</span>
        <span class="s2">&quot;χ_tilde&quot;</span><span class="p">:</span> <span class="n">χ_tilde</span><span class="p">,</span>
        <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span>
        <span class="s2">&quot;c_j&quot;</span><span class="p">:</span> <span class="n">c_j</span><span class="p">,</span>
        <span class="s2">&quot;d_j&quot;</span><span class="p">:</span> <span class="n">d_j</span><span class="p">,</span>
        <span class="s2">&quot;d_share&quot;</span><span class="p">:</span> <span class="n">d_share</span><span class="p">,</span>
        <span class="s2">&quot;k_share&quot;</span><span class="p">:</span> <span class="n">k_share</span><span class="p">,</span>
        <span class="s2">&quot;k_hat&quot;</span><span class="p">:</span> <span class="n">k_hat</span><span class="p">,</span>
        <span class="s2">&quot;a_total&quot;</span><span class="p">:</span> <span class="n">a_total</span><span class="p">,</span>
        <span class="s2">&quot;x_path&quot;</span><span class="p">:</span> <span class="n">x_path</span><span class="p">,</span>
        <span class="s2">&quot;z_path&quot;</span><span class="p">:</span> <span class="n">z_path</span><span class="p">,</span>
        <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The next function collects objects required to  solve the planner’s problem and compute household paths
into one function.</p>
<p>First we use the <code class="docutils literal notranslate"><span class="pre">DLE</span></code> class to set up the representative-agent DLE problem.</p>
<p>Then we build the full initial state by stacking zeros for lagged durables and capital with the initial exogenous state.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">LQ</span></code> class, we solve the LQ problem and simulate paths for the full state.</p>
<p>Finally, we call <code class="docutils literal notranslate"><span class="pre">compute_household_paths</span></code> to get household allocations and limited-markets portfolios along the simulated path</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">solve_model</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tech</span><span class="p">,</span> <span class="n">pref</span><span class="p">,</span> <span class="n">U_b_list</span><span class="p">,</span> <span class="n">U_d_list</span><span class="p">,</span> <span class="n">γ_1</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> 
                            <span class="n">z0</span><span class="p">,</span> <span class="n">ts_length</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve the representative-agent DLE problem and compute household paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">econ</span> <span class="o">=</span> <span class="n">DLE</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tech</span><span class="p">,</span> <span class="n">pref</span><span class="p">)</span>

    <span class="c1"># Build full initial state x0 = [h_{-1}, k_{-1}, z0]</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">n_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">thetah</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">thetak</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x0_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_h</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">z0</span><span class="p">])</span>

    <span class="c1"># Solve LQ problem and simulate paths</span>
    <span class="n">lq</span> <span class="o">=</span> <span class="n">LQ</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">econ</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">econ</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">econ</span><span class="o">.</span><span class="n">B</span><span class="p">,</span>
            <span class="n">econ</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">econ</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">econ</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span>
    <span class="n">x_path</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">compute_sequence</span><span class="p">(</span><span class="n">x0_full</span><span class="p">,</span> 
                        <span class="n">ts_length</span><span class="o">=</span><span class="n">ts_length</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="n">compute_household_paths</span><span class="p">(</span>
        <span class="n">econ</span><span class="o">=</span><span class="n">econ</span><span class="p">,</span>
        <span class="n">U_b_list</span><span class="o">=</span><span class="n">U_b_list</span><span class="p">,</span>
        <span class="n">U_d_list</span><span class="o">=</span><span class="n">U_d_list</span><span class="p">,</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">x0_full</span><span class="p">,</span>
        <span class="n">x_path</span><span class="o">=</span><span class="n">x_path</span><span class="p">,</span>
        <span class="n">γ_1</span><span class="o">=</span><span class="n">γ_1</span><span class="p">,</span>
        <span class="n">Λ</span><span class="o">=</span><span class="n">Λ</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">paths</span><span class="p">,</span> <span class="n">econ</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="example-two-household-economy">
<span id="gorman-twohh"></span><h2><span class="section-number">22.5. </span>Example: two-household economy<a class="headerlink" href="#example-two-household-economy" title="Link to this heading">#</a></h2>
<p>We now reproduce a two-household example from Chapter 12.6 of <span id="id14">Hansen and Sargent [<a class="reference internal" href="zreferences.html#id162" title="L P Hansen and T J Sargent. Recursive Models of Dynamic Linear Economies. The Gorman Lectures in Economics. Princeton University Press, 2013.">2013</a>]</span>.</p>
<p>There are two households, each with preferences</p>
<div class="math notranslate nohighlight">
\[
-\frac{1}{2} \mathbb{E}_0 \sum_{t=0}^{\infty} \beta^t \left[(c^i_t - b^i_t)^2 + \ell^{i\,2}_t\right], \quad i = 1, 2.
\]</div>
<p>We set <span class="math notranslate nohighlight">\(b^i_t = 15\)</span> for <span class="math notranslate nohighlight">\(i = 1, 2\)</span>, so the aggregate preference shock is <span class="math notranslate nohighlight">\(b_t = \sum_i b^i_t = 30\)</span>. The endowment processes are</p>
<div class="math notranslate nohighlight">
\[
d^1_t = 4 + 0.2\, \varepsilon^1_t, \qquad
d^2_t = 3 + \tilde{d}^2_t,
\]</div>
<p>where <span class="math notranslate nohighlight">\(\varepsilon^1_t\)</span> is standard Gaussian noise (so the idiosyncratic component has standard deviation <span class="math notranslate nohighlight">\(0.2\)</span>), and <span class="math notranslate nohighlight">\(\tilde{d}^2_t\)</span> follows</p>
<div class="math notranslate nohighlight">
\[
\tilde{d}^2_t = 1.2\, \tilde{d}^2_{t-1} - 0.22\, \tilde{d}^2_{t-2} + 0.25\, \varepsilon^2_t,
\]</div>
<p>with <span class="math notranslate nohighlight">\(\varepsilon^2_t\)</span> also standard Gaussian noise (so the innovation has standard deviation <span class="math notranslate nohighlight">\(0.25\)</span>).</p>
<p>Here <span class="math notranslate nohighlight">\(\varepsilon^1_t\)</span> and <span class="math notranslate nohighlight">\(\varepsilon^2_t\)</span> are components of the exogenous innovation vector <span class="math notranslate nohighlight">\(w_{t+1}\)</span> driving <span class="math notranslate nohighlight">\(z_t\)</span> and should not be confused with the wage-price sequence <span class="math notranslate nohighlight">\(w_{0t}\)</span> in the household budget constraint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Technology: c + i = γ_1 * k_{t-1} + d, with β = 1/(γ_1 + δ_k)</span>
<span class="c1"># No habits/durables (Λ = δ_h = θ_h = 0), so services = consumption</span>
<span class="n">ϕ_1</span><span class="p">,</span> <span class="n">γ_1</span><span class="p">,</span> <span class="n">δ_k</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.95</span>
<span class="n">β</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">γ_1</span> <span class="o">+</span> <span class="n">δ_k</span><span class="p">)</span>
<span class="n">θ_k</span><span class="p">,</span> <span class="n">δ_h</span><span class="p">,</span> <span class="n">θ_h</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">Π_h</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span>

<span class="n">Φ_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]])</span>
<span class="n">Φ_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]])</span>
<span class="n">Φ_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">ϕ_1</span><span class="p">]])</span>
<span class="n">Γ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">γ_1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]])</span>

<span class="c1"># Exogenous state z_t = [1, d_2_t, d_2_{t-1}, ε_1_t, ε_2_t]&#39;</span>
<span class="c1"># AR(2) aggregate shock in components 2-3; i.i.d. idiosyncratic in 4-5</span>
<span class="n">A_22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
<span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="n">C_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
<span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Both households: constant bliss point b = 15</span>
<span class="n">U_b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
<span class="n">U_b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
<span class="n">U_b</span> <span class="o">=</span> <span class="n">U_b1</span> <span class="o">+</span> <span class="n">U_b2</span>

<span class="c1"># HH1: d_1 = 4 + 0.2ε_1 (idiosyncratic); </span>
<span class="c1"># HH2: d_2 = 3 + d_tilde2 (aggregate AR(2))</span>
<span class="n">U_d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
<span class="n">U_d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
<span class="n">U_d</span> <span class="o">=</span> <span class="n">U_d1</span> <span class="o">+</span> <span class="n">U_d2</span>

<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">A_22</span><span class="p">,</span> <span class="n">C_2</span><span class="p">,</span> <span class="n">U_b</span><span class="p">,</span> <span class="n">U_d</span><span class="p">)</span>
<span class="n">tech</span> <span class="o">=</span> <span class="p">(</span><span class="n">Φ_c</span><span class="p">,</span> <span class="n">Φ_g</span><span class="p">,</span> <span class="n">Φ_i</span><span class="p">,</span> <span class="n">Γ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">δ_k</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">θ_k</span><span class="p">]]))</span>
<span class="n">pref</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">β</span><span class="p">]]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">Λ</span><span class="p">]]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">Π_h</span><span class="p">]]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">δ_h</span><span class="p">]]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">θ_h</span><span class="p">]]))</span>

<span class="n">econ</span> <span class="o">=</span> <span class="n">DLE</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tech</span><span class="p">,</span> <span class="n">pref</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We simulate the closed-loop DLE state and compute household paths.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
<span class="n">ts_length</span> <span class="o">=</span> <span class="mi">2_000</span>

<span class="c1"># Solve LQ problem and simulate paths</span>
<span class="n">lq</span> <span class="o">=</span> <span class="n">LQ</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">econ</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">econ</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">econ</span><span class="o">.</span><span class="n">B</span><span class="p">,</span>
        <span class="n">econ</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">econ</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">econ</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span>
<span class="n">x_path</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lq</span><span class="o">.</span><span class="n">compute_sequence</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span>
                <span class="n">ts_length</span><span class="o">=</span><span class="n">ts_length</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">paths</span> <span class="o">=</span> <span class="n">compute_household_paths</span><span class="p">(</span>
    <span class="n">econ</span><span class="o">=</span><span class="n">econ</span><span class="p">,</span>
    <span class="n">U_b_list</span><span class="o">=</span><span class="p">[</span><span class="n">U_b1</span><span class="p">,</span> <span class="n">U_b2</span><span class="p">],</span>
    <span class="n">U_d_list</span><span class="o">=</span><span class="p">[</span><span class="n">U_d1</span><span class="p">,</span> <span class="n">U_d2</span><span class="p">],</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span>
    <span class="n">x_path</span><span class="o">=</span><span class="n">x_path</span><span class="p">,</span>
    <span class="n">γ_1</span><span class="o">=</span><span class="n">γ_1</span><span class="p">,</span>
    <span class="n">Λ</span><span class="o">=</span><span class="n">Λ</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The next figure plots the consumption paths for the aggregate economy and the two households</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T_plot</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">t0</span> <span class="o">=</span> <span class="mi">200</span> 

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span><span class="n">t0</span><span class="o">+</span><span class="n">T_plot</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;aggregate&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;c_j&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span><span class="n">t0</span><span class="o">+</span><span class="n">T_plot</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;household 1&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;c_j&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span><span class="n">t0</span><span class="o">+</span><span class="n">T_plot</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;household 2&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;consumption&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<figure class="align-default" id="fig-gorman-consumption">
<img alt="_images/72ad67ab6f20eed152c2a3ee1123126f4d6ae16a8e0a03bafc7b45349e2f4a7b.png" src="_images/72ad67ab6f20eed152c2a3ee1123126f4d6ae16a8e0a03bafc7b45349e2f4a7b.png" />
<figcaption>
<p><span class="caption-number">Fig. 22.2 </span><span class="caption-text">consumption paths</span><a class="headerlink" href="#fig-gorman-consumption" title="Link to this image">#</a></p>
</figcaption>
</figure>
</div>
</div>
<p>The next figure plots the limited-markets bond adjustment and confirms that the adjustments sum to approximately zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;k_hat&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span><span class="n">t0</span><span class="o">+</span><span class="n">T_plot</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;household 1&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;k_hat&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="n">t0</span><span class="p">:</span><span class="n">t0</span><span class="o">+</span><span class="n">T_plot</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;household 2&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;k_hat&quot;</span><span class="p">][:,</span> <span class="n">t0</span><span class="p">:</span><span class="n">t0</span><span class="o">+</span><span class="n">T_plot</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;bond position&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<figure class="align-default" id="fig-gorman-bond-adjustment">
<img alt="_images/4d132570f0a1ad32e095b058ee3ce99c447f864623a5d8a17da7b0c43017c8ed.png" src="_images/4d132570f0a1ad32e095b058ee3ce99c447f864623a5d8a17da7b0c43017c8ed.png" />
<figcaption>
<p><span class="caption-number">Fig. 22.3 </span><span class="caption-text">bond position adjustments</span><a class="headerlink" href="#fig-gorman-bond-adjustment" title="Link to this image">#</a></p>
</figcaption>
</figure>
</div>
</div>
<p>Our final check is to verify that the bond positions sum to zero at all times, confirming that the limited-markets implementation is self-financing</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;k_hat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(3.552713678800501e-14)
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-many-household-gorman-economies">
<h2><span class="section-number">22.6. </span>Example: many-household Gorman economies<a class="headerlink" href="#example-many-household-gorman-economies" title="Link to this heading">#</a></h2>
<p>We now extend the two-household example to an economy with many households.</p>
<section id="specification">
<h3><span class="section-number">22.6.1. </span>Specification<a class="headerlink" href="#specification" title="Link to this heading">#</a></h3>
<p>The exogenous state vector is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
z_t =
\begin{bmatrix}
1 \\
d_{a,t} \\
d_{a,t-1} \\
\eta_{J_a+1,t} \\
\vdots \\
\eta_{J,t} \\
\xi_{1,t} \\
\vdots \\
\xi_{J,t}
\end{bmatrix},
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(J\)</span> is the number of households and <span class="math notranslate nohighlight">\(J_a\)</span> is the number of “absorbing” households (defined below).</p>
<p>The first three components track a constant and the “ghost” aggregate endowment process.
The components <span class="math notranslate nohighlight">\(\{\eta_{j,t}\}_{j=J_a+1}^J\)</span> are idiosyncratic endowment states for the non-absorbing households.
The components <span class="math notranslate nohighlight">\(\{\xi_{j,t}\}_{j=1}^J\)</span> are idiosyncratic preference-shock states (often set to zero in experiments).</p>
<p>The aggregate endowment follows an AR(2) process:</p>
<div class="math notranslate nohighlight">
\[
d_{a,t+1} = \rho_1 d_{a,t} + \rho_2 d_{a,t-1} + \sigma_a w_{1,t+1},
\]</div>
<p>where <span class="math notranslate nohighlight">\(w_{1,t+1}\)</span> is the aggregate innovation (the first component of <span class="math notranslate nohighlight">\(w_{t+1}\)</span>) and we can set the <span class="math notranslate nohighlight">\(\rho_j\)</span>’s to capture persistent aggregate fluctuations.</p>
<p>Let <span class="math notranslate nohighlight">\(J_a\)</span> denote the number of “absorbing” households.
For households <span class="math notranslate nohighlight">\(j &gt; J_a\)</span>, individual endowments are</p>
<div class="math notranslate nohighlight">
\[
d_{jt} = \alpha_j + \phi_j d_{a,t} + \eta_{j,t}, \quad j = J_a + 1, \ldots, J.
\]</div>
<p>The first <span class="math notranslate nohighlight">\(J_a\)</span> households absorb the negative of all idiosyncratic endowment shocks to ensure aggregation:</p>
<div class="math notranslate nohighlight">
\[
d_{jt} = \alpha_j + \phi_j d_{a,t} - \frac{1}{J_a} \sum_{k=J_a+1}^J \eta_{k,t}, \quad j = 1, \ldots, J_a.
\]</div>
<p>This construction ensures that</p>
<div class="math notranslate nohighlight">
\[
\sum_{j=1}^J d_{j,t} = \sum_{j=1}^J \alpha_j + \left(\sum_{j=1}^J \phi_j\right) d_{a,t}.
\]</div>
<p>Imposing <span class="math notranslate nohighlight">\(\sum_{j=1}^J \phi_j = 1\)</span> gives</p>
<div class="math notranslate nohighlight">
\[
\sum_{j=1}^J d_{j,t} = \sum_{j=1}^J \alpha_j + d_{a,t}.
\]</div>
<p>To activate the assumptions behind our limited-markets arrangement for implementing an Arrow-Debreu allocation, we silence preference shocks by setting:</p>
<div class="math notranslate nohighlight">
\[
b_{jt} = \bar{b} + \xi_{j,t}, \quad j = 1, \ldots, J,
\]</div>
<p>where the <span class="math notranslate nohighlight">\(\xi_{j,t}\)</span> processes  can be silenced by setting their innovation loadings to zero.</p>
<p>To complete the specification, we let the idiosyncratic states follow AR(1) laws of motion
(all innovations are components of the i.i.d. vector <span class="math notranslate nohighlight">\(w_{t+1}\)</span> in <span class="math notranslate nohighlight">\(z_{t+1} = A_{22} z_t + C_2 w_{t+1}\)</span>):</p>
<div class="math notranslate nohighlight">
\[
\eta_{j,t+1} = \rho^{d}_j \eta_{j,t} + \sigma_j \varepsilon^{d}_{j,t+1},
\qquad j = J_a + 1, \ldots, J,
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
\xi_{j,t+1} = \rho^{b}_j \xi_{j,t} + \gamma_j \varepsilon^{b}_{j,t+1},
\qquad j = 1, \ldots, J.
\]</div>
<p>Here <span class="math notranslate nohighlight">\(\varepsilon^{d}_{j,t+1}\)</span> and <span class="math notranslate nohighlight">\(\varepsilon^{b}_{j,t+1}\)</span> are mean-zero, unit-variance innovations (components of <span class="math notranslate nohighlight">\(w_{t+1}\)</span>).
Setting <span class="math notranslate nohighlight">\(\rho^{d}_j = 0\)</span> (or <span class="math notranslate nohighlight">\(\rho^{b}_j = 0\)</span>) recovers i.i.d. shocks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">build_gorman_extended</span><span class="p">(</span>
    <span class="n">n</span><span class="p">,</span>
    <span class="n">rho1</span><span class="p">,</span> <span class="n">rho2</span><span class="p">,</span> <span class="n">sigma_a</span><span class="p">,</span>
    <span class="n">alphas</span><span class="p">,</span> <span class="n">phis</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span>
    <span class="n">b_bar</span><span class="p">,</span> <span class="n">gammas</span><span class="p">,</span>
    <span class="n">rho_idio</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">rho_pref</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">n_absorb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extended version that includes idiosyncratic shocks as state variables,</span>
<span class="sd">    allowing the full heterogeneous dynamics to be captured.</span>

<span class="sd">    The state vector is:</span>
<span class="sd">    z_t = [1, d_{a,t}, d_{a,t-1}, eta_{n_absorb+1,t}, </span>
<span class="sd">            ..., eta_{n,t}, xi_{1,t}, ..., xi_{n,t}]</span>

<span class="sd">    The first n_absorb households absorb the negative sum </span>
<span class="sd">    of all idiosyncratic shocks to ensure shocks sum to zero:</span>
<span class="sd">    sum_{j=1}^{n_absorb} (-1/n_absorb * sum_{k&gt;n_absorb} eta_k) </span>
<span class="sd">    + sum_{k&gt;n_absorb} eta_k = 0</span>

<span class="sd">    Each household k &gt; n_absorb has its own idiosyncratic endowment shock </span>
<span class="sd">    eta_{k,t} following an AR(1):</span>

<span class="sd">        eta_{k,t+1} = rho_idio[k] * eta_{k,t} + sigma_k * w_{k,t+1}</span>

<span class="sd">    with rho_idio = 0 recovering i.i.d. shocks (AR(0)).</span>

<span class="sd">    Preference shocks xi_{j,t} are included for each household but </span>
<span class="sd">    can be set to zero if desired.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">phis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">phis</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sigmas</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gammas</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">phis</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sigmas</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">gammas</span><span class="p">)</span> <span class="o">==</span> <span class="n">n</span>

    <span class="c1"># Default: 10% of households absorb shocks (at least 1)</span>
    <span class="k">if</span> <span class="n">n_absorb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_absorb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">n_absorb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_absorb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_absorb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">n_absorb</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;n_absorb must be in [1, n-1], got </span><span class="si">{</span><span class="n">n_absorb</span><span class="si">}</span><span class="s2"> with n=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Dimensions</span>
    <span class="n">n_idio</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">n_absorb</span>       <span class="c1"># eta_{n_absorb+1}, ..., eta_n</span>
    <span class="n">n_pref</span> <span class="o">=</span> <span class="n">n</span>                  <span class="c1"># xi_1, ..., xi_n</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">n_idio</span> <span class="o">+</span> <span class="n">n_pref</span>
    <span class="n">nw</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">n_idio</span> <span class="o">+</span> <span class="n">n_pref</span>    <span class="c1"># aggregate + idio + pref shocks</span>

    <span class="c1"># Persistence parameters</span>
    <span class="n">rho_idio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rho_idio</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rho_idio</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">rho_idio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_idio</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">rho_idio</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rho_idio</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_idio</span><span class="p">,):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;rho_idio must be scalar or shape (</span><span class="si">{</span><span class="n">n_idio</span><span class="si">}</span><span class="s2">,), got </span><span class="si">{</span><span class="n">rho_idio</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">rho_pref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rho_pref</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rho_pref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">rho_pref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_pref</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">rho_pref</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rho_pref</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_pref</span><span class="p">,):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;rho_pref must be scalar or shape (</span><span class="si">{</span><span class="n">n_pref</span><span class="si">}</span><span class="s2">,), got </span><span class="si">{</span><span class="n">rho_pref</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># A22: transition matrix</span>
    <span class="n">A22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="n">nz</span><span class="p">))</span>
    <span class="n">A22</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>           <span class="c1"># constant</span>
    <span class="n">A22</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho1</span>          <span class="c1"># d_{a,t} AR(2) first coef</span>
    <span class="n">A22</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho2</span>          <span class="c1"># d_{a,t} AR(2) second coef</span>
    <span class="n">A22</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>           <span class="c1"># lag transition</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_idio</span><span class="p">):</span>
        <span class="n">A22</span><span class="p">[</span><span class="mi">3</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_idio</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pref</span><span class="p">):</span>
        <span class="n">A22</span><span class="p">[</span><span class="mi">3</span> <span class="o">+</span> <span class="n">n_idio</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">n_idio</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_pref</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="c1"># C2: shock loading</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="n">nw</span><span class="p">))</span>
    <span class="n">C2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_a</span>  
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_idio</span><span class="p">):</span>
        <span class="c1"># Map to households n_absorb+1, ..., n </span>
        <span class="n">C2</span><span class="p">[</span><span class="mi">3</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">n_absorb</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pref</span><span class="p">):</span>
        <span class="n">C2</span><span class="p">[</span><span class="mi">3</span> <span class="o">+</span> <span class="n">n_idio</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">n_idio</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gammas</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># gamma_j -&gt; xi_j</span>

    <span class="c1"># Ud_per_house: endowment loading</span>
    <span class="c1"># First n_absorb households: </span>
    <span class="c1"># d_{jt} = alpha_j + phi_j * d_{a,t} - (1/n_ab) * sum_{k&gt;n_ab} eta_{k,t}</span>
    <span class="c1"># Remaining households k &gt; n_absorb: </span>
    <span class="c1"># d_{kt} = alpha_k + phi_k * d_{a,t} + eta_{k,t}</span>
    <span class="n">Ud_per_house</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">nz</span><span class="p">))</span>
        <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphas</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>    <span class="c1"># constant</span>
        <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phis</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>      <span class="c1"># loading on d_{a,t}</span>

        <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n_absorb</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_idio</span><span class="p">):</span>
                <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">n_absorb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">n_absorb</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">Ud_per_house</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

    <span class="n">Ud</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Ud_per_house</span><span class="p">)</span>

    <span class="c1"># Ub_per_house: bliss loading</span>
    <span class="c1"># b_{jt} = b_bars[j] + xi_{j,t}</span>
    <span class="c1"># b_bar can be scalar (same for all) or array (household-specific)</span>
    <span class="n">b_bars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">b_bar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b_bars</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">b_bars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">b_bars</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">Ub_per_house</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="p">))</span>
        <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_bars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>         <span class="c1"># household-specific bliss</span>
        <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">n_idio</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># loading on xi_j (zeroed if gammas=0)</span>
        <span class="n">Ub_per_house</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="n">Ub</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Ub_per_house</span><span class="p">)</span>

    <span class="c1"># Initial state</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># constant = 1</span>

    <span class="k">return</span> <span class="n">A22</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">Ub</span><span class="p">,</span> <span class="n">Ud</span><span class="p">,</span> <span class="n">Ub_per_house</span><span class="p">,</span> <span class="n">Ud_per_house</span><span class="p">,</span> <span class="n">x0</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="household-economy">
<h3><span class="section-number">22.6.2. </span>100-household  economy<a class="headerlink" href="#household-economy" title="Link to this heading">#</a></h3>
<p>We now instantiate a 100-household version of the preceding economy.</p>
<p>We use the same technology and preference parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Technology and preference parameters</span>
<span class="n">ϕ_1</span> <span class="o">=</span> <span class="mf">1e-5</span>
<span class="n">γ_1</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">δ_k</span> <span class="o">=</span> <span class="mf">0.95</span>
<span class="n">β</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">γ_1</span> <span class="o">+</span> <span class="n">δ_k</span><span class="p">)</span>

<span class="n">θ_k</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">δ_h</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">θ_h</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">Λ</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">Π_h</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">Φ_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]])</span>
<span class="n">Φ_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]])</span>
<span class="n">Φ_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">ϕ_1</span><span class="p">]])</span>
<span class="n">Γ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">γ_1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<p>We set household-specific parameters below and impose <span class="math notranslate nohighlight">\(\sum_j \phi_j = 1\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Aggregate endowment process parameters</span>
<span class="n">ρ1</span> <span class="o">=</span> <span class="mf">0.95</span>
<span class="n">ρ2</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">σ_a</span> <span class="o">=</span> <span class="mf">0.5</span>


<span class="c1"># Mean endowments α_j and aggregate exposure φ_j</span>
<span class="n">αs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">φs_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">φs</span> <span class="o">=</span> <span class="n">φs_raw</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">φs_raw</span><span class="p">)</span>  <span class="c1"># normalize so Σ φ_j = 1</span>

<span class="c1"># Rank households by mean endowment to assign idiosyncratic risk</span>
<span class="n">wealth_rank_proxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">αs</span><span class="p">))</span>
<span class="n">wealth_pct_proxy</span> <span class="o">=</span> <span class="p">(</span><span class="n">wealth_rank_proxy</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
<span class="n">poorness</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">wealth_pct_proxy</span>

<span class="c1"># First n_absorb households absorb idiosyncratic shocks</span>
<span class="n">n_absorb</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># Poorer households face larger, more persistent idiosyncratic shocks</span>
<span class="n">σ_idio_min</span><span class="p">,</span> <span class="n">σ_idio_max</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">5.0</span>
<span class="n">σs</span> <span class="o">=</span> <span class="n">σ_idio_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">σ_idio_max</span> <span class="o">-</span> <span class="n">σ_idio_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">poorness</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="n">ρ_idio_min</span><span class="p">,</span> <span class="n">ρ_idio_max</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.94</span>
<span class="n">ρ_idio</span> <span class="o">=</span> <span class="n">ρ_idio_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">ρ_idio_max</span> <span class="o">-</span> <span class="n">ρ_idio_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">poorness</span><span class="p">[</span><span class="n">n_absorb</span><span class="p">:]</span> <span class="o">**</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># Preference shocks are muted</span>
<span class="c1"># Bliss points scale with endowment so high-α households want more consumption</span>
<span class="n">b_bar_base</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">b_bars</span> <span class="o">=</span> <span class="n">b_bar_base</span> <span class="o">*</span> <span class="p">(</span><span class="n">αs</span> <span class="o">/</span> <span class="n">αs</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>  <span class="c1"># household-specific bliss points</span>
<span class="n">γs_pref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">ρ_pref</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="n">A22</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">Ub</span><span class="p">,</span> <span class="n">Ud</span><span class="p">,</span> <span class="n">Ub_list</span><span class="p">,</span> <span class="n">Ud_list</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">build_gorman_extended</span><span class="p">(</span>
    <span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span>
    <span class="n">rho1</span><span class="o">=</span><span class="n">ρ1</span><span class="p">,</span> <span class="n">rho2</span><span class="o">=</span><span class="n">ρ2</span><span class="p">,</span> <span class="n">sigma_a</span><span class="o">=</span><span class="n">σ_a</span><span class="p">,</span>
    <span class="n">alphas</span><span class="o">=</span><span class="n">αs</span><span class="p">,</span> <span class="n">phis</span><span class="o">=</span><span class="n">φs</span><span class="p">,</span> <span class="n">sigmas</span><span class="o">=</span><span class="n">σs</span><span class="p">,</span>
    <span class="n">b_bar</span><span class="o">=</span><span class="n">b_bars</span><span class="p">,</span> <span class="n">gammas</span><span class="o">=</span><span class="n">γs_pref</span><span class="p">,</span>
    <span class="n">rho_idio</span><span class="o">=</span><span class="n">ρ_idio</span><span class="p">,</span> <span class="n">rho_pref</span><span class="o">=</span><span class="n">ρ_pref</span><span class="p">,</span>
    <span class="n">n_absorb</span><span class="o">=</span><span class="n">n_absorb</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sum(φs) = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">φs</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> (should be 1.0)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sum(φs) = 1.000000 (should be 1.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info_ar1</span> <span class="o">=</span> <span class="p">(</span><span class="n">A22</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">Ub</span><span class="p">,</span> <span class="n">Ud</span><span class="p">)</span>
<span class="n">pref_ar1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">β</span><span class="p">]]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">Λ</span><span class="p">]]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">Π_h</span><span class="p">]]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">δ_h</span><span class="p">]]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">θ_h</span><span class="p">]]))</span>
<span class="n">tech_ar1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Φ_c</span><span class="p">,</span> <span class="n">Φ_g</span><span class="p">,</span> <span class="n">Φ_i</span><span class="p">,</span> <span class="n">Γ</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">δ_k</span><span class="p">]]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">θ_k</span><span class="p">]]))</span>

<span class="n">paths</span><span class="p">,</span> <span class="n">econ</span> <span class="o">=</span> <span class="n">solve_model</span><span class="p">(</span><span class="n">info_ar1</span><span class="p">,</span> <span class="n">tech_ar1</span><span class="p">,</span> <span class="n">pref_ar1</span><span class="p">,</span>
                    <span class="n">Ub_list</span><span class="p">,</span> <span class="n">Ud_list</span><span class="p">,</span> <span class="n">γ_1</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="n">x0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;State dimension: </span><span class="si">{</span><span class="n">A22</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, shock dimension: </span><span class="si">{</span><span class="n">C2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggregate: ρ_1=</span><span class="si">{</span><span class="n">ρ1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, ρ_2=</span><span class="si">{</span><span class="n">ρ2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, σ_a=</span><span class="si">{</span><span class="n">σ_a</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Endowments: α in [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">αs</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">αs</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>State dimension: 153, shock dimension: 151
Aggregate: ρ_1=0.950, ρ_2=0.000, σ_a=0.50
Endowments: α in [3.01, 4.97]
</pre></div>
</div>
</div>
</div>
<p>The next plots show household consumption and dividend paths after discarding the initial burn-in period.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T_plot</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;c_j&quot;</span><span class="p">][:,</span> <span class="n">t0</span><span class="p">:</span><span class="n">t0</span><span class="o">+</span><span class="n">T_plot</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;consumption&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;d_share&quot;</span><span class="p">][:,</span> <span class="n">t0</span><span class="p">:</span><span class="n">t0</span><span class="o">+</span><span class="n">T_plot</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;dividends&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/479f95ae717682d61c26c0989792e7c27edbe43833339e204d35d5b23ee7d107.png" src="_images/479f95ae717682d61c26c0989792e7c27edbe43833339e204d35d5b23ee7d107.png" />
</div>
</div>
</section>
</section>
<section id="state-space-representation">
<h2><span class="section-number">22.7. </span>State-space representation<a class="headerlink" href="#state-space-representation" title="Link to this heading">#</a></h2>
<section id="closed-loop-state-space-system">
<h3><span class="section-number">22.7.1. </span>Closed-loop state-space system<a class="headerlink" href="#closed-loop-state-space-system" title="Link to this heading">#</a></h3>
<p>We can use our DLE tools first to solve the representative-household social planning problem and represent equilibrium quantities as a linear closed-loop  state-space system that takes the usual Chapter 5 <span id="id15">Hansen and Sargent [<a class="reference internal" href="zreferences.html#id162" title="L P Hansen and T J Sargent. Recursive Models of Dynamic Linear Economies. The Gorman Lectures in Economics. Princeton University Press, 2013.">2013</a>]</span> form</p>
<div class="math notranslate nohighlight">
\[
x_{t+1} = A_0 x_t + C w_{t+1},
\]</div>
<p>where the aggregate state vector is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
x_t =
\begin{bmatrix}
h_{t-1}\\
k_{t-1}\\
z_t
\end{bmatrix},
\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(h_{t-1}\)</span> the aggregate household service stock, <span class="math notranslate nohighlight">\(k_{t-1}\)</span> the aggregate  capital stock, and <span class="math notranslate nohighlight">\(z_t\)</span> the exogenous state (constant, aggregate endowment states, and idiosyncratic shock states).</p>
<p>Any equilibrium quantity is a linear function of the state.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">quantecon.DLE</span></code> module provides selection matrices <span class="math notranslate nohighlight">\(S_\bullet\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[
c_t = S_c x_t,\quad g_t = S_g x_t,\quad i_t = S_i x_t,\quad h_t = S_h x_t,\quad k_t = S_k x_t,\quad d_t = S_d x_t,\quad b_t = S_b x_t,\quad s_t = S_s x_t.
\]</div>
<p>We can stack these to form a measurement matrix:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
G =
\begin{bmatrix}
S_c\\ S_g\\ S_i\\ S_h\\ S_k\\ S_d\\ S_b\\ S_s
\end{bmatrix},
\qquad\text{giving}\qquad
y_t = G x_t.
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A0</span> <span class="o">=</span> <span class="n">econ</span><span class="o">.</span><span class="n">A0</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">econ</span><span class="o">.</span><span class="n">C</span>

<span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span>
    <span class="n">econ</span><span class="o">.</span><span class="n">Sc</span><span class="p">,</span>
    <span class="n">econ</span><span class="o">.</span><span class="n">Sg</span><span class="p">,</span>
    <span class="n">econ</span><span class="o">.</span><span class="n">Si</span><span class="p">,</span>
    <span class="n">econ</span><span class="o">.</span><span class="n">Sh</span><span class="p">,</span>
    <span class="n">econ</span><span class="o">.</span><span class="n">Sk</span><span class="p">,</span>
    <span class="n">econ</span><span class="o">.</span><span class="n">Sd</span><span class="p">,</span>
    <span class="n">econ</span><span class="o">.</span><span class="n">Sb</span><span class="p">,</span>
    <span class="n">econ</span><span class="o">.</span><span class="n">Ss</span><span class="p">,</span>
<span class="p">])</span>

<span class="c1"># Extract dimensions for proper slicing</span>
<span class="n">n_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">thetah</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">thetak</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_endo</span> <span class="o">=</span> <span class="n">n_h</span> <span class="o">+</span> <span class="n">n_k</span>  <span class="c1"># endogenous state dimension</span>
</pre></div>
</div>
</div>
</div>
<p>With the state-space representation, we can compute impulse responses to show how shocks propagate.</p>
<p>To trace the impulse response to shock <span class="math notranslate nohighlight">\(j\)</span>, we set <code class="docutils literal notranslate"><span class="pre">shock_idx=j</span></code> which selects column <span class="math notranslate nohighlight">\(j\)</span> of the loading matrix <span class="math notranslate nohighlight">\(C\)</span>.</p>
<p>This creates an initial state <span class="math notranslate nohighlight">\(x_0 = C e_j \sigma\)</span> where <span class="math notranslate nohighlight">\(e_j\)</span> is the <span class="math notranslate nohighlight">\(j\)</span>-th standard basis vector and <span class="math notranslate nohighlight">\(\sigma\)</span> is the shock size.</p>
<p>We then iterate forward with <span class="math notranslate nohighlight">\(x_{t+1} = A_0 x_t\)</span> and compute observables via <span class="math notranslate nohighlight">\(y_t = G x_t\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_irf</span><span class="p">(</span><span class="n">A0</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">shock_idx</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">shock_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute impulse response to shock shock_idx with given shock size.&quot;&quot;&quot;</span>
    <span class="n">n_x</span> <span class="o">=</span> <span class="n">A0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_w</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">x_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_x</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
    <span class="n">y_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">G</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">T</span><span class="p">))</span>

    <span class="n">w0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_w</span><span class="p">)</span>
    <span class="n">w0</span><span class="p">[</span><span class="n">shock_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">shock_size</span>
    <span class="n">x_path</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="n">w0</span>
    <span class="n">y_path</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">G</span> <span class="o">@</span> <span class="n">x_path</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
        <span class="n">x_path</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">A0</span> <span class="o">@</span> <span class="n">x_path</span><span class="p">[:,</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y_path</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">G</span> <span class="o">@</span> <span class="n">x_path</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x_path</span><span class="p">,</span> <span class="n">y_path</span>

<span class="n">n_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">thetah</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">thetak</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">idx_da</span> <span class="o">=</span> <span class="n">n_h</span> <span class="o">+</span> <span class="n">n_k</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">T_irf</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">shock_size</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">irf_x</span><span class="p">,</span> <span class="n">irf_y</span> <span class="o">=</span> <span class="n">compute_irf</span><span class="p">(</span><span class="n">A0</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">shock_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T_irf</span><span class="p">,</span> <span class="n">shock_size</span><span class="o">=</span><span class="n">shock_size</span><span class="p">)</span>
<span class="n">idx_k</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># index of capital in stacked observable vector G @ x</span>


<span class="n">da_irf</span> <span class="o">=</span> <span class="n">irf_x</span><span class="p">[</span><span class="n">idx_da</span><span class="p">,</span> <span class="p">:]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>


<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">irf_y</span><span class="p">[</span><span class="n">idx_k</span><span class="p">,</span> <span class="p">:],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;capital&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">da_irf</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$d_{a,t}$&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/adebca731de6fa3e633094aab0da69529d3c13d314889bcc2baeca859480e72c.png" src="_images/adebca731de6fa3e633094aab0da69529d3c13d314889bcc2baeca859480e72c.png" />
</div>
</div>
<p>The aggregate endowment shock <span class="math notranslate nohighlight">\(d_{a,t}\)</span> follows an AR(1) process with <span class="math notranslate nohighlight">\(\rho_1 = 0.95\)</span>, so after the initial impact it decays monotonically toward zero as <span class="math notranslate nohighlight">\(0.95^t\)</span>.</p>
<p>By contrast, capital  is an endogenous stock that accumulates when the planner smooths consumption.</p>
<p>The positive endowment shock increases resources temporarily, but Hall-style preferences imply the planner saves part of the windfall rather than consuming it immediately.</p>
<p>This causes capital to rise as <span class="math notranslate nohighlight">\(d_{a,t}\)</span> falls — this is permanent income logic at work.</p>
<p>Next, we examine whether the household consumption and endowment paths generated by the simulation obey the Gorman sharing rule</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c_j_t0</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;c_j&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">t0</span><span class="p">:]</span>
<span class="n">d_j_t0</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;d_share&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">t0</span><span class="p">:]</span>

<span class="n">c_panel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">c_j_t0</span> <span class="o">-</span> <span class="n">c_j_t0</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># (N, T - t0)</span>
<span class="n">d_panel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">d_j_t0</span> <span class="o">-</span> <span class="n">d_j_t0</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># (N, T - t0)</span>
<span class="k">assert</span> <span class="n">c_panel</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">d_panel</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Plot aggregate endowment and individual household endowments</span>
<span class="n">d_agg</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">t0</span><span class="p">:]</span>
<span class="n">d_households</span> <span class="o">=</span> <span class="n">d_j_t0</span>

<span class="n">T_plot</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">d_agg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">time_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T_plot</span><span class="p">)</span>
<span class="n">n_to_plot</span> <span class="o">=</span> <span class="mi">1</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Top panel: Aggregate endowment</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_idx</span><span class="p">,</span> <span class="n">d_agg</span><span class="p">[:</span><span class="n">T_plot</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> 
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Aggregate endowment $d_t$&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Aggregate Endowment&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;endowment&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Also plot the mean across households</span>
<span class="n">d_mean</span> <span class="o">=</span> <span class="n">d_households</span><span class="p">[:,</span> <span class="p">:</span><span class="n">T_plot</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_idx</span><span class="p">,</span> <span class="n">d_mean</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mean across </span><span class="si">{</span><span class="n">d_households</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> households&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average of Individual Household Endowments&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (after burn-in)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;endowment&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4e2886457e4151e8b1064057e037fa83d363b8ca2b6410344b51c163a6b3e5ac.png" src="_images/4e2886457e4151e8b1064057e037fa83d363b8ca2b6410344b51c163a6b3e5ac.png" />
</div>
</div>
<p>Indeed, the average of individual household endowments tracks the aggregate endowment process, confirming that the construction of the idiosyncratic shocks and absorbing households works as intended.</p>
</section>
</section>
<section id="redistributing-by-adjusting-pareto-weights">
<h2><span class="section-number">22.8. </span>Redistributing by adjusting  Pareto weights<a class="headerlink" href="#redistributing-by-adjusting-pareto-weights" title="Link to this heading">#</a></h2>
<p>This section analyzes Pareto-efficient tax-and-transfer schemes by starting with competitive equilibrium allocations and using a specific set of nonnegative Pareto weights that sum to one.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are various tax-and-transfer   schemes that would deliver such efficient redistributions, but in terms of what interests us in this example, they are all equivalent.</p>
</div>
<section id="redistribution-via-pareto-weights">
<h3><span class="section-number">22.8.1. </span>Redistribution via Pareto weights<a class="headerlink" href="#redistribution-via-pareto-weights" title="Link to this heading">#</a></h3>
<p>The sharing rule <a class="reference internal" href="#equation-eq-sharing-rule">(22.11)</a> can be written as <span class="math notranslate nohighlight">\(c_{jt} - \chi_{jt} = \mu_j (c_t - \chi_t)\)</span>, where <span class="math notranslate nohighlight">\(\mu_j\)</span> is household <span class="math notranslate nohighlight">\(j\)</span>’s Pareto weight.</p>
<p>Define the Pareto weight <span class="math notranslate nohighlight">\(\lambda_j := \mu_j\)</span>, with <span class="math notranslate nohighlight">\(\sum_{j=1}^J \lambda_j = 1\)</span>.</p>
<p>Consider redistributing consumption by choosing new weights <span class="math notranslate nohighlight">\(\{\lambda_j^*\}\)</span> satisfying <span class="math notranslate nohighlight">\(\lambda_j^* \geq 0\)</span> and <span class="math notranslate nohighlight">\(\sum_j \lambda_j^* = 1\)</span>.</p>
<p>The new allocation <span class="math notranslate nohighlight">\(c_{jt} - \chi_{jt} = \lambda_j^* (c_t - \chi_t)\)</span> preserves aggregate dynamics <span class="math notranslate nohighlight">\((c_t, k_t)\)</span> while reallocating consumption across households.</p>
<p>Let <span class="math notranslate nohighlight">\(R := \delta_k + \gamma_1\)</span>.</p>
<p>For a given Pareto-weight vector <span class="math notranslate nohighlight">\(\omega\)</span>,
household <span class="math notranslate nohighlight">\(j\)</span>’s assets are <span class="math notranslate nohighlight">\(a_{j,t} := \omega_j k_t + \hat{k}_{j,t}\)</span> and income is</p>
<div class="math notranslate nohighlight">
\[
y_{j,t}(\omega) = \omega_j d_t + (R-1) a_{j,t-1}.
\]</div>
<p>We want to  compare pre- and post-redistribution consumption and income.</p>
<p>Let <span class="math notranslate nohighlight">\(\mu := \{\mu_j\}_{j=1}^J\)</span> denote the original competitive equilibrium Pareto weights, and let <span class="math notranslate nohighlight">\(\lambda^* := \{\lambda_j^*\}_{j=1}^J\)</span> denote the redistributed weights.</p>
<p>We write <span class="math notranslate nohighlight">\(y^{pre}_{j,t} = y_{j,t}(\mu)\)</span> and <span class="math notranslate nohighlight">\(y^{post}_{j,t} = y_{j,t}(\lambda^*)\)</span>, then compare consumption to income using percentile plots.</p>
<p>To implement a redistribution from <span class="math notranslate nohighlight">\(\mu\)</span> to <span class="math notranslate nohighlight">\(\lambda^*\)</span>, we construct new Pareto weights <span class="math notranslate nohighlight">\(\{\lambda_j^*\}_{j=1}^J\)</span> that:</p>
<ol class="arabic simple">
<li><p>Lower the weights for low-<span class="math notranslate nohighlight">\(j\)</span> types (wealthier households in our ordering)</p></li>
<li><p>Increase the weights for high-<span class="math notranslate nohighlight">\(j\)</span> types (less wealthy households)</p></li>
<li><p>Leave middle-<span class="math notranslate nohighlight">\(j\)</span> types relatively unaffected</p></li>
<li><p>Preserve the constraint <span class="math notranslate nohighlight">\(\sum_{j=1}^J \lambda_j^* = 1\)</span></p></li>
</ol>
<p>We choose to implement these steps by  using a smooth transformation.</p>
<p>Let <span class="math notranslate nohighlight">\(\{\lambda_j\}_{j=1}^J\)</span> denote the original competitive equilibrium Pareto weights (sorted in descending order). Define the redistribution function:</p>
<div class="math notranslate nohighlight">
\[
f(j; J) = \frac{j-1}{J-1}, \qquad
g(j; J) = 2\left|f(j; J) - \frac{1}{2}\right|, \qquad
\tau(j; J, \alpha, \beta) = \alpha \cdot \left[g(j; J)\right]^\beta,
\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(j \in \{1, \ldots, J\}\)</span> is the household index</p></li>
<li><p><span class="math notranslate nohighlight">\(\alpha &gt; 0\)</span> controls the overall magnitude of redistribution</p></li>
<li><p><span class="math notranslate nohighlight">\(\beta\)</span> controls the progressivity (higher <span class="math notranslate nohighlight">\(\beta\)</span> concentrates redistribution more strongly in the tails)</p></li>
</ul>
<p>Post-redistribution Pareto weights are:</p>
<div class="math notranslate nohighlight">
\[
\tilde{\lambda}_j = \lambda_j + \tau(j; J, \alpha, \beta) \cdot (\bar{\lambda} - \lambda_j),
\]</div>
<p>where <span class="math notranslate nohighlight">\(\bar{\lambda} = J^{-1}\)</span> is the equal-weight benchmark.</p>
<p>To ensure that our  weights sum to unity, we normalize:</p>
<div class="math notranslate nohighlight">
\[
\lambda_j^* = \frac{\tilde{\lambda}_j}{\sum_{k=1}^J \tilde{\lambda}_k}.
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_redistributed_weights</span><span class="p">(</span><span class="n">λ_orig</span><span class="p">,</span> <span class="n">α</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">β</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create more egalitarian Pareto weights via smooth redistribution.&quot;&quot;&quot;</span>
    <span class="n">λ_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">λ_orig</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">J</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">λ_orig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">J</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;λ_orig must be non-empty&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">J</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
    <span class="n">λ_bar</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">J</span>
    <span class="n">j_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
    <span class="n">f_j</span> <span class="o">=</span> <span class="n">j_indices</span> <span class="o">/</span> <span class="p">(</span><span class="n">J</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dist_from_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f_j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.5</span>
    <span class="n">τ_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">α</span> <span class="o">*</span> <span class="p">(</span><span class="n">dist_from_median</span> <span class="o">**</span> <span class="n">β</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">λ_tilde</span> <span class="o">=</span> <span class="n">λ_orig</span> <span class="o">+</span> <span class="n">τ_j</span> <span class="o">*</span> <span class="p">(</span><span class="n">λ_bar</span> <span class="o">-</span> <span class="n">λ_orig</span><span class="p">)</span>
    <span class="n">λ_star</span> <span class="o">=</span> <span class="n">λ_tilde</span> <span class="o">/</span> <span class="n">λ_tilde</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">λ_star</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the effect of redistribution on the Pareto weights in our 100-household economy</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μ_values</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;μ&quot;</span><span class="p">]</span>
<span class="n">idx_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">μ_values</span><span class="p">)</span>
<span class="n">λ_orig_sorted</span> <span class="o">=</span> <span class="n">μ_values</span><span class="p">[</span><span class="n">idx_sorted</span><span class="p">]</span>

<span class="n">red_α</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">red_β</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="n">λ_star_sorted</span> <span class="o">=</span> <span class="n">create_redistributed_weights</span><span class="p">(</span><span class="n">λ_orig_sorted</span><span class="p">,</span> <span class="n">α</span><span class="o">=</span><span class="n">red_α</span><span class="p">,</span> <span class="n">β</span><span class="o">=</span><span class="n">red_β</span><span class="p">)</span>

<span class="c1"># Map redistributed weights back to the original household ordering</span>
<span class="n">λ_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">μ_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">λ_star</span><span class="p">[</span><span class="n">idx_sorted</span><span class="p">]</span> <span class="o">=</span> <span class="n">λ_star_sorted</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">n_plot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">λ_orig_sorted</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">λ_orig_sorted</span><span class="p">[:</span><span class="n">n_plot</span><span class="p">],</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;original $\lambda_j$&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">λ_star_sorted</span><span class="p">[:</span><span class="n">n_plot</span><span class="p">],</span> <span class="s1">&#39;s-&#39;</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;redistributed $\lambda_j^*$&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">λ_orig_sorted</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;equal weight (1/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">λ_orig_sorted</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;household index $j$ (sorted by $\lambda$)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pareto weight&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">Δλ_sorted</span> <span class="o">=</span> <span class="n">λ_star_sorted</span> <span class="o">-</span> <span class="n">λ_orig_sorted</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_plot</span><span class="p">),</span> <span class="n">Δλ_sorted</span><span class="p">[:</span><span class="n">n_plot</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;g&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;r&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Δλ_sorted</span><span class="p">[:</span><span class="n">n_plot</span><span class="p">]])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;household index $j$ (sorted by $\lambda$)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\lambda_j^* - \lambda_j$&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bd10b6f8a26a63ee6ff6b32f3d0862b08e6ee3cc991d4c5fc11362a46105a9ec.png" src="_images/bd10b6f8a26a63ee6ff6b32f3d0862b08e6ee3cc991d4c5fc11362a46105a9ec.png" />
</div>
</div>
<p>Once we have the redistributed Pareto weights, we can compute the new household consumption and income paths.</p>
<p>The function below computes household consumption and income under given Pareto weights</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">allocation_from_weights</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">econ</span><span class="p">,</span> 
                            <span class="n">U_b_list</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">γ_1</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">h0i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">original_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute household consumption and income under given Pareto weights.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="c1"># For χ computation, use original weights if provided</span>
    <span class="k">if</span> <span class="n">original_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights_for_chi</span> <span class="o">=</span> <span class="n">weights</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weights_for_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">original_weights</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Extract aggregate paths</span>
    <span class="n">x_path</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;x_path&quot;</span><span class="p">]</span>
    <span class="n">c_agg</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
    <span class="n">d_agg</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span>
    <span class="n">k_agg</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span>
    <span class="n">z_path</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="s2">&quot;z_path&quot;</span><span class="p">]</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">c_agg</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Get parameters</span>
    <span class="n">Θ_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">thetah</span><span class="p">)</span>
    <span class="n">Δ_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">deltah</span><span class="p">)</span>
    <span class="n">Π_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">pih</span><span class="p">)</span>
    <span class="n">Λ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">Λ</span><span class="p">)</span>
    <span class="n">n_h</span> <span class="o">=</span> <span class="n">Θ_h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">δ_k</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">econ</span><span class="o">.</span><span class="n">deltak</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">δ_k</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">γ_1</span><span class="p">)</span>

    <span class="n">Π_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Π_h</span><span class="p">)</span>
    <span class="n">A_h</span> <span class="o">=</span> <span class="n">Δ_h</span> <span class="o">-</span> <span class="n">Θ_h</span> <span class="o">@</span> <span class="n">Π_inv</span> <span class="o">@</span> <span class="n">Λ</span>
    <span class="n">B_h</span> <span class="o">=</span> <span class="n">Θ_h</span> <span class="o">@</span> <span class="n">Π_inv</span>

    <span class="k">if</span> <span class="n">h0i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h0i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_h</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Compute household allocations</span>
    <span class="n">c_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
    <span class="n">χ_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
    <span class="n">k_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">U_bj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">U_b_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">b_agg</span> <span class="o">=</span> <span class="n">econ</span><span class="o">.</span><span class="n">Sb</span> <span class="o">@</span> <span class="n">x_path</span>
        <span class="c1"># Use weights_for_chi for b_tilde: keeps χ fixed during redistribution</span>
        <span class="n">b_tilde</span> <span class="o">=</span> <span class="n">U_bj</span> <span class="o">@</span> <span class="n">z_path</span> <span class="o">-</span> <span class="n">weights_for_chi</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">b_agg</span>

        <span class="n">η</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_h</span><span class="p">,</span> <span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">η</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">h0i</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># At t=0, assume η_{-1} = 0 </span>
        <span class="n">χ_tilde</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Π_inv</span> <span class="o">@</span> <span class="n">b_tilde</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
            <span class="n">χ_tilde</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="n">Π_inv</span> <span class="o">@</span> <span class="n">Λ</span> <span class="o">@</span> <span class="n">η</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Π_inv</span> <span class="o">@</span> <span class="n">b_tilde</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">η</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A_h</span> <span class="o">@</span> <span class="n">η</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">B_h</span> <span class="o">@</span> <span class="n">b_tilde</span><span class="p">[:,</span> <span class="n">t</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="n">c_j</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">c_agg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">χ_tilde</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Solve for bond path by backward iteration from terminal condition.</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1e-14</span><span class="p">:</span>
            <span class="n">k_hat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">χ_tilde</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">k_hat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">k_hat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">χ_tilde</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span> <span class="o">/</span> <span class="n">R</span>

    <span class="c1"># Compute income</span>
    <span class="n">k_share</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">k_agg</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">a_total</span> <span class="o">=</span> <span class="n">k_share</span> <span class="o">+</span> <span class="n">k_hat</span>

    <span class="c1"># Lagged assets</span>
    <span class="n">a_lag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">a_total</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">a_total</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Net income: dividend share + asset return</span>
    <span class="n">y_net</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">d_agg</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_lag</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">c_j</span><span class="p">,</span> <span class="s2">&quot;y_net&quot;</span><span class="p">:</span> <span class="n">y_net</span><span class="p">,</span> 
            <span class="s2">&quot;χ_tilde&quot;</span><span class="p">:</span> <span class="n">χ_tilde</span><span class="p">,</span> <span class="s2">&quot;k_hat&quot;</span><span class="p">:</span> <span class="n">k_hat</span><span class="p">,</span> 
            <span class="s2">&quot;a_total&quot;</span><span class="p">:</span> <span class="n">a_total</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">μ_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s2">&quot;μ&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">R</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">δ_k</span> <span class="o">+</span> <span class="n">γ_1</span><span class="p">)</span>

<span class="c1"># Redistribution parameters (same as visualization above)</span>
<span class="n">red_α</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">red_β</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="n">idx_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">μ_values</span><span class="p">)</span>
<span class="n">λ_orig_sorted</span> <span class="o">=</span> <span class="n">μ_values</span><span class="p">[</span><span class="n">idx_sorted</span><span class="p">]</span>

<span class="n">λ_star_sorted</span> <span class="o">=</span> <span class="n">create_redistributed_weights</span><span class="p">(</span><span class="n">λ_orig_sorted</span><span class="p">,</span> <span class="n">α</span><span class="o">=</span><span class="n">red_α</span><span class="p">,</span> <span class="n">β</span><span class="o">=</span><span class="n">red_β</span><span class="p">)</span>
<span class="n">λ_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">μ_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">λ_star</span><span class="p">[</span><span class="n">idx_sorted</span><span class="p">]</span> <span class="o">=</span> <span class="n">λ_star_sorted</span>

<span class="n">h0i_alloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">]])</span>

<span class="n">pre</span> <span class="o">=</span> <span class="n">allocation_from_weights</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">econ</span><span class="p">,</span>
                <span class="n">Ub_list</span><span class="p">,</span> <span class="n">μ_values</span><span class="p">,</span> <span class="n">γ_1</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">h0i_alloc</span><span class="p">)</span>

<span class="c1"># For post-redistribution: use λ_star for proportional share, but keep χ fixed</span>
<span class="c1"># that is to say preferences don&#39;t change with taxes</span>
<span class="n">post</span> <span class="o">=</span> <span class="n">allocation_from_weights</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">econ</span><span class="p">,</span>
                <span class="n">Ub_list</span><span class="p">,</span> <span class="n">λ_star</span><span class="p">,</span> <span class="n">γ_1</span><span class="p">,</span> <span class="n">Λ</span><span class="p">,</span> <span class="n">h0i_alloc</span><span class="p">,</span>
                <span class="n">original_weights</span><span class="o">=</span><span class="n">μ_values</span><span class="p">)</span>

<span class="n">c_pre</span> <span class="o">=</span> <span class="n">pre</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][:,</span> <span class="n">t0</span><span class="p">:]</span>
<span class="n">y_pre</span> <span class="o">=</span> <span class="n">pre</span><span class="p">[</span><span class="s2">&quot;y_net&quot;</span><span class="p">][:,</span> <span class="n">t0</span><span class="p">:]</span>
<span class="n">c_post</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][:,</span> <span class="n">t0</span><span class="p">:]</span>
<span class="n">y_post</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;y_net&quot;</span><span class="p">][:,</span> <span class="n">t0</span><span class="p">:]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_pct</span><span class="p">(</span><span class="n">panel</span><span class="p">,</span> <span class="n">ps</span><span class="o">=</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">panel</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">T_ts</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">c_pre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T_ts</span><span class="p">)</span>

<span class="n">y_pre_pct</span> <span class="o">=</span> <span class="n">_pct</span><span class="p">(</span><span class="n">y_pre</span><span class="p">[:,</span> <span class="p">:</span><span class="n">T_ts</span><span class="p">])</span>
<span class="n">y_post_pct</span> <span class="o">=</span> <span class="n">_pct</span><span class="p">(</span><span class="n">y_post</span><span class="p">[:,</span> <span class="p">:</span><span class="n">T_ts</span><span class="p">])</span>
<span class="n">c_pre_pct</span> <span class="o">=</span> <span class="n">_pct</span><span class="p">(</span><span class="n">c_pre</span><span class="p">[:,</span> <span class="p">:</span><span class="n">T_ts</span><span class="p">])</span>
<span class="n">c_post_pct</span> <span class="o">=</span> <span class="n">_pct</span><span class="p">(</span><span class="n">c_post</span><span class="p">[:,</span> <span class="p">:</span><span class="n">T_ts</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span>  <span class="mi">6</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_pre_pct</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p90&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_pre_pct</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p50&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_pre_pct</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p10&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$t$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$y^</span><span class="si">{pre}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_post_pct</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p90&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_post_pct</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p50&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_post_pct</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p10&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$t$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$y^</span><span class="si">{post}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c_post_pct</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p90&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c_post_pct</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p50&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">c_post_pct</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p10&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$t$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$c^</span><span class="si">{post}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
    <span class="n">handles</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">,</span>
    <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span>
    <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/593f0648e9b73ae8381d56e924b9872267edc5863f885f3826f2f6671bd9be5d.png" src="_images/593f0648e9b73ae8381d56e924b9872267edc5863f885f3826f2f6671bd9be5d.png" />
</div>
</div>
<p>The figures reveal a striking  reduction in income and consumption inequality after redistribution.</p>
<p>Also, notice how insurance smooths consumption relative to income, especially for lower-percentile households.</p>
<p>The post-tax-and-transfer income path exhibits less volatility for the lower percentiles compared to the pre-tax-and-transfer income.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                    </div>
                    
                </main> <!-- .page__content -->
                


                <footer class="qe-page__footer">

                    <p><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"></a></p>

                    <p>Creative Commons License &ndash; This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International.</p>

                    <p>A theme by <a href="https://quantecon.org">QuantEcon</a></p>

                </footer> <!-- .page__footer -->

            </div> <!-- .page -->

            

            
            <div class="qe-sidebar bd-sidebar inactive" id="site-navigation">

                <div class="qe-sidebar__header">


                    Contents

                </div>

                <nav class="qe-sidebar__nav" id="qe-sidebar-nav" aria-label="Main navigation">
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tools and Techniques
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="orth_proj.html">
   1. Orthogonal Projections and Their Applications
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="stationary_densities.html">
   2. Continuous State Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="muth_kalman.html">
   3. Reverse Engineering a la Muth
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="discrete_dp.html">
   4. Discrete State Dynamic Programming
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  LQ Control
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="cons_news.html">
   5. Information and Consumption Smoothing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="smoothing.html">
   6. Consumption Smoothing with Complete and Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="smoothing_tax.html">
   7. Tax Smoothing with Complete and Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="markov_jump_lq.html">
   8. Markov Jump Linear Quadratic Dynamic Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_1.html">
   9. How to Pay for a War: Part 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_2.html">
   10. How to Pay for a War: Part 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tax_smoothing_3.html">
   11. How to Pay for a War: Part 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lqramsey.html">
   12. Optimal Taxation in an LQ Economy
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Multiple Agent Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="arellano.html">
   13. Default Risk and Income Fluctuations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="matsuyama.html">
   14. Globalization and Cycles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coase.html">
   15. Coase’s Theory of the Firm
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="match_transport.html">
   16. Composite Sorting
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dynamic Linear Economies
 </span>
</p>
<ul class="current nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="hs_recursive_models.html">
   17. Recursive Models of Dynamic Linear Economies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="growth_in_dles.html">
   18. Growth in Dynamic Linear Economies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lucas_asset_pricing_dles.html">
   19. Lucas Asset Pricing Using DLE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="irfs_in_hall_model.html">
   20. IRFs in Hall Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="permanent_income_dles.html">
   21. Permanent Income Model using the DLE Class
  </a>
 </li>
 <li class="toctree-l1 current active active">
  <a class="current reference internal" href="#">
   22. Gorman Aggregation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rosen_schooling_model.html">
   23. Rosen Schooling Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cattle_cycles.html">
   24. Cattle Cycles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hs_invertibility_example.html">
   25. Shock Non Invertibility
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Risk, Model Uncertainty, and Robustness
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="five_preferences.html">
   26. Risk and Model Uncertainty
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="entropy.html">
   27. Etymology of Entropy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="robustness.html">
   28. Robustness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rob_markov_perf.html">
   29. Robust Markov Perfect Equilibrium
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Time Series Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="arma.html">
   30. Covariance Stationary Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="estspec.html">
   31. Estimation of Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="additive_functionals.html">
   32. Additive and Multiplicative Functionals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lu_tricks.html">
   33. Classical Control with Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="classical_filtering.html">
   34. Classical Prediction and Filtering With Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="knowing_forecasts_of_others.html">
   35. Knowing the Forecasts of Others
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Asset Pricing and Finance
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="lucas_model.html">
   36. Asset Pricing II: The Lucas Asset Pricing Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="asset_pricing_lph.html">
   37. Elementary Asset Pricing Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="black_litterman.html">
   38. Two Modifications of Mean-Variance Portfolio Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="BCG_complete_mkts.html">
   39. Irrelevance of Capital Structures with Complete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="BCG_incomplete_mkts.html">
   40. Equilibrium Capital Structures with Incomplete Markets
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dynamic Programming Squared
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="un_insure.html">
   41. Optimal Unemployment Insurance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dyn_stack.html">
   42. Stackelberg Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="calvo_machine_learn.html">
   43. Machine Learning a Ramsey Plan
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="calvo.html">
   44. Time Inconsistency of Ramsey Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="calvo_abreu.html">
   45. Sustainable Plans for a Calvo Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="opt_tax_recur.html">
   46. Optimal Taxation with State-Contingent Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="amss.html">
   47. Optimal Taxation without State-Contingent Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="amss2.html">
   48. Fluctuating Interest Rates Deliver Fiscal Insurance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="amss3.html">
   49. Fiscal Risk and Government Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chang_ramsey.html">
   50. Competitive Equilibria of a Model of Chang
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chang_credible.html">
   51. Credible Government Policies in a Model of Chang
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="troubleshooting.html">
   52. Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="zreferences.html">
   53. References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="status.html">
   54. Execution Statistics
  </a>
 </li>
</ul>

                </nav>

                <div class="qe-sidebar__footer">

                </div>

            </div> <!-- .sidebar -->
            
        </div> <!-- .main -->

        <div class="qe-toolbar">

            <div class="qe-toolbar__inner">

                <ul class="qe-toolbar__main">
                    <li data-tippy-content="Table of Contents" class="btn__sidebar"><i data-feather="menu"></i></li>
                    <li data-tippy-content="Home"><a href="intro.html"><i data-feather="home"></i></a></li>
                    <li class="btn__qelogo"><a href="https://quantecon.org" title=""><span class="show-for-sr">QuantEcon</span></a></li>
                </ul>

                <ul class="qe-toolbar__links">
                    <li class="btn__search">
                        <form action="search.html" method="get">
                            <input type="search" class="form-control" name="q" id="search-input" placeholder="Search..." aria-label="Search..." autocomplete="off" accesskey="k">
                            <i data-feather="search" id="search-icon"></i>
                        </form>
                    </li>
                    <li data-tippy-content="Fullscreen" class="btn__fullscreen"><i data-feather="maximize"></i></li>
                    <li data-tippy-content="Increase font size" class="btn__plus"><i data-feather="plus-circle"></i></li>
                    <li data-tippy-content="Decrease font size" class="btn__minus"><i data-feather="minus-circle"></i></li>
                    <li data-tippy-content="Change contrast" class="btn__contrast"><i data-feather="sunset"></i></li>
                    <li data-tippy-content="Download Notebook"><a href="/_notebooks/gorman_heterogeneous_households.ipynb" download><i data-feather="download-cloud"></i></a></li>
                    <li class="settings-button" id="settingsButton"><div data-tippy-content="Launch Notebook"><i data-feather="play-circle"></i></div></li>
                        <li class="download-pdf" id="downloadButton"><i data-feather="file"></i></li>
                    <!--
                    # Enable if looking for link to specific document hosted on GitHub
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-python-advanced.myst/blob/main/lectures/gorman_heterogeneous_households.md" download><i data-feather="github"></i></a></li>
                    -->
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-python-advanced.myst" download><i data-feather="github"></i></a></li>
                </ul>

            </div>

        </div> <!-- .toolbar -->
        <div id="downloadPDFModal" style="display: none;">
            <ul class="pdf-options" style="display: block;">
                <li class="download-pdf-book" onClick="window.print()">
                    <p>Lecture (PDF)</p>
                </li>
                <li class="download-pdf-file">
                    <a href="/_pdf/quantecon-python-advanced.pdf" download><p>Book (PDF)</p></a>
                </li>
            </ul>
        </div>
        <div id="settingsModal" style="display: none;">
            <p class="modal-title"> Notebook Launcher </p>
            <div class="modal-desc">
            <p>
                Choose public or private cloud service for "Launch" button.
            </p>
            </div>
            <p class="modal-subtitle">Select a server</p>
            <ul class="modal-servers">
            <li class="active launcher-public">
                <span class="label">Public</span>
                <select id="launcher-public-input">
                
                    <option value="https://colab.research.google.com/github/QuantEcon/lecture-python-advanced.notebooks/blob/main/gorman_heterogeneous_households.ipynb">Colab</option>
                
                </select>
                <i class="fas fa-check-circle"></i>
            </li>
            <li class="launcher-private">
                <span class="label">Private</span>
                <input type="text" id="launcher-private-input" data-repourl="https://github.com/QuantEcon/lecture-python-advanced.notebooks" data-urlpath="tree/lecture-python-advanced.notebooks/gorman_heterogeneous_households.ipynb" data-branch=main>
                <i class="fas fa-check-circle"></i>
            </li>
            </ul>
            <p class="launch"><a href="https://colab.research.google.com/github/QuantEcon/lecture-python-advanced.notebooks/blob/main/gorman_heterogeneous_households.ipynb" id="advancedLaunchButton" target="_blank">Launch Notebook</a></p>
            <script>
                // QuantEcon Notebook Launcher
                const launcherTypeElements = document.querySelectorAll('#settingsModal .modal-servers li');
                // Highlight the server type if previous selection exists
                if (typeof localStorage.launcherType !== 'undefined') {
                  for (var i = 0; i < launcherTypeElements.length; i++) {
                    launcherTypeElements[i].classList.remove('active');
                    if ( launcherTypeElements[i].classList.contains(localStorage.launcherType) ) {
                      launcherTypeElements[i].classList.add('active');
                    }
                  }
                }
                // Highlight server type on click and set local storage value
                for (var i = 0; i < launcherTypeElements.length; i++) {
                  launcherTypeElements[i].addEventListener('click', function() {
                    for (var j = 0; j < launcherTypeElements.length; j++) {
                      launcherTypeElements[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    if ( this.classList.contains('launcher-private') ) {
                      localStorage.launcherType = 'launcher-private';
                    } else if ( this.classList.contains('launcher-public') ) {
                      localStorage.launcherType = 'launcher-public';
                    }
                    setLaunchServer();
                  })
                }
                const launcherPublic = document.getElementById('launcher-public-input');
                const launcherPrivate = document.getElementById('launcher-private-input');
                const pageName = "gorman_heterogeneous_households";
                const repoURL = "https://github.com/QuantEcon/lecture-python-advanced.notebooks";
                const urlPath = "tree/lecture-python-advanced.notebooks/gorman_heterogeneous_households.ipynb";
                const branch = "main"
                const launchNotebookLink = document.getElementById('advancedLaunchButton');

                // Highlight public server option if previous selection exists
                if (typeof localStorage.launcherPublic !== 'undefined') {
                  launcherPublic.value = localStorage.launcherPublic;
                }
                // Update local storage upon public server selection
                launcherPublic.addEventListener('change', (event) => {
                  setLaunchServer();
                });
                // Populate private server input if previous entry exists
                if (typeof localStorage.launcherPrivate !== 'undefined') {
                  launcherPrivate.value = localStorage.launcherPrivate;
                }
                // Update local storage when a private server is entered
                launcherPrivate.addEventListener('input', (event) => {
                  setLaunchServer();
                });

                // Function to update the "Launch Notebook" link href
                function setLaunchServer() {
                  launchNotebookLink.removeAttribute("style")
                  if ( localStorage.launcherType == 'launcher-private' ) {
                    let repoPrefix = "/user-redirect/git-pull?repo=" + repoURL + "&branch=" + branch + "&urlpath=" + urlPath;
                    launcherPrivateValue = launcherPrivate.value
                    if (!launcherPrivateValue) {
                        launchNotebookLink.removeAttribute("href")
                        launchNotebookLink.style.background = "grey"
                        return
                    }
                    localStorage.launcherPrivate = launcherPrivateValue;
                    privateServer = localStorage.launcherPrivate.replace(/\/$/, "")
                    if (!privateServer.includes("http")) {
                        privateServer = "http://" + privateServer
                    }
                    launchNotebookLinkURL = privateServer + repoPrefix;
                  } else if ( localStorage.launcherType == 'launcher-public' ) {
                    launcherPublicValue = launcherPublic.options[launcherPublic.selectedIndex].value;
                    localStorage.launcherPublic = launcherPublicValue;
                    launchNotebookLinkURL = localStorage.launcherPublic;
                  }
                  if (launchNotebookLinkURL) launchNotebookLink.href = launchNotebookLinkURL;
                }
                // Check if user has previously selected a server
                if ( (typeof localStorage.launcherPrivate !== 'undefined') || (typeof localStorage.launcherPublic !== 'undefined') ) {
                  setLaunchServer();
                }
                </script>

        </div>

    </div> <!-- .wrapper-->
  </body>
</html>